Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
	by mail.lfdr.de (Postfix) with ESMTPS id DB1512D1B5D
	for <lists.virtualization@lfdr.de>; Mon,  7 Dec 2020 21:57:02 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by fraxinus.osuosl.org (Postfix) with ESMTP id 8F83F8725A;
	Mon,  7 Dec 2020 20:57:01 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id m8kdNuDUe8Hj; Mon,  7 Dec 2020 20:56:59 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by fraxinus.osuosl.org (Postfix) with ESMTP id 654478716C;
	Mon,  7 Dec 2020 20:56:58 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 3F3C4C013B;
	Mon,  7 Dec 2020 20:56:58 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
 by lists.linuxfoundation.org (Postfix) with ESMTP id DD329C1834
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:56:55 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by fraxinus.osuosl.org (Postfix) with ESMTP id D3886870BE
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:56:55 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id 7kC0BjMsTbNQ
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:56:54 +0000 (UTC)
X-Greylist: from auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by fraxinus.osuosl.org (Postfix) with ESMTPS id EB8CF870CE
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:56:53 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 5E409305D48B; Mon,  7 Dec 2020 22:46:26 +0200 (EET)
Received: from localhost.localdomain (unknown [91.199.104.27])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 3B6A53072784;
 Mon,  7 Dec 2020 22:46:26 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v11 80/81] KVM: introspection: emulate a guest page table walk
 on SPT violations due to A/D bit updates
Date: Mon,  7 Dec 2020 22:46:21 +0200
Message-Id: <20201207204622.15258-81-alazar@bitdefender.com>
In-Reply-To: <20201207204622.15258-1-alazar@bitdefender.com>
References: <20201207204622.15258-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKT24gU1BUIHBhZ2Ug
ZmF1bHRzIGNhdXNlZCBieSBndWVzdCBwYWdlIHRhYmxlIHdhbGtzLCB1c2UgdGhlIGV4aXN0aW5n
Cmd1ZXN0IHBhZ2UgdGFibGUgd2FsayBjb2RlIHRvIG1ha2UgdGhlIG5lY2Vzc2FyeSBhZGp1c3Rt
ZW50cyB0byB0aGUgQS9ECmJpdHMgYW5kIHJldHVybiB0byBndWVzdC4gVGhpcyBlZmZlY3RpdmVs
eSBieXBhc3NlcyB0aGUgeDg2IGVtdWxhdG9yCndobyB3YXMgbWFraW5nIHRoZSB3cm9uZyBtb2Rp
ZmljYXRpb25zIGxlYWRpbmcgb25lIE9TIChXaW5kb3dzIDguMSB4NjQpCnRvIHRyaXBsZS1mYXVs
dCB2ZXJ5IGVhcmx5IGluIHRoZSBib290IHByb2Nlc3Mgd2l0aCB0aGUgaW50cm9zcGVjdGlvbgpl
bmFibGVkLgoKV2l0aCBpbnRyb3NwZWN0aW9uIGRpc2FibGVkLCB0aGVzZSBmYXVsdHMgYXJlIGhh
bmRsZWQgYnkgc2ltcGx5IHJlbW92aW5nCnRoZSBwcm90ZWN0aW9uIGZyb20gdGhlIGFmZmVjdGVk
IGd1ZXN0IHBhZ2UgYW5kIHJldHVybmluZyB0byBndWVzdC4KClNpZ25lZC1vZmYtYnk6IE1paGFp
IERvbsibdSA8bWRvbnR1QGJpdGRlZmVuZGVyLmNvbT4KU2lnbmVkLW9mZi1ieTogQWRhbGJlcnQg
TGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29tPgotLS0KIGFyY2gveDg2L2luY2x1ZGUvYXNt
L2t2bWlfaG9zdC5oIHwgIDIgKysKIGFyY2gveDg2L2t2bS9rdm1pLmMgICAgICAgICAgICAgIHwg
MzAgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiBhcmNoL3g4Ni9rdm0vbW11L21tdS5j
ICAgICAgICAgICB8IDEyICsrKysrKysrKystLQogaW5jbHVkZS9saW51eC9rdm1pX2hvc3QuaCAg
ICAgICAgfCAgMyArKysKIHZpcnQva3ZtL2ludHJvc3BlY3Rpb24va3ZtaS5jICAgIHwgMjYgKysr
KysrKysrKysrKysrKysrKysrKysrKysKIDUgZmlsZXMgY2hhbmdlZCwgNzEgaW5zZXJ0aW9ucygr
KSwgMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5oCmluZGV4IDMxNTAwZDNm
ZjY5ZC4uMDUwMjI5M2JkMGM5IDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaAorKysgYi9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaApAQCAtNzcsNiAr
NzcsNyBAQCBib29sIGt2bWlfZGVzY3JpcHRvcl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IHU4IGRlc2NyaXB0b3IsIGJvb2wgd3JpdGUpOwogYm9vbCBrdm1pX21zcl9ldmVudChzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIHN0cnVjdCBtc3JfZGF0YSAqbXNyKTsKIGJvb2wga3ZtaV9tb25pdG9y
X21zcndfaW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwgYm9vbCBlbmFi
bGUpOwogYm9vbCBrdm1pX21zcndfaW50ZXJjZXB0X29yaWdpbmF0b3Ioc3RydWN0IGt2bV92Y3B1
ICp2Y3B1KTsKK2Jvb2wga3ZtaV91cGRhdGVfYWRfZmxhZ3Moc3RydWN0IGt2bV92Y3B1ICp2Y3B1
KTsKIAogI2Vsc2UgLyogQ09ORklHX0tWTV9JTlRST1NQRUNUSU9OICovCiAKQEAgLTEwMiw2ICsx
MDMsNyBAQCBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9tb25pdG9yX21zcndfaW50ZXJjZXB0KHN0
cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwKIAkJCQkJICAgICAgIGJvb2wgZW5hYmxlKSB7
IHJldHVybiBmYWxzZTsgfQogc3RhdGljIGlubGluZSBib29sIGt2bWlfbXNyd19pbnRlcmNlcHRf
b3JpZ2luYXRvcihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCiAJCQkJeyByZXR1cm4gZmFsc2U7IH0K
K3N0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX3VwZGF0ZV9hZF9mbGFncyhzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUpIHsgcmV0dXJuIGZhbHNlOyB9CiAKICNlbmRpZiAvKiBDT05GSUdfS1ZNX0lOVFJPU1BF
Q1RJT04gKi8KIApkaWZmIC0tZ2l0IGEvYXJjaC94ODYva3ZtL2t2bWkuYyBiL2FyY2gveDg2L2t2
bS9rdm1pLmMKaW5kZXggYjAxMGQyMzY5NzU2Li42ZGM1ZGY1OWYyNzQgMTAwNjQ0Ci0tLSBhL2Fy
Y2gveDg2L2t2bS9rdm1pLmMKKysrIGIvYXJjaC94ODYva3ZtL2t2bWkuYwpAQCAtMTA5OSwzICsx
MDk5LDMzIEBAIHZvaWQga3ZtaV9hcmNoX3N0b3Bfc2luZ2xlc3RlcChzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUpCiB7CiAJa3ZtX3g4Nl9vcHMuY29udHJvbF9zaW5nbGVzdGVwKHZjcHUsIGZhbHNlKTsK
IH0KKworYm9vbCBrdm1pX3VwZGF0ZV9hZF9mbGFncyhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCit7
CisJc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pOworCWJvb2wgcmV0ID0gZmFsc2U7CisJ
Z3ZhX3QgZ3ZhOworCWdwYV90IGdwYTsKKworCWt2bWkgPSBrdm1pX2dldCh2Y3B1LT5rdm0pOwor
CWlmICgha3ZtaSkKKwkJcmV0dXJuIGZhbHNlOworCisJZ3ZhID0ga3ZtX3g4Nl9vcHMuZmF1bHRf
Z2xhKHZjcHUpOworCWlmIChndmEgPT0gfjB1bGwpCisJCWdvdG8gb3V0OworCisJZ3BhID0ga3Zt
X21tdV9ndmFfdG9fZ3BhX3N5c3RlbSh2Y3B1LCBndmEsIFBGRVJSX1dSSVRFX01BU0ssIE5VTEwp
OworCWlmIChncGEgPT0gVU5NQVBQRURfR1ZBKSB7CisJCXN0cnVjdCB4ODZfZXhjZXB0aW9uIGV4
Y2VwdGlvbiA9IHsgfTsKKworCQlncGEgPSBrdm1fbW11X2d2YV90b19ncGFfc3lzdGVtKHZjcHUs
IGd2YSwgMCwgJmV4Y2VwdGlvbik7CisJfQorCisJcmV0ID0gKGdwYSAhPSBVTk1BUFBFRF9HVkEp
OworCitvdXQ6CisJa3ZtaV9wdXQodmNwdS0+a3ZtKTsKKworCXJldHVybiByZXQ7Cit9CmRpZmYg
LS1naXQgYS9hcmNoL3g4Ni9rdm0vbW11L21tdS5jIGIvYXJjaC94ODYva3ZtL21tdS9tbXUuYwpp
bmRleCBmNzljZjU4YTI3ZGMuLjIwNGU0NGQ0ZTQ2NSAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3Zt
L21tdS9tbXUuYworKysgYi9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCkBAIC00Myw2ICs0Myw3IEBA
CiAjaW5jbHVkZSA8bGludXgvaGFzaC5oPgogI2luY2x1ZGUgPGxpbnV4L2tlcm5fbGV2ZWxzLmg+
CiAjaW5jbHVkZSA8bGludXgva3RocmVhZC5oPgorI2luY2x1ZGUgPGxpbnV4L2t2bWlfaG9zdC5o
PgogCiAjaW5jbHVkZSA8YXNtL3BhZ2UuaD4KICNpbmNsdWRlIDxhc20vbWVtdHlwZS5oPgpAQCAt
NTE4NCw4ICs1MTg1LDE1IEBAIGludCBrdm1fbW11X3BhZ2VfZmF1bHQoc3RydWN0IGt2bV92Y3B1
ICp2Y3B1LCBncGFfdCBjcjJfb3JfZ3BhLCB1NjQgZXJyb3JfY29kZSwKIAkgKi8KIAlpZiAodmNw
dS0+YXJjaC5tbXUtPmRpcmVjdF9tYXAgJiYKIAkgICAgKGVycm9yX2NvZGUgJiBQRkVSUl9ORVNU
RURfR1VFU1RfUEFHRSkgPT0gUEZFUlJfTkVTVEVEX0dVRVNUX1BBR0UpIHsKLQkJa3ZtX21tdV91
bnByb3RlY3RfcGFnZSh2Y3B1LT5rdm0sIGdwYV90b19nZm4oY3IyX29yX2dwYSkpOwotCQlyZXR1
cm4gMTsKKwkJZ2ZuX3QgZ2ZuID0gZ3BhX3RvX2dmbihjcjJfb3JfZ3BhKTsKKworCQlpZiAoa3Zt
aV90cmFja2VkX2dmbih2Y3B1LCBnZm4pKSB7CisJCQlpZiAoa3ZtaV91cGRhdGVfYWRfZmxhZ3Mo
dmNwdSkpCisJCQkJcmV0dXJuIDE7CisJCX0gZWxzZSB7CisJCQlrdm1fbW11X3VucHJvdGVjdF9w
YWdlKHZjcHUtPmt2bSwgZ2ZuKTsKKwkJCXJldHVybiAxOworCQl9CiAJfQogCiAJLyoKZGlmZiAt
LWdpdCBhL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmggYi9pbmNsdWRlL2xpbnV4L2t2bWlfaG9z
dC5oCmluZGV4IGVjMzhlNDM0YzhlOS4uOTA2NDdiYjJhNTcwIDEwMDY0NAotLS0gYS9pbmNsdWRl
L2xpbnV4L2t2bWlfaG9zdC5oCisrKyBiL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgKQEAgLTgz
LDYgKzgzLDcgQEAgYm9vbCBrdm1pX2JyZWFrcG9pbnRfZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2
Y3B1LCB1NjQgZ3ZhLCB1OCBpbnNuX2xlbik7CiBib29sIGt2bWlfdmNwdV9ydW5uaW5nX3Npbmds
ZXN0ZXAoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsKIHZvaWQga3ZtaV9zaW5nbGVzdGVwX2RvbmUo
c3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsKIHZvaWQga3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUpOworYm9vbCBrdm1pX3RyYWNrZWRfZ2ZuKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSwgZ2ZuX3QgZ2ZuKTsKIAogI2Vsc2UKIApAQCAtMTAxLDYgKzEwMiw4IEBAIHN0YXRp
YyBpbmxpbmUgYm9vbCBrdm1pX3ZjcHVfcnVubmluZ19zaW5nbGVzdGVwKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSkKIAkJCXsgcmV0dXJuIGZhbHNlOyB9CiBzdGF0aWMgaW5saW5lIHZvaWQga3ZtaV9z
aW5nbGVzdGVwX2RvbmUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KSB7IH0KIHN0YXRpYyBpbmxpbmUg
dm9pZCBrdm1pX3NpbmdsZXN0ZXBfZmFpbGVkKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkgeyB9Citz
dGF0aWMgaW5saW5lIGJvb2wga3ZtaV90cmFja2VkX2dmbihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IGdmbl90IGdmbikKKwkJCXsgcmV0dXJuIGZhbHNlOyB9CiAKICNlbmRpZiAvKiBDT05GSUdfS1ZN
X0lOVFJPU1BFQ1RJT04gKi8KIApkaWZmIC0tZ2l0IGEvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9r
dm1pLmMgYi92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYwppbmRleCA0ZjlkYTc2YzY3Nzcu
LjA0NzRkODViNTRhNCAxMDA2NDQKLS0tIGEvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMK
KysrIGIvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMKQEAgLTEyMzYsMyArMTIzNiwyOSBA
QCB2b2lkIGt2bWlfc2luZ2xlc3RlcF9mYWlsZWQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogCWt2
bWlfaGFuZGxlX3NpbmdsZXN0ZXBfZXhpdCh2Y3B1LCBmYWxzZSk7CiB9CiBFWFBPUlRfU1lNQk9M
KGt2bWlfc2luZ2xlc3RlcF9mYWlsZWQpOworCitzdGF0aWMgYm9vbCBfX2t2bWlfdHJhY2tlZF9n
Zm4oc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pLCBnZm5fdCBnZm4pCit7CisJdTggaWdu
b3JlZF9hY2Nlc3M7CisKKwlpZiAoa3ZtaV9nZXRfZ2ZuX2FjY2Vzcyhrdm1pLCBnZm4sICZpZ25v
cmVkX2FjY2VzcykpCisJCXJldHVybiBmYWxzZTsKKworCXJldHVybiB0cnVlOworfQorCitib29s
IGt2bWlfdHJhY2tlZF9nZm4oc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBnZm5fdCBnZm4pCit7CisJ
c3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pOworCWJvb2wgcmV0OworCisJa3ZtaSA9IGt2
bWlfZ2V0KHZjcHUtPmt2bSk7CisJaWYgKCFrdm1pKQorCQlyZXR1cm4gZmFsc2U7CisKKwlyZXQg
PSBfX2t2bWlfdHJhY2tlZF9nZm4oa3ZtaSwgZ2ZuKTsKKworCWt2bWlfcHV0KHZjcHUtPmt2bSk7
CisKKwlyZXR1cm4gcmV0OworfQpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fXwpWaXJ0dWFsaXphdGlvbiBtYWlsaW5nIGxpc3QKVmlydHVhbGl6YXRpb25AbGlz
dHMubGludXgtZm91bmRhdGlvbi5vcmcKaHR0cHM6Ly9saXN0cy5saW51eGZvdW5kYXRpb24ub3Jn
L21haWxtYW4vbGlzdGluZm8vdmlydHVhbGl6YXRpb24=
