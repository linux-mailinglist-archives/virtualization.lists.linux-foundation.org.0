Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
	by mail.lfdr.de (Postfix) with ESMTPS id 662F71F66BA
	for <lists.virtualization@lfdr.de>; Thu, 11 Jun 2020 13:34:29 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by whitealder.osuosl.org (Postfix) with ESMTP id 18DEB886F8;
	Thu, 11 Jun 2020 11:34:28 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id z69OogG+JxPI; Thu, 11 Jun 2020 11:34:26 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by whitealder.osuosl.org (Postfix) with ESMTP id 85D8F8869D;
	Thu, 11 Jun 2020 11:34:26 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 5E977C016F;
	Thu, 11 Jun 2020 11:34:26 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 30305C016F
 for <virtualization@lists.linux-foundation.org>;
 Thu, 11 Jun 2020 11:34:25 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by hemlock.osuosl.org (Postfix) with ESMTP id 1F15F895C1
 for <virtualization@lists.linux-foundation.org>;
 Thu, 11 Jun 2020 11:34:25 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id DaVevrlDhHWk
 for <virtualization@lists.linux-foundation.org>;
 Thu, 11 Jun 2020 11:34:24 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from us-smtp-1.mimecast.com (us-smtp-delivery-1.mimecast.com
 [205.139.110.120])
 by hemlock.osuosl.org (Postfix) with ESMTPS id D8D48895BA
 for <virtualization@lists.linux-foundation.org>;
 Thu, 11 Jun 2020 11:34:23 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
 s=mimecast20190719; t=1591875262;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=wjgEeFu3a+LIiqg+5XiliZ73/V0mxb4sydm2yHd7x/A=;
 b=II04Nj5zN8r7GmDe6yjU2bMDck1uuPXOicr4x31xmmiwAZ1XnpNko3g7OGTX2Bi+bhjLAv
 MioVrJOW+pEJeR5bAq1PM5vbUuwSKpaAOHOeIFzwCilvFbDjOgcy0eZQzeyT0h4gbe4enD
 uFDsDQbsfGL2xeg3FF8pjfx0pmYWiHo=
Received: from mail-wm1-f69.google.com (mail-wm1-f69.google.com
 [209.85.128.69]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-318-mnK4z4HQOjqhIoKR82DBzw-1; Thu, 11 Jun 2020 07:34:21 -0400
X-MC-Unique: mnK4z4HQOjqhIoKR82DBzw-1
Received: by mail-wm1-f69.google.com with SMTP id r1so1234772wmh.7
 for <virtualization@lists.linux-foundation.org>;
 Thu, 11 Jun 2020 04:34:20 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:date:from:to:cc:subject:message-id:references
 :mime-version:content-disposition:content-transfer-encoding
 :in-reply-to;
 bh=wjgEeFu3a+LIiqg+5XiliZ73/V0mxb4sydm2yHd7x/A=;
 b=ikMSCUfeP53IQgcSaCiZtjQjNuJfbe1yDMrazqGaaA491o0I/eQnvYo1FpClI0qin4
 /4Pq4g1fpMWbTBEn7P6po6EjwNT+IhTgu5dSzAGdjB6EhX6ynhR+mXd+eJSl746/9RWa
 JGiZTH4KAuugcM7JF6WAqLP4xIMqPv0bsfYav5x7QwqQUoZRVqDNLba0z99+fqby+URm
 tZfpbALOxgPC/bJVZy+m02hUKqYYbrBsHGu65gN5/RgLo2HWpJzlo+11vSFL0fk9vxiH
 Nozt2k6NSQNTw13WO5RYeVmS4iGfGQRaWomINw7tUjRzjOdWZwsoylBpMSz3zN52JA/B
 s2Gw==
X-Gm-Message-State: AOAM531XaZpWS5u6szXjg/uXJ0ZF6RhTqDwLXXhhwt8wdLbu57o2hkUO
 r+HLaqhAPu0fXguLMoX2/z18JqzxHBHUMUOuTA1JtKoAFnYM0RQBA3d5J4O5oW2cvm+GiRnqkVR
 IMx2YnfExVSthKmVzYHF2TV27rHFX9nG4S85iZV1HpQ==
X-Received: by 2002:a1c:a1c5:: with SMTP id k188mr8099521wme.41.1591875259340; 
 Thu, 11 Jun 2020 04:34:19 -0700 (PDT)
X-Google-Smtp-Source: ABdhPJxJjTP+Jltfvil3r7Eu5Xs33+bjgt+vVMAo54RDN03ftXfSQjwjTV1cnO4g7LuNMX5q4+LB7g==
X-Received: by 2002:a1c:a1c5:: with SMTP id k188mr8099486wme.41.1591875258829; 
 Thu, 11 Jun 2020 04:34:18 -0700 (PDT)
Received: from redhat.com (bzq-79-181-55-232.red.bezeqint.net. [79.181.55.232])
 by smtp.gmail.com with ESMTPSA id f71sm3316834wmf.22.2020.06.11.04.34.17
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Thu, 11 Jun 2020 04:34:18 -0700 (PDT)
Date: Thu, 11 Jun 2020 07:34:16 -0400
From: "Michael S. Tsirkin" <mst@redhat.com>
To: linux-kernel@vger.kernel.org
Subject: [PATCH RFC v8 01/11] vhost: option to fetch descriptors through an
 independent struct
Message-ID: <20200611113404.17810-2-mst@redhat.com>
References: <20200611113404.17810-1-mst@redhat.com>
MIME-Version: 1.0
In-Reply-To: <20200611113404.17810-1-mst@redhat.com>
X-Mailer: git-send-email 2.27.0.106.g8ac3dc51b1
X-Mutt-Fcc: =sent
X-Mimecast-Spam-Score: 0
X-Mimecast-Originator: redhat.com
Content-Disposition: inline
Cc: netdev@vger.kernel.org, eperezma@redhat.com, kvm@vger.kernel.org,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

VGhlIGlkZWEgaXMgdG8gc3VwcG9ydCBtdWx0aXBsZSByaW5nIGZvcm1hdHMgYnkgY29udmVydGlu
Zwp0byBhIGZvcm1hdC1pbmRlcGVuZGVudCBhcnJheSBvZiBkZXNjcmlwdG9ycy4KClRoaXMgY29z
dHMgZXh0cmEgY3ljbGVzLCBidXQgd2UgZ2FpbiBpbiBhYmlsaXR5CnRvIGZldGNoIGEgYmF0Y2gg
b2YgZGVzY3JpcHRvcnMgaW4gb25lIGdvLCB3aGljaAppcyBnb29kIGZvciBjb2RlIGNhY2hlIGxv
Y2FsaXR5LgoKV2hlbiB1c2VkLCB0aGlzIGNhdXNlcyBhIG1pbm9yIHBlcmZvcm1hbmNlIGRlZ3Jh
ZGF0aW9uLAppdCdzIGJlZW4ga2VwdCBhcyBzaW1wbGUgYXMgcG9zc2libGUgZm9yIGVhc2Ugb2Yg
cmV2aWV3LgpBIGZvbGxvdy11cCBwYXRjaCBnZXRzIHVzIGJhY2sgdGhlIHBlcmZvcm1hbmNlIGJ5
IGFkZGluZyBiYXRjaGluZy4KClRvIHNpbXBsaWZ5IGJlbmNobWFya2luZywgSSBrZXB0IHRoZSBv
bGQgY29kZSBhcm91bmQgc28gb25lIGNhbiBzd2l0Y2gKYmFjayBhbmQgZm9ydGggYmV0d2VlbiBv
bGQgYW5kIG5ldyBjb2RlLiBUaGlzIHdpbGwgZ28gYXdheSBpbiB0aGUgZmluYWwKc3VibWlzc2lv
bi4KClNpZ25lZC1vZmYtYnk6IE1pY2hhZWwgUy4gVHNpcmtpbiA8bXN0QHJlZGhhdC5jb20+ClNp
Z25lZC1vZmYtYnk6IEV1Z2VuaW8gUMOpcmV6IDxlcGVyZXptYUByZWRoYXQuY29tPgpMaW5rOiBo
dHRwczovL2xvcmUua2VybmVsLm9yZy9yLzIwMjAwNDAxMTgzMTE4LjgzMzQtMi1lcGVyZXptYUBy
ZWRoYXQuY29tClNpZ25lZC1vZmYtYnk6IE1pY2hhZWwgUy4gVHNpcmtpbiA8bXN0QHJlZGhhdC5j
b20+Ci0tLQogZHJpdmVycy92aG9zdC92aG9zdC5jIHwgMzA1ICsrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrLQogZHJpdmVycy92aG9zdC92aG9zdC5oIHwgIDE2ICsrKwog
MiBmaWxlcyBjaGFuZ2VkLCAzMjAgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlvbigtKQoKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYyBiL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYwppbmRl
eCAxNzJkYTA5MjEwN2UuLjExNDMzZDcwOTY1MSAxMDA2NDQKLS0tIGEvZHJpdmVycy92aG9zdC92
aG9zdC5jCisrKyBiL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYwpAQCAtMzAzLDYgKzMwMyw3IEBAIHN0
YXRpYyB2b2lkIHZob3N0X3ZxX3Jlc2V0KHN0cnVjdCB2aG9zdF9kZXYgKmRldiwKIAkJCSAgIHN0
cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxKQogewogCXZxLT5udW0gPSAxOworCXZxLT5uZGVzY3Mg
PSAwOwogCXZxLT5kZXNjID0gTlVMTDsKIAl2cS0+YXZhaWwgPSBOVUxMOwogCXZxLT51c2VkID0g
TlVMTDsKQEAgLTM3Myw2ICszNzQsOSBAQCBzdGF0aWMgaW50IHZob3N0X3dvcmtlcih2b2lkICpk
YXRhKQogCiBzdGF0aWMgdm9pZCB2aG9zdF92cV9mcmVlX2lvdmVjcyhzdHJ1Y3Qgdmhvc3Rfdmly
dHF1ZXVlICp2cSkKIHsKKwlrZnJlZSh2cS0+ZGVzY3MpOworCXZxLT5kZXNjcyA9IE5VTEw7CisJ
dnEtPm1heF9kZXNjcyA9IDA7CiAJa2ZyZWUodnEtPmluZGlyZWN0KTsKIAl2cS0+aW5kaXJlY3Qg
PSBOVUxMOwogCWtmcmVlKHZxLT5sb2cpOwpAQCAtMzg5LDYgKzM5MywxMCBAQCBzdGF0aWMgbG9u
ZyB2aG9zdF9kZXZfYWxsb2NfaW92ZWNzKHN0cnVjdCB2aG9zdF9kZXYgKmRldikKIAogCWZvciAo
aSA9IDA7IGkgPCBkZXYtPm52cXM7ICsraSkgewogCQl2cSA9IGRldi0+dnFzW2ldOworCQl2cS0+
bWF4X2Rlc2NzID0gZGV2LT5pb3ZfbGltaXQ7CisJCXZxLT5kZXNjcyA9IGttYWxsb2NfYXJyYXko
dnEtPm1heF9kZXNjcywKKwkJCQkJICBzaXplb2YoKnZxLT5kZXNjcyksCisJCQkJCSAgR0ZQX0tF
Uk5FTCk7CiAJCXZxLT5pbmRpcmVjdCA9IGttYWxsb2NfYXJyYXkoVUlPX01BWElPViwKIAkJCQkJ
ICAgICBzaXplb2YoKnZxLT5pbmRpcmVjdCksCiAJCQkJCSAgICAgR0ZQX0tFUk5FTCk7CkBAIC0z
OTYsNyArNDA0LDcgQEAgc3RhdGljIGxvbmcgdmhvc3RfZGV2X2FsbG9jX2lvdmVjcyhzdHJ1Y3Qg
dmhvc3RfZGV2ICpkZXYpCiAJCQkJCUdGUF9LRVJORUwpOwogCQl2cS0+aGVhZHMgPSBrbWFsbG9j
X2FycmF5KGRldi0+aW92X2xpbWl0LCBzaXplb2YoKnZxLT5oZWFkcyksCiAJCQkJCSAgR0ZQX0tF
Uk5FTCk7Ci0JCWlmICghdnEtPmluZGlyZWN0IHx8ICF2cS0+bG9nIHx8ICF2cS0+aGVhZHMpCisJ
CWlmICghdnEtPmluZGlyZWN0IHx8ICF2cS0+bG9nIHx8ICF2cS0+aGVhZHMgfHwgIXZxLT5kZXNj
cykKIAkJCWdvdG8gZXJyX25vbWVtOwogCX0KIAlyZXR1cm4gMDsKQEAgLTQ4OCw2ICs0OTYsOCBA
QCB2b2lkIHZob3N0X2Rldl9pbml0KHN0cnVjdCB2aG9zdF9kZXYgKmRldiwKIAogCWZvciAoaSA9
IDA7IGkgPCBkZXYtPm52cXM7ICsraSkgewogCQl2cSA9IGRldi0+dnFzW2ldOworCQl2cS0+ZGVz
Y3MgPSBOVUxMOworCQl2cS0+bWF4X2Rlc2NzID0gMDsKIAkJdnEtPmxvZyA9IE5VTEw7CiAJCXZx
LT5pbmRpcmVjdCA9IE5VTEw7CiAJCXZxLT5oZWFkcyA9IE5VTEw7CkBAIC0yMzE1LDYgKzIzMjUs
Mjk5IEBAIGludCB2aG9zdF9nZXRfdnFfZGVzYyhzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICp2cSwK
IH0KIEVYUE9SVF9TWU1CT0xfR1BMKHZob3N0X2dldF92cV9kZXNjKTsKIAorc3RhdGljIHN0cnVj
dCB2aG9zdF9kZXNjICpwZWVrX3NwbGl0X2Rlc2Moc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnEp
Cit7CisJQlVHX09OKCF2cS0+bmRlc2NzKTsKKwlyZXR1cm4gJnZxLT5kZXNjc1t2cS0+bmRlc2Nz
IC0gMV07Cit9CisKK3N0YXRpYyB2b2lkIHBvcF9zcGxpdF9kZXNjKHN0cnVjdCB2aG9zdF92aXJ0
cXVldWUgKnZxKQoreworCUJVR19PTighdnEtPm5kZXNjcyk7CisJLS12cS0+bmRlc2NzOworfQor
CisjZGVmaW5lIFZIT1NUX0RFU0NfRkxBR1MgKFZSSU5HX0RFU0NfRl9JTkRJUkVDVCB8IFZSSU5H
X0RFU0NfRl9XUklURSB8IFwKKwkJCSAgVlJJTkdfREVTQ19GX05FWFQpCitzdGF0aWMgaW50IHB1
c2hfc3BsaXRfZGVzYyhzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICp2cSwgc3RydWN0IHZyaW5nX2Rl
c2MgKmRlc2MsIHUxNiBpZCkKK3sKKwlzdHJ1Y3Qgdmhvc3RfZGVzYyAqaDsKKworCWlmICh1bmxp
a2VseSh2cS0+bmRlc2NzID49IHZxLT5tYXhfZGVzY3MpKQorCQlyZXR1cm4gLUVJTlZBTDsKKwlo
ID0gJnZxLT5kZXNjc1t2cS0+bmRlc2NzKytdOworCWgtPmFkZHIgPSB2aG9zdDY0X3RvX2NwdSh2
cSwgZGVzYy0+YWRkcik7CisJaC0+bGVuID0gdmhvc3QzMl90b19jcHUodnEsIGRlc2MtPmxlbik7
CisJaC0+ZmxhZ3MgPSB2aG9zdDE2X3RvX2NwdSh2cSwgZGVzYy0+ZmxhZ3MpICYgVkhPU1RfREVT
Q19GTEFHUzsKKwloLT5pZCA9IGlkOworCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBpbnQgZmV0
Y2hfaW5kaXJlY3RfZGVzY3Moc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnEsCisJCQkJc3RydWN0
IHZob3N0X2Rlc2MgKmluZGlyZWN0LAorCQkJCXUxNiBoZWFkKQoreworCXN0cnVjdCB2cmluZ19k
ZXNjIGRlc2M7CisJdW5zaWduZWQgaW50IGkgPSAwLCBjb3VudCwgZm91bmQgPSAwOworCXUzMiBs
ZW4gPSBpbmRpcmVjdC0+bGVuOworCXN0cnVjdCBpb3ZfaXRlciBmcm9tOworCWludCByZXQ7CisK
KwkvKiBTYW5pdHkgY2hlY2sgKi8KKwlpZiAodW5saWtlbHkobGVuICUgc2l6ZW9mIGRlc2MpKSB7
CisJCXZxX2Vycih2cSwgIkludmFsaWQgbGVuZ3RoIGluIGluZGlyZWN0IGRlc2NyaXB0b3I6ICIK
KwkJICAgICAgICJsZW4gMHglbGx4IG5vdCBtdWx0aXBsZSBvZiAweCV6eFxuIiwKKwkJICAgICAg
ICh1bnNpZ25lZCBsb25nIGxvbmcpbGVuLAorCQkgICAgICAgc2l6ZW9mIGRlc2MpOworCQlyZXR1
cm4gLUVJTlZBTDsKKwl9CisKKwlyZXQgPSB0cmFuc2xhdGVfZGVzYyh2cSwgaW5kaXJlY3QtPmFk
ZHIsIGxlbiwgdnEtPmluZGlyZWN0LAorCQkJICAgICBVSU9fTUFYSU9WLCBWSE9TVF9BQ0NFU1Nf
Uk8pOworCWlmICh1bmxpa2VseShyZXQgPCAwKSkgeworCQlpZiAocmV0ICE9IC1FQUdBSU4pCisJ
CQl2cV9lcnIodnEsICJUcmFuc2xhdGlvbiBmYWlsdXJlICVkIGluIGluZGlyZWN0LlxuIiwgcmV0
KTsKKwkJcmV0dXJuIHJldDsKKwl9CisJaW92X2l0ZXJfaW5pdCgmZnJvbSwgUkVBRCwgdnEtPmlu
ZGlyZWN0LCByZXQsIGxlbik7CisKKwkvKiBXZSB3aWxsIHVzZSB0aGUgcmVzdWx0IGFzIGFuIGFk
ZHJlc3MgdG8gcmVhZCBmcm9tLCBzbyBtb3N0CisJICogYXJjaGl0ZWN0dXJlcyBvbmx5IG5lZWQg
YSBjb21waWxlciBiYXJyaWVyIGhlcmUuICovCisJcmVhZF9iYXJyaWVyX2RlcGVuZHMoKTsKKwor
CWNvdW50ID0gbGVuIC8gc2l6ZW9mIGRlc2M7CisJLyogQnVmZmVycyBhcmUgY2hhaW5lZCB2aWEg
YSAxNiBiaXQgbmV4dCBmaWVsZCwgc28KKwkgKiB3ZSBjYW4gaGF2ZSBhdCBtb3N0IDJeMTYgb2Yg
dGhlc2UuICovCisJaWYgKHVubGlrZWx5KGNvdW50ID4gVVNIUlRfTUFYICsgMSkpIHsKKwkJdnFf
ZXJyKHZxLCAiSW5kaXJlY3QgYnVmZmVyIGxlbmd0aCB0b28gYmlnOiAlZFxuIiwKKwkJICAgICAg
IGluZGlyZWN0LT5sZW4pOworCQlyZXR1cm4gLUUyQklHOworCX0KKwlpZiAodW5saWtlbHkodnEt
Pm5kZXNjcyArIGNvdW50ID4gdnEtPm1heF9kZXNjcykpIHsKKwkJdnFfZXJyKHZxLCAiVG9vIG1h
bnkgaW5kaXJlY3QgKyBkaXJlY3QgZGVzY3M6ICVkICsgJWRcbiIsCisJCSAgICAgICB2cS0+bmRl
c2NzLCBpbmRpcmVjdC0+bGVuKTsKKwkJcmV0dXJuIC1FMkJJRzsKKwl9CisKKwlkbyB7CisJCWlm
ICh1bmxpa2VseSgrK2ZvdW5kID4gY291bnQpKSB7CisJCQl2cV9lcnIodnEsICJMb29wIGRldGVj
dGVkOiBsYXN0IG9uZSBhdCAldSAiCisJCQkgICAgICAgImluZGlyZWN0IHNpemUgJXVcbiIsCisJ
CQkgICAgICAgaSwgY291bnQpOworCQkJcmV0dXJuIC1FSU5WQUw7CisJCX0KKwkJaWYgKHVubGlr
ZWx5KCFjb3B5X2Zyb21faXRlcl9mdWxsKCZkZXNjLCBzaXplb2YoZGVzYyksICZmcm9tKSkpIHsK
KwkJCXZxX2Vycih2cSwgIkZhaWxlZCBpbmRpcmVjdCBkZXNjcmlwdG9yOiBpZHggJWQsICV6eFxu
IiwKKwkJCSAgICAgICBpLCAoc2l6ZV90KWluZGlyZWN0LT5hZGRyICsgaSAqIHNpemVvZiBkZXNj
KTsKKwkJCXJldHVybiAtRUlOVkFMOworCQl9CisJCWlmICh1bmxpa2VseShkZXNjLmZsYWdzICYg
Y3B1X3RvX3Zob3N0MTYodnEsIFZSSU5HX0RFU0NfRl9JTkRJUkVDVCkpKSB7CisJCQl2cV9lcnIo
dnEsICJOZXN0ZWQgaW5kaXJlY3QgZGVzY3JpcHRvcjogaWR4ICVkLCAlenhcbiIsCisJCQkgICAg
ICAgaSwgKHNpemVfdClpbmRpcmVjdC0+YWRkciArIGkgKiBzaXplb2YgZGVzYyk7CisJCQlyZXR1
cm4gLUVJTlZBTDsKKwkJfQorCisJCS8qIE5vdGU6IHB1c2hfc3BsaXRfZGVzYyBjYW4ndCBmYWls
IGhlcmU6CisJCSAqIHdlIG5ldmVyIGZldGNoIHVubGVzcyB0aGVyZSdzIHNwYWNlLiAqLworCQly
ZXQgPSBwdXNoX3NwbGl0X2Rlc2ModnEsICZkZXNjLCBoZWFkKTsKKwkJV0FSTl9PTihyZXQpOwor
CX0gd2hpbGUgKChpID0gbmV4dF9kZXNjKHZxLCAmZGVzYykpICE9IC0xKTsKKwlyZXR1cm4gMDsK
K30KKworLyogVGhpcyBmdW5jdGlvbiByZXR1cm5zIGEgdmFsdWUgPiAwIGlmIGEgZGVzY3JpcHRv
ciB3YXMgZm91bmQsIG9yIDAgaWYgbm9uZSB3ZXJlIGZvdW5kLgorICogQSBuZWdhdGl2ZSBjb2Rl
IGlzIHJldHVybmVkIG9uIGVycm9yLiAqLworc3RhdGljIGludCBmZXRjaF9kZXNjcyhzdHJ1Y3Qg
dmhvc3RfdmlydHF1ZXVlICp2cSkKK3sKKwl1bnNpZ25lZCBpbnQgaSwgaGVhZCwgZm91bmQgPSAw
OworCXN0cnVjdCB2aG9zdF9kZXNjICpsYXN0OworCXN0cnVjdCB2cmluZ19kZXNjIGRlc2M7CisJ
X192aXJ0aW8xNiBhdmFpbF9pZHg7CisJX192aXJ0aW8xNiByaW5nX2hlYWQ7CisJdTE2IGxhc3Rf
YXZhaWxfaWR4OworCWludCByZXQ7CisKKwkvKiBDaGVjayBpdCBpc24ndCBkb2luZyB2ZXJ5IHN0
cmFuZ2UgdGhpbmdzIHdpdGggZGVzY3JpcHRvciBudW1iZXJzLiAqLworCWxhc3RfYXZhaWxfaWR4
ID0gdnEtPmxhc3RfYXZhaWxfaWR4OworCisJaWYgKHZxLT5hdmFpbF9pZHggPT0gdnEtPmxhc3Rf
YXZhaWxfaWR4KSB7CisJCWlmICh1bmxpa2VseSh2aG9zdF9nZXRfYXZhaWxfaWR4KHZxLCAmYXZh
aWxfaWR4KSkpIHsKKwkJCXZxX2Vycih2cSwgIkZhaWxlZCB0byBhY2Nlc3MgYXZhaWwgaWR4IGF0
ICVwXG4iLAorCQkJCSZ2cS0+YXZhaWwtPmlkeCk7CisJCQlyZXR1cm4gLUVGQVVMVDsKKwkJfQor
CQl2cS0+YXZhaWxfaWR4ID0gdmhvc3QxNl90b19jcHUodnEsIGF2YWlsX2lkeCk7CisKKwkJaWYg
KHVubGlrZWx5KCh1MTYpKHZxLT5hdmFpbF9pZHggLSBsYXN0X2F2YWlsX2lkeCkgPiB2cS0+bnVt
KSkgeworCQkJdnFfZXJyKHZxLCAiR3Vlc3QgbW92ZWQgdXNlZCBpbmRleCBmcm9tICV1IHRvICV1
IiwKKwkJCQlsYXN0X2F2YWlsX2lkeCwgdnEtPmF2YWlsX2lkeCk7CisJCQlyZXR1cm4gLUVGQVVM
VDsKKwkJfQorCisJCS8qIElmIHRoZXJlJ3Mgbm90aGluZyBuZXcgc2luY2UgbGFzdCB3ZSBsb29r
ZWQsIHJldHVybgorCQkgKiBpbnZhbGlkLgorCQkgKi8KKwkJaWYgKHZxLT5hdmFpbF9pZHggPT0g
bGFzdF9hdmFpbF9pZHgpCisJCQlyZXR1cm4gMDsKKworCQkvKiBPbmx5IGdldCBhdmFpbCByaW5n
IGVudHJpZXMgYWZ0ZXIgdGhleSBoYXZlIGJlZW4KKwkJICogZXhwb3NlZCBieSBndWVzdC4KKwkJ
ICovCisJCXNtcF9ybWIoKTsKKwl9CisKKwkvKiBHcmFiIHRoZSBuZXh0IGRlc2NyaXB0b3IgbnVt
YmVyIHRoZXkncmUgYWR2ZXJ0aXNpbmcgKi8KKwlpZiAodW5saWtlbHkodmhvc3RfZ2V0X2F2YWls
X2hlYWQodnEsICZyaW5nX2hlYWQsIGxhc3RfYXZhaWxfaWR4KSkpIHsKKwkJdnFfZXJyKHZxLCAi
RmFpbGVkIHRvIHJlYWQgaGVhZDogaWR4ICVkIGFkZHJlc3MgJXBcbiIsCisJCSAgICAgICBsYXN0
X2F2YWlsX2lkeCwKKwkJICAgICAgICZ2cS0+YXZhaWwtPnJpbmdbbGFzdF9hdmFpbF9pZHggJSB2
cS0+bnVtXSk7CisJCXJldHVybiAtRUZBVUxUOworCX0KKworCWhlYWQgPSB2aG9zdDE2X3RvX2Nw
dSh2cSwgcmluZ19oZWFkKTsKKworCS8qIElmIHRoZWlyIG51bWJlciBpcyBzaWxseSwgdGhhdCdz
IGFuIGVycm9yLiAqLworCWlmICh1bmxpa2VseShoZWFkID49IHZxLT5udW0pKSB7CisJCXZxX2Vy
cih2cSwgIkd1ZXN0IHNheXMgaW5kZXggJXUgPiAldSBpcyBhdmFpbGFibGUiLAorCQkgICAgICAg
aGVhZCwgdnEtPm51bSk7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCWkgPSBoZWFkOworCWRv
IHsKKwkJaWYgKHVubGlrZWx5KGkgPj0gdnEtPm51bSkpIHsKKwkJCXZxX2Vycih2cSwgIkRlc2Mg
aW5kZXggaXMgJXUgPiAldSwgaGVhZCA9ICV1IiwKKwkJCSAgICAgICBpLCB2cS0+bnVtLCBoZWFk
KTsKKwkJCXJldHVybiAtRUlOVkFMOworCQl9CisJCWlmICh1bmxpa2VseSgrK2ZvdW5kID4gdnEt
Pm51bSkpIHsKKwkJCXZxX2Vycih2cSwgIkxvb3AgZGV0ZWN0ZWQ6IGxhc3Qgb25lIGF0ICV1ICIK
KwkJCSAgICAgICAidnEgc2l6ZSAldSBoZWFkICV1XG4iLAorCQkJICAgICAgIGksIHZxLT5udW0s
IGhlYWQpOworCQkJcmV0dXJuIC1FSU5WQUw7CisJCX0KKwkJcmV0ID0gdmhvc3RfZ2V0X2Rlc2Mo
dnEsICZkZXNjLCBpKTsKKwkJaWYgKHVubGlrZWx5KHJldCkpIHsKKwkJCXZxX2Vycih2cSwgIkZh
aWxlZCB0byBnZXQgZGVzY3JpcHRvcjogaWR4ICVkIGFkZHIgJXBcbiIsCisJCQkgICAgICAgaSwg
dnEtPmRlc2MgKyBpKTsKKwkJCXJldHVybiAtRUZBVUxUOworCQl9CisJCXJldCA9IHB1c2hfc3Bs
aXRfZGVzYyh2cSwgJmRlc2MsIGhlYWQpOworCQlpZiAodW5saWtlbHkocmV0KSkgeworCQkJdnFf
ZXJyKHZxLCAiRmFpbGVkIHRvIHNhdmUgZGVzY3JpcHRvcjogaWR4ICVkXG4iLCBpKTsKKwkJCXJl
dHVybiAtRUlOVkFMOworCQl9CisJfSB3aGlsZSAoKGkgPSBuZXh0X2Rlc2ModnEsICZkZXNjKSkg
IT0gLTEpOworCisJbGFzdCA9IHBlZWtfc3BsaXRfZGVzYyh2cSk7CisJaWYgKHVubGlrZWx5KGxh
c3QtPmZsYWdzICYgVlJJTkdfREVTQ19GX0lORElSRUNUKSkgeworCQlwb3Bfc3BsaXRfZGVzYyh2
cSk7CisJCXJldCA9IGZldGNoX2luZGlyZWN0X2Rlc2NzKHZxLCBsYXN0LCBoZWFkKTsKKwkJaWYg
KHVubGlrZWx5KHJldCA8IDApKSB7CisJCQlpZiAocmV0ICE9IC1FQUdBSU4pCisJCQkJdnFfZXJy
KHZxLCAiRmFpbHVyZSBkZXRlY3RlZCAiCisJCQkJICAgICAgICJpbiBpbmRpcmVjdCBkZXNjcmlw
dG9yIGF0IGlkeCAlZFxuIiwgaGVhZCk7CisJCQlyZXR1cm4gcmV0OworCQl9CisJfQorCisJLyog
QXNzdW1lIG5vdGlmaWNhdGlvbnMgZnJvbSBndWVzdCBhcmUgZGlzYWJsZWQgYXQgdGhpcyBwb2lu
dCwKKwkgKiBpZiB0aGV5IGFyZW4ndCB3ZSB3b3VsZCBuZWVkIHRvIHVwZGF0ZSBhdmFpbF9ldmVu
dCBpbmRleC4gKi8KKwlCVUdfT04oISh2cS0+dXNlZF9mbGFncyAmIFZSSU5HX1VTRURfRl9OT19O
T1RJRlkpKTsKKworCS8qIE9uIHN1Y2Nlc3MsIGluY3JlbWVudCBhdmFpbCBpbmRleC4gKi8KKwl2
cS0+bGFzdF9hdmFpbF9pZHgrKzsKKworCXJldHVybiAxOworfQorCisvKiBUaGlzIGxvb2tzIGlu
IHRoZSB2aXJ0cXVldWUgYW5kIGZvciB0aGUgZmlyc3QgYXZhaWxhYmxlIGJ1ZmZlciwgYW5kIGNv
bnZlcnRzCisgKiBpdCB0byBhbiBpb3ZlYyBmb3IgY29udmVuaWVudCBhY2Nlc3MuICBTaW5jZSBk
ZXNjcmlwdG9ycyBjb25zaXN0IG9mIHNvbWUKKyAqIG51bWJlciBvZiBvdXRwdXQgdGhlbiBzb21l
IG51bWJlciBvZiBpbnB1dCBkZXNjcmlwdG9ycywgaXQncyBhY3R1YWxseSB0d28KKyAqIGlvdmVj
cywgYnV0IHdlIHBhY2sgdGhlbSBpbnRvIG9uZSBhbmQgbm90ZSBob3cgbWFueSBvZiBlYWNoIHRo
ZXJlIHdlcmUuCisgKgorICogVGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBkZXNjcmlwdG9yIG51
bWJlciBmb3VuZCwgb3IgdnEtPm51bSAod2hpY2ggaXMKKyAqIG5ldmVyIGEgdmFsaWQgZGVzY3Jp
cHRvciBudW1iZXIpIGlmIG5vbmUgd2FzIGZvdW5kLiAgQSBuZWdhdGl2ZSBjb2RlIGlzCisgKiBy
ZXR1cm5lZCBvbiBlcnJvci4gKi8KK2ludCB2aG9zdF9nZXRfdnFfZGVzY19iYXRjaChzdHJ1Y3Qg
dmhvc3RfdmlydHF1ZXVlICp2cSwKKwkJICAgICAgc3RydWN0IGlvdmVjIGlvdltdLCB1bnNpZ25l
ZCBpbnQgaW92X3NpemUsCisJCSAgICAgIHVuc2lnbmVkIGludCAqb3V0X251bSwgdW5zaWduZWQg
aW50ICppbl9udW0sCisJCSAgICAgIHN0cnVjdCB2aG9zdF9sb2cgKmxvZywgdW5zaWduZWQgaW50
ICpsb2dfbnVtKQoreworCWludCByZXQgPSBmZXRjaF9kZXNjcyh2cSk7CisJaW50IGk7CisKKwlp
ZiAocmV0IDw9IDApCisJCWdvdG8gZXJyX2ZldGNoOworCisJLyogTm93IGNvbnZlcnQgdG8gSU9W
ICovCisJLyogV2hlbiB3ZSBzdGFydCB0aGVyZSBhcmUgbm9uZSBvZiBlaXRoZXIgaW5wdXQgbm9y
IG91dHB1dC4gKi8KKwkqb3V0X251bSA9ICppbl9udW0gPSAwOworCWlmICh1bmxpa2VseShsb2cp
KQorCQkqbG9nX251bSA9IDA7CisKKwlmb3IgKGkgPSAwOyBpIDwgdnEtPm5kZXNjczsgKytpKSB7
CisJCXVuc2lnbmVkIGlvdl9jb3VudCA9ICppbl9udW0gKyAqb3V0X251bTsKKwkJc3RydWN0IHZo
b3N0X2Rlc2MgKmRlc2MgPSAmdnEtPmRlc2NzW2ldOworCQlpbnQgYWNjZXNzOworCisJCWlmIChk
ZXNjLT5mbGFncyAmIH5WSE9TVF9ERVNDX0ZMQUdTKSB7CisJCQl2cV9lcnIodnEsICJVbmV4cGVj
dGVkIGZsYWdzOiAweCV4IGF0IGRlc2NyaXB0b3IgaWQgMHgleFxuIiwKKwkJCSAgICAgICBkZXNj
LT5mbGFncywgZGVzYy0+aWQpOworCQkJcmV0ID0gLUVJTlZBTDsKKwkJCWdvdG8gZXJyOworCQl9
CisJCWlmIChkZXNjLT5mbGFncyAmIFZSSU5HX0RFU0NfRl9XUklURSkKKwkJCWFjY2VzcyA9IFZI
T1NUX0FDQ0VTU19XTzsKKwkJZWxzZQorCQkJYWNjZXNzID0gVkhPU1RfQUNDRVNTX1JPOworCQly
ZXQgPSB0cmFuc2xhdGVfZGVzYyh2cSwgZGVzYy0+YWRkciwKKwkJCQkgICAgIGRlc2MtPmxlbiwg
aW92ICsgaW92X2NvdW50LAorCQkJCSAgICAgaW92X3NpemUgLSBpb3ZfY291bnQsIGFjY2Vzcyk7
CisJCWlmICh1bmxpa2VseShyZXQgPCAwKSkgeworCQkJaWYgKHJldCAhPSAtRUFHQUlOKQorCQkJ
CXZxX2Vycih2cSwgIlRyYW5zbGF0aW9uIGZhaWx1cmUgJWQgZGVzY3JpcHRvciBpZHggJWRcbiIs
CisJCQkJCXJldCwgaSk7CisJCQlnb3RvIGVycjsKKwkJfQorCQlpZiAoYWNjZXNzID09IFZIT1NU
X0FDQ0VTU19XTykgeworCQkJLyogSWYgdGhpcyBpcyBhbiBpbnB1dCBkZXNjcmlwdG9yLAorCQkJ
ICogaW5jcmVtZW50IHRoYXQgY291bnQuICovCisJCQkqaW5fbnVtICs9IHJldDsKKwkJCWlmICh1
bmxpa2VseShsb2cgJiYgcmV0KSkgeworCQkJCWxvZ1sqbG9nX251bV0uYWRkciA9IGRlc2MtPmFk
ZHI7CisJCQkJbG9nWypsb2dfbnVtXS5sZW4gPSBkZXNjLT5sZW47CisJCQkJKysqbG9nX251bTsK
KwkJCX0KKwkJfSBlbHNlIHsKKwkJCS8qIElmIGl0J3MgYW4gb3V0cHV0IGRlc2NyaXB0b3IsIHRo
ZXkncmUgYWxsIHN1cHBvc2VkCisJCQkgKiB0byBjb21lIGJlZm9yZSBhbnkgaW5wdXQgZGVzY3Jp
cHRvcnMuICovCisJCQlpZiAodW5saWtlbHkoKmluX251bSkpIHsKKwkJCQl2cV9lcnIodnEsICJE
ZXNjcmlwdG9yIGhhcyBvdXQgYWZ0ZXIgaW46ICIKKwkJCQkgICAgICAgImlkeCAlZFxuIiwgaSk7
CisJCQkJcmV0ID0gLUVJTlZBTDsKKwkJCQlnb3RvIGVycjsKKwkJCX0KKwkJCSpvdXRfbnVtICs9
IHJldDsKKwkJfQorCisJCXJldCA9IGRlc2MtPmlkOworCX0KKworCXZxLT5uZGVzY3MgPSAwOwor
CisJcmV0dXJuIHJldDsKKworZXJyOgorCXZob3N0X2Rpc2NhcmRfdnFfZGVzYyh2cSwgMSk7Citl
cnJfZmV0Y2g6CisJdnEtPm5kZXNjcyA9IDA7CisKKwlyZXR1cm4gcmV0ID8gcmV0IDogdnEtPm51
bTsKK30KK0VYUE9SVF9TWU1CT0xfR1BMKHZob3N0X2dldF92cV9kZXNjX2JhdGNoKTsKKwogLyog
UmV2ZXJzZSB0aGUgZWZmZWN0IG9mIHZob3N0X2dldF92cV9kZXNjLiBVc2VmdWwgZm9yIGVycm9y
IGhhbmRsaW5nLiAqLwogdm9pZCB2aG9zdF9kaXNjYXJkX3ZxX2Rlc2Moc3RydWN0IHZob3N0X3Zp
cnRxdWV1ZSAqdnEsIGludCBuKQogewpkaWZmIC0tZ2l0IGEvZHJpdmVycy92aG9zdC92aG9zdC5o
IGIvZHJpdmVycy92aG9zdC92aG9zdC5oCmluZGV4IGM4ZTk2YTA5NWQzYi4uODcwODlkNTE0OTBk
IDEwMDY0NAotLS0gYS9kcml2ZXJzL3Zob3N0L3Zob3N0LmgKKysrIGIvZHJpdmVycy92aG9zdC92
aG9zdC5oCkBAIC02MCw2ICs2MCwxMyBAQCBlbnVtIHZob3N0X3VhZGRyX3R5cGUgewogCVZIT1NU
X05VTV9BRERSUyA9IDMsCiB9OwogCitzdHJ1Y3Qgdmhvc3RfZGVzYyB7CisJdTY0IGFkZHI7CisJ
dTMyIGxlbjsKKwl1MTYgZmxhZ3M7IC8qIFZSSU5HX0RFU0NfRl9XUklURSwgVlJJTkdfREVTQ19G
X05FWFQgKi8KKwl1MTYgaWQ7Cit9OworCiAvKiBUaGUgdmlydHF1ZXVlIHN0cnVjdHVyZSBkZXNj
cmliZXMgYSBxdWV1ZSBhdHRhY2hlZCB0byBhIGRldmljZS4gKi8KIHN0cnVjdCB2aG9zdF92aXJ0
cXVldWUgewogCXN0cnVjdCB2aG9zdF9kZXYgKmRldjsKQEAgLTcxLDYgKzc4LDExIEBAIHN0cnVj
dCB2aG9zdF92aXJ0cXVldWUgewogCXZyaW5nX2F2YWlsX3QgX191c2VyICphdmFpbDsKIAl2cmlu
Z191c2VkX3QgX191c2VyICp1c2VkOwogCWNvbnN0IHN0cnVjdCB2aG9zdF9pb3RsYl9tYXAgKm1l
dGFfaW90bGJbVkhPU1RfTlVNX0FERFJTXTsKKworCXN0cnVjdCB2aG9zdF9kZXNjICpkZXNjczsK
KwlpbnQgbmRlc2NzOworCWludCBtYXhfZGVzY3M7CisKIAlzdHJ1Y3QgZmlsZSAqa2ljazsKIAlz
dHJ1Y3QgZXZlbnRmZF9jdHggKmNhbGxfY3R4OwogCXN0cnVjdCBldmVudGZkX2N0eCAqZXJyb3Jf
Y3R4OwpAQCAtMTc3LDYgKzE4OSwxMCBAQCBsb25nIHZob3N0X3ZyaW5nX2lvY3RsKHN0cnVjdCB2
aG9zdF9kZXYgKmQsIHVuc2lnbmVkIGludCBpb2N0bCwgdm9pZCBfX3VzZXIgKmFyZwogYm9vbCB2
aG9zdF92cV9hY2Nlc3Nfb2soc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnEpOwogYm9vbCB2aG9z
dF9sb2dfYWNjZXNzX29rKHN0cnVjdCB2aG9zdF9kZXYgKik7CiAKK2ludCB2aG9zdF9nZXRfdnFf
ZGVzY19iYXRjaChzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICosCisJCSAgICAgIHN0cnVjdCBpb3Zl
YyBpb3ZbXSwgdW5zaWduZWQgaW50IGlvdl9jb3VudCwKKwkJICAgICAgdW5zaWduZWQgaW50ICpv
dXRfbnVtLCB1bnNpZ25lZCBpbnQgKmluX251bSwKKwkJICAgICAgc3RydWN0IHZob3N0X2xvZyAq
bG9nLCB1bnNpZ25lZCBpbnQgKmxvZ19udW0pOwogaW50IHZob3N0X2dldF92cV9kZXNjKHN0cnVj
dCB2aG9zdF92aXJ0cXVldWUgKiwKIAkJICAgICAgc3RydWN0IGlvdmVjIGlvdltdLCB1bnNpZ25l
ZCBpbnQgaW92X2NvdW50LAogCQkgICAgICB1bnNpZ25lZCBpbnQgKm91dF9udW0sIHVuc2lnbmVk
IGludCAqaW5fbnVtLAotLSAKTVNUCgpfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fXwpWaXJ0dWFsaXphdGlvbiBtYWlsaW5nIGxpc3QKVmlydHVhbGl6YXRpb25A
bGlzdHMubGludXgtZm91bmRhdGlvbi5vcmcKaHR0cHM6Ly9saXN0cy5saW51eGZvdW5kYXRpb24u
b3JnL21haWxtYW4vbGlzdGluZm8vdmlydHVhbGl6YXRpb24=
