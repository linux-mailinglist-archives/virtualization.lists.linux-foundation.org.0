Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
	by mail.lfdr.de (Postfix) with ESMTPS id E22B12D1ADF
	for <lists.virtualization@lfdr.de>; Mon,  7 Dec 2020 21:46:50 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by whitealder.osuosl.org (Postfix) with ESMTP id 907D887AC5;
	Mon,  7 Dec 2020 20:46:49 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id 8Jb3xKKpblzL; Mon,  7 Dec 2020 20:46:42 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by whitealder.osuosl.org (Postfix) with ESMTP id C001787B67;
	Mon,  7 Dec 2020 20:46:24 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id A98E8C013B;
	Mon,  7 Dec 2020 20:46:24 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
 by lists.linuxfoundation.org (Postfix) with ESMTP id C3243C1DA0
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:46:19 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by hemlock.osuosl.org (Postfix) with ESMTP id AA5EB87899
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:46:19 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id 1DpryRh+E2wm
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:46:18 +0000 (UTC)
X-Greylist: from auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by hemlock.osuosl.org (Postfix) with ESMTPS id 5562B8789C
 for <virtualization@lists.linux-foundation.org>;
 Mon,  7 Dec 2020 20:46:18 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 DDF8A305D516; Mon,  7 Dec 2020 22:46:16 +0200 (EET)
Received: from localhost.localdomain (unknown [91.199.104.27])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id AD2063072784;
 Mon,  7 Dec 2020 22:46:16 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v11 30/81] KVM: x86: wire in the preread/prewrite/preexec page
 trackers
Date: Mon,  7 Dec 2020 22:45:31 +0200
Message-Id: <20201207204622.15258-31-alazar@bitdefender.com>
In-Reply-To: <20201207204622.15258-1-alazar@bitdefender.com>
References: <20201207204622.15258-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 Stefan Sicleru <ssicleru@bitdefender.com>,
 virtualization@lists.linux-foundation.org,
 =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Marian Rotariu <marian.c.rotariu@gmail.com>,
 Paolo Bonzini <pbonzini@redhat.com>
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKVGhlc2UgYXJlIG5l
ZWRlZCBpbiBvcmRlciB0byBub3RpZnkgdGhlIGludHJvc3BlY3Rpb24gdG9vbCB3aGVuCnJlYWQv
d3JpdGUvZXhlY3V0ZSBhY2Nlc3MgaGFwcGVucyBvbiBvbmUgb2YgdGhlIHRyYWNrZWQgbWVtb3J5
IHBhZ2VzLgoKQWxzbywgdGhpcyBwYXRjaCBhZGRzIHRoZSBjYXNlIHdoZW4gdGhlIGludHJvc3Bl
Y3Rpb24gdG9vbCByZXF1ZXN0cwp0aGF0IHRoZSB2Q1BVIHJlLWVudGVyIGluIGd1ZXN0IChhbmQg
YWJvcnQgdGhlIGVtdWxhdGlvbiBvZiB0aGUgY3VycmVudAppbnN0cnVjdGlvbikuCgpTaWduZWQt
b2ZmLWJ5OiBNaWhhaSBEb27Im3UgPG1kb250dUBiaXRkZWZlbmRlci5jb20+CkNvLWRldmVsb3Bl
ZC1ieTogTWFyaWFuIFJvdGFyaXUgPG1hcmlhbi5jLnJvdGFyaXVAZ21haWwuY29tPgpTaWduZWQt
b2ZmLWJ5OiBNYXJpYW4gUm90YXJpdSA8bWFyaWFuLmMucm90YXJpdUBnbWFpbC5jb20+CkNvLWRl
dmVsb3BlZC1ieTogU3RlZmFuIFNpY2xlcnUgPHNzaWNsZXJ1QGJpdGRlZmVuZGVyLmNvbT4KU2ln
bmVkLW9mZi1ieTogU3RlZmFuIFNpY2xlcnUgPHNzaWNsZXJ1QGJpdGRlZmVuZGVyLmNvbT4KU2ln
bmVkLW9mZi1ieTogQWRhbGJlcnQgTGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29tPgotLS0K
IGFyY2gveDg2L2t2bS9lbXVsYXRlLmMgICAgIHwgIDQgKysrKwogYXJjaC94ODYva3ZtL2t2bV9l
bXVsYXRlLmggfCAgMSArCiBhcmNoL3g4Ni9rdm0vbW11L21tdS5jICAgICB8IDM4ICsrKysrKysr
KysrKysrKysrKysrKy0tLS0tLS0tLS0tCiBhcmNoL3g4Ni9rdm0vbW11L3NwdGUuYyAgICB8IDE3
ICsrKysrKysrKysrKysrCiBhcmNoL3g4Ni9rdm0veDg2LmMgICAgICAgICB8IDQ1ICsrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0tCiA1IGZpbGVzIGNoYW5nZWQsIDgzIGluc2Vy
dGlvbnMoKyksIDIyIGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2bS9lbXVs
YXRlLmMgYi9hcmNoL3g4Ni9rdm0vZW11bGF0ZS5jCmluZGV4IDU2Y2FlMWZmOWUzZi4uYWQzMjYz
MmQ0ZGNiIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vZW11bGF0ZS5jCisrKyBiL2FyY2gveDg2
L2t2bS9lbXVsYXRlLmMKQEAgLTU0NzQsNiArNTQ3NCw4IEBAIGludCB4ODZfZGVjb2RlX2luc24o
c3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQsIHZvaWQgKmluc24sIGludCBpbnNuX2xlbikK
IAkJCQkJY3R4dC0+bWVtb3BwLT5hZGRyLm1lbS5lYSArIGN0eHQtPl9laXApOwogCiBkb25lOgor
CWlmIChyYyA9PSBYODZFTVVMX1JFVFJZX0lOU1RSKQorCQlyZXR1cm4gRU1VTEFUSU9OX1JFVFJZ
X0lOU1RSOwogCWlmIChyYyA9PSBYODZFTVVMX1BST1BBR0FURV9GQVVMVCkKIAkJY3R4dC0+aGF2
ZV9leGNlcHRpb24gPSB0cnVlOwogCXJldHVybiAocmMgIT0gWDg2RU1VTF9DT05USU5VRSkgPyBF
TVVMQVRJT05fRkFJTEVEIDogRU1VTEFUSU9OX09LOwpAQCAtNTg0NSw2ICs1ODQ3LDggQEAgaW50
IHg4Nl9lbXVsYXRlX2luc24oc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQpCiAJaWYgKHJj
ID09IFg4NkVNVUxfSU5URVJDRVBURUQpCiAJCXJldHVybiBFTVVMQVRJT05fSU5URVJDRVBURUQ7
CiAKKwlpZiAocmMgPT0gWDg2RU1VTF9SRVRSWV9JTlNUUikKKwkJcmV0dXJuIEVNVUxBVElPTl9S
RVRSWV9JTlNUUjsKIAlpZiAocmMgPT0gWDg2RU1VTF9DT05USU5VRSkKIAkJd3JpdGViYWNrX3Jl
Z2lzdGVycyhjdHh0KTsKIApkaWZmIC0tZ2l0IGEvYXJjaC94ODYva3ZtL2t2bV9lbXVsYXRlLmgg
Yi9hcmNoL3g4Ni9rdm0va3ZtX2VtdWxhdGUuaAppbmRleCA0M2M5M2ZmYTc2ZWQuLjViZmFiOGQ2
NWNkMSAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL2t2bV9lbXVsYXRlLmgKKysrIGIvYXJjaC94
ODYva3ZtL2t2bV9lbXVsYXRlLmgKQEAgLTQ5Niw2ICs0OTYsNyBAQCBib29sIHg4Nl9wYWdlX3Rh
YmxlX3dyaXRpbmdfaW5zbihzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCk7CiAjZGVmaW5l
IEVNVUxBVElPTl9PSyAwCiAjZGVmaW5lIEVNVUxBVElPTl9SRVNUQVJUIDEKICNkZWZpbmUgRU1V
TEFUSU9OX0lOVEVSQ0VQVEVEIDIKKyNkZWZpbmUgRU1VTEFUSU9OX1JFVFJZX0lOU1RSIDMKIHZv
aWQgaW5pdF9kZWNvZGVfY2FjaGUoc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQpOwogaW50
IHg4Nl9lbXVsYXRlX2luc24oc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQpOwogaW50IGVt
dWxhdG9yX3Rhc2tfc3dpdGNoKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0LApkaWZmIC0t
Z2l0IGEvYXJjaC94ODYva3ZtL21tdS9tbXUuYyBiL2FyY2gveDg2L2t2bS9tbXUvbW11LmMKaW5k
ZXggMzZhZGQ2ZmI3MTJmLi4yM2I3MjUzMmNkMTggMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS9t
bXUvbW11LmMKKysrIGIvYXJjaC94ODYva3ZtL21tdS9tbXUuYwpAQCAtNzY5LDkgKzc2OSwxMyBA
QCBzdGF0aWMgdm9pZCBhY2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2
bV9tbXVfcGFnZSAqc3ApCiAJc2xvdCA9IF9fZ2ZuX3RvX21lbXNsb3Qoc2xvdHMsIGdmbik7CiAK
IAkvKiB0aGUgbm9uLWxlYWYgc2hhZG93IHBhZ2VzIGFyZSBrZWVwaW5nIHJlYWRvbmx5LiAqLwot
CWlmIChzcC0+cm9sZS5sZXZlbCA+IFBHX0xFVkVMXzRLKQotCQlyZXR1cm4ga3ZtX3Nsb3RfcGFn
ZV90cmFja19hZGRfcGFnZShrdm0sIHNsb3QsIGdmbiwKLQkJCQkJCSAgICBLVk1fUEFHRV9UUkFD
S19XUklURSk7CisJaWYgKHNwLT5yb2xlLmxldmVsID4gUEdfTEVWRUxfNEspIHsKKwkJa3ZtX3Ns
b3RfcGFnZV90cmFja19hZGRfcGFnZShrdm0sIHNsb3QsIGdmbiwKKwkJCQkJICAgICBLVk1fUEFH
RV9UUkFDS19QUkVXUklURSk7CisJCWt2bV9zbG90X3BhZ2VfdHJhY2tfYWRkX3BhZ2Uoa3ZtLCBz
bG90LCBnZm4sCisJCQkJCSAgICAgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpOworCQlyZXR1cm47CisJ
fQogCiAJa3ZtX21tdV9nZm5fZGlzYWxsb3dfbHBhZ2Uoc2xvdCwgZ2ZuKTsKIH0KQEAgLTc5Nyw5
ICs4MDEsMTMgQEAgc3RhdGljIHZvaWQgdW5hY2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0gKmt2
bSwgc3RydWN0IGt2bV9tbXVfcGFnZSAqc3ApCiAJZ2ZuID0gc3AtPmdmbjsKIAlzbG90cyA9IGt2
bV9tZW1zbG90c19mb3Jfc3B0ZV9yb2xlKGt2bSwgc3AtPnJvbGUpOwogCXNsb3QgPSBfX2dmbl90
b19tZW1zbG90KHNsb3RzLCBnZm4pOwotCWlmIChzcC0+cm9sZS5sZXZlbCA+IFBHX0xFVkVMXzRL
KQotCQlyZXR1cm4ga3ZtX3Nsb3RfcGFnZV90cmFja19yZW1vdmVfcGFnZShrdm0sIHNsb3QsIGdm
biwKLQkJCQkJCSAgICAgICBLVk1fUEFHRV9UUkFDS19XUklURSk7CisJaWYgKHNwLT5yb2xlLmxl
dmVsID4gUEdfTEVWRUxfNEspIHsKKwkJa3ZtX3Nsb3RfcGFnZV90cmFja19yZW1vdmVfcGFnZShr
dm0sIHNsb3QsIGdmbiwKKwkJCQkJCUtWTV9QQUdFX1RSQUNLX1BSRVdSSVRFKTsKKwkJa3ZtX3Ns
b3RfcGFnZV90cmFja19yZW1vdmVfcGFnZShrdm0sIHNsb3QsIGdmbiwKKwkJCQkJCUtWTV9QQUdF
X1RSQUNLX1dSSVRFKTsKKwkJcmV0dXJuOworCX0KIAogCWt2bV9tbXVfZ2ZuX2FsbG93X2xwYWdl
KHNsb3QsIGdmbik7CiB9CkBAIC0yNjAxLDcgKzI2MDksOCBAQCBib29sIG1tdV9uZWVkX3dyaXRl
X3Byb3RlY3Qoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBnZm5fdCBnZm4sCiB7CiAJc3RydWN0IGt2
bV9tbXVfcGFnZSAqc3A7CiAKLQlpZiAoa3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUsIGdm
biwgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpKQorCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUo
dmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19QUkVXUklURSkgfHwKKwkgICAga3ZtX3BhZ2VfdHJh
Y2tfaXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpKQogCQlyZXR1cm4g
dHJ1ZTsKIAogCWZvcl9lYWNoX2dmbl9pbmRpcmVjdF92YWxpZF9zcCh2Y3B1LT5rdm0sIHNwLCBn
Zm4pIHsKQEAgLTM2ODksMTUgKzM2OTgsMTggQEAgc3RhdGljIGJvb2wgcGFnZV9mYXVsdF9oYW5k
bGVfcGFnZV90cmFjayhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsCiAJaWYgKHVubGlrZWx5KGVycm9y
X2NvZGUgJiBQRkVSUl9SU1ZEX01BU0spKQogCQlyZXR1cm4gZmFsc2U7CiAKLQlpZiAoIShlcnJv
cl9jb2RlICYgUEZFUlJfUFJFU0VOVF9NQVNLKSB8fAotCSAgICAgICEoZXJyb3JfY29kZSAmIFBG
RVJSX1dSSVRFX01BU0spKQotCQlyZXR1cm4gZmFsc2U7Ci0KIAkvKgotCSAqIGd1ZXN0IGlzIHdy
aXRpbmcgdGhlIHBhZ2Ugd2hpY2ggaXMgd3JpdGUgdHJhY2tlZCB3aGljaCBjYW4KKwkgKiBndWVz
dCBpcyByZWFkaW5nL3dyaXRpbmcvZmV0Y2hpbmcgdGhlIHBhZ2Ugd2hpY2ggaXMKKwkgKiByZWFk
L3dyaXRlL2V4ZWN1dGUgdHJhY2tlZCB3aGljaCBjYW4KIAkgKiBub3QgYmUgZml4ZWQgYnkgcGFn
ZSBmYXVsdCBoYW5kbGVyLgogCSAqLwotCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNw
dSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19XUklURSkpCisJaWYgKCgoZXJyb3JfY29kZSAmIFBGRVJS
X1VTRVJfTUFTSykKKwkJJiYga3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZN
X1BBR0VfVFJBQ0tfUFJFUkVBRCkpCisJICAgIHx8ICgoZXJyb3JfY29kZSAmIFBGRVJSX1dSSVRF
X01BU0spCisJCSYmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFH
RV9UUkFDS19QUkVXUklURSkKKwkJIHx8IGt2bV9wYWdlX3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBn
Zm4sIEtWTV9QQUdFX1RSQUNLX1dSSVRFKSkpCisJICAgIHx8ICgoZXJyb3JfY29kZSAmIFBGRVJS
X0ZFVENIX01BU0spCisJCSYmIGt2bV9wYWdlX3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtW
TV9QQUdFX1RSQUNLX1BSRUVYRUMpKSkKIAkJcmV0dXJuIHRydWU7CiAKIAlyZXR1cm4gZmFsc2U7
CmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9rdm0vbW11L3NwdGUuYyBiL2FyY2gveDg2L2t2bS9tbXUv
c3B0ZS5jCmluZGV4IGZjYWMyY2FjNzhmZS4uOTIyNWI4MGFiMjA5IDEwMDY0NAotLS0gYS9hcmNo
L3g4Ni9rdm0vbW11L3NwdGUuYworKysgYi9hcmNoL3g4Ni9rdm0vbW11L3NwdGUuYwpAQCAtODEs
NiArODEsMjEgQEAgc3RhdGljIGJvb2wga3ZtX2lzX21taW9fcGZuKGt2bV9wZm5fdCBwZm4pCiAJ
CQkJICAgICBFODIwX1RZUEVfUkFNKTsKIH0KIAorc3RhdGljIHVuc2lnbmVkIGludCBrdm1fbW11
X2FwcGx5X2ludHJvc3BlY3Rpb25fYWNjZXNzKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwKKwkJCQkJ
CQlnZm5fdCBnZm4sCisJCQkJCQkJdW5zaWduZWQgaW50IGFjYykKK3sKKwlpZiAoa3ZtX3BhZ2Vf
dHJhY2tfaXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0VfVFJBQ0tfUFJFUkVBRCkpCisJCWFj
YyAmPSB+QUNDX1VTRVJfTUFTSzsKKwlpZiAoa3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUs
IGdmbiwgS1ZNX1BBR0VfVFJBQ0tfUFJFV1JJVEUpIHx8CisJICAgIGt2bV9wYWdlX3RyYWNrX2lz
X2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9QQUdFX1RSQUNLX1dSSVRFKSkKKwkJYWNjICY9IH5BQ0Nf
V1JJVEVfTUFTSzsKKwlpZiAoa3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZN
X1BBR0VfVFJBQ0tfUFJFRVhFQykpCisJCWFjYyAmPSB+QUNDX0VYRUNfTUFTSzsKKworCXJldHVy
biBhY2M7Cit9CisKIGludCBtYWtlX3NwdGUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25l
ZCBpbnQgcHRlX2FjY2VzcywgaW50IGxldmVsLAogCQkgICAgIGdmbl90IGdmbiwga3ZtX3Bmbl90
IHBmbiwgdTY0IG9sZF9zcHRlLCBib29sIHNwZWN1bGF0aXZlLAogCQkgICAgIGJvb2wgY2FuX3Vu
c3luYywgYm9vbCBob3N0X3dyaXRhYmxlLCBib29sIGFkX2Rpc2FibGVkLApAQCAtODksNiArMTA0
LDggQEAgaW50IG1ha2Vfc3B0ZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGludCBw
dGVfYWNjZXNzLCBpbnQgbGV2ZWwsCiAJdTY0IHNwdGUgPSAwOwogCWludCByZXQgPSAwOwogCisJ
cHRlX2FjY2VzcyA9IGt2bV9tbXVfYXBwbHlfaW50cm9zcGVjdGlvbl9hY2Nlc3ModmNwdSwgZ2Zu
LCBwdGVfYWNjZXNzKTsKKwogCWlmIChhZF9kaXNhYmxlZCkKIAkJc3B0ZSB8PSBTUFRFX0FEX0RJ
U0FCTEVEX01BU0s7CiAJZWxzZSBpZiAoa3ZtX3ZjcHVfYWRfbmVlZF93cml0ZV9wcm90ZWN0KHZj
cHUpKQpkaWZmIC0tZ2l0IGEvYXJjaC94ODYva3ZtL3g4Ni5jIGIvYXJjaC94ODYva3ZtL3g4Ni5j
CmluZGV4IDRkMTlkYTAxNmMxMi4uYTgyZGI2YjMwYWVlIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9r
dm0veDg2LmMKKysrIGIvYXJjaC94ODYva3ZtL3g4Ni5jCkBAIC01OTExLDYgKzU5MTEsOCBAQCBz
dGF0aWMgaW50IGt2bV9yZWFkX2d1ZXN0X3ZpcnRfaGVscGVyKGd2YV90IGFkZHIsIHZvaWQgKnZh
bCwgdW5zaWduZWQgaW50IGJ5dGVzLAogCiAJCWlmIChncGEgPT0gVU5NQVBQRURfR1ZBKQogCQkJ
cmV0dXJuIFg4NkVNVUxfUFJPUEFHQVRFX0ZBVUxUOworCQlpZiAoIWt2bV9wYWdlX3RyYWNrX3By
ZXJlYWQodmNwdSwgZ3BhLCBhZGRyLCB0b3JlYWQpKQorCQkJcmV0dXJuIFg4NkVNVUxfUkVUUllf
SU5TVFI7CiAJCXJldCA9IGt2bV92Y3B1X3JlYWRfZ3Vlc3RfcGFnZSh2Y3B1LCBncGEgPj4gUEFH
RV9TSElGVCwgZGF0YSwKIAkJCQkJICAgICAgIG9mZnNldCwgdG9yZWFkKTsKIAkJaWYgKHJldCA8
IDApIHsKQEAgLTU5NDIsNiArNTk0NCw5IEBAIHN0YXRpYyBpbnQga3ZtX2ZldGNoX2d1ZXN0X3Zp
cnQoc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQsCiAJaWYgKHVubGlrZWx5KGdwYSA9PSBV
Tk1BUFBFRF9HVkEpKQogCQlyZXR1cm4gWDg2RU1VTF9QUk9QQUdBVEVfRkFVTFQ7CiAKKwlpZiAo
IWt2bV9wYWdlX3RyYWNrX3ByZWV4ZWModmNwdSwgZ3BhLCBhZGRyKSkKKwkJcmV0dXJuIFg4NkVN
VUxfUkVUUllfSU5TVFI7CisKIAlvZmZzZXQgPSBhZGRyICYgKFBBR0VfU0laRS0xKTsKIAlpZiAo
V0FSTl9PTihvZmZzZXQgKyBieXRlcyA+IFBBR0VfU0laRSkpCiAJCWJ5dGVzID0gKHVuc2lnbmVk
KVBBR0VfU0laRSAtIG9mZnNldDsKQEAgLTYwMTAsMTEgKzYwMTUsMTQgQEAgc3RhdGljIGludCBr
dm1fd3JpdGVfZ3Vlc3RfdmlydF9oZWxwZXIoZ3ZhX3QgYWRkciwgdm9pZCAqdmFsLCB1bnNpZ25l
ZCBpbnQgYnl0ZXMKIAogCQlpZiAoZ3BhID09IFVOTUFQUEVEX0dWQSkKIAkJCXJldHVybiBYODZF
TVVMX1BST1BBR0FURV9GQVVMVDsKKwkJaWYgKCFrdm1fcGFnZV90cmFja19wcmV3cml0ZSh2Y3B1
LCBncGEsIGFkZHIsIGRhdGEsIHRvd3JpdGUpKQorCQkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5T
VFI7CiAJCXJldCA9IGt2bV92Y3B1X3dyaXRlX2d1ZXN0KHZjcHUsIGdwYSwgZGF0YSwgdG93cml0
ZSk7CiAJCWlmIChyZXQgPCAwKSB7CiAJCQlyID0gWDg2RU1VTF9JT19ORUVERUQ7CiAJCQlnb3Rv
IG91dDsKIAkJfQorCQlrdm1fcGFnZV90cmFja193cml0ZSh2Y3B1LCBncGEsIGFkZHIsIGRhdGEs
IHRvd3JpdGUpOwogCiAJCWJ5dGVzIC09IHRvd3JpdGU7CiAJCWRhdGEgKz0gdG93cml0ZTsKQEAg
LTYxMTgsMTMgKzYxMjYsMjIgQEAgc3RhdGljIGludCB2Y3B1X21taW9fZ3ZhX3RvX2dwYShzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGxvbmcgZ3ZhLAogaW50IGVtdWxhdG9yX3dyaXRl
X3BoeXMoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEsIGd2YV90IGd2YSwKIAkJCWNv
bnN0IHZvaWQgKnZhbCwgaW50IGJ5dGVzKQogewotCWludCByZXQ7Ci0KLQlyZXQgPSBrdm1fdmNw
dV93cml0ZV9ndWVzdCh2Y3B1LCBncGEsIHZhbCwgYnl0ZXMpOwotCWlmIChyZXQgPCAwKQotCQly
ZXR1cm4gMDsKKwlpZiAoIWt2bV9wYWdlX3RyYWNrX3ByZXdyaXRlKHZjcHUsIGdwYSwgZ3ZhLCB2
YWwsIGJ5dGVzKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5TVFI7CisJaWYgKGt2bV92Y3B1
X3dyaXRlX2d1ZXN0KHZjcHUsIGdwYSwgdmFsLCBieXRlcykgPCAwKQorCQlyZXR1cm4gWDg2RU1V
TF9VTkhBTkRMRUFCTEU7CiAJa3ZtX3BhZ2VfdHJhY2tfd3JpdGUodmNwdSwgZ3BhLCBndmEsIHZh
bCwgYnl0ZXMpOwotCXJldHVybiAxOworCXJldHVybiBYODZFTVVMX0NPTlRJTlVFOworfQorCitz
dGF0aWMgaW50IGVtdWxhdG9yX3JlYWRfcGh5cyhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90
IGdwYSwgZ3ZhX3QgZ3ZhLAorCQkJICAgICAgdm9pZCAqdmFsLCBpbnQgYnl0ZXMpCit7CisJaWYg
KCFrdm1fcGFnZV90cmFja19wcmVyZWFkKHZjcHUsIGdwYSwgZ3ZhLCBieXRlcykpCisJCXJldHVy
biBYODZFTVVMX1JFVFJZX0lOU1RSOworCWlmIChrdm1fdmNwdV9yZWFkX2d1ZXN0KHZjcHUsIGdw
YSwgdmFsLCBieXRlcykgPCAwKQorCQlyZXR1cm4gWDg2RU1VTF9VTkhBTkRMRUFCTEU7CisJcmV0
dXJuIFg4NkVNVUxfQ09OVElOVUU7CiB9CiAKIHN0cnVjdCByZWFkX3dyaXRlX2VtdWxhdG9yX29w
cyB7CkBAIC02MTU0LDcgKzYxNzEsNyBAQCBzdGF0aWMgaW50IHJlYWRfcHJlcGFyZShzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIHZvaWQgKnZhbCwgaW50IGJ5dGVzKQogc3RhdGljIGludCByZWFkX2Vt
dWxhdGUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEsIGd2YV90IGd2YSwKIAkJCXZv
aWQgKnZhbCwgaW50IGJ5dGVzKQogewotCXJldHVybiAha3ZtX3ZjcHVfcmVhZF9ndWVzdCh2Y3B1
LCBncGEsIHZhbCwgYnl0ZXMpOworCXJldHVybiBlbXVsYXRvcl9yZWFkX3BoeXModmNwdSwgZ3Bh
LCBndmEsIHZhbCwgYnl0ZXMpOwogfQogCiBzdGF0aWMgaW50IHdyaXRlX2VtdWxhdGUoc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEsIGd2YV90IGd2YSwKQEAgLTYyMjgsOCArNjI0NSwx
MSBAQCBzdGF0aWMgaW50IGVtdWxhdG9yX3JlYWRfd3JpdGVfb25lcGFnZSh1bnNpZ25lZCBsb25n
IGFkZHIsIHZvaWQgKnZhbCwKIAkJCXJldHVybiBYODZFTVVMX1BST1BBR0FURV9GQVVMVDsKIAl9
CiAKLQlpZiAoIXJldCAmJiBvcHMtPnJlYWRfd3JpdGVfZW11bGF0ZSh2Y3B1LCBncGEsIGFkZHIs
IHZhbCwgYnl0ZXMpKQotCQlyZXR1cm4gWDg2RU1VTF9DT05USU5VRTsKKwlpZiAoIXJldCkgewor
CQlyZXQgPSBvcHMtPnJlYWRfd3JpdGVfZW11bGF0ZSh2Y3B1LCBncGEsIGFkZHIsIHZhbCwgYnl0
ZXMpOworCQlpZiAocmV0ID09IFg4NkVNVUxfQ09OVElOVUUgfHwgcmV0ID09IFg4NkVNVUxfUkVU
UllfSU5TVFIpCisJCQlyZXR1cm4gcmV0OworCX0KIAogCS8qCiAJICogSXMgdGhpcyBNTUlPIGhh
bmRsZWQgbG9jYWxseT8KQEAgLTYzNzMsNiArNjM5Myw5IEBAIHN0YXRpYyBpbnQgZW11bGF0b3Jf
Y21weGNoZ19lbXVsYXRlZChzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCwKIAlpZiAoa3Zt
X3ZjcHVfbWFwKHZjcHUsIGdwYV90b19nZm4oZ3BhKSwgJm1hcCkpCiAJCWdvdG8gZW11bF93cml0
ZTsKIAorCWlmICgha3ZtX3BhZ2VfdHJhY2tfcHJld3JpdGUodmNwdSwgZ3BhLCBhZGRyLCBuZXcs
IGJ5dGVzKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5TVFI7CisKIAlrYWRkciA9IG1hcC5o
dmEgKyBvZmZzZXRfaW5fcGFnZShncGEpOwogCiAJc3dpdGNoIChieXRlcykgewpAQCAtNzMyMyw2
ICs3MzQ2LDggQEAgaW50IHg4Nl9lbXVsYXRlX2luc3RydWN0aW9uKHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSwgZ3BhX3QgY3IyX29yX2dwYSwKIAogCQl0cmFjZV9rdm1fZW11bGF0ZV9pbnNuX3N0YXJ0
KHZjcHUpOwogCQkrK3ZjcHUtPnN0YXQuaW5zbl9lbXVsYXRpb247CisJCWlmIChyID09IEVNVUxB
VElPTl9SRVRSWV9JTlNUUikKKwkJCXJldHVybiAxOwogCQlpZiAociAhPSBFTVVMQVRJT05fT0sp
ICB7CiAJCQlpZiAoKGVtdWxhdGlvbl90eXBlICYgRU1VTFRZUEVfVFJBUF9VRCkgfHwKIAkJCSAg
ICAoZW11bGF0aW9uX3R5cGUgJiBFTVVMVFlQRV9UUkFQX1VEX0ZPUkNFRCkpIHsKQEAgLTczOTIs
NiArNzQxNyw4IEBAIGludCB4ODZfZW11bGF0ZV9pbnN0cnVjdGlvbihzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUsIGdwYV90IGNyMl9vcl9ncGEsCiAKIAlyID0geDg2X2VtdWxhdGVfaW5zbihjdHh0KTsK
IAorCWlmIChyID09IEVNVUxBVElPTl9SRVRSWV9JTlNUUikKKwkJcmV0dXJuIDE7CiAJaWYgKHIg
PT0gRU1VTEFUSU9OX0lOVEVSQ0VQVEVEKQogCQlyZXR1cm4gMTsKIApfX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpWaXJ0dWFsaXphdGlvbiBtYWlsaW5nIGxp
c3QKVmlydHVhbGl6YXRpb25AbGlzdHMubGludXgtZm91bmRhdGlvbi5vcmcKaHR0cHM6Ly9saXN0
cy5saW51eGZvdW5kYXRpb24ub3JnL21haWxtYW4vbGlzdGluZm8vdmlydHVhbGl6YXRpb24=
