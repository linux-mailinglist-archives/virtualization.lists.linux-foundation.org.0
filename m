Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 20ED5229C8D
	for <lists.virtualization@lfdr.de>; Wed, 22 Jul 2020 18:01:56 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by hemlock.osuosl.org (Postfix) with ESMTP id A4D118872A;
	Wed, 22 Jul 2020 16:01:54 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id XK88E2OOifjE; Wed, 22 Jul 2020 16:01:52 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by hemlock.osuosl.org (Postfix) with ESMTP id F3C5E887E9;
	Wed, 22 Jul 2020 16:01:43 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id CE405C004C;
	Wed, 22 Jul 2020 16:01:43 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
 by lists.linuxfoundation.org (Postfix) with ESMTP id E5E51C004E
 for <virtualization@lists.linux-foundation.org>;
 Wed, 22 Jul 2020 16:01:38 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by fraxinus.osuosl.org (Postfix) with ESMTP id D1F8886B08
 for <virtualization@lists.linux-foundation.org>;
 Wed, 22 Jul 2020 16:01:38 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id ZAHUJw5KVl6y
 for <virtualization@lists.linux-foundation.org>;
 Wed, 22 Jul 2020 16:01:37 +0000 (UTC)
X-Greylist: from auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by fraxinus.osuosl.org (Postfix) with ESMTPS id 834EA86AE9
 for <virtualization@lists.linux-foundation.org>;
 Wed, 22 Jul 2020 16:01:37 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 8EA6E305D768; Wed, 22 Jul 2020 19:01:32 +0300 (EEST)
Received: from localhost.localdomain (unknown [91.199.104.6])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 807BE305FFA4;
 Wed, 22 Jul 2020 19:01:32 +0300 (EEST)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [RFC PATCH v1 17/34] KVM: introspection: extend the access rights
 database with EPT view info
Date: Wed, 22 Jul 2020 19:01:04 +0300
Message-Id: <20200722160121.9601-18-alazar@bitdefender.com>
In-Reply-To: <20200722160121.9601-1-alazar@bitdefender.com>
References: <20200722160121.9601-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?=C8=98tefan=20=C8=98icleru?= <ssicleru@bitdefender.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogyJh0ZWZhbiDImGljbGVydSA8c3NpY2xlcnVAYml0ZGVmZW5kZXIuY29tPgoKT24gRVBU
IHZpb2xhdGlvbnMsIHdoZW4gd2UgY2hlY2sgaWYgdGhlIGludHJvc3BlY3Rpb24gdG9vbCBoYXMg
c2hvd24KaW50ZXJlc3QgaW4gdGhlIGN1cnJlbnQgZ3Vlc3QgcGFnZSwgd2Ugd2lsbCB0YWtlIGlu
dG8gY29uc2lkZXJhdGlvbgp0aGUgRVBUIHZpZXcgb2YgdGhlIGN1cnJlbnQgdkNQVSB0b28uCgpT
aWduZWQtb2ZmLWJ5OiDImHRlZmFuIMiYaWNsZXJ1IDxzc2ljbGVydUBiaXRkZWZlbmRlci5jb20+
ClNpZ25lZC1vZmYtYnk6IEFkYWxiZXJ0IExhesSDciA8YWxhemFyQGJpdGRlZmVuZGVyLmNvbT4K
LS0tCiBhcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaCAgfCAgIDEgKwogYXJjaC94ODYv
a3ZtL2t2bWkuYyAgICAgICAgICAgICAgIHwgICA5ICstLQogaW5jbHVkZS9saW51eC9rdm1pX2hv
c3QuaCAgICAgICAgIHwgICAyICstCiB2aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYyAgICAg
fCAxMDcgKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0tCiB2aXJ0L2t2bS9pbnRyb3NwZWN0
aW9uL2t2bWlfaW50LmggfCAgIDQgKy0KIDUgZmlsZXMgY2hhbmdlZCwgNzEgaW5zZXJ0aW9ucygr
KSwgNTIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYvaW5jbHVkZS9hc20va3Zt
aV9ob3N0LmggYi9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaAppbmRleCA1MDlmYTNm
ZmY1ZTcuLjhhZjAzYmEzODMxNiAxMDA2NDQKLS0tIGEvYXJjaC94ODYvaW5jbHVkZS9hc20va3Zt
aV9ob3N0LmgKKysrIGIvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtaV9ob3N0LmgKQEAgLTksNiAr
OSw3IEBAIHN0cnVjdCBtc3JfZGF0YTsKIAogI2RlZmluZSBLVk1JX05VTV9DUiA1CiAjZGVmaW5l
IEtWTUlfTlVNX01TUiAweDIwMDAKKyNkZWZpbmUgS1ZNSV9NQVhfQUNDRVNTX1RSRUVTIEtWTV9N
QVhfRVBUX1ZJRVdTCiAKIHN0cnVjdCBrdm1pX21vbml0b3JfaW50ZXJjZXB0aW9uIHsKIAlib29s
IGt2bWlfaW50ZXJjZXB0ZWQ7CmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9rdm0va3ZtaS5jIGIvYXJj
aC94ODYva3ZtL2t2bWkuYwppbmRleCAwNjM1N2I4YWI1NGEuLjUyODg1YjllNWI2ZSAxMDA2NDQK
LS0tIGEvYXJjaC94ODYva3ZtL2t2bWkuYworKysgYi9hcmNoL3g4Ni9rdm0va3ZtaS5jCkBAIC0x
MTk3LDcgKzExOTcsNyBAQCBzdGF0aWMgY29uc3Qgc3RydWN0IHsKIAogdm9pZCBrdm1pX2FyY2hf
dXBkYXRlX3BhZ2VfdHJhY2tpbmcoc3RydWN0IGt2bSAqa3ZtLAogCQkJCSAgICBzdHJ1Y3Qga3Zt
X21lbW9yeV9zbG90ICpzbG90LAotCQkJCSAgICBzdHJ1Y3Qga3ZtaV9tZW1fYWNjZXNzICptKQor
CQkJCSAgICBzdHJ1Y3Qga3ZtaV9tZW1fYWNjZXNzICptLCB1MTYgdmlldykKIHsKIAlzdHJ1Y3Qg
a3ZtaV9hcmNoX21lbV9hY2Nlc3MgKmFyY2ggPSAmbS0+YXJjaDsKIAlpbnQgaTsKQEAgLTEyMTcs
MTIgKzEyMTcsMTIgQEAgdm9pZCBrdm1pX2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoc3RydWN0
IGt2bSAqa3ZtLAogCQkJaWYgKHNsb3RfdHJhY2tlZCkgewogCQkJCWt2bV9zbG90X3BhZ2VfdHJh
Y2tfcmVtb3ZlX3BhZ2Uoa3ZtLCBzbG90LAogCQkJCQkJCQltLT5nZm4sIG1vZGUsCi0JCQkJCQkJ
CTApOworCQkJCQkJCQl2aWV3KTsKIAkJCQljbGVhcl9iaXQoc2xvdC0+aWQsIGFyY2gtPmFjdGl2
ZVttb2RlXSk7CiAJCQl9CiAJCX0gZWxzZSBpZiAoIXNsb3RfdHJhY2tlZCkgewogCQkJa3ZtX3Ns
b3RfcGFnZV90cmFja19hZGRfcGFnZShrdm0sIHNsb3QsIG0tPmdmbiwgbW9kZSwKLQkJCQkJCSAg
ICAgMCk7CisJCQkJCQkgICAgIHZpZXcpOwogCQkJc2V0X2JpdChzbG90LT5pZCwgYXJjaC0+YWN0
aXZlW21vZGVdKTsKIAkJfQogCX0KQEAgLTEyNTYsNyArMTI1Niw4IEBAIHN0YXRpYyBib29sIGlz
X3BmX29mX2ludGVyZXN0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3BhX3QgZ3BhLCB1OCBhY2Nl
c3MpCiAJaWYgKGt2bV94ODZfb3BzLmdwdF90cmFuc2xhdGlvbl9mYXVsdCh2Y3B1KSkKIAkJcmV0
dXJuIGZhbHNlOwogCi0JcmV0dXJuIGt2bWlfcmVzdHJpY3RlZF9wYWdlX2FjY2VzcyhLVk1JKHZj
cHUtPmt2bSksIGdwYSwgYWNjZXNzKTsKKwlyZXR1cm4ga3ZtaV9yZXN0cmljdGVkX3BhZ2VfYWNj
ZXNzKEtWTUkodmNwdS0+a3ZtKSwgZ3BhLCBhY2Nlc3MsCisJCQkJCSAgIGt2bV9nZXRfZXB0X3Zp
ZXcodmNwdSkpOwogfQogCiBzdGF0aWMgYm9vbCBoYW5kbGVfcGZfZXZlbnQoc3RydWN0IGt2bV92
Y3B1ICp2Y3B1LCBncGFfdCBncGEsIGd2YV90IGd2YSwKZGlmZiAtLWdpdCBhL2luY2x1ZGUvbGlu
dXgva3ZtaV9ob3N0LmggYi9pbmNsdWRlL2xpbnV4L2t2bWlfaG9zdC5oCmluZGV4IDViYWVmNjhk
OGNiZS4uYzM4YzdmMTZkNWQwIDEwMDY0NAotLS0gYS9pbmNsdWRlL2xpbnV4L2t2bWlfaG9zdC5o
CisrKyBiL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgKQEAgLTY5LDcgKzY5LDcgQEAgc3RydWN0
IGt2bV9pbnRyb3NwZWN0aW9uIHsKIAogCWJvb2wgY2xlYW51cF9vbl91bmhvb2s7CiAKLQlzdHJ1
Y3QgcmFkaXhfdHJlZV9yb290IGFjY2Vzc190cmVlOworCXN0cnVjdCByYWRpeF90cmVlX3Jvb3Qg
YWNjZXNzX3RyZWVbS1ZNSV9NQVhfQUNDRVNTX1RSRUVTXTsKIAlyd2xvY2tfdCBhY2Nlc3NfdHJl
ZV9sb2NrOwogfTsKIApkaWZmIC0tZ2l0IGEvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMg
Yi92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYwppbmRleCAyYTk2YjgwYmRkYjIuLjczN2Zl
M2M3YTk1NiAxMDA2NDQKLS0tIGEvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMKKysrIGIv
dmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMKQEAgLTI1OCwyMCArMjU4LDIzIEBAIHN0YXRp
YyB2b2lkIGt2bWlfY2xlYXJfbWVtX2FjY2VzcyhzdHJ1Y3Qga3ZtICprdm0pCiAJc3RydWN0IGt2
bV9pbnRyb3NwZWN0aW9uICprdm1pID0gS1ZNSShrdm0pOwogCXN0cnVjdCByYWRpeF90cmVlX2l0
ZXIgaXRlcjsKIAl2b2lkICoqc2xvdDsKLQlpbnQgaWR4OworCWludCBpZHgsIHZpZXc7CiAKIAlp
ZHggPSBzcmN1X3JlYWRfbG9jaygma3ZtLT5zcmN1KTsKIAlzcGluX2xvY2soJmt2bS0+bW11X2xv
Y2spOwogCi0JcmFkaXhfdHJlZV9mb3JfZWFjaF9zbG90KHNsb3QsICZrdm1pLT5hY2Nlc3NfdHJl
ZSwgJml0ZXIsIDApIHsKLQkJc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbSA9ICpzbG90OworCWZv
ciAodmlldyA9IDA7IHZpZXcgPCBLVk1JX01BWF9BQ0NFU1NfVFJFRVM7IHZpZXcrKykKKwkJcmFk
aXhfdHJlZV9mb3JfZWFjaF9zbG90KHNsb3QsICZrdm1pLT5hY2Nlc3NfdHJlZVt2aWV3XSwKKwkJ
CQkJICZpdGVyLCAwKSB7CisJCQlzdHJ1Y3Qga3ZtaV9tZW1fYWNjZXNzICptID0gKnNsb3Q7CiAK
LQkJbS0+YWNjZXNzID0gZnVsbF9hY2Nlc3M7Ci0JCWt2bWlfYXJjaF91cGRhdGVfcGFnZV90cmFj
a2luZyhrdm0sIE5VTEwsIG0pOworCQkJbS0+YWNjZXNzID0gZnVsbF9hY2Nlc3M7CisJCQlrdm1p
X2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoa3ZtLCBOVUxMLCBtLCB2aWV3KTsKIAotCQlyYWRp
eF90cmVlX2l0ZXJfZGVsZXRlKCZrdm1pLT5hY2Nlc3NfdHJlZSwgJml0ZXIsIHNsb3QpOwotCQlr
bWVtX2NhY2hlX2ZyZWUocmFkaXhfY2FjaGUsIG0pOwotCX0KKwkJCXJhZGl4X3RyZWVfaXRlcl9k
ZWxldGUoJmt2bWktPmFjY2Vzc190cmVlW3ZpZXddLAorCQkJCQkgICAgICAgJml0ZXIsIHNsb3Qp
OworCQkJa21lbV9jYWNoZV9mcmVlKHJhZGl4X2NhY2hlLCBtKTsKKwkJfQogCiAJc3Bpbl91bmxv
Y2soJmt2bS0+bW11X2xvY2spOwogCXNyY3VfcmVhZF91bmxvY2soJmt2bS0+c3JjdSwgaWR4KTsK
QEAgLTMzNSw4ICszMzgsOSBAQCBhbGxvY19rdm1pKHN0cnVjdCBrdm0gKmt2bSwgY29uc3Qgc3Ry
dWN0IGt2bV9pbnRyb3NwZWN0aW9uX2hvb2sgKmhvb2spCiAKIAlhdG9taWNfc2V0KCZrdm1pLT5l
dl9zZXEsIDApOwogCi0JSU5JVF9SQURJWF9UUkVFKCZrdm1pLT5hY2Nlc3NfdHJlZSwKLQkJCUdG
UF9LRVJORUwgJiB+X19HRlBfRElSRUNUX1JFQ0xBSU0pOworCWZvciAoaSA9IDA7IGkgPCBBUlJB
WV9TSVpFKGt2bWktPmFjY2Vzc190cmVlKTsgaSsrKQorCQlJTklUX1JBRElYX1RSRUUoJmt2bWkt
PmFjY2Vzc190cmVlW2ldLAorCQkJCUdGUF9LRVJORUwgJiB+X19HRlBfRElSRUNUX1JFQ0xBSU0p
OwogCXJ3bG9ja19pbml0KCZrdm1pLT5hY2Nlc3NfdHJlZV9sb2NrKTsKIAogCWt2bV9mb3JfZWFj
aF92Y3B1KGksIHZjcHUsIGt2bSkgewpAQCAtMTA2NSwzMyArMTA2OSwzNSBAQCBib29sIGt2bWlf
ZW50ZXJfZ3Vlc3Qoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogfQogCiBzdGF0aWMgc3RydWN0IGt2
bWlfbWVtX2FjY2VzcyAqCi1fX2t2bWlfZ2V0X2dmbl9hY2Nlc3Moc3RydWN0IGt2bV9pbnRyb3Nw
ZWN0aW9uICprdm1pLCBjb25zdCBnZm5fdCBnZm4pCitfX2t2bWlfZ2V0X2dmbl9hY2Nlc3Moc3Ry
dWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pLCBjb25zdCBnZm5fdCBnZm4sIHUxNiB2aWV3KQog
ewotCXJldHVybiByYWRpeF90cmVlX2xvb2t1cCgma3ZtaS0+YWNjZXNzX3RyZWUsIGdmbik7CisJ
cmV0dXJuIHJhZGl4X3RyZWVfbG9va3VwKCZrdm1pLT5hY2Nlc3NfdHJlZVt2aWV3XSwgZ2ZuKTsK
IH0KIAotc3RhdGljIHZvaWQga3ZtaV91cGRhdGVfbWVtX2FjY2VzcyhzdHJ1Y3Qga3ZtICprdm0s
IHN0cnVjdCBrdm1pX21lbV9hY2Nlc3MgKm0pCitzdGF0aWMgdm9pZCBrdm1pX3VwZGF0ZV9tZW1f
YWNjZXNzKHN0cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbSwKKwkJCQkg
ICB1MTYgdmlldykKIHsKIAlzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWkgPSBLVk1JKGt2
bSk7CiAKLQlrdm1pX2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoa3ZtLCBOVUxMLCBtKTsKKwlr
dm1pX2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoa3ZtLCBOVUxMLCBtLCB2aWV3KTsKIAogCWlm
IChtLT5hY2Nlc3MgPT0gZnVsbF9hY2Nlc3MpIHsKLQkJcmFkaXhfdHJlZV9kZWxldGUoJmt2bWkt
PmFjY2Vzc190cmVlLCBtLT5nZm4pOworCQlyYWRpeF90cmVlX2RlbGV0ZSgma3ZtaS0+YWNjZXNz
X3RyZWVbdmlld10sIG0tPmdmbik7CiAJCWttZW1fY2FjaGVfZnJlZShyYWRpeF9jYWNoZSwgbSk7
CiAJfQogfQogCi1zdGF0aWMgdm9pZCBrdm1pX2luc2VydF9tZW1fYWNjZXNzKHN0cnVjdCBrdm0g
Kmt2bSwgc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbSkKK3N0YXRpYyB2b2lkIGt2bWlfaW5zZXJ0
X21lbV9hY2Nlc3Moc3RydWN0IGt2bSAqa3ZtLCBzdHJ1Y3Qga3ZtaV9tZW1fYWNjZXNzICptLAor
CQkJCSAgIHUxNiB2aWV3KQogewogCXN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaSA9IEtW
TUkoa3ZtKTsKIAotCXJhZGl4X3RyZWVfaW5zZXJ0KCZrdm1pLT5hY2Nlc3NfdHJlZSwgbS0+Z2Zu
LCBtKTsKLQlrdm1pX2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoa3ZtLCBOVUxMLCBtKTsKKwly
YWRpeF90cmVlX2luc2VydCgma3ZtaS0+YWNjZXNzX3RyZWVbdmlld10sIG0tPmdmbiwgbSk7CisJ
a3ZtaV9hcmNoX3VwZGF0ZV9wYWdlX3RyYWNraW5nKGt2bSwgTlVMTCwgbSwgdmlldyk7CiB9CiAK
IHN0YXRpYyB2b2lkIGt2bWlfc2V0X21lbV9hY2Nlc3Moc3RydWN0IGt2bSAqa3ZtLCBzdHJ1Y3Qg
a3ZtaV9tZW1fYWNjZXNzICptLAotCQkJCWJvb2wgKnVzZWQpCisJCQkJdTE2IHZpZXcsIGJvb2wg
KnVzZWQpCiB7CiAJc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pID0gS1ZNSShrdm0pOwog
CXN0cnVjdCBrdm1pX21lbV9hY2Nlc3MgKmZvdW5kOwpAQCAtMTEwMSwxMiArMTEwNywxMiBAQCBz
dGF0aWMgdm9pZCBrdm1pX3NldF9tZW1fYWNjZXNzKHN0cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2
bWlfbWVtX2FjY2VzcyAqbSwKIAlzcGluX2xvY2soJmt2bS0+bW11X2xvY2spOwogCXdyaXRlX2xv
Y2soJmt2bWktPmFjY2Vzc190cmVlX2xvY2spOwogCi0JZm91bmQgPSBfX2t2bWlfZ2V0X2dmbl9h
Y2Nlc3Moa3ZtaSwgbS0+Z2ZuKTsKKwlmb3VuZCA9IF9fa3ZtaV9nZXRfZ2ZuX2FjY2Vzcyhrdm1p
LCBtLT5nZm4sIHZpZXcpOwogCWlmIChmb3VuZCkgewogCQlmb3VuZC0+YWNjZXNzID0gbS0+YWNj
ZXNzOwotCQlrdm1pX3VwZGF0ZV9tZW1fYWNjZXNzKGt2bSwgZm91bmQpOworCQlrdm1pX3VwZGF0
ZV9tZW1fYWNjZXNzKGt2bSwgZm91bmQsIHZpZXcpOwogCX0gZWxzZSBpZiAobS0+YWNjZXNzICE9
IGZ1bGxfYWNjZXNzKSB7Ci0JCWt2bWlfaW5zZXJ0X21lbV9hY2Nlc3Moa3ZtLCBtKTsKKwkJa3Zt
aV9pbnNlcnRfbWVtX2FjY2Vzcyhrdm0sIG0sIHZpZXcpOwogCQkqdXNlZCA9IHRydWU7CiAJfQog
CkBAIC0xMTE1LDcgKzExMjEsOCBAQCBzdGF0aWMgdm9pZCBrdm1pX3NldF9tZW1fYWNjZXNzKHN0
cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbSwKIAlzcmN1X3JlYWRfdW5s
b2NrKCZrdm0tPnNyY3UsIGlkeCk7CiB9CiAKLXN0YXRpYyBpbnQga3ZtaV9zZXRfZ2ZuX2FjY2Vz
cyhzdHJ1Y3Qga3ZtICprdm0sIGdmbl90IGdmbiwgdTggYWNjZXNzKQorc3RhdGljIGludCBrdm1p
X3NldF9nZm5fYWNjZXNzKHN0cnVjdCBrdm0gKmt2bSwgZ2ZuX3QgZ2ZuLCB1OCBhY2Nlc3MsCisJ
CQkgICAgICAgdTE2IHZpZXcpCiB7CiAJc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbTsKIAlib29s
IHVzZWQgPSBmYWxzZTsKQEAgLTExMzEsNyArMTEzOCw3IEBAIHN0YXRpYyBpbnQga3ZtaV9zZXRf
Z2ZuX2FjY2VzcyhzdHJ1Y3Qga3ZtICprdm0sIGdmbl90IGdmbiwgdTggYWNjZXNzKQogCWlmIChy
YWRpeF90cmVlX3ByZWxvYWQoR0ZQX0tFUk5FTCkpCiAJCWVyciA9IC1LVk1fRU5PTUVNOwogCWVs
c2UKLQkJa3ZtaV9zZXRfbWVtX2FjY2Vzcyhrdm0sIG0sICZ1c2VkKTsKKwkJa3ZtaV9zZXRfbWVt
X2FjY2Vzcyhrdm0sIG0sIHZpZXcsICZ1c2VkKTsKIAogCXJhZGl4X3RyZWVfcHJlbG9hZF9lbmQo
KTsKIApAQCAtMTE1Myw3ICsxMTYwLDcgQEAgc3RhdGljIGJvb2wga3ZtaV9pc192aXNpYmxlX2dm
bihzdHJ1Y3Qga3ZtICprdm0sIGdmbl90IGdmbikKIAlyZXR1cm4gdmlzaWJsZTsKIH0KIAotc3Rh
dGljIGludCBzZXRfcGFnZV9hY2Nlc3NfZW50cnkoc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICpr
dm1pLAorc3RhdGljIGludCBzZXRfcGFnZV9hY2Nlc3NfZW50cnkoc3RydWN0IGt2bV9pbnRyb3Nw
ZWN0aW9uICprdm1pLCB1MTYgdmlldywKIAkJCQkgY29uc3Qgc3RydWN0IGt2bWlfcGFnZV9hY2Nl
c3NfZW50cnkgKmVudHJ5KQogewogCXU4IHVua25vd25fYml0cyA9IH4oS1ZNSV9QQUdFX0FDQ0VT
U19SIHwgS1ZNSV9QQUdFX0FDQ0VTU19XCkBAIC0xMTY5LDcgKzExNzYsNyBAQCBzdGF0aWMgaW50
IHNldF9wYWdlX2FjY2Vzc19lbnRyeShzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWksCiAJ
aWYgKCFrdm1pX2lzX3Zpc2libGVfZ2ZuKGt2bSwgZ2ZuKSkKIAkJcmV0dXJuIGVudHJ5LT52aXNp
YmxlID8gLUtWTV9FSU5WQUwgOiAwOwogCi0JcmV0dXJuIGt2bWlfc2V0X2dmbl9hY2Nlc3Moa3Zt
LCBnZm4sIGVudHJ5LT5hY2Nlc3MpOworCXJldHVybiBrdm1pX3NldF9nZm5fYWNjZXNzKGt2bSwg
Z2ZuLCBlbnRyeS0+YWNjZXNzLCB2aWV3KTsKIH0KIAogaW50IGt2bWlfY21kX3NldF9wYWdlX2Fj
Y2VzcyhzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWksCkBAIC0xMTg3LDcgKzExOTQsNyBA
QCBpbnQga3ZtaV9jbWRfc2V0X3BhZ2VfYWNjZXNzKHN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAq
a3ZtaSwKIAkJcmV0dXJuIC1LVk1fRUlOVkFMOwogCiAJZm9yICg7IGVudHJ5IDwgZW5kOyBlbnRy
eSsrKSB7Ci0JCWludCByID0gc2V0X3BhZ2VfYWNjZXNzX2VudHJ5KGt2bWksIGVudHJ5KTsKKwkJ
aW50IHIgPSBzZXRfcGFnZV9hY2Nlc3NfZW50cnkoa3ZtaSwgMCwgZW50cnkpOwogCiAJCWlmIChy
ICYmICFlYykKIAkJCWVjID0gcjsKQEAgLTExOTcsMTIgKzEyMDQsMTIgQEAgaW50IGt2bWlfY21k
X3NldF9wYWdlX2FjY2VzcyhzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWksCiB9CiAKIHN0
YXRpYyBpbnQga3ZtaV9nZXRfZ2ZuX2FjY2VzcyhzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2
bWksIGNvbnN0IGdmbl90IGdmbiwKLQkJCSAgICAgICB1OCAqYWNjZXNzKQorCQkJICAgICAgIHU4
ICphY2Nlc3MsIHUxNiB2aWV3KQogewogCXN0cnVjdCBrdm1pX21lbV9hY2Nlc3MgKm07CiAKIAly
ZWFkX2xvY2soJmt2bWktPmFjY2Vzc190cmVlX2xvY2spOwotCW0gPSBfX2t2bWlfZ2V0X2dmbl9h
Y2Nlc3Moa3ZtaSwgZ2ZuKTsKKwltID0gX19rdm1pX2dldF9nZm5fYWNjZXNzKGt2bWksIGdmbiwg
dmlldyk7CiAJaWYgKG0pCiAJCSphY2Nlc3MgPSBtLT5hY2Nlc3M7CiAJcmVhZF91bmxvY2soJmt2
bWktPmFjY2Vzc190cmVlX2xvY2spOwpAQCAtMTIxMSwxMiArMTIxOCwxMyBAQCBzdGF0aWMgaW50
IGt2bWlfZ2V0X2dmbl9hY2Nlc3Moc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pLCBjb25z
dCBnZm5fdCBnZm4sCiB9CiAKIGJvb2wga3ZtaV9yZXN0cmljdGVkX3BhZ2VfYWNjZXNzKHN0cnVj
dCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaSwgZ3BhX3QgZ3BhLAotCQkJCSB1OCBhY2Nlc3MpCisJ
CQkJIHU4IGFjY2VzcywgdTE2IHZpZXcpCiB7CiAJdTggYWxsb3dlZF9hY2Nlc3M7CiAJaW50IGVy
cjsKIAotCWVyciA9IGt2bWlfZ2V0X2dmbl9hY2Nlc3Moa3ZtaSwgZ3BhX3RvX2dmbihncGEpLCAm
YWxsb3dlZF9hY2Nlc3MpOworCWVyciA9IGt2bWlfZ2V0X2dmbl9hY2Nlc3Moa3ZtaSwgZ3BhX3Rv
X2dmbihncGEpLCAmYWxsb3dlZF9hY2Nlc3MsIHZpZXcpOworCiAJaWYgKGVycikKIAkJcmV0dXJu
IGZhbHNlOwogCkBAIC0xMjY0LDEwICsxMjcyLDE0IEBAIHZvaWQga3ZtaV9hZGRfbWVtc2xvdChz
dHJ1Y3Qga3ZtICprdm0sIHN0cnVjdCBrdm1fbWVtb3J5X3Nsb3QgKnNsb3QsCiAKIAl3aGlsZSAo
c3RhcnQgPCBlbmQpIHsKIAkJc3RydWN0IGt2bWlfbWVtX2FjY2VzcyAqbTsKKwkJdTE2IHZpZXc7
CiAKLQkJbSA9IF9fa3ZtaV9nZXRfZ2ZuX2FjY2Vzcyhrdm1pLCBzdGFydCk7Ci0JCWlmIChtKQot
CQkJa3ZtaV9hcmNoX3VwZGF0ZV9wYWdlX3RyYWNraW5nKGt2bSwgc2xvdCwgbSk7CisJCWZvciAo
dmlldyA9IDA7IHZpZXcgPCBLVk1JX01BWF9BQ0NFU1NfVFJFRVM7IHZpZXcrKykgeworCQkJbSA9
IF9fa3ZtaV9nZXRfZ2ZuX2FjY2Vzcyhrdm1pLCBzdGFydCwgdmlldyk7CisJCQlpZiAobSkKKwkJ
CQlrdm1pX2FyY2hfdXBkYXRlX3BhZ2VfdHJhY2tpbmcoa3ZtLCBzbG90LCBtLAorCQkJCQkJCSAg
ICAgICB2aWV3KTsKKwkJfQogCQlzdGFydCsrOwogCX0KIApAQCAtMTI4OSwxNCArMTMwMSwxOCBA
QCB2b2lkIGt2bWlfcmVtb3ZlX21lbXNsb3Qoc3RydWN0IGt2bSAqa3ZtLCBzdHJ1Y3Qga3ZtX21l
bW9yeV9zbG90ICpzbG90KQogCiAJd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAJCXN0cnVjdCBrdm1p
X21lbV9hY2Nlc3MgKm07CisJCXUxNiB2aWV3OwogCi0JCW0gPSBfX2t2bWlfZ2V0X2dmbl9hY2Nl
c3Moa3ZtaSwgc3RhcnQpOwotCQlpZiAobSkgewotCQkJdTggcHJldl9hY2Nlc3MgPSBtLT5hY2Nl
c3M7CisJCWZvciAodmlldyA9IDA7IHZpZXcgPCBLVk1JX01BWF9BQ0NFU1NfVFJFRVM7IHZpZXcr
KykgeworCQkJbSA9IF9fa3ZtaV9nZXRfZ2ZuX2FjY2Vzcyhrdm1pLCBzdGFydCwgdmlldyk7CisJ
CQlpZiAobSkgeworCQkJCXU4IHByZXZfYWNjZXNzID0gbS0+YWNjZXNzOwogCi0JCQltLT5hY2Nl
c3MgPSBmdWxsX2FjY2VzczsKLQkJCWt2bWlfYXJjaF91cGRhdGVfcGFnZV90cmFja2luZyhrdm0s
IHNsb3QsIG0pOwotCQkJbS0+YWNjZXNzID0gcHJldl9hY2Nlc3M7CisJCQkJbS0+YWNjZXNzID0g
ZnVsbF9hY2Nlc3M7CisJCQkJa3ZtaV9hcmNoX3VwZGF0ZV9wYWdlX3RyYWNraW5nKGt2bSwgc2xv
dCwgbSwKKwkJCQkJCQkgICAgICAgdmlldyk7CisJCQkJbS0+YWNjZXNzID0gcHJldl9hY2Nlc3M7
CisJCQl9CiAJCX0KIAkJc3RhcnQrKzsKIAl9CkBAIC0xMzgyLDE0ICsxMzk4LDE1IEBAIHZvaWQg
a3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCiB9CiBFWFBPUlRf
U1lNQk9MKGt2bWlfc2luZ2xlc3RlcF9mYWlsZWQpOwogCi1zdGF0aWMgYm9vbCBfX2t2bWlfdHJh
Y2tlZF9nZm4oc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1pLCBnZm5fdCBnZm4pCitzdGF0
aWMgYm9vbCBfX2t2bWlfdHJhY2tlZF9nZm4oc3RydWN0IGt2bV9pbnRyb3NwZWN0aW9uICprdm1p
LCBnZm5fdCBnZm4sCisJCQkgICAgICAgdTE2IHZpZXcpCiB7CiAJdTggaWdub3JlZF9hY2Nlc3M7
CisJaW50IGVycjsKIAotCWlmIChrdm1pX2dldF9nZm5fYWNjZXNzKGt2bWksIGdmbiwgJmlnbm9y
ZWRfYWNjZXNzKSkKLQkJcmV0dXJuIGZhbHNlOworCWVyciA9IGt2bWlfZ2V0X2dmbl9hY2Nlc3Mo
a3ZtaSwgZ2ZuLCAmaWdub3JlZF9hY2Nlc3MsIHZpZXcpOwogCi0JcmV0dXJuIHRydWU7CisJcmV0
dXJuICFlcnI7CiB9CiAKIGJvb2wga3ZtaV90cmFja2VkX2dmbihzdHJ1Y3Qga3ZtX3ZjcHUgKnZj
cHUsIGdmbl90IGdmbikKQEAgLTE0MDEsNyArMTQxOCw3IEBAIGJvb2wga3ZtaV90cmFja2VkX2dm
bihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdmbl90IGdmbikKIAlpZiAoIWt2bWkpCiAJCXJldHVy
biBmYWxzZTsKIAotCXJldCA9IF9fa3ZtaV90cmFja2VkX2dmbihrdm1pLCBnZm4pOworCXJldCA9
IF9fa3ZtaV90cmFja2VkX2dmbihrdm1pLCBnZm4sIGt2bV9nZXRfZXB0X3ZpZXcodmNwdSkpOwog
CiAJa3ZtaV9wdXQodmNwdS0+a3ZtKTsKIApkaWZmIC0tZ2l0IGEvdmlydC9rdm0vaW50cm9zcGVj
dGlvbi9rdm1pX2ludC5oIGIvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pX2ludC5oCmluZGV4
IGQ3ODExNjQ0MmRkZC4uZmM2ZGJkM2E2NDcyIDEwMDY0NAotLS0gYS92aXJ0L2t2bS9pbnRyb3Nw
ZWN0aW9uL2t2bWlfaW50LmgKKysrIGIvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pX2ludC5o
CkBAIC04OSw3ICs4OSw3IEBAIGludCBrdm1pX2NtZF9zZXRfcGFnZV9hY2Nlc3Moc3RydWN0IGt2
bV9pbnRyb3NwZWN0aW9uICprdm1pLAogCQkJICAgICBjb25zdCBzdHJ1Y3Qga3ZtaV9tc2dfaGRy
ICptc2csCiAJCQkgICAgIGNvbnN0IHN0cnVjdCBrdm1pX3ZtX3NldF9wYWdlX2FjY2VzcyAqcmVx
KTsKIGJvb2wga3ZtaV9yZXN0cmljdGVkX3BhZ2VfYWNjZXNzKHN0cnVjdCBrdm1faW50cm9zcGVj
dGlvbiAqa3ZtaSwgZ3BhX3QgZ3BhLAotCQkJCSB1OCBhY2Nlc3MpOworCQkJCSB1OCBhY2Nlc3Ms
IHUxNiB2aWV3KTsKIGJvb2wga3ZtaV9wZl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdw
YV90IGdwYSwgZ3ZhX3QgZ3ZhLCB1OCBhY2Nlc3MpOwogdm9pZCBrdm1pX2FkZF9tZW1zbG90KHN0
cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2bV9tZW1vcnlfc2xvdCAqc2xvdCwKIAkJICAgICAgdW5z
aWduZWQgbG9uZyBucGFnZXMpOwpAQCAtMTQwLDcgKzE0MCw3IEBAIGludCBrdm1pX2FyY2hfY21k
X3ZjcHVfY29udHJvbF9tc3Ioc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAogCQkJCSAgIGNvbnN0IHN0
cnVjdCBrdm1pX3ZjcHVfY29udHJvbF9tc3IgKnJlcSk7CiB2b2lkIGt2bWlfYXJjaF91cGRhdGVf
cGFnZV90cmFja2luZyhzdHJ1Y3Qga3ZtICprdm0sCiAJCQkJICAgIHN0cnVjdCBrdm1fbWVtb3J5
X3Nsb3QgKnNsb3QsCi0JCQkJICAgIHN0cnVjdCBrdm1pX21lbV9hY2Nlc3MgKm0pOworCQkJCSAg
ICBzdHJ1Y3Qga3ZtaV9tZW1fYWNjZXNzICptLCB1MTYgdmlldyk7CiB2b2lkIGt2bWlfYXJjaF9o
b29rKHN0cnVjdCBrdm0gKmt2bSk7CiB2b2lkIGt2bWlfYXJjaF91bmhvb2soc3RydWN0IGt2bSAq
a3ZtKTsKIHZvaWQga3ZtaV9hcmNoX2ZlYXR1cmVzKHN0cnVjdCBrdm1pX2ZlYXR1cmVzICpmZWF0
KTsKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KVmlydHVh
bGl6YXRpb24gbWFpbGluZyBsaXN0ClZpcnR1YWxpemF0aW9uQGxpc3RzLmxpbnV4LWZvdW5kYXRp
b24ub3JnCmh0dHBzOi8vbGlzdHMubGludXhmb3VuZGF0aW9uLm9yZy9tYWlsbWFuL2xpc3RpbmZv
L3ZpcnR1YWxpemF0aW9u
