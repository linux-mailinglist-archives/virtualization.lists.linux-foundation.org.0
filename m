Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 7111219788B
	for <lists.virtualization@lfdr.de>; Mon, 30 Mar 2020 12:13:12 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by hemlock.osuosl.org (Postfix) with ESMTP id BBE4088498;
	Mon, 30 Mar 2020 10:13:10 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id Fc49rXISIzt5; Mon, 30 Mar 2020 10:13:10 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by hemlock.osuosl.org (Postfix) with ESMTP id A521488493;
	Mon, 30 Mar 2020 10:13:04 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 731A5C07FF;
	Mon, 30 Mar 2020 10:13:04 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 420F1C1D8E
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:58 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by whitealder.osuosl.org (Postfix) with ESMTP id 32A75878B5
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:58 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id lscWLFhl+-eE
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:55 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by whitealder.osuosl.org (Postfix) with ESMTPS id 39C3C878C0
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:54 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp02.buh.bitdefender.net [10.17.80.76])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 8801C30747D3; Mon, 30 Mar 2020 13:12:51 +0300 (EEST)
Received: from localhost.localdomain (unknown [91.199.104.28])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 61DAA305B7A1;
 Mon, 30 Mar 2020 13:12:51 +0300 (EEST)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v8 18/81] KVM: x86: use MSR_TYPE_R,
 MSR_TYPE_W and MSR_TYPE_RW with AMD code too
Date: Mon, 30 Mar 2020 13:12:05 +0300
Message-Id: <20200330101308.21702-19-alazar@bitdefender.com>
In-Reply-To: <20200330101308.21702-1-alazar@bitdefender.com>
References: <20200330101308.21702-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Nicu=C8=99or=20C=C3=AE=C8=9Bu?= <ncitu@bitdefender.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTmljdciZb3IgQ8OuyJt1IDxuY2l0dUBiaXRkZWZlbmRlci5jb20+CgpXZSBjYW4gdGhh
biB1c2UgYSBjb21tb24gaW50ZXJmYWNlIHRvIGVuYWJsZS9kaXNhYmxlIHRoZSBNU1IgaW50ZXJj
ZXB0aW9uLgoKU2lnbmVkLW9mZi1ieTogTmljdciZb3IgQ8OuyJt1IDxuY2l0dUBiaXRkZWZlbmRl
ci5jb20+ClNpZ25lZC1vZmYtYnk6IEFkYWxiZXJ0IExhesSDciA8YWxhemFyQGJpdGRlZmVuZGVy
LmNvbT4KLS0tCiBhcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1faG9zdC5oIHwgIDQgKysrCiBhcmNo
L3g4Ni9rdm0vc3ZtLmMgICAgICAgICAgICAgIHwgNDQgKysrKysrKysrKysrKysrKysrKysrKy0t
LS0tLS0tLS0tCiBhcmNoL3g4Ni9rdm0vdm14L3ZteC5oICAgICAgICAgIHwgIDQgLS0tCiAzIGZp
bGVzIGNoYW5nZWQsIDM0IGluc2VydGlvbnMoKyksIDE4IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdp
dCBhL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bV9ob3N0LmggYi9hcmNoL3g4Ni9pbmNsdWRlL2Fz
bS9rdm1faG9zdC5oCmluZGV4IDhkNTAxMjMzMGUyZC4uOWFlMGUwMzY0Y2FmIDEwMDY0NAotLS0g
YS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1faG9zdC5oCisrKyBiL2FyY2gveDg2L2luY2x1ZGUv
YXNtL2t2bV9ob3N0LmgKQEAgLTE0MCw2ICsxNDAsMTAgQEAgc3RhdGljIGlubGluZSBnZm5fdCBn
Zm5fdG9faW5kZXgoZ2ZuX3QgZ2ZuLCBnZm5fdCBiYXNlX2dmbiwgaW50IGxldmVsKQogI2RlZmlu
ZSBDUl9UWVBFX1cJMgogI2RlZmluZSBDUl9UWVBFX1JXCTMKIAorI2RlZmluZSBNU1JfVFlQRV9S
CTEKKyNkZWZpbmUgTVNSX1RZUEVfVwkyCisjZGVmaW5lIE1TUl9UWVBFX1JXCTMKKwogI2RlZmlu
ZSBBU1lOQ19QRl9QRVJfVkNQVSA2NAogCiBlbnVtIGt2bV9yZWcgewpkaWZmIC0tZ2l0IGEvYXJj
aC94ODYva3ZtL3N2bS5jIGIvYXJjaC94ODYva3ZtL3N2bS5jCmluZGV4IDQ2M2ZlODExMmYyMi4u
NzBjOGM5MTNmMTRlIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vc3ZtLmMKKysrIGIvYXJjaC94
ODYva3ZtL3N2bS5jCkBAIC0xMDgxLDcgKzEwODEsNyBAQCBzdGF0aWMgYm9vbCBtc3Jfd3JpdGVf
aW50ZXJjZXB0ZWQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBtc3IpCiB9CiAKIHN0
YXRpYyB2b2lkIHNldF9tc3JfaW50ZXJjZXB0aW9uKHUzMiAqbXNycG0sIHVuc2lnbmVkIG1zciwK
LQkJCQkgaW50IHJlYWQsIGludCB3cml0ZSkKKwkJCQkgaW50IHR5cGUsIGJvb2wgdmFsdWUpCiB7
CiAJdTggYml0X3JlYWQsIGJpdF93cml0ZTsKIAl1bnNpZ25lZCBsb25nIHRtcDsKQEAgLTExMDAs
OCArMTEwMCwxMSBAQCBzdGF0aWMgdm9pZCBzZXRfbXNyX2ludGVyY2VwdGlvbih1MzIgKm1zcnBt
LCB1bnNpZ25lZCBtc3IsCiAKIAlCVUdfT04ob2Zmc2V0ID09IE1TUl9JTlZBTElEKTsKIAotCXJl
YWQgID8gY2xlYXJfYml0KGJpdF9yZWFkLCAgJnRtcCkgOiBzZXRfYml0KGJpdF9yZWFkLCAgJnRt
cCk7Ci0Jd3JpdGUgPyBjbGVhcl9iaXQoYml0X3dyaXRlLCAmdG1wKSA6IHNldF9iaXQoYml0X3dy
aXRlLCAmdG1wKTsKKwlpZiAodHlwZSAmIE1TUl9UWVBFX1IpCisJCXZhbHVlID8gY2xlYXJfYml0
KGJpdF9yZWFkLCAgJnRtcCkgOiBzZXRfYml0KGJpdF9yZWFkLCAgJnRtcCk7CisJaWYgKHR5cGUg
JiBNU1JfVFlQRV9XKQorCQl2YWx1ZSA/IGNsZWFyX2JpdChiaXRfd3JpdGUsICZ0bXApIDogc2V0
X2JpdChiaXRfd3JpdGUsICZ0bXApOworCiAKIAltc3JwbVtvZmZzZXRdID0gdG1wOwogfQpAQCAt
MTExNiw3ICsxMTE5LDggQEAgc3RhdGljIHZvaWQgc3ZtX3ZjcHVfaW5pdF9tc3JwbSh1MzIgKm1z
cnBtKQogCQlpZiAoIWRpcmVjdF9hY2Nlc3NfbXNyc1tpXS5hbHdheXMpCiAJCQljb250aW51ZTsK
IAotCQlzZXRfbXNyX2ludGVyY2VwdGlvbihtc3JwbSwgZGlyZWN0X2FjY2Vzc19tc3JzW2ldLmlu
ZGV4LCAxLCAxKTsKKwkJc2V0X21zcl9pbnRlcmNlcHRpb24obXNycG0sIGRpcmVjdF9hY2Nlc3Nf
bXNyc1tpXS5pbmRleCwKKwkJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKIAl9CiB9CiAKQEAgLTEx
NjgsMTAgKzExNzIsMTQgQEAgc3RhdGljIHZvaWQgc3ZtX2VuYWJsZV9sYnJ2KHN0cnVjdCB2Y3B1
X3N2bSAqc3ZtKQogCXUzMiAqbXNycG0gPSBzdm0tPm1zcnBtOwogCiAJc3ZtLT52bWNiLT5jb250
cm9sLnZpcnRfZXh0IHw9IExCUl9DVExfRU5BQkxFX01BU0s7Ci0Jc2V0X21zcl9pbnRlcmNlcHRp
b24obXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hGUk9NSVAsIDEsIDEpOwotCXNldF9tc3JfaW50
ZXJjZXB0aW9uKG1zcnBtLCBNU1JfSUEzMl9MQVNUQlJBTkNIVE9JUCwgMSwgMSk7Ci0Jc2V0X21z
cl9pbnRlcmNlcHRpb24obXNycG0sIE1TUl9JQTMyX0xBU1RJTlRGUk9NSVAsIDEsIDEpOwotCXNl
dF9tc3JfaW50ZXJjZXB0aW9uKG1zcnBtLCBNU1JfSUEzMl9MQVNUSU5UVE9JUCwgMSwgMSk7CisJ
c2V0X21zcl9pbnRlcmNlcHRpb24obXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hGUk9NSVAsCisJ
CQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKKwlzZXRfbXNyX2ludGVyY2VwdGlvbihtc3JwbSwgTVNS
X0lBMzJfTEFTVEJSQU5DSFRPSVAsCisJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKKwlzZXRfbXNy
X2ludGVyY2VwdGlvbihtc3JwbSwgTVNSX0lBMzJfTEFTVElOVEZST01JUCwKKwkJCSAgICAgTVNS
X1RZUEVfUlcsIDEpOworCXNldF9tc3JfaW50ZXJjZXB0aW9uKG1zcnBtLCBNU1JfSUEzMl9MQVNU
SU5UVE9JUCwKKwkJCSAgICAgTVNSX1RZUEVfUlcsIDEpOwogfQogCiBzdGF0aWMgdm9pZCBzdm1f
ZGlzYWJsZV9sYnJ2KHN0cnVjdCB2Y3B1X3N2bSAqc3ZtKQpAQCAtMTE3OSwxMCArMTE4NywxNCBA
QCBzdGF0aWMgdm9pZCBzdm1fZGlzYWJsZV9sYnJ2KHN0cnVjdCB2Y3B1X3N2bSAqc3ZtKQogCXUz
MiAqbXNycG0gPSBzdm0tPm1zcnBtOwogCiAJc3ZtLT52bWNiLT5jb250cm9sLnZpcnRfZXh0ICY9
IH5MQlJfQ1RMX0VOQUJMRV9NQVNLOwotCXNldF9tc3JfaW50ZXJjZXB0aW9uKG1zcnBtLCBNU1Jf
SUEzMl9MQVNUQlJBTkNIRlJPTUlQLCAwLCAwKTsKLQlzZXRfbXNyX2ludGVyY2VwdGlvbihtc3Jw
bSwgTVNSX0lBMzJfTEFTVEJSQU5DSFRPSVAsIDAsIDApOwotCXNldF9tc3JfaW50ZXJjZXB0aW9u
KG1zcnBtLCBNU1JfSUEzMl9MQVNUSU5URlJPTUlQLCAwLCAwKTsKLQlzZXRfbXNyX2ludGVyY2Vw
dGlvbihtc3JwbSwgTVNSX0lBMzJfTEFTVElOVFRPSVAsIDAsIDApOworCXNldF9tc3JfaW50ZXJj
ZXB0aW9uKG1zcnBtLCBNU1JfSUEzMl9MQVNUQlJBTkNIRlJPTUlQLAorCQkJICAgICBNU1JfVFlQ
RV9SVywgMCk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24obXNycG0sIE1TUl9JQTMyX0xBU1RCUkFO
Q0hUT0lQLAorCQkJICAgICBNU1JfVFlQRV9SVywgMCk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24o
bXNycG0sIE1TUl9JQTMyX0xBU1RJTlRGUk9NSVAsCisJCQkgICAgIE1TUl9UWVBFX1JXLCAwKTsK
KwlzZXRfbXNyX2ludGVyY2VwdGlvbihtc3JwbSwgTVNSX0lBMzJfTEFTVElOVFRPSVAsCisJCQkg
ICAgIE1TUl9UWVBFX1JXLCAwKTsKIH0KIAogc3RhdGljIHZvaWQgZGlzYWJsZV9ubWlfc2luZ2xl
c3RlcChzdHJ1Y3QgdmNwdV9zdm0gKnN2bSkKQEAgLTQzNTAsNyArNDM2Miw4IEBAIHN0YXRpYyBp
bnQgc3ZtX3NldF9tc3Ioc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBzdHJ1Y3QgbXNyX2RhdGEgKm1z
cikKIAkJICogV2UgdXBkYXRlIHRoZSBMMSBNU1IgYml0IGFzIHdlbGwgc2luY2UgaXQgd2lsbCBl
bmQgdXAKIAkJICogdG91Y2hpbmcgdGhlIE1TUiBhbnl3YXkgbm93LgogCQkgKi8KLQkJc2V0X21z
cl9pbnRlcmNlcHRpb24oc3ZtLT5tc3JwbSwgTVNSX0lBMzJfU1BFQ19DVFJMLCAxLCAxKTsKKwkJ
c2V0X21zcl9pbnRlcmNlcHRpb24oc3ZtLT5tc3JwbSwgTVNSX0lBMzJfU1BFQ19DVFJMLAorCQkJ
CSAgICAgTVNSX1RZUEVfUlcsIDEpOwogCQlicmVhazsKIAljYXNlIE1TUl9JQTMyX1BSRURfQ01E
OgogCQlpZiAoIW1zci0+aG9zdF9pbml0aWF0ZWQgJiYKQEAgLTQzNjUsNyArNDM3OCwxMCBAQCBz
dGF0aWMgaW50IHN2bV9zZXRfbXNyKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgc3RydWN0IG1zcl9k
YXRhICptc3IpCiAJCQlicmVhazsKIAogCQl3cm1zcmwoTVNSX0lBMzJfUFJFRF9DTUQsIFBSRURf
Q01EX0lCUEIpOwotCQlzZXRfbXNyX2ludGVyY2VwdGlvbihzdm0tPm1zcnBtLCBNU1JfSUEzMl9Q
UkVEX0NNRCwgMCwgMSk7CisJCXNldF9tc3JfaW50ZXJjZXB0aW9uKHN2bS0+bXNycG0sIE1TUl9J
QTMyX1BSRURfQ01ELAorCQkJCSAgICAgTVNSX1RZUEVfUiwgMCk7CisJCXNldF9tc3JfaW50ZXJj
ZXB0aW9uKHN2bS0+bXNycG0sIE1TUl9JQTMyX1BSRURfQ01ELAorCQkJCSAgICAgTVNSX1RZUEVf
VywgMSk7CiAJCWJyZWFrOwogCWNhc2UgTVNSX0FNRDY0X1ZJUlRfU1BFQ19DVFJMOgogCQlpZiAo
IW1zci0+aG9zdF9pbml0aWF0ZWQgJiYKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2bS92bXgvdm14
LmggYi9hcmNoL3g4Ni9rdm0vdm14L3ZteC5oCmluZGV4IGU2NGRhMDZjNzAwOS4uZTU1NzQ4YWQ2
OGMxIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vdm14L3ZteC5oCisrKyBiL2FyY2gveDg2L2t2
bS92bXgvdm14LmgKQEAgLTE2LDEwICsxNiw2IEBAIGV4dGVybiB1NjQgaG9zdF9lZmVyOwogCiBl
eHRlcm4gdTMyIGdldF91bXdhaXRfY29udHJvbF9tc3Iodm9pZCk7CiAKLSNkZWZpbmUgTVNSX1RZ
UEVfUgkxCi0jZGVmaW5lIE1TUl9UWVBFX1cJMgotI2RlZmluZSBNU1JfVFlQRV9SVwkzCi0KICNk
ZWZpbmUgWDJBUElDX01TUihyKSAoQVBJQ19CQVNFX01TUiArICgocikgPj4gNCkpCiAKICNpZmRl
ZiBDT05GSUdfWDg2XzY0Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fClZpcnR1YWxpemF0aW9uIG1haWxpbmcgbGlzdApWaXJ0dWFsaXphdGlvbkBsaXN0cy5s
aW51eC1mb3VuZGF0aW9uLm9yZwpodHRwczovL2xpc3RzLmxpbnV4Zm91bmRhdGlvbi5vcmcvbWFp
bG1hbi9saXN0aW5mby92aXJ0dWFsaXphdGlvbg==
