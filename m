Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 36D551A040E
	for <lists.virtualization@lfdr.de>; Tue,  7 Apr 2020 03:08:25 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by hemlock.osuosl.org (Postfix) with ESMTP id D38A488602;
	Tue,  7 Apr 2020 01:08:23 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id yVMT8KGuk7J5; Tue,  7 Apr 2020 01:08:23 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by hemlock.osuosl.org (Postfix) with ESMTP id 2AF5888613;
	Tue,  7 Apr 2020 01:08:20 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id E7007C0177;
	Tue,  7 Apr 2020 01:08:19 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 5922CC0177
 for <virtualization@lists.linux-foundation.org>;
 Tue,  7 Apr 2020 01:08:18 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id 545932079C
 for <virtualization@lists.linux-foundation.org>;
 Tue,  7 Apr 2020 01:08:18 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id DSk4udcEOrLc
 for <virtualization@lists.linux-foundation.org>;
 Tue,  7 Apr 2020 01:08:17 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from us-smtp-delivery-1.mimecast.com (us-smtp-2.mimecast.com
 [205.139.110.61])
 by silver.osuosl.org (Postfix) with ESMTPS id C297920534
 for <virtualization@lists.linux-foundation.org>;
 Tue,  7 Apr 2020 01:08:16 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
 s=mimecast20190719; t=1586221695;
 h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
 to:to:cc:cc:mime-version:mime-version:content-type:content-type:
 content-transfer-encoding:content-transfer-encoding:
 in-reply-to:in-reply-to:references:references;
 bh=lVunxeUGbb+QAKZJYBIWDBklfV6A5oOFLLHt5aVAHSI=;
 b=Rr7wHW6f8WOBt/btmeCtAJih7b28/kD6OKV1Y1Z4cS4iNVw3bCzPfnxtTdRh7h6qBKt9tk
 qB9FMrbQzJUPdCdX2VATjQt5mGiFzmQqjsTD769EElwUXp61hR6p2rgGbxSTf4KIlZZuyb
 mlH8Loh0CxS67JRoyR8b7V0fOL27XnE=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-104-CeLi2m2XMXCOFIlzE3LwqA-1; Mon, 06 Apr 2020 21:08:10 -0400
X-MC-Unique: CeLi2m2XMXCOFIlzE3LwqA-1
Received: by mail-wr1-f70.google.com with SMTP id h14so851717wrr.12
 for <virtualization@lists.linux-foundation.org>;
 Mon, 06 Apr 2020 18:08:09 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:date:from:to:cc:subject:message-id:references
 :mime-version:content-disposition:content-transfer-encoding
 :in-reply-to;
 bh=lVunxeUGbb+QAKZJYBIWDBklfV6A5oOFLLHt5aVAHSI=;
 b=ixlsS+ip+xTd9vrkKqndtpC1Az4fgBmaIhHLmguRb2eSnE+RnAE/B79h9MgedMkOcH
 MzjoAA5VszGhxtt6wK+LJKea1NqeR1aDkkHdE1cN4aL1fmPGn2Fu0/c3MmeCjTTTOGF+
 vYFyeyVvYFkcVXXJqosJ/LR+IVa74CXvkFNo7TJUfkvzkzDRYZ6gKh7rGs2o4lYsJl7B
 ltKoGasoYUzKjyWAdJ4mMcgh6Woz9eq1PseQzUE6eTrQJg64AaPGMViSmA5uTRvEPBg7
 HsN7y3knDghcxJ5Tl+ZhB7UG0uEejfUBui6P5KfUKGyl17BtxPJepiVPYPMXwU6rrSg8
 yRpQ==
X-Gm-Message-State: AGi0PubQvT/XEZFEiqlRlq5MMLtFQlJdD1SQEycW/Tz8sJIhWUqflE+P
 4CO3vWfuXbJDCd1fAJ0xT9wrrXe+vkn0sfeF6lOFoqXIqC5zqtyby9Sw4mxOJmIP+xXXZACMdbq
 TUbgE7Wq964yHwzOfi1rb0uIiUQUH5TfiP8YzOIab0g==
X-Received: by 2002:a05:600c:4145:: with SMTP id
 h5mr2012375wmm.3.1586221688445; 
 Mon, 06 Apr 2020 18:08:08 -0700 (PDT)
X-Google-Smtp-Source: APiQypLiaruaXfh56DmzhXrcKdVGS2yMmwHvYBUSYSFl/PpjoQL2J3yP1blfp/v3BjD5XceWEWQakQ==
X-Received: by 2002:a05:600c:4145:: with SMTP id
 h5mr2012338wmm.3.1586221687677; 
 Mon, 06 Apr 2020 18:08:07 -0700 (PDT)
Received: from redhat.com (bzq-79-176-51-222.red.bezeqint.net. [79.176.51.222])
 by smtp.gmail.com with ESMTPSA id i5sm28025686wrr.12.2020.04.06.18.08.06
 (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
 Mon, 06 Apr 2020 18:08:07 -0700 (PDT)
Date: Mon, 6 Apr 2020 21:08:05 -0400
From: "Michael S. Tsirkin" <mst@redhat.com>
To: linux-kernel@vger.kernel.org
Subject: [PATCH v7 17/19] vhost: option to fetch descriptors through an
 independent struct
Message-ID: <20200407010700.446571-18-mst@redhat.com>
References: <20200407010700.446571-1-mst@redhat.com>
MIME-Version: 1.0
In-Reply-To: <20200407010700.446571-1-mst@redhat.com>
X-Mailer: git-send-email 2.24.1.751.gd10ce2899c
X-Mutt-Fcc: =sent
X-Mimecast-Spam-Score: 0
X-Mimecast-Originator: redhat.com
Content-Disposition: inline
Cc: Eugenio =?utf-8?B?UMOpcmV6?= <eperezma@redhat.com>, netdev@vger.kernel.org,
 kvm@vger.kernel.org, virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

VGhlIGlkZWEgaXMgdG8gc3VwcG9ydCBtdWx0aXBsZSByaW5nIGZvcm1hdHMgYnkgY29udmVydGlu
Zwp0byBhIGZvcm1hdC1pbmRlcGVuZGVudCBhcnJheSBvZiBkZXNjcmlwdG9ycy4KClRoaXMgY29z
dHMgZXh0cmEgY3ljbGVzLCBidXQgd2UgZ2FpbiBpbiBhYmlsaXR5CnRvIGZldGNoIGEgYmF0Y2gg
b2YgZGVzY3JpcHRvcnMgaW4gb25lIGdvLCB3aGljaAppcyBnb29kIGZvciBjb2RlIGNhY2hlIGxv
Y2FsaXR5LgoKV2hlbiB1c2VkLCB0aGlzIGNhdXNlcyBhIG1pbm9yIHBlcmZvcm1hbmNlIGRlZ3Jh
ZGF0aW9uLAppdCdzIGJlZW4ga2VwdCBhcyBzaW1wbGUgYXMgcG9zc2libGUgZm9yIGVhc2Ugb2Yg
cmV2aWV3LgpBIGZvbGxvdy11cCBwYXRjaCBnZXRzIHVzIGJhY2sgdGhlIHBlcmZvcm1hbmNlIGJ5
IGFkZGluZyBiYXRjaGluZy4KClRvIHNpbXBsaWZ5IGJlbmNobWFya2luZywgSSBrZXB0IHRoZSBv
bGQgY29kZSBhcm91bmQgc28gb25lIGNhbiBzd2l0Y2gKYmFjayBhbmQgZm9ydGggYmV0d2VlbiBv
bGQgYW5kIG5ldyBjb2RlLiBUaGlzIHdpbGwgZ28gYXdheSBpbiB0aGUgZmluYWwKc3VibWlzc2lv
bi4KClNpZ25lZC1vZmYtYnk6IE1pY2hhZWwgUy4gVHNpcmtpbiA8bXN0QHJlZGhhdC5jb20+ClNp
Z25lZC1vZmYtYnk6IEV1Z2VuaW8gUMOpcmV6IDxlcGVyZXptYUByZWRoYXQuY29tPgpMaW5rOiBo
dHRwczovL2xvcmUua2VybmVsLm9yZy9yLzIwMjAwNDAxMTgzMTE4LjgzMzQtMi1lcGVyZXptYUBy
ZWRoYXQuY29tClNpZ25lZC1vZmYtYnk6IE1pY2hhZWwgUy4gVHNpcmtpbiA8bXN0QHJlZGhhdC5j
b20+Ci0tLQogZHJpdmVycy92aG9zdC92aG9zdC5jIHwgMjk3ICsrKysrKysrKysrKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrLQogZHJpdmVycy92aG9zdC92aG9zdC5oIHwgIDE2ICsrKwog
MiBmaWxlcyBjaGFuZ2VkLCAzMTIgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlvbigtKQoKZGlmZiAt
LWdpdCBhL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYyBiL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYwppbmRl
eCBkNDUwZTE2YzVjMjUuLjU2NTkzYmE2ZGVjYyAxMDA2NDQKLS0tIGEvZHJpdmVycy92aG9zdC92
aG9zdC5jCisrKyBiL2RyaXZlcnMvdmhvc3Qvdmhvc3QuYwpAQCAtMjk4LDYgKzI5OCw3IEBAIHN0
YXRpYyB2b2lkIHZob3N0X3ZxX3Jlc2V0KHN0cnVjdCB2aG9zdF9kZXYgKmRldiwKIAkJCSAgIHN0
cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxKQogewogCXZxLT5udW0gPSAxOworCXZxLT5uZGVzY3Mg
PSAwOwogCXZxLT5kZXNjID0gTlVMTDsKIAl2cS0+YXZhaWwgPSBOVUxMOwogCXZxLT51c2VkID0g
TlVMTDsKQEAgLTM2OCw2ICszNjksOSBAQCBzdGF0aWMgaW50IHZob3N0X3dvcmtlcih2b2lkICpk
YXRhKQogCiBzdGF0aWMgdm9pZCB2aG9zdF92cV9mcmVlX2lvdmVjcyhzdHJ1Y3Qgdmhvc3Rfdmly
dHF1ZXVlICp2cSkKIHsKKwlrZnJlZSh2cS0+ZGVzY3MpOworCXZxLT5kZXNjcyA9IE5VTEw7CisJ
dnEtPm1heF9kZXNjcyA9IDA7CiAJa2ZyZWUodnEtPmluZGlyZWN0KTsKIAl2cS0+aW5kaXJlY3Qg
PSBOVUxMOwogCWtmcmVlKHZxLT5sb2cpOwpAQCAtMzg0LDYgKzM4OCwxMCBAQCBzdGF0aWMgbG9u
ZyB2aG9zdF9kZXZfYWxsb2NfaW92ZWNzKHN0cnVjdCB2aG9zdF9kZXYgKmRldikKIAogCWZvciAo
aSA9IDA7IGkgPCBkZXYtPm52cXM7ICsraSkgewogCQl2cSA9IGRldi0+dnFzW2ldOworCQl2cS0+
bWF4X2Rlc2NzID0gZGV2LT5pb3ZfbGltaXQ7CisJCXZxLT5kZXNjcyA9IGttYWxsb2NfYXJyYXko
dnEtPm1heF9kZXNjcywKKwkJCQkJICBzaXplb2YoKnZxLT5kZXNjcyksCisJCQkJCSAgR0ZQX0tF
Uk5FTCk7CiAJCXZxLT5pbmRpcmVjdCA9IGttYWxsb2NfYXJyYXkoVUlPX01BWElPViwKIAkJCQkJ
ICAgICBzaXplb2YoKnZxLT5pbmRpcmVjdCksCiAJCQkJCSAgICAgR0ZQX0tFUk5FTCk7CkBAIC0z
OTEsNyArMzk5LDcgQEAgc3RhdGljIGxvbmcgdmhvc3RfZGV2X2FsbG9jX2lvdmVjcyhzdHJ1Y3Qg
dmhvc3RfZGV2ICpkZXYpCiAJCQkJCUdGUF9LRVJORUwpOwogCQl2cS0+aGVhZHMgPSBrbWFsbG9j
X2FycmF5KGRldi0+aW92X2xpbWl0LCBzaXplb2YoKnZxLT5oZWFkcyksCiAJCQkJCSAgR0ZQX0tF
Uk5FTCk7Ci0JCWlmICghdnEtPmluZGlyZWN0IHx8ICF2cS0+bG9nIHx8ICF2cS0+aGVhZHMpCisJ
CWlmICghdnEtPmluZGlyZWN0IHx8ICF2cS0+bG9nIHx8ICF2cS0+aGVhZHMgfHwgIXZxLT5kZXNj
cykKIAkJCWdvdG8gZXJyX25vbWVtOwogCX0KIAlyZXR1cm4gMDsKQEAgLTIyNzcsNiArMjI4NSwy
OTMgQEAgaW50IHZob3N0X2dldF92cV9kZXNjKHN0cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxLAog
fQogRVhQT1JUX1NZTUJPTF9HUEwodmhvc3RfZ2V0X3ZxX2Rlc2MpOwogCitzdGF0aWMgc3RydWN0
IHZob3N0X2Rlc2MgKnBlZWtfc3BsaXRfZGVzYyhzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICp2cSkK
K3sKKwlCVUdfT04oIXZxLT5uZGVzY3MpOworCXJldHVybiAmdnEtPmRlc2NzW3ZxLT5uZGVzY3Mg
LSAxXTsKK30KKworc3RhdGljIHZvaWQgcG9wX3NwbGl0X2Rlc2Moc3RydWN0IHZob3N0X3ZpcnRx
dWV1ZSAqdnEpCit7CisJQlVHX09OKCF2cS0+bmRlc2NzKTsKKwktLXZxLT5uZGVzY3M7Cit9CisK
KyNkZWZpbmUgVkhPU1RfREVTQ19GTEFHUyAoVlJJTkdfREVTQ19GX0lORElSRUNUIHwgVlJJTkdf
REVTQ19GX1dSSVRFIHwgXAorCQkJICBWUklOR19ERVNDX0ZfTkVYVCkKK3N0YXRpYyBpbnQgcHVz
aF9zcGxpdF9kZXNjKHN0cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxLCBzdHJ1Y3QgdnJpbmdfZGVz
YyAqZGVzYywgdTE2IGlkKQoreworCXN0cnVjdCB2aG9zdF9kZXNjICpoOworCisJaWYgKHVubGlr
ZWx5KHZxLT5uZGVzY3MgPj0gdnEtPm1heF9kZXNjcykpCisJCXJldHVybiAtRUlOVkFMOworCWgg
PSAmdnEtPmRlc2NzW3ZxLT5uZGVzY3MrK107CisJaC0+YWRkciA9IHZob3N0NjRfdG9fY3B1KHZx
LCBkZXNjLT5hZGRyKTsKKwloLT5sZW4gPSB2aG9zdDMyX3RvX2NwdSh2cSwgZGVzYy0+bGVuKTsK
KwloLT5mbGFncyA9IHZob3N0MTZfdG9fY3B1KHZxLCBkZXNjLT5mbGFncykgJiBWSE9TVF9ERVND
X0ZMQUdTOworCWgtPmlkID0gaWQ7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCBmZXRj
aF9pbmRpcmVjdF9kZXNjcyhzdHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICp2cSwKKwkJCQlzdHJ1Y3Qg
dmhvc3RfZGVzYyAqaW5kaXJlY3QsCisJCQkJdTE2IGhlYWQpCit7CisJc3RydWN0IHZyaW5nX2Rl
c2MgZGVzYzsKKwl1bnNpZ25lZCBpbnQgaSA9IDAsIGNvdW50LCBmb3VuZCA9IDA7CisJdTMyIGxl
biA9IGluZGlyZWN0LT5sZW47CisJc3RydWN0IGlvdl9pdGVyIGZyb207CisJaW50IHJldDsKKwor
CS8qIFNhbml0eSBjaGVjayAqLworCWlmICh1bmxpa2VseShsZW4gJSBzaXplb2YgZGVzYykpIHsK
KwkJdnFfZXJyKHZxLCAiSW52YWxpZCBsZW5ndGggaW4gaW5kaXJlY3QgZGVzY3JpcHRvcjogIgor
CQkgICAgICAgImxlbiAweCVsbHggbm90IG11bHRpcGxlIG9mIDB4JXp4XG4iLAorCQkgICAgICAg
KHVuc2lnbmVkIGxvbmcgbG9uZylsZW4sCisJCSAgICAgICBzaXplb2YgZGVzYyk7CisJCXJldHVy
biAtRUlOVkFMOworCX0KKworCXJldCA9IHRyYW5zbGF0ZV9kZXNjKHZxLCBpbmRpcmVjdC0+YWRk
ciwgbGVuLCB2cS0+aW5kaXJlY3QsCisJCQkgICAgIFVJT19NQVhJT1YsIFZIT1NUX0FDQ0VTU19S
Tyk7CisJaWYgKHVubGlrZWx5KHJldCA8IDApKSB7CisJCWlmIChyZXQgIT0gLUVBR0FJTikKKwkJ
CXZxX2Vycih2cSwgIlRyYW5zbGF0aW9uIGZhaWx1cmUgJWQgaW4gaW5kaXJlY3QuXG4iLCByZXQp
OworCQlyZXR1cm4gcmV0OworCX0KKwlpb3ZfaXRlcl9pbml0KCZmcm9tLCBSRUFELCB2cS0+aW5k
aXJlY3QsIHJldCwgbGVuKTsKKworCS8qIFdlIHdpbGwgdXNlIHRoZSByZXN1bHQgYXMgYW4gYWRk
cmVzcyB0byByZWFkIGZyb20sIHNvIG1vc3QKKwkgKiBhcmNoaXRlY3R1cmVzIG9ubHkgbmVlZCBh
IGNvbXBpbGVyIGJhcnJpZXIgaGVyZS4gKi8KKwlyZWFkX2JhcnJpZXJfZGVwZW5kcygpOworCisJ
Y291bnQgPSBsZW4gLyBzaXplb2YgZGVzYzsKKwkvKiBCdWZmZXJzIGFyZSBjaGFpbmVkIHZpYSBh
IDE2IGJpdCBuZXh0IGZpZWxkLCBzbworCSAqIHdlIGNhbiBoYXZlIGF0IG1vc3QgMl4xNiBvZiB0
aGVzZS4gKi8KKwlpZiAodW5saWtlbHkoY291bnQgPiBVU0hSVF9NQVggKyAxKSkgeworCQl2cV9l
cnIodnEsICJJbmRpcmVjdCBidWZmZXIgbGVuZ3RoIHRvbyBiaWc6ICVkXG4iLAorCQkgICAgICAg
aW5kaXJlY3QtPmxlbik7CisJCXJldHVybiAtRTJCSUc7CisJfQorCWlmICh1bmxpa2VseSh2cS0+
bmRlc2NzICsgY291bnQgPiB2cS0+bWF4X2Rlc2NzKSkgeworCQl2cV9lcnIodnEsICJUb28gbWFu
eSBpbmRpcmVjdCArIGRpcmVjdCBkZXNjczogJWQgKyAlZFxuIiwKKwkJICAgICAgIHZxLT5uZGVz
Y3MsIGluZGlyZWN0LT5sZW4pOworCQlyZXR1cm4gLUUyQklHOworCX0KKworCWRvIHsKKwkJaWYg
KHVubGlrZWx5KCsrZm91bmQgPiBjb3VudCkpIHsKKwkJCXZxX2Vycih2cSwgIkxvb3AgZGV0ZWN0
ZWQ6IGxhc3Qgb25lIGF0ICV1ICIKKwkJCSAgICAgICAiaW5kaXJlY3Qgc2l6ZSAldVxuIiwKKwkJ
CSAgICAgICBpLCBjb3VudCk7CisJCQlyZXR1cm4gLUVJTlZBTDsKKwkJfQorCQlpZiAodW5saWtl
bHkoIWNvcHlfZnJvbV9pdGVyX2Z1bGwoJmRlc2MsIHNpemVvZihkZXNjKSwgJmZyb20pKSkgewor
CQkJdnFfZXJyKHZxLCAiRmFpbGVkIGluZGlyZWN0IGRlc2NyaXB0b3I6IGlkeCAlZCwgJXp4XG4i
LAorCQkJICAgICAgIGksIChzaXplX3QpaW5kaXJlY3QtPmFkZHIgKyBpICogc2l6ZW9mIGRlc2Mp
OworCQkJcmV0dXJuIC1FSU5WQUw7CisJCX0KKwkJaWYgKHVubGlrZWx5KGRlc2MuZmxhZ3MgJiBj
cHVfdG9fdmhvc3QxNih2cSwgVlJJTkdfREVTQ19GX0lORElSRUNUKSkpIHsKKwkJCXZxX2Vycih2
cSwgIk5lc3RlZCBpbmRpcmVjdCBkZXNjcmlwdG9yOiBpZHggJWQsICV6eFxuIiwKKwkJCSAgICAg
ICBpLCAoc2l6ZV90KWluZGlyZWN0LT5hZGRyICsgaSAqIHNpemVvZiBkZXNjKTsKKwkJCXJldHVy
biAtRUlOVkFMOworCQl9CisKKwkJcHVzaF9zcGxpdF9kZXNjKHZxLCAmZGVzYywgaGVhZCk7CisJ
fSB3aGlsZSAoKGkgPSBuZXh0X2Rlc2ModnEsICZkZXNjKSkgIT0gLTEpOworCXJldHVybiAwOwor
fQorCitzdGF0aWMgaW50IGZldGNoX2Rlc2NzKHN0cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxKQor
eworCXVuc2lnbmVkIGludCBpLCBoZWFkLCBmb3VuZCA9IDA7CisJc3RydWN0IHZob3N0X2Rlc2Mg
Kmxhc3Q7CisJc3RydWN0IHZyaW5nX2Rlc2MgZGVzYzsKKwlfX3ZpcnRpbzE2IGF2YWlsX2lkeDsK
KwlfX3ZpcnRpbzE2IHJpbmdfaGVhZDsKKwl1MTYgbGFzdF9hdmFpbF9pZHg7CisJaW50IHJldDsK
KworCS8qIENoZWNrIGl0IGlzbid0IGRvaW5nIHZlcnkgc3RyYW5nZSB0aGluZ3Mgd2l0aCBkZXNj
cmlwdG9yIG51bWJlcnMuICovCisJbGFzdF9hdmFpbF9pZHggPSB2cS0+bGFzdF9hdmFpbF9pZHg7
CisKKwlpZiAodnEtPmF2YWlsX2lkeCA9PSB2cS0+bGFzdF9hdmFpbF9pZHgpIHsKKwkJaWYgKHVu
bGlrZWx5KHZob3N0X2dldF9hdmFpbF9pZHgodnEsICZhdmFpbF9pZHgpKSkgeworCQkJdnFfZXJy
KHZxLCAiRmFpbGVkIHRvIGFjY2VzcyBhdmFpbCBpZHggYXQgJXBcbiIsCisJCQkJJnZxLT5hdmFp
bC0+aWR4KTsKKwkJCXJldHVybiAtRUZBVUxUOworCQl9CisJCXZxLT5hdmFpbF9pZHggPSB2aG9z
dDE2X3RvX2NwdSh2cSwgYXZhaWxfaWR4KTsKKworCQlpZiAodW5saWtlbHkoKHUxNikodnEtPmF2
YWlsX2lkeCAtIGxhc3RfYXZhaWxfaWR4KSA+IHZxLT5udW0pKSB7CisJCQl2cV9lcnIodnEsICJH
dWVzdCBtb3ZlZCB1c2VkIGluZGV4IGZyb20gJXUgdG8gJXUiLAorCQkJCWxhc3RfYXZhaWxfaWR4
LCB2cS0+YXZhaWxfaWR4KTsKKwkJCXJldHVybiAtRUZBVUxUOworCQl9CisKKwkJLyogSWYgdGhl
cmUncyBub3RoaW5nIG5ldyBzaW5jZSBsYXN0IHdlIGxvb2tlZCwgcmV0dXJuCisJCSAqIGludmFs
aWQuCisJCSAqLworCQlpZiAodnEtPmF2YWlsX2lkeCA9PSBsYXN0X2F2YWlsX2lkeCkKKwkJCXJl
dHVybiB2cS0+bnVtOworCisJCS8qIE9ubHkgZ2V0IGF2YWlsIHJpbmcgZW50cmllcyBhZnRlciB0
aGV5IGhhdmUgYmVlbgorCQkgKiBleHBvc2VkIGJ5IGd1ZXN0LgorCQkgKi8KKwkJc21wX3JtYigp
OworCX0KKworCS8qIEdyYWIgdGhlIG5leHQgZGVzY3JpcHRvciBudW1iZXIgdGhleSdyZSBhZHZl
cnRpc2luZyAqLworCWlmICh1bmxpa2VseSh2aG9zdF9nZXRfYXZhaWxfaGVhZCh2cSwgJnJpbmdf
aGVhZCwgbGFzdF9hdmFpbF9pZHgpKSkgeworCQl2cV9lcnIodnEsICJGYWlsZWQgdG8gcmVhZCBo
ZWFkOiBpZHggJWQgYWRkcmVzcyAlcFxuIiwKKwkJICAgICAgIGxhc3RfYXZhaWxfaWR4LAorCQkg
ICAgICAgJnZxLT5hdmFpbC0+cmluZ1tsYXN0X2F2YWlsX2lkeCAlIHZxLT5udW1dKTsKKwkJcmV0
dXJuIC1FRkFVTFQ7CisJfQorCisJaGVhZCA9IHZob3N0MTZfdG9fY3B1KHZxLCByaW5nX2hlYWQp
OworCisJLyogSWYgdGhlaXIgbnVtYmVyIGlzIHNpbGx5LCB0aGF0J3MgYW4gZXJyb3IuICovCisJ
aWYgKHVubGlrZWx5KGhlYWQgPj0gdnEtPm51bSkpIHsKKwkJdnFfZXJyKHZxLCAiR3Vlc3Qgc2F5
cyBpbmRleCAldSA+ICV1IGlzIGF2YWlsYWJsZSIsCisJCSAgICAgICBoZWFkLCB2cS0+bnVtKTsK
KwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJaSA9IGhlYWQ7CisJZG8geworCQlpZiAodW5saWtl
bHkoaSA+PSB2cS0+bnVtKSkgeworCQkJdnFfZXJyKHZxLCAiRGVzYyBpbmRleCBpcyAldSA+ICV1
LCBoZWFkID0gJXUiLAorCQkJICAgICAgIGksIHZxLT5udW0sIGhlYWQpOworCQkJcmV0dXJuIC1F
SU5WQUw7CisJCX0KKwkJaWYgKHVubGlrZWx5KCsrZm91bmQgPiB2cS0+bnVtKSkgeworCQkJdnFf
ZXJyKHZxLCAiTG9vcCBkZXRlY3RlZDogbGFzdCBvbmUgYXQgJXUgIgorCQkJICAgICAgICJ2cSBz
aXplICV1IGhlYWQgJXVcbiIsCisJCQkgICAgICAgaSwgdnEtPm51bSwgaGVhZCk7CisJCQlyZXR1
cm4gLUVJTlZBTDsKKwkJfQorCQlyZXQgPSB2aG9zdF9nZXRfZGVzYyh2cSwgJmRlc2MsIGkpOwor
CQlpZiAodW5saWtlbHkocmV0KSkgeworCQkJdnFfZXJyKHZxLCAiRmFpbGVkIHRvIGdldCBkZXNj
cmlwdG9yOiBpZHggJWQgYWRkciAlcFxuIiwKKwkJCSAgICAgICBpLCB2cS0+ZGVzYyArIGkpOwor
CQkJcmV0dXJuIC1FRkFVTFQ7CisJCX0KKwkJcmV0ID0gcHVzaF9zcGxpdF9kZXNjKHZxLCAmZGVz
YywgaGVhZCk7CisJCWlmICh1bmxpa2VseShyZXQpKSB7CisJCQl2cV9lcnIodnEsICJGYWlsZWQg
dG8gc2F2ZSBkZXNjcmlwdG9yOiBpZHggJWRcbiIsIGkpOworCQkJcmV0dXJuIC1FSU5WQUw7CisJ
CX0KKwl9IHdoaWxlICgoaSA9IG5leHRfZGVzYyh2cSwgJmRlc2MpKSAhPSAtMSk7CisKKwlsYXN0
ID0gcGVla19zcGxpdF9kZXNjKHZxKTsKKwlpZiAodW5saWtlbHkobGFzdC0+ZmxhZ3MgJiBWUklO
R19ERVNDX0ZfSU5ESVJFQ1QpKSB7CisJCXBvcF9zcGxpdF9kZXNjKHZxKTsKKwkJcmV0ID0gZmV0
Y2hfaW5kaXJlY3RfZGVzY3ModnEsIGxhc3QsIGhlYWQpOworCQlpZiAodW5saWtlbHkocmV0IDwg
MCkpIHsKKwkJCWlmIChyZXQgIT0gLUVBR0FJTikKKwkJCQl2cV9lcnIodnEsICJGYWlsdXJlIGRl
dGVjdGVkICIKKwkJCQkgICAgICAgImluIGluZGlyZWN0IGRlc2NyaXB0b3IgYXQgaWR4ICVkXG4i
LCBoZWFkKTsKKwkJCXJldHVybiByZXQ7CisJCX0KKwl9CisKKwkvKiBBc3N1bWUgbm90aWZpY2F0
aW9ucyBmcm9tIGd1ZXN0IGFyZSBkaXNhYmxlZCBhdCB0aGlzIHBvaW50LAorCSAqIGlmIHRoZXkg
YXJlbid0IHdlIHdvdWxkIG5lZWQgdG8gdXBkYXRlIGF2YWlsX2V2ZW50IGluZGV4LiAqLworCUJV
R19PTighKHZxLT51c2VkX2ZsYWdzICYgVlJJTkdfVVNFRF9GX05PX05PVElGWSkpOworCisJLyog
T24gc3VjY2VzcywgaW5jcmVtZW50IGF2YWlsIGluZGV4LiAqLworCXZxLT5sYXN0X2F2YWlsX2lk
eCsrOworCisJcmV0dXJuIDA7Cit9CisKKy8qIFRoaXMgbG9va3MgaW4gdGhlIHZpcnRxdWV1ZSBh
bmQgZm9yIHRoZSBmaXJzdCBhdmFpbGFibGUgYnVmZmVyLCBhbmQgY29udmVydHMKKyAqIGl0IHRv
IGFuIGlvdmVjIGZvciBjb252ZW5pZW50IGFjY2Vzcy4gIFNpbmNlIGRlc2NyaXB0b3JzIGNvbnNp
c3Qgb2Ygc29tZQorICogbnVtYmVyIG9mIG91dHB1dCB0aGVuIHNvbWUgbnVtYmVyIG9mIGlucHV0
IGRlc2NyaXB0b3JzLCBpdCdzIGFjdHVhbGx5IHR3bworICogaW92ZWNzLCBidXQgd2UgcGFjayB0
aGVtIGludG8gb25lIGFuZCBub3RlIGhvdyBtYW55IG9mIGVhY2ggdGhlcmUgd2VyZS4KKyAqCisg
KiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgdGhlIGRlc2NyaXB0b3IgbnVtYmVyIGZvdW5kLCBvciB2
cS0+bnVtICh3aGljaCBpcworICogbmV2ZXIgYSB2YWxpZCBkZXNjcmlwdG9yIG51bWJlcikgaWYg
bm9uZSB3YXMgZm91bmQuICBBIG5lZ2F0aXZlIGNvZGUgaXMKKyAqIHJldHVybmVkIG9uIGVycm9y
LiAqLworaW50IHZob3N0X2dldF92cV9kZXNjX2JhdGNoKHN0cnVjdCB2aG9zdF92aXJ0cXVldWUg
KnZxLAorCQkgICAgICBzdHJ1Y3QgaW92ZWMgaW92W10sIHVuc2lnbmVkIGludCBpb3Zfc2l6ZSwK
KwkJICAgICAgdW5zaWduZWQgaW50ICpvdXRfbnVtLCB1bnNpZ25lZCBpbnQgKmluX251bSwKKwkJ
ICAgICAgc3RydWN0IHZob3N0X2xvZyAqbG9nLCB1bnNpZ25lZCBpbnQgKmxvZ19udW0pCit7CisJ
aW50IHJldCA9IGZldGNoX2Rlc2NzKHZxKTsKKwlpbnQgaTsKKworCWlmIChyZXQpCisJCXJldHVy
biByZXQ7CisKKwkvKiBOb3cgY29udmVydCB0byBJT1YgKi8KKwkvKiBXaGVuIHdlIHN0YXJ0IHRo
ZXJlIGFyZSBub25lIG9mIGVpdGhlciBpbnB1dCBub3Igb3V0cHV0LiAqLworCSpvdXRfbnVtID0g
KmluX251bSA9IDA7CisJaWYgKHVubGlrZWx5KGxvZykpCisJCSpsb2dfbnVtID0gMDsKKworCWZv
ciAoaSA9IDA7IGkgPCB2cS0+bmRlc2NzOyArK2kpIHsKKwkJdW5zaWduZWQgaW92X2NvdW50ID0g
KmluX251bSArICpvdXRfbnVtOworCQlzdHJ1Y3Qgdmhvc3RfZGVzYyAqZGVzYyA9ICZ2cS0+ZGVz
Y3NbaV07CisJCWludCBhY2Nlc3M7CisKKwkJaWYgKGRlc2MtPmZsYWdzICYgflZIT1NUX0RFU0Nf
RkxBR1MpIHsKKwkJCXZxX2Vycih2cSwgIlVuZXhwZWN0ZWQgZmxhZ3M6IDB4JXggYXQgZGVzY3Jp
cHRvciBpZCAweCV4XG4iLAorCQkJICAgICAgIGRlc2MtPmZsYWdzLCBkZXNjLT5pZCk7CisJCQly
ZXQgPSAtRUlOVkFMOworCQkJZ290byBlcnI7CisJCX0KKwkJaWYgKGRlc2MtPmZsYWdzICYgVlJJ
TkdfREVTQ19GX1dSSVRFKQorCQkJYWNjZXNzID0gVkhPU1RfQUNDRVNTX1dPOworCQllbHNlCisJ
CQlhY2Nlc3MgPSBWSE9TVF9BQ0NFU1NfUk87CisJCXJldCA9IHRyYW5zbGF0ZV9kZXNjKHZxLCBk
ZXNjLT5hZGRyLAorCQkJCSAgICAgZGVzYy0+bGVuLCBpb3YgKyBpb3ZfY291bnQsCisJCQkJICAg
ICBpb3Zfc2l6ZSAtIGlvdl9jb3VudCwgYWNjZXNzKTsKKwkJaWYgKHVubGlrZWx5KHJldCA8IDAp
KSB7CisJCQlpZiAocmV0ICE9IC1FQUdBSU4pCisJCQkJdnFfZXJyKHZxLCAiVHJhbnNsYXRpb24g
ZmFpbHVyZSAlZCBkZXNjcmlwdG9yIGlkeCAlZFxuIiwKKwkJCQkJcmV0LCBpKTsKKwkJCWdvdG8g
ZXJyOworCQl9CisJCWlmIChhY2Nlc3MgPT0gVkhPU1RfQUNDRVNTX1dPKSB7CisJCQkvKiBJZiB0
aGlzIGlzIGFuIGlucHV0IGRlc2NyaXB0b3IsCisJCQkgKiBpbmNyZW1lbnQgdGhhdCBjb3VudC4g
Ki8KKwkJCSppbl9udW0gKz0gcmV0OworCQkJaWYgKHVubGlrZWx5KGxvZyAmJiByZXQpKSB7CisJ
CQkJbG9nWypsb2dfbnVtXS5hZGRyID0gZGVzYy0+YWRkcjsKKwkJCQlsb2dbKmxvZ19udW1dLmxl
biA9IGRlc2MtPmxlbjsKKwkJCQkrKypsb2dfbnVtOworCQkJfQorCQl9IGVsc2UgeworCQkJLyog
SWYgaXQncyBhbiBvdXRwdXQgZGVzY3JpcHRvciwgdGhleSdyZSBhbGwgc3VwcG9zZWQKKwkJCSAq
IHRvIGNvbWUgYmVmb3JlIGFueSBpbnB1dCBkZXNjcmlwdG9ycy4gKi8KKwkJCWlmICh1bmxpa2Vs
eSgqaW5fbnVtKSkgeworCQkJCXZxX2Vycih2cSwgIkRlc2NyaXB0b3IgaGFzIG91dCBhZnRlciBp
bjogIgorCQkJCSAgICAgICAiaWR4ICVkXG4iLCBpKTsKKwkJCQlyZXQgPSAtRUlOVkFMOworCQkJ
CWdvdG8gZXJyOworCQkJfQorCQkJKm91dF9udW0gKz0gcmV0OworCQl9CisKKwkJcmV0ID0gZGVz
Yy0+aWQ7CisJfQorCisJdnEtPm5kZXNjcyA9IDA7CisKKwlyZXR1cm4gcmV0OworCitlcnI6CisJ
dmhvc3RfZGlzY2FyZF92cV9kZXNjKHZxLCAxKTsKKwl2cS0+bmRlc2NzID0gMDsKKworCXJldHVy
biByZXQ7Cit9CitFWFBPUlRfU1lNQk9MX0dQTCh2aG9zdF9nZXRfdnFfZGVzY19iYXRjaCk7CisK
IC8qIFJldmVyc2UgdGhlIGVmZmVjdCBvZiB2aG9zdF9nZXRfdnFfZGVzYy4gVXNlZnVsIGZvciBl
cnJvciBoYW5kbGluZy4gKi8KIHZvaWQgdmhvc3RfZGlzY2FyZF92cV9kZXNjKHN0cnVjdCB2aG9z
dF92aXJ0cXVldWUgKnZxLCBpbnQgbikKIHsKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhvc3Qvdmhv
c3QuaCBiL2RyaXZlcnMvdmhvc3Qvdmhvc3QuaAppbmRleCA2MGNhYjRjNzgyMjkuLjA5NzZhMjg1
MzkzNSAxMDA2NDQKLS0tIGEvZHJpdmVycy92aG9zdC92aG9zdC5oCisrKyBiL2RyaXZlcnMvdmhv
c3Qvdmhvc3QuaApAQCAtNjAsNiArNjAsMTMgQEAgZW51bSB2aG9zdF91YWRkcl90eXBlIHsKIAlW
SE9TVF9OVU1fQUREUlMgPSAzLAogfTsKIAorc3RydWN0IHZob3N0X2Rlc2MgeworCXU2NCBhZGRy
OworCXUzMiBsZW47CisJdTE2IGZsYWdzOyAvKiBWUklOR19ERVNDX0ZfV1JJVEUsIFZSSU5HX0RF
U0NfRl9ORVhUICovCisJdTE2IGlkOworfTsKKwogLyogVGhlIHZpcnRxdWV1ZSBzdHJ1Y3R1cmUg
ZGVzY3JpYmVzIGEgcXVldWUgYXR0YWNoZWQgdG8gYSBkZXZpY2UuICovCiBzdHJ1Y3Qgdmhvc3Rf
dmlydHF1ZXVlIHsKIAlzdHJ1Y3Qgdmhvc3RfZGV2ICpkZXY7CkBAIC03MSw2ICs3OCwxMSBAQCBz
dHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlIHsKIAl2cmluZ19hdmFpbF90IF9fdXNlciAqYXZhaWw7CiAJ
dnJpbmdfdXNlZF90IF9fdXNlciAqdXNlZDsKIAljb25zdCBzdHJ1Y3Qgdmhvc3RfaW90bGJfbWFw
ICptZXRhX2lvdGxiW1ZIT1NUX05VTV9BRERSU107CisKKwlzdHJ1Y3Qgdmhvc3RfZGVzYyAqZGVz
Y3M7CisJaW50IG5kZXNjczsKKwlpbnQgbWF4X2Rlc2NzOworCiAJc3RydWN0IGZpbGUgKmtpY2s7
CiAJc3RydWN0IGV2ZW50ZmRfY3R4ICpjYWxsX2N0eDsKIAlzdHJ1Y3QgZXZlbnRmZF9jdHggKmVy
cm9yX2N0eDsKQEAgLTE3NSw2ICsxODcsMTAgQEAgbG9uZyB2aG9zdF92cmluZ19pb2N0bChzdHJ1
Y3Qgdmhvc3RfZGV2ICpkLCB1bnNpZ25lZCBpbnQgaW9jdGwsIHZvaWQgX191c2VyICphcmcKIGJv
b2wgdmhvc3RfdnFfYWNjZXNzX29rKHN0cnVjdCB2aG9zdF92aXJ0cXVldWUgKnZxKTsKIGJvb2wg
dmhvc3RfbG9nX2FjY2Vzc19vayhzdHJ1Y3Qgdmhvc3RfZGV2ICopOwogCitpbnQgdmhvc3RfZ2V0
X3ZxX2Rlc2NfYmF0Y2goc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqLAorCQkgICAgICBzdHJ1Y3Qg
aW92ZWMgaW92W10sIHVuc2lnbmVkIGludCBpb3ZfY291bnQsCisJCSAgICAgIHVuc2lnbmVkIGlu
dCAqb3V0X251bSwgdW5zaWduZWQgaW50ICppbl9udW0sCisJCSAgICAgIHN0cnVjdCB2aG9zdF9s
b2cgKmxvZywgdW5zaWduZWQgaW50ICpsb2dfbnVtKTsKIGludCB2aG9zdF9nZXRfdnFfZGVzYyhz
dHJ1Y3Qgdmhvc3RfdmlydHF1ZXVlICosCiAJCSAgICAgIHN0cnVjdCBpb3ZlYyBpb3ZbXSwgdW5z
aWduZWQgaW50IGlvdl9jb3VudCwKIAkJICAgICAgdW5zaWduZWQgaW50ICpvdXRfbnVtLCB1bnNp
Z25lZCBpbnQgKmluX251bSwKLS0gCk1TVAoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KVmlydHVhbGl6YXRpb24gbWFpbGluZyBsaXN0ClZpcnR1YWxpemF0
aW9uQGxpc3RzLmxpbnV4LWZvdW5kYXRpb24ub3JnCmh0dHBzOi8vbGlzdHMubGludXhmb3VuZGF0
aW9uLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3ZpcnR1YWxpemF0aW9u
