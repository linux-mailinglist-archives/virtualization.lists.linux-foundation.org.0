Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
	by mail.lfdr.de (Postfix) with ESMTPS id 51DF2155E03
	for <lists.virtualization@lfdr.de>; Fri,  7 Feb 2020 19:26:23 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by whitealder.osuosl.org (Postfix) with ESMTP id E893A86DDC;
	Fri,  7 Feb 2020 18:26:21 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id O8HTb2zy9aDr; Fri,  7 Feb 2020 18:26:16 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by whitealder.osuosl.org (Postfix) with ESMTP id 47B1386E88;
	Fri,  7 Feb 2020 18:26:11 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 2B7A1C013E;
	Fri,  7 Feb 2020 18:26:11 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 90284C013E
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:26:04 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id 71858226D7
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:26:04 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id 95EJT6Kn8oPn
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:25:57 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by silver.osuosl.org (Postfix) with ESMTPS id 3EE102263E
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:25:56 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 CB156305D364; Fri,  7 Feb 2020 20:16:41 +0200 (EET)
Received: from host.bbu.bitdefender.biz (unknown [195.210.4.22])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id BC7D83052068;
 Fri,  7 Feb 2020 20:16:41 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [RFC PATCH v7 70/78] KVM: introspection: restore the state of MSR
 interception on unhook
Date: Fri,  7 Feb 2020 20:16:28 +0200
Message-Id: <20200207181636.1065-71-alazar@bitdefender.com>
In-Reply-To: <20200207181636.1065-1-alazar@bitdefender.com>
References: <20200207181636.1065-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Nicu=C8=99or=20C=C3=AE=C8=9Bu?= <ncitu@bitdefender.com>,
 Sean Christopherson <sean.j.christopherson@intel.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTmljdciZb3IgQ8OuyJt1IDxuY2l0dUBiaXRkZWZlbmRlci5jb20+CgpUaGlzIGNvbW1p
dCBhbHNvIGVuc3VyZXMgdGhhdCB0aGUgaW50cm9zcGVjdGlvbiB0b29sIGFuZCB0aGUgdXNlcnNw
YWNlCmRvIG5vdCBkaXNhYmxlIGVhY2ggb3RoZXIgdGhlIE1TUiBhY2Nlc3MgVk0tZXhpdC4KClNp
Z25lZC1vZmYtYnk6IE5pY3XImW9yIEPDrsibdSA8bmNpdHVAYml0ZGVmZW5kZXIuY29tPgpTaWdu
ZWQtb2ZmLWJ5OiBBZGFsYmVydCBMYXrEg3IgPGFsYXphckBiaXRkZWZlbmRlci5jb20+Ci0tLQog
YXJjaC94ODYvaW5jbHVkZS9hc20va3ZtaV9ob3N0LmggfCAgMTIgKysrKwogYXJjaC94ODYva3Zt
L2t2bWkuYyAgICAgICAgICAgICAgfCAxMTkgKysrKysrKysrKysrKysrKysrKysrKysrKysrLS0t
LQogYXJjaC94ODYva3ZtL3N2bS5jICAgICAgICAgICAgICAgfCAgMTEgKysrCiBhcmNoL3g4Ni9r
dm0vdm14L3ZteC5jICAgICAgICAgICB8ICAxMSArKysKIDQgZmlsZXMgY2hhbmdlZCwgMTM5IGlu
c2VydGlvbnMoKyksIDE0IGRlbGV0aW9ucygtKQoKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2luY2x1
ZGUvYXNtL2t2bWlfaG9zdC5oIGIvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtaV9ob3N0LmgKaW5k
ZXggZjlhYWZmNDVkMDgyLi44NzU3NzhkODAxNzYgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2luY2x1
ZGUvYXNtL2t2bWlfaG9zdC5oCisrKyBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5o
CkBAIC0yMyw2ICsyMywxMiBAQCBzdHJ1Y3Qga3ZtaV9pbnRlcmNlcHRpb24gewogCQkJREVDTEFS
RV9CSVRNQVAobG93LCBLVk1JX05VTV9NU1IpOwogCQkJREVDTEFSRV9CSVRNQVAoaGlnaCwgS1ZN
SV9OVU1fTVNSKTsKIAkJfSBrdm1pX21hc2s7CisJCXN0cnVjdCB7CisJCQlERUNMQVJFX0JJVE1B
UChsb3csIEtWTUlfTlVNX01TUik7CisJCQlERUNMQVJFX0JJVE1BUChoaWdoLCBLVk1JX05VTV9N
U1IpOworCQl9IGt2bV9tYXNrOworCQlib29sICgqbW9uaXRvcl9mY3QpKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSwgdTMyIG1zciwKKwkJCQkgICAgYm9vbCBlbmFibGUpOwogCX0gbXNydzsKIH07CiAK
QEAgLTQ0LDYgKzUwLDggQEAgdm9pZCBrdm1pX3hzZXRidl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUpOwogYm9vbCBrdm1pX21vbml0b3JfZGVzY19pbnRlcmNlcHQoc3RydWN0IGt2bV92Y3B1
ICp2Y3B1LCBib29sIGVuYWJsZSk7CiBib29sIGt2bWlfZGVzY3JpcHRvcl9ldmVudChzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIHU4IGRlc2NyaXB0b3IsIHU4IHdyaXRlKTsKIGJvb2wga3ZtaV9tc3Jf
ZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBzdHJ1Y3QgbXNyX2RhdGEgKm1zcik7Citib29s
IGt2bWlfbW9uaXRvcl9tc3J3X2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiBt
c3IsIGJvb2wgZW5hYmxlKTsKK2Jvb2wga3ZtaV9tc3J3X2ludGVyY2VwdF9vcmlnaW5hdG9yKHN0
cnVjdCBrdm1fdmNwdSAqdmNwdSk7CiAKICNlbHNlIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElP
TiAqLwogCkBAIC02Miw2ICs3MCwxMCBAQCBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9kZXNjcmlw
dG9yX2V2ZW50KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTggZGVzY3JpcHRvciwKIAkJCQkJIHU4
IHdyaXRlKSB7IHJldHVybiB0cnVlOyB9CiBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9tc3JfZXZl
bnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBzdHJ1Y3QgbXNyX2RhdGEgKm1zcikKIAkJCQl7IHJl
dHVybiB0cnVlOyB9CitzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9tb25pdG9yX21zcndfaW50ZXJj
ZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwKKwkJCQkJICAgICAgIGJvb2wgZW5h
YmxlKSB7IHJldHVybiBmYWxzZTsgfQorc3RhdGljIGlubGluZSBib29sIGt2bWlfbXNyd19pbnRl
cmNlcHRfb3JpZ2luYXRvcihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCisJCQkJeyByZXR1cm4gZmFs
c2U7IH0KIAogI2VuZGlmIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwogCmRpZmYgLS1n
aXQgYS9hcmNoL3g4Ni9rdm0va3ZtaS5jIGIvYXJjaC94ODYva3ZtL2t2bWkuYwppbmRleCA3NzA1
YWMxNTVjODQuLmJlZDZlMDI2OTdjYSAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL2t2bWkuYwor
KysgYi9hcmNoL3g4Ni9rdm0va3ZtaS5jCkBAIC0zNjksMjIgKzM2OSwyNSBAQCBzdGF0aWMgdm9p
ZCBrdm1pX2FyY2hfZGlzYWJsZV9kZXNjX2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUp
CiAJdmNwdS0+YXJjaC5rdm1pLT5kZXNjcmlwdG9yLmt2bV9pbnRlcmNlcHRlZCA9IGZhbHNlOwog
fQogCi1zdGF0aWMgdW5zaWduZWQgbG9uZyAqbXNyX21hc2soc3RydWN0IGt2bV92Y3B1ICp2Y3B1
LCB1bnNpZ25lZCBpbnQgKm1zcikKK3N0YXRpYyB1bnNpZ25lZCBsb25nICptc3JfbWFzayhzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGludCAqbXNyLAorCQkJICAgICAgIGJvb2wga3Zt
aSkKIHsKIAlzd2l0Y2ggKCptc3IpIHsKIAljYXNlIDAgLi4uIDB4MWZmZjoKLQkJcmV0dXJuIHZj
cHUtPmFyY2gua3ZtaS0+bXNydy5rdm1pX21hc2subG93OworCQlyZXR1cm4ga3ZtaSA/IHZjcHUt
PmFyY2gua3ZtaS0+bXNydy5rdm1pX21hc2subG93IDoKKwkJCSAgICAgIHZjcHUtPmFyY2gua3Zt
aS0+bXNydy5rdm1fbWFzay5sb3c7CiAJY2FzZSAweGMwMDAwMDAwIC4uLiAweGMwMDAxZmZmOgog
CQkqbXNyICY9IDB4MWZmZjsKLQkJcmV0dXJuIHZjcHUtPmFyY2gua3ZtaS0+bXNydy5rdm1pX21h
c2suaGlnaDsKKwkJcmV0dXJuIGt2bWkgPyB2Y3B1LT5hcmNoLmt2bWktPm1zcncua3ZtaV9tYXNr
LmhpZ2ggOgorCQkJICAgICAgdmNwdS0+YXJjaC5rdm1pLT5tc3J3Lmt2bV9tYXNrLmhpZ2g7CiAJ
fQogCiAJcmV0dXJuIE5VTEw7CiB9CiAKLXN0YXRpYyBib29sIHRlc3RfbXNyX21hc2soc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBpbnQgbXNyKQorc3RhdGljIGJvb2wgdGVzdF9tc3Jf
bWFzayhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGludCBtc3IsIGJvb2wga3ZtaSkK
IHsKLQl1bnNpZ25lZCBsb25nICptYXNrID0gbXNyX21hc2sodmNwdSwgJm1zcik7CisJdW5zaWdu
ZWQgbG9uZyAqbWFzayA9IG1zcl9tYXNrKHZjcHUsICZtc3IsIGt2bWkpOwogCiAJaWYgKCFtYXNr
KQogCQlyZXR1cm4gZmFsc2U7CkBAIC0zOTIsOSArMzk1LDI3IEBAIHN0YXRpYyBib29sIHRlc3Rf
bXNyX21hc2soc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBpbnQgbXNyKQogCXJldHVy
biAhIXRlc3RfYml0KG1zciwgbWFzayk7CiB9CiAKLXN0YXRpYyBib29sIG1zcl9jb250cm9sKHN0
cnVjdCBrdm1fdmNwdSAqdmNwdSwgdW5zaWduZWQgaW50IG1zciwgYm9vbCBlbmFibGUpCisvKgor
ICogUmV0dXJucyB0cnVlIGlmIG9uZSBzaWRlIChrdm0gb3Iga3ZtaSkgdHJpZXMgdG8gZGlzYWJs
ZSB0aGUgTVNSIHdyaXRlCisgKiBpbnRlcmNlcHRpb24gd2hpbGUgdGhlIG90aGVyIHNpZGUgaXMg
c3RpbGwgdHJhY2tpbmcgaXQuCisgKi8KK2Jvb2wga3ZtaV9tb25pdG9yX21zcndfaW50ZXJjZXB0
KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwgYm9vbCBlbmFibGUpCit7CisJc3RydWN0
IGt2bWlfaW50ZXJjZXB0aW9uICphcmNoX3ZjcHVpOworCisJaWYgKCF2Y3B1KQorCQlyZXR1cm4g
ZmFsc2U7CisKKwlhcmNoX3ZjcHVpID0gUkVBRF9PTkNFKHZjcHUtPmFyY2gua3ZtaSk7CisKKwly
ZXR1cm4gKGFyY2hfdmNwdWkgJiYgYXJjaF92Y3B1aS0+bXNydy5tb25pdG9yX2ZjdCh2Y3B1LCBt
c3IsIGVuYWJsZSkpOworfQorRVhQT1JUX1NZTUJPTChrdm1pX21vbml0b3JfbXNyd19pbnRlcmNl
cHQpOworCitzdGF0aWMgYm9vbCBtc3JfY29udHJvbChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVu
c2lnbmVkIGludCBtc3IsIGJvb2wgZW5hYmxlLAorCQkgICAgICAgYm9vbCBrdm1pKQogewotCXVu
c2lnbmVkIGxvbmcgKm1hc2sgPSBtc3JfbWFzayh2Y3B1LCAmbXNyKTsKKwl1bnNpZ25lZCBsb25n
ICptYXNrID0gbXNyX21hc2sodmNwdSwgJm1zciwga3ZtaSk7CiAKIAlpZiAoIW1hc2spCiAJCXJl
dHVybiBmYWxzZTsKQEAgLTQwNyw2ICs0MjgsNjMgQEAgc3RhdGljIGJvb2wgbXNyX2NvbnRyb2wo
c3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBpbnQgbXNyLCBib29sIGVuYWJsZSkKIAly
ZXR1cm4gdHJ1ZTsKIH0KIAorc3RhdGljIGJvb2wgbXNyX2ludGVyY2VwdGVkX2J5X2t2bWkoc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyKQoreworCXJldHVybiB0ZXN0X21zcl9tYXNrKHZj
cHUsIG1zciwgdHJ1ZSk7Cit9CisKK3N0YXRpYyBib29sIG1zcl9pbnRlcmNlcHRlZF9ieV9rdm0o
c3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyKQoreworCXJldHVybiB0ZXN0X21zcl9tYXNr
KHZjcHUsIG1zciwgZmFsc2UpOworfQorCitzdGF0aWMgdm9pZCByZWNvcmRfbXNyX2ludGVyY2Vw
dF9zdGF0dXNfZm9yX2t2bWkoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLAorCQkJCQkJ
IGJvb2wgZW5hYmxlKQoreworCW1zcl9jb250cm9sKHZjcHUsIG1zciwgZW5hYmxlLCB0cnVlKTsK
K30KKworc3RhdGljIHZvaWQgcmVjb3JkX21zcl9pbnRlcmNlcHRfc3RhdHVzX2Zvcl9rdm0oc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLAorCQkJCQkJYm9vbCBlbmFibGUpCit7CisJbXNy
X2NvbnRyb2wodmNwdSwgbXNyLCBlbmFibGUsIGZhbHNlKTsKK30KKworc3RhdGljIGJvb2wgbW9u
aXRvcl9tc3J3X2ZjdF9rdm1pKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwgYm9vbCBl
bmFibGUpCit7CisJYm9vbCByZXQgPSBmYWxzZTsKKworCWlmIChlbmFibGUpIHsKKwkJaWYgKGt2
bV94ODZfb3BzLT5tc3Jfd3JpdGVfaW50ZXJjZXB0ZWQodmNwdSwgbXNyKSkKKwkJCXJlY29yZF9t
c3JfaW50ZXJjZXB0X3N0YXR1c19mb3Jfa3ZtKHZjcHUsIG1zciwgdHJ1ZSk7CisJfSBlbHNlIHsK
KwkJaWYgKHVubGlrZWx5KCFtc3JfaW50ZXJjZXB0ZWRfYnlfa3ZtaSh2Y3B1LCBtc3IpKSkKKwkJ
CXJldCA9IHRydWU7CisKKwkJaWYgKG1zcl9pbnRlcmNlcHRlZF9ieV9rdm0odmNwdSwgbXNyKSkK
KwkJCXJldCA9IHRydWU7CisJfQorCisJcmVjb3JkX21zcl9pbnRlcmNlcHRfc3RhdHVzX2Zvcl9r
dm1pKHZjcHUsIG1zciwgZW5hYmxlKTsKKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyBib29s
IG1vbml0b3JfbXNyd19mY3Rfa3ZtKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwgYm9v
bCBlbmFibGUpCit7CisJYm9vbCByZXQgPSBmYWxzZTsKKworCWlmICghKG1zcl9pbnRlcmNlcHRl
ZF9ieV9rdm1pKHZjcHUsIG1zcikpKQorCQlyZXR1cm4gZmFsc2U7CisKKwlpZiAoIWVuYWJsZSkK
KwkJcmV0ID0gdHJ1ZTsKKworCXJlY29yZF9tc3JfaW50ZXJjZXB0X3N0YXR1c19mb3Jfa3ZtKHZj
cHUsIG1zciwgZW5hYmxlKTsKKworCXJldHVybiByZXQ7Cit9CisKIHN0YXRpYyB1bnNpZ25lZCBp
bnQgbXNyX21hc2tfdG9fYmFzZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGxvbmcg
Km1hc2spCiB7CiAJaWYgKG1hc2sgPT0gdmNwdS0+YXJjaC5rdm1pLT5tc3J3Lmt2bWlfbWFzay5o
aWdoKQpAQCAtNDE1LDYgKzQ5MywxNCBAQCBzdGF0aWMgdW5zaWduZWQgaW50IG1zcl9tYXNrX3Rv
X2Jhc2Uoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBsb25nICptYXNrKQogCXJldHVy
biAwOwogfQogCitzdGF0aWMgdm9pZCBrdm1pX2NvbnRyb2xfbXNyd19pbnRlcmNlcHQoc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLAorCQkJCQlib29sIGVuYWJsZSkKK3sKKwl2Y3B1LT5h
cmNoLmt2bWktPm1zcncubW9uaXRvcl9mY3QgPSBtb25pdG9yX21zcndfZmN0X2t2bWk7CisJa3Zt
X3g4Nl9vcHMtPmNvbnRyb2xfbXNyX2ludGVyY2VwdCh2Y3B1LCBtc3IsIE1TUl9UWVBFX1csIGVu
YWJsZSk7CisJdmNwdS0+YXJjaC5rdm1pLT5tc3J3Lm1vbml0b3JfZmN0ID0gbW9uaXRvcl9tc3J3
X2ZjdF9rdm07Cit9CisKIHN0YXRpYyB2b2lkIGt2bWlfYXJjaF9kaXNhYmxlX21zcl9pbnRlcmNl
cHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAogCQkJCQkgICAgdW5zaWduZWQgbG9uZyAqbWFzaykK
IHsKQEAgLTQyNyw5ICs1MTMsNyBAQCBzdGF0aWMgdm9pZCBrdm1pX2FyY2hfZGlzYWJsZV9tc3Jf
aW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwKIAkJaWYgKG9mZnNldCA+PSBLVk1JX05V
TV9NU1IpCiAJCQlicmVhazsKIAotCQlrdm1feDg2X29wcy0+Y29udHJvbF9tc3JfaW50ZXJjZXB0
KHZjcHUsIG1zcl9iYXNlICsgb2Zmc2V0LAotCQkJCQkJICAgTVNSX1RZUEVfVywgZmFsc2UpOwot
CQltc3JfY29udHJvbCh2Y3B1LCBtc3JfYmFzZSArIG9mZnNldCwgZmFsc2UpOworCQlrdm1pX2Nv
bnRyb2xfbXNyd19pbnRlcmNlcHQodmNwdSwgbXNyX2Jhc2UgKyBvZmZzZXQsIGZhbHNlKTsKIAl9
CiAKIAliaXRtYXBfemVybyhtYXNrLCBLVk1JX05VTV9NU1IpOwpAQCAtNTAxLDEyICs1ODUsMTQg
QEAgYm9vbCBrdm1pX2FyY2hfdmNwdV9hbGxvYyhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCiAJYXJj
aF92Y3B1aS0+YnJlYWtwb2ludC5tb25pdG9yX2ZjdCA9IG1vbml0b3JfYnBfZmN0X2t2bTsKIAlh
cmNoX3ZjcHVpLT5jcjN3Lm1vbml0b3JfZmN0ID0gbW9uaXRvcl9jcjN3X2ZjdF9rdm07CiAJYXJj
aF92Y3B1aS0+ZGVzY3JpcHRvci5tb25pdG9yX2ZjdCA9IG1vbml0b3JfZGVzY19mY3Rfa3ZtOwor
CWFyY2hfdmNwdWktPm1zcncubW9uaXRvcl9mY3QgPSBtb25pdG9yX21zcndfZmN0X2t2bTsKIAog
CS8qCiAJICogcGFpcmVkIHdpdGg6CiAJICogIC0ga3ZtaV9tb25pdG9yX2JwX2ludGVyY2VwdCgp
CiAJICogIC0ga3ZtaV9tb25pdG9yX2NyM3dfaW50ZXJjZXB0KCkKIAkgKiAgLSBrdm1pX21vbml0
b3JfZGVzY19pbnRlcmNlcHQoKQorCSAqICAtIGt2bWlfbW9uaXRvcl9tc3J3X2ludGVyY2VwdCgp
CiAJICovCiAJc21wX3dtYigpOwogCVdSSVRFX09OQ0UodmNwdS0+YXJjaC5rdm1pLCBhcmNoX3Zj
cHVpKTsKQEAgLTgyMyw2ICs5MDksMTMgQEAgc3RhdGljIGJvb2wga3ZtaV9tc3JfdmFsaWQodW5z
aWduZWQgaW50IG1zcikKIAlyZXR1cm4gZmFsc2U7CiB9CiAKK2Jvb2wga3ZtaV9tc3J3X2ludGVy
Y2VwdF9vcmlnaW5hdG9yKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkKK3sKKwlzdHJ1Y3Qga3ZtaV9p
bnRlcmNlcHRpb24gKmFyY2ggPSB2Y3B1LT5hcmNoLmt2bWk7CisKKwlyZXR1cm4gKGFyY2ggJiYg
YXJjaC0+bXNydy5tb25pdG9yX2ZjdCA9PSBtb25pdG9yX21zcndfZmN0X2t2bWkpOworfQorRVhQ
T1JUX1NZTUJPTChrdm1pX21zcndfaW50ZXJjZXB0X29yaWdpbmF0b3IpOwogCiBpbnQga3ZtaV9h
cmNoX2NtZF92Y3B1X2NvbnRyb2xfbXNyKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwKIAkJCQkgICBj
b25zdCBzdHJ1Y3Qga3ZtaV92Y3B1X2NvbnRyb2xfbXNyICpyZXEpCkBAIC04MzMsOSArOTI2LDcg
QEAgaW50IGt2bWlfYXJjaF9jbWRfdmNwdV9jb250cm9sX21zcihzdHJ1Y3Qga3ZtX3ZjcHUgKnZj
cHUsCiAJaWYgKCFrdm1pX21zcl92YWxpZChyZXEtPm1zcikpCiAJCXJldHVybiAtS1ZNX0VJTlZB
TDsKIAotCWt2bV94ODZfb3BzLT5jb250cm9sX21zcl9pbnRlcmNlcHQodmNwdSwgcmVxLT5tc3Is
IE1TUl9UWVBFX1csCi0JCQkJCSAgIHJlcS0+ZW5hYmxlKTsKLQltc3JfY29udHJvbCh2Y3B1LCBy
ZXEtPm1zciwgcmVxLT5lbmFibGUpOworCWt2bWlfY29udHJvbF9tc3J3X2ludGVyY2VwdCh2Y3B1
LCByZXEtPm1zciwgcmVxLT5lbmFibGUpOwogCiAJcmV0dXJuIDA7CiB9CkBAIC04NzIsNyArOTYz
LDcgQEAgc3RhdGljIGJvb2wgX19rdm1pX21zcl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IHN0cnVjdCBtc3JfZGF0YSAqbXNyKQogCXU2NCByZXRfdmFsdWU7CiAJdTMyIGFjdGlvbjsKIAot
CWlmICghdGVzdF9tc3JfbWFzayh2Y3B1LCBtc3ItPmluZGV4KSkKKwlpZiAoIXRlc3RfbXNyX21h
c2sodmNwdSwgbXNyLT5pbmRleCwgdHJ1ZSkpCiAJCXJldHVybiB0cnVlOwogCWlmIChrdm1feDg2
X29wcy0+Z2V0X21zcih2Y3B1LCAmb2xkX21zcikpCiAJCXJldHVybiB0cnVlOwpkaWZmIC0tZ2l0
IGEvYXJjaC94ODYva3ZtL3N2bS5jIGIvYXJjaC94ODYva3ZtL3N2bS5jCmluZGV4IDdjZDQ4ZWYy
NWY1OS4uMzA5YTdlNWU4YjYyIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vc3ZtLmMKKysrIGIv
YXJjaC94ODYva3ZtL3N2bS5jCkBAIC0xMDg1LDYgKzEwODUsMTcgQEAgc3RhdGljIHZvaWQgc2V0
X21zcl9pbnRlcmNlcHRpb24oc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAogCXVuc2lnbmVkIGxvbmcg
dG1wOwogCXUzMiBvZmZzZXQ7CiAKKyNpZmRlZiBDT05GSUdfS1ZNX0lOVFJPU1BFQ1RJT04KKwlp
ZiAoKHR5cGUgJiBNU1JfVFlQRV9XKSAmJgorCSAgICBrdm1pX21vbml0b3JfbXNyd19pbnRlcmNl
cHQodmNwdSwgbXNyLCAhdmFsdWUpKQorCQl0eXBlICY9IH5NU1JfVFlQRV9XOworCisJLyoKKwkg
KiBBdm9pZCB0aGUgYmVsb3cgd2FybmluZyBmb3Iga3ZtaSBpbnRlcmNlcHRlZCBtc3JzLgorCSAq
LworCWlmICgha3ZtaV9tc3J3X2ludGVyY2VwdF9vcmlnaW5hdG9yKHZjcHUpKQorI2VuZGlmIC8q
IENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLworCiAJLyoKIAkgKiBJZiB0aGlzIHdhcm5pbmcg
dHJpZ2dlcnMgZXh0ZW5kIHRoZSBkaXJlY3RfYWNjZXNzX21zcnMgbGlzdCBhdCB0aGUKIAkgKiBi
ZWdpbm5pbmcgb2YgdGhlIGZpbGUKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2bS92bXgvdm14LmMg
Yi9hcmNoL3g4Ni9rdm0vdm14L3ZteC5jCmluZGV4IGU0MjNkYmJmM2NmNS4uMmFhYTc0Y2FlZmZm
IDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vdm14L3ZteC5jCisrKyBiL2FyY2gveDg2L2t2bS92
bXgvdm14LmMKQEAgLTM2MzAsNiArMzYzMCwxMiBAQCBzdGF0aWMgX19hbHdheXNfaW5saW5lIHZv
aWQgdm14X2Rpc2FibGVfaW50ZXJjZXB0X2Zvcl9tc3Ioc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAog
CWlmICghY3B1X2hhc192bXhfbXNyX2JpdG1hcCgpKQogCQlyZXR1cm47CiAKKyNpZmRlZiBDT05G
SUdfS1ZNX0lOVFJPU1BFQ1RJT04KKwlpZiAoKHR5cGUgJiBNU1JfVFlQRV9XKSAmJgorCSAgICBr
dm1pX21vbml0b3JfbXNyd19pbnRlcmNlcHQodmNwdSwgbXNyLCBmYWxzZSkpCisJCXR5cGUgJj0g
fk1TUl9UWVBFX1c7CisjZW5kaWYgLyogQ09ORklHX0tWTV9JTlRST1NQRUNUSU9OICovCisKIAlp
ZiAoc3RhdGljX2JyYW5jaF91bmxpa2VseSgmZW5hYmxlX2V2bWNzKSkKIAkJZXZtY3NfdG91Y2hf
bXNyX2JpdG1hcCgpOwogCkBAIC0zNjY5LDYgKzM2NzUsMTEgQEAgc3RhdGljIF9fYWx3YXlzX2lu
bGluZSB2b2lkIHZteF9lbmFibGVfaW50ZXJjZXB0X2Zvcl9tc3Ioc3RydWN0IGt2bV92Y3B1ICp2
Y3B1LAogCWlmICghY3B1X2hhc192bXhfbXNyX2JpdG1hcCgpKQogCQlyZXR1cm47CiAKKyNpZmRl
ZiBDT05GSUdfS1ZNX0lOVFJPU1BFQ1RJT04KKwlpZiAodHlwZSAmIE1TUl9UWVBFX1cpCisJCWt2
bWlfbW9uaXRvcl9tc3J3X2ludGVyY2VwdCh2Y3B1LCBtc3IsIHRydWUpOworI2VuZGlmIC8qIENP
TkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLworCiAJaWYgKHN0YXRpY19icmFuY2hfdW5saWtlbHko
JmVuYWJsZV9ldm1jcykpCiAJCWV2bWNzX3RvdWNoX21zcl9iaXRtYXAoKTsKIApfX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpWaXJ0dWFsaXphdGlvbiBtYWls
aW5nIGxpc3QKVmlydHVhbGl6YXRpb25AbGlzdHMubGludXgtZm91bmRhdGlvbi5vcmcKaHR0cHM6
Ly9saXN0cy5saW51eGZvdW5kYXRpb24ub3JnL21haWxtYW4vbGlzdGluZm8vdmlydHVhbGl6YXRp
b24=
