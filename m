Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
	by mail.lfdr.de (Postfix) with ESMTPS id 130A8197896
	for <lists.virtualization@lfdr.de>; Mon, 30 Mar 2020 12:13:30 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by whitealder.osuosl.org (Postfix) with ESMTP id BFE3A878C0;
	Mon, 30 Mar 2020 10:13:28 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id O02Xg84WtYd2; Mon, 30 Mar 2020 10:13:21 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by whitealder.osuosl.org (Postfix) with ESMTP id 2FBE087BFF;
	Mon, 30 Mar 2020 10:13:14 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 256DFC07FF;
	Mon, 30 Mar 2020 10:13:14 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id CE6D3C07FF
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:13:06 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id B4571230F6
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:13:06 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id X2-XlFfvj-IW
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:57 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by silver.osuosl.org (Postfix) with ESMTPS id B3BE7230ED
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:12:56 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp02.buh.bitdefender.net [10.17.80.76])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 224F43074B6F; Mon, 30 Mar 2020 13:12:54 +0300 (EEST)
Received: from localhost.localdomain (unknown [91.199.104.28])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id F28E6305B7A0;
 Mon, 30 Mar 2020 13:12:53 +0300 (EEST)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v8 35/81] KVM: x86: wire in the preread/prewrite/preexec page
 trackers
Date: Mon, 30 Mar 2020 13:12:22 +0300
Message-Id: <20200330101308.21702-36-alazar@bitdefender.com>
In-Reply-To: <20200330101308.21702-1-alazar@bitdefender.com>
References: <20200330101308.21702-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 Marian Rotariu <marian.c.rotariu@gmail.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKVGhlc2UgYXJlIG5l
ZWRlZCBieSB0aGUgaW50cm9zcGVjdGlvbiBzdWJzeXN0ZW0uCgpTaWduZWQtb2ZmLWJ5OiBNaWhh
aSBEb27Im3UgPG1kb250dUBiaXRkZWZlbmRlci5jb20+CkNvLWRldmVsb3BlZC1ieTogTWFyaWFu
IFJvdGFyaXUgPG1hcmlhbi5jLnJvdGFyaXVAZ21haWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBNYXJp
YW4gUm90YXJpdSA8bWFyaWFuLmMucm90YXJpdUBnbWFpbC5jb20+ClNpZ25lZC1vZmYtYnk6IEFk
YWxiZXJ0IExhesSDciA8YWxhemFyQGJpdGRlZmVuZGVyLmNvbT4KLS0tCiBhcmNoL3g4Ni9pbmNs
dWRlL2FzbS9rdm1fZW11bGF0ZS5oIHwgIDEgKwogYXJjaC94ODYva3ZtL2VtdWxhdGUuYyAgICAg
ICAgICAgICB8ICA0ICsrKwogYXJjaC94ODYva3ZtL21tdS9tbXUuYyAgICAgICAgICAgICB8IDU3
ICsrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLQogYXJjaC94ODYva3ZtL3g4Ni5jICAgICAg
ICAgICAgICAgICB8IDQyICsrKysrKysrKysrKysrKysrLS0tLS0KIDQgZmlsZXMgY2hhbmdlZCwg
ODMgaW5zZXJ0aW9ucygrKSwgMjEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYv
aW5jbHVkZS9hc20va3ZtX2VtdWxhdGUuaCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bV9lbXVs
YXRlLmgKaW5kZXggYzA2ZTgzNTNlZmQzLi4zZGFjNTNkNTZhODUgMTAwNjQ0Ci0tLSBhL2FyY2gv
eDg2L2luY2x1ZGUvYXNtL2t2bV9lbXVsYXRlLmgKKysrIGIvYXJjaC94ODYvaW5jbHVkZS9hc20v
a3ZtX2VtdWxhdGUuaApAQCAtNDYxLDYgKzQ2MSw3IEBAIGJvb2wgeDg2X3BhZ2VfdGFibGVfd3Jp
dGluZ19pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0KTsKICNkZWZpbmUgRU1VTEFU
SU9OX09LIDAKICNkZWZpbmUgRU1VTEFUSU9OX1JFU1RBUlQgMQogI2RlZmluZSBFTVVMQVRJT05f
SU5URVJDRVBURUQgMgorI2RlZmluZSBFTVVMQVRJT05fUkVUUllfSU5TVFIgMwogdm9pZCBpbml0
X2RlY29kZV9jYWNoZShzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCk7CiBpbnQgeDg2X2Vt
dWxhdGVfaW5zbihzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCk7CiBpbnQgZW11bGF0b3Jf
dGFza19zd2l0Y2goc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQsCmRpZmYgLS1naXQgYS9h
cmNoL3g4Ni9rdm0vZW11bGF0ZS5jIGIvYXJjaC94ODYva3ZtL2VtdWxhdGUuYwppbmRleCBiYzAw
NjQyZTVkM2IuLjY1MDNmOGNlN2JlMyAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL2VtdWxhdGUu
YworKysgYi9hcmNoL3g4Ni9rdm0vZW11bGF0ZS5jCkBAIC01NDQ3LDYgKzU0NDcsOCBAQCBpbnQg
eDg2X2RlY29kZV9pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0LCB2b2lkICppbnNu
LCBpbnQgaW5zbl9sZW4pCiAJCQkJCWN0eHQtPm1lbW9wcC0+YWRkci5tZW0uZWEgKyBjdHh0LT5f
ZWlwKTsKIAogZG9uZToKKwlpZiAocmMgPT0gWDg2RU1VTF9SRVRSWV9JTlNUUikKKwkJcmV0dXJu
IEVNVUxBVElPTl9SRVRSWV9JTlNUUjsKIAlpZiAocmMgPT0gWDg2RU1VTF9QUk9QQUdBVEVfRkFV
TFQpCiAJCWN0eHQtPmhhdmVfZXhjZXB0aW9uID0gdHJ1ZTsKIAlyZXR1cm4gKHJjICE9IFg4NkVN
VUxfQ09OVElOVUUpID8gRU1VTEFUSU9OX0ZBSUxFRCA6IEVNVUxBVElPTl9PSzsKQEAgLTU4MTYs
NiArNTgxOCw4IEBAIGludCB4ODZfZW11bGF0ZV9pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0
ICpjdHh0KQogCWlmIChyYyA9PSBYODZFTVVMX0lOVEVSQ0VQVEVEKQogCQlyZXR1cm4gRU1VTEFU
SU9OX0lOVEVSQ0VQVEVEOwogCisJaWYgKHJjID09IFg4NkVNVUxfUkVUUllfSU5TVFIpCisJCXJl
dHVybiBFTVVMQVRJT05fUkVUUllfSU5TVFI7CiAJaWYgKHJjID09IFg4NkVNVUxfQ09OVElOVUUp
CiAJCXdyaXRlYmFja19yZWdpc3RlcnMoY3R4dCk7CiAKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2
bS9tbXUvbW11LmMgYi9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCmluZGV4IGJkODJjZjFmYjZhMi4u
N2M2MzY4ZGRjNmE1IDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCisrKyBiL2Fy
Y2gveDg2L2t2bS9tbXUvbW11LmMKQEAgLTEyMzMsOSArMTIzMywxMyBAQCBzdGF0aWMgdm9pZCBh
Y2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2bV9tbXVfcGFnZSAqc3Ap
CiAJc2xvdCA9IF9fZ2ZuX3RvX21lbXNsb3Qoc2xvdHMsIGdmbik7CiAKIAkvKiB0aGUgbm9uLWxl
YWYgc2hhZG93IHBhZ2VzIGFyZSBrZWVwaW5nIHJlYWRvbmx5LiAqLwotCWlmIChzcC0+cm9sZS5s
ZXZlbCA+IFBUX1BBR0VfVEFCTEVfTEVWRUwpCi0JCXJldHVybiBrdm1fc2xvdF9wYWdlX3RyYWNr
X2FkZF9wYWdlKGt2bSwgc2xvdCwgZ2ZuLAotCQkJCQkJICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRF
KTsKKwlpZiAoc3AtPnJvbGUubGV2ZWwgPiBQVF9QQUdFX1RBQkxFX0xFVkVMKSB7CisJCWt2bV9z
bG90X3BhZ2VfdHJhY2tfYWRkX3BhZ2Uoa3ZtLCBzbG90LCBnZm4sCisJCQkJCSAgICAgS1ZNX1BB
R0VfVFJBQ0tfUFJFV1JJVEUpOworCQlrdm1fc2xvdF9wYWdlX3RyYWNrX2FkZF9wYWdlKGt2bSwg
c2xvdCwgZ2ZuLAorCQkJCQkgICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRFKTsKKwkJcmV0dXJuOwor
CX0KIAogCWt2bV9tbXVfZ2ZuX2Rpc2FsbG93X2xwYWdlKHNsb3QsIGdmbik7CiB9CkBAIC0xMjYx
LDkgKzEyNjUsMTMgQEAgc3RhdGljIHZvaWQgdW5hY2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0g
Kmt2bSwgc3RydWN0IGt2bV9tbXVfcGFnZSAqc3ApCiAJZ2ZuID0gc3AtPmdmbjsKIAlzbG90cyA9
IGt2bV9tZW1zbG90c19mb3Jfc3B0ZV9yb2xlKGt2bSwgc3AtPnJvbGUpOwogCXNsb3QgPSBfX2dm
bl90b19tZW1zbG90KHNsb3RzLCBnZm4pOwotCWlmIChzcC0+cm9sZS5sZXZlbCA+IFBUX1BBR0Vf
VEFCTEVfTEVWRUwpCi0JCXJldHVybiBrdm1fc2xvdF9wYWdlX3RyYWNrX3JlbW92ZV9wYWdlKGt2
bSwgc2xvdCwgZ2ZuLAotCQkJCQkJICAgICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRFKTsKKwlpZiAo
c3AtPnJvbGUubGV2ZWwgPiBQVF9QQUdFX1RBQkxFX0xFVkVMKSB7CisJCWt2bV9zbG90X3BhZ2Vf
dHJhY2tfcmVtb3ZlX3BhZ2Uoa3ZtLCBzbG90LCBnZm4sCisJCQkJCQlLVk1fUEFHRV9UUkFDS19Q
UkVXUklURSk7CisJCWt2bV9zbG90X3BhZ2VfdHJhY2tfcmVtb3ZlX3BhZ2Uoa3ZtLCBzbG90LCBn
Zm4sCisJCQkJCQlLVk1fUEFHRV9UUkFDS19XUklURSk7CisJCXJldHVybjsKKwl9CiAKIAlrdm1f
bW11X2dmbl9hbGxvd19scGFnZShzbG90LCBnZm4pOwogfQpAQCAtMzAwMCw3ICszMDA4LDggQEAg
c3RhdGljIGJvb2wgbW11X25lZWRfd3JpdGVfcHJvdGVjdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IGdmbl90IGdmbiwKIHsKIAlzdHJ1Y3Qga3ZtX21tdV9wYWdlICpzcDsKIAotCWlmIChrdm1fcGFn
ZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19XUklURSkpCisJaWYg
KGt2bV9wYWdlX3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9QQUdFX1RSQUNLX1BSRVdS
SVRFKSB8fAorCSAgICBrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFH
RV9UUkFDS19XUklURSkpCiAJCXJldHVybiB0cnVlOwogCiAJZm9yX2VhY2hfZ2ZuX2luZGlyZWN0
X3ZhbGlkX3NwKHZjcHUtPmt2bSwgc3AsIGdmbikgewpAQCAtMzQyMyw2ICszNDMyLDIxIEBAIHN0
YXRpYyB2b2lkIGRpc2FsbG93ZWRfaHVnZXBhZ2VfYWRqdXN0KHN0cnVjdCBrdm1fc2hhZG93X3dh
bGtfaXRlcmF0b3IgaXQsCiAJfQogfQogCitzdGF0aWMgdW5zaWduZWQgaW50IGt2bV9tbXVfYXBw
bHlfaW50cm9zcGVjdGlvbl9hY2Nlc3Moc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAorCQkJCQkJCWdm
bl90IGdmbiwKKwkJCQkJCQl1bnNpZ25lZCBpbnQgYWNjKQoreworCWlmIChrdm1fcGFnZV90cmFj
a19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19QUkVSRUFEKSkKKwkJYWNjICY9
IH5BQ0NfVVNFUl9NQVNLOworCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2Zu
LCBLVk1fUEFHRV9UUkFDS19QUkVXUklURSkgfHwKKwkgICAga3ZtX3BhZ2VfdHJhY2tfaXNfYWN0
aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpKQorCQlhY2MgJj0gfkFDQ19XUklU
RV9NQVNLOworCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFH
RV9UUkFDS19QUkVFWEVDKSkKKwkJYWNjICY9IH5BQ0NfRVhFQ19NQVNLOworCisJcmV0dXJuIGFj
YzsKK30KKwogc3RhdGljIGludCBfX2RpcmVjdF9tYXAoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBn
cGFfdCBncGEsIGludCB3cml0ZSwKIAkJCWludCBtYXBfd3JpdGFibGUsIGludCBtYXhfbGV2ZWws
IGt2bV9wZm5fdCBwZm4sCiAJCQlib29sIHByZWZhdWx0LCBib29sIGFjY291bnRfZGlzYWxsb3dl
ZF9ueF9scGFnZSkKQEAgLTM0MzIsNiArMzQ1Niw3IEBAIHN0YXRpYyBpbnQgX19kaXJlY3RfbWFw
KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3BhX3QgZ3BhLCBpbnQgd3JpdGUsCiAJaW50IGxldmVs
LCByZXQ7CiAJZ2ZuX3QgZ2ZuID0gZ3BhID4+IFBBR0VfU0hJRlQ7CiAJZ2ZuX3QgYmFzZV9nZm4g
PSBnZm47CisJdW5zaWduZWQgaW50IGFjYzsKIAogCWlmIChXQVJOX09OKCFWQUxJRF9QQUdFKHZj
cHUtPmFyY2gubW11LT5yb290X2hwYSkpKQogCQlyZXR1cm4gUkVUX1BGX1JFVFJZOwpAQCAtMzQ2
MSw3ICszNDg2LDkgQEAgc3RhdGljIGludCBfX2RpcmVjdF9tYXAoc3RydWN0IGt2bV92Y3B1ICp2
Y3B1LCBncGFfdCBncGEsIGludCB3cml0ZSwKIAkJfQogCX0KIAotCXJldCA9IG1tdV9zZXRfc3B0
ZSh2Y3B1LCBpdC5zcHRlcCwgQUNDX0FMTCwKKwlhY2MgPSBrdm1fbW11X2FwcGx5X2ludHJvc3Bl
Y3Rpb25fYWNjZXNzKHZjcHUsIGJhc2VfZ2ZuLCBBQ0NfQUxMKTsKKworCXJldCA9IG1tdV9zZXRf
c3B0ZSh2Y3B1LCBpdC5zcHRlcCwgYWNjLAogCQkJICAgd3JpdGUsIGxldmVsLCBiYXNlX2dmbiwg
cGZuLCBwcmVmYXVsdCwKIAkJCSAgIG1hcF93cml0YWJsZSk7CiAJZGlyZWN0X3B0ZV9wcmVmZXRj
aCh2Y3B1LCBpdC5zcHRlcCk7CkBAIC00MTI1LDE1ICs0MTUyLDIxIEBAIHN0YXRpYyBib29sIHBh
Z2VfZmF1bHRfaGFuZGxlX3BhZ2VfdHJhY2soc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAogCWlmICh1
bmxpa2VseShlcnJvcl9jb2RlICYgUEZFUlJfUlNWRF9NQVNLKSkKIAkJcmV0dXJuIGZhbHNlOwog
Ci0JaWYgKCEoZXJyb3JfY29kZSAmIFBGRVJSX1BSRVNFTlRfTUFTSykgfHwKLQkgICAgICAhKGVy
cm9yX2NvZGUgJiBQRkVSUl9XUklURV9NQVNLKSkKKwlpZiAoIShlcnJvcl9jb2RlICYgUEZFUlJf
UFJFU0VOVF9NQVNLKSkKIAkJcmV0dXJuIGZhbHNlOwogCiAJLyoKLQkgKiBndWVzdCBpcyB3cml0
aW5nIHRoZSBwYWdlIHdoaWNoIGlzIHdyaXRlIHRyYWNrZWQgd2hpY2ggY2FuCisJICogZ3Vlc3Qg
aXMgcmVhZGluZy93cml0aW5nL2ZldGNoaW5nIHRoZSBwYWdlIHdoaWNoIGlzCisJICogcmVhZC93
cml0ZS9leGVjdXRlIHRyYWNrZWQgd2hpY2ggY2FuCiAJICogbm90IGJlIGZpeGVkIGJ5IHBhZ2Ug
ZmF1bHQgaGFuZGxlci4KIAkgKi8KLQlpZiAoa3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUs
IGdmbiwgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpKQorCWlmICgoKGVycm9yX2NvZGUgJiBQRkVSUl9V
U0VSX01BU0spCisJCSYmIGt2bV9wYWdlX3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9Q
QUdFX1RSQUNLX1BSRVJFQUQpKQorCSAgICB8fCAoKGVycm9yX2NvZGUgJiBQRkVSUl9XUklURV9N
QVNLKQorCQkmJiAoa3ZtX3BhZ2VfdHJhY2tfaXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0Vf
VFJBQ0tfUFJFV1JJVEUpCisJCSB8fCBrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2Zu
LCBLVk1fUEFHRV9UUkFDS19XUklURSkpKQorCSAgICB8fCAoKGVycm9yX2NvZGUgJiBQRkVSUl9G
RVRDSF9NQVNLKQorCQkmJiBrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1f
UEFHRV9UUkFDS19QUkVFWEVDKSkpCiAJCXJldHVybiB0cnVlOwogCiAJcmV0dXJuIGZhbHNlOwpk
aWZmIC0tZ2l0IGEvYXJjaC94ODYva3ZtL3g4Ni5jIGIvYXJjaC94ODYva3ZtL3g4Ni5jCmluZGV4
IDE3ZThhOWQ0ZTEzOC4uZDM1Y2RkYTExNWNjIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0veDg2
LmMKKysrIGIvYXJjaC94ODYva3ZtL3g4Ni5jCkBAIC01NDM1LDYgKzU0MzUsOCBAQCBzdGF0aWMg
aW50IGt2bV9yZWFkX2d1ZXN0X3ZpcnRfaGVscGVyKGd2YV90IGFkZHIsIHZvaWQgKnZhbCwgdW5z
aWduZWQgaW50IGJ5dGVzLAogCiAJCWlmIChncGEgPT0gVU5NQVBQRURfR1ZBKQogCQkJcmV0dXJu
IFg4NkVNVUxfUFJPUEFHQVRFX0ZBVUxUOworCQlpZiAoIWt2bV9wYWdlX3RyYWNrX3ByZXJlYWQo
dmNwdSwgZ3BhLCBhZGRyLCB0b3JlYWQpKQorCQkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5TVFI7
CiAJCXJldCA9IGt2bV92Y3B1X3JlYWRfZ3Vlc3RfcGFnZSh2Y3B1LCBncGEgPj4gUEFHRV9TSElG
VCwgZGF0YSwKIAkJCQkJICAgICAgIG9mZnNldCwgdG9yZWFkKTsKIAkJaWYgKHJldCA8IDApIHsK
QEAgLTU0NjYsNiArNTQ2OCw5IEBAIHN0YXRpYyBpbnQga3ZtX2ZldGNoX2d1ZXN0X3ZpcnQoc3Ry
dWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQsCiAJaWYgKHVubGlrZWx5KGdwYSA9PSBVTk1BUFBF
RF9HVkEpKQogCQlyZXR1cm4gWDg2RU1VTF9QUk9QQUdBVEVfRkFVTFQ7CiAKKwlpZiAoIWt2bV9w
YWdlX3RyYWNrX3ByZWV4ZWModmNwdSwgZ3BhLCBhZGRyKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVU
UllfSU5TVFI7CisKIAlvZmZzZXQgPSBhZGRyICYgKFBBR0VfU0laRS0xKTsKIAlpZiAoV0FSTl9P
TihvZmZzZXQgKyBieXRlcyA+IFBBR0VfU0laRSkpCiAJCWJ5dGVzID0gKHVuc2lnbmVkKVBBR0Vf
U0laRSAtIG9mZnNldDsKQEAgLTU2NDYsMTMgKzU2NTEsMjIgQEAgc3RhdGljIGludCB2Y3B1X21t
aW9fZ3ZhX3RvX2dwYShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHVuc2lnbmVkIGxvbmcgZ3ZhLAog
aW50IGVtdWxhdG9yX3dyaXRlX3BoeXMoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEs
IGd2YV90IGd2YSwKIAkJCWNvbnN0IHZvaWQgKnZhbCwgaW50IGJ5dGVzKQogewotCWludCByZXQ7
Ci0KLQlyZXQgPSBrdm1fdmNwdV93cml0ZV9ndWVzdCh2Y3B1LCBncGEsIHZhbCwgYnl0ZXMpOwot
CWlmIChyZXQgPCAwKQotCQlyZXR1cm4gMDsKKwlpZiAoIWt2bV9wYWdlX3RyYWNrX3ByZXdyaXRl
KHZjcHUsIGdwYSwgZ3ZhLCB2YWwsIGJ5dGVzKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5T
VFI7CisJaWYgKGt2bV92Y3B1X3dyaXRlX2d1ZXN0KHZjcHUsIGdwYSwgdmFsLCBieXRlcykgPCAw
KQorCQlyZXR1cm4gWDg2RU1VTF9VTkhBTkRMRUFCTEU7CiAJa3ZtX3BhZ2VfdHJhY2tfd3JpdGUo
dmNwdSwgZ3BhLCBndmEsIHZhbCwgYnl0ZXMpOwotCXJldHVybiAxOworCXJldHVybiBYODZFTVVM
X0NPTlRJTlVFOworfQorCitzdGF0aWMgaW50IGVtdWxhdG9yX3JlYWRfcGh5cyhzdHJ1Y3Qga3Zt
X3ZjcHUgKnZjcHUsIGdwYV90IGdwYSwgZ3ZhX3QgZ3ZhLAorCQkJICAgICAgdm9pZCAqdmFsLCBp
bnQgYnl0ZXMpCit7CisJaWYgKCFrdm1fcGFnZV90cmFja19wcmVyZWFkKHZjcHUsIGdwYSwgZ3Zh
LCBieXRlcykpCisJCXJldHVybiBYODZFTVVMX1JFVFJZX0lOU1RSOworCWlmIChrdm1fdmNwdV9y
ZWFkX2d1ZXN0KHZjcHUsIGdwYSwgdmFsLCBieXRlcykgPCAwKQorCQlyZXR1cm4gWDg2RU1VTF9V
TkhBTkRMRUFCTEU7CisJcmV0dXJuIFg4NkVNVUxfQ09OVElOVUU7CiB9CiAKIHN0cnVjdCByZWFk
X3dyaXRlX2VtdWxhdG9yX29wcyB7CkBAIC01NjgyLDcgKzU2OTYsNyBAQCBzdGF0aWMgaW50IHJl
YWRfcHJlcGFyZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHZvaWQgKnZhbCwgaW50IGJ5dGVzKQog
c3RhdGljIGludCByZWFkX2VtdWxhdGUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEs
IGd2YV90IGd2YSwKIAkJCXZvaWQgKnZhbCwgaW50IGJ5dGVzKQogewotCXJldHVybiAha3ZtX3Zj
cHVfcmVhZF9ndWVzdCh2Y3B1LCBncGEsIHZhbCwgYnl0ZXMpOworCXJldHVybiBlbXVsYXRvcl9y
ZWFkX3BoeXModmNwdSwgZ3BhLCBndmEsIHZhbCwgYnl0ZXMpOwogfQogCiBzdGF0aWMgaW50IHdy
aXRlX2VtdWxhdGUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBncGFfdCBncGEsIGd2YV90IGd2YSwK
QEAgLTU3NTcsOCArNTc3MSwxMSBAQCBzdGF0aWMgaW50IGVtdWxhdG9yX3JlYWRfd3JpdGVfb25l
cGFnZSh1bnNpZ25lZCBsb25nIGFkZHIsIHZvaWQgKnZhbCwKIAkJCXJldHVybiBYODZFTVVMX1BS
T1BBR0FURV9GQVVMVDsKIAl9CiAKLQlpZiAoIXJldCAmJiBvcHMtPnJlYWRfd3JpdGVfZW11bGF0
ZSh2Y3B1LCBncGEsIGFkZHIsIHZhbCwgYnl0ZXMpKQotCQlyZXR1cm4gWDg2RU1VTF9DT05USU5V
RTsKKwlpZiAoIXJldCkgeworCQlyZXQgPSBvcHMtPnJlYWRfd3JpdGVfZW11bGF0ZSh2Y3B1LCBn
cGEsIGFkZHIsIHZhbCwgYnl0ZXMpOworCQlpZiAocmV0ID09IFg4NkVNVUxfQ09OVElOVUUgfHwg
cmV0ID09IFg4NkVNVUxfUkVUUllfSU5TVFIpCisJCQlyZXR1cm4gcmV0OworCX0KIAogCS8qCiAJ
ICogSXMgdGhpcyBNTUlPIGhhbmRsZWQgbG9jYWxseT8KQEAgLTU4OTIsNiArNTkwOSw5IEBAIHN0
YXRpYyBpbnQgZW11bGF0b3JfY21weGNoZ19lbXVsYXRlZChzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4
dCAqY3R4dCwKIAlpZiAoa3ZtX3ZjcHVfbWFwKHZjcHUsIGdwYV90b19nZm4oZ3BhKSwgJm1hcCkp
CiAJCWdvdG8gZW11bF93cml0ZTsKIAorCWlmICgha3ZtX3BhZ2VfdHJhY2tfcHJld3JpdGUodmNw
dSwgZ3BhLCBhZGRyLCBuZXcsIGJ5dGVzKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVUUllfSU5TVFI7
CisKIAlrYWRkciA9IG1hcC5odmEgKyBvZmZzZXRfaW5fcGFnZShncGEpOwogCiAJc3dpdGNoIChi
eXRlcykgewpAQCAtNjc4Nyw2ICs2ODA3LDggQEAgaW50IHg4Nl9lbXVsYXRlX2luc3RydWN0aW9u
KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3BhX3QgY3IyX29yX2dwYSwKIAogCQl0cmFjZV9rdm1f
ZW11bGF0ZV9pbnNuX3N0YXJ0KHZjcHUpOwogCQkrK3ZjcHUtPnN0YXQuaW5zbl9lbXVsYXRpb247
CisJCWlmIChyID09IEVNVUxBVElPTl9SRVRSWV9JTlNUUikKKwkJCXJldHVybiAxOwogCQlpZiAo
ciAhPSBFTVVMQVRJT05fT0spICB7CiAJCQlpZiAoKGVtdWxhdGlvbl90eXBlICYgRU1VTFRZUEVf
VFJBUF9VRCkgfHwKIAkJCSAgICAoZW11bGF0aW9uX3R5cGUgJiBFTVVMVFlQRV9UUkFQX1VEX0ZP
UkNFRCkpIHsKQEAgLTY4NDUsNiArNjg2Nyw4IEBAIGludCB4ODZfZW11bGF0ZV9pbnN0cnVjdGlv
bihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGNyMl9vcl9ncGEsCiAKIAlyID0geDg2X2Vt
dWxhdGVfaW5zbihjdHh0KTsKIAorCWlmIChyID09IEVNVUxBVElPTl9SRVRSWV9JTlNUUikKKwkJ
cmV0dXJuIDE7CiAJaWYgKHIgPT0gRU1VTEFUSU9OX0lOVEVSQ0VQVEVEKQogCQlyZXR1cm4gMTsK
IApfX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fXwpWaXJ0dWFs
aXphdGlvbiBtYWlsaW5nIGxpc3QKVmlydHVhbGl6YXRpb25AbGlzdHMubGludXgtZm91bmRhdGlv
bi5vcmcKaHR0cHM6Ly9saXN0cy5saW51eGZvdW5kYXRpb24ub3JnL21haWxtYW4vbGlzdGluZm8v
dmlydHVhbGl6YXRpb24=
