Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from smtp4.osuosl.org (smtp4.osuosl.org [140.211.166.137])
	by mail.lfdr.de (Postfix) with ESMTPS id 665EA424569
	for <lists.virtualization@lfdr.de>; Wed,  6 Oct 2021 19:56:00 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by smtp4.osuosl.org (Postfix) with ESMTP id 86B504090D;
	Wed,  6 Oct 2021 17:55:54 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from smtp4.osuosl.org ([127.0.0.1])
	by localhost (smtp4.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id tR2Y9z3Tt62f; Wed,  6 Oct 2021 17:55:51 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [IPv6:2605:bc80:3010:104::8cd3:938])
	by smtp4.osuosl.org (Postfix) with ESMTPS id CF54440901;
	Wed,  6 Oct 2021 17:55:50 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 96A87C0033;
	Wed,  6 Oct 2021 17:55:49 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from smtp3.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 1E256C000D
 for <virtualization@lists.linux-foundation.org>;
 Wed,  6 Oct 2021 17:55:45 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by smtp3.osuosl.org (Postfix) with ESMTP id BABEB60EF5
 for <virtualization@lists.linux-foundation.org>;
 Wed,  6 Oct 2021 17:55:43 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from smtp3.osuosl.org ([127.0.0.1])
 by localhost (smtp3.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id DnjDPGc6CUIH
 for <virtualization@lists.linux-foundation.org>;
 Wed,  6 Oct 2021 17:55:42 +0000 (UTC)
X-Greylist: from auto-whitelisted by SQLgrey-1.8.0
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by smtp3.osuosl.org (Postfix) with ESMTPS id 7773C60EF4
 for <virtualization@lists.linux-foundation.org>;
 Wed,  6 Oct 2021 17:55:42 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 B5C91307CAE5; Wed,  6 Oct 2021 20:30:58 +0300 (EEST)
Received: from localhost (unknown [91.199.104.28])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 9AC143064495;
 Wed,  6 Oct 2021 20:30:58 +0300 (EEST)
X-Is-Junk-Enabled: fGZTSsP0qEJE2AIKtlSuFiRRwg9xyHmJ
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v12 14/77] KVM: x86: svm: use the vmx convention to control
 the MSR interception
Date: Wed,  6 Oct 2021 20:30:10 +0300
Message-Id: <20211006173113.26445-15-alazar@bitdefender.com>
In-Reply-To: <20211006173113.26445-1-alazar@bitdefender.com>
References: <20211006173113.26445-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: Tamas K Lengyel <tamas@tklengyel.com>, Wanpeng Li <wanpengli@tencent.com>,
 =?UTF-8?q?Nicu=C8=99or=20C=C3=AE=C8=9Bu?= <nicu.citu@icloud.com>,
 Sean Christopherson <seanjc@google.com>, Joerg Roedel <joro@8bytes.org>,
 virtualization@lists.linux-foundation.org,
 =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Mathieu Tarral <mathieu.tarral@protonmail.com>,
 Paolo Bonzini <pbonzini@redhat.com>, Jim Mattson <jmattson@google.com>
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTmljdciZb3IgQ8OuyJt1IDxuaWN1LmNpdHVAaWNsb3VkLmNvbT4KClRoaXMgaXMgYSBw
cmVwYXJhdG9yeSBwYXRjaCBpbiBvcmRlciB0byB1c2UgYSBjb21tb24gaW50ZXJmYWNlIHRvCmVu
YWJsZS9kaXNhYmxlIHRoZSBNU1IgaW50ZXJjZXB0aW9uLgoKQWxzbywgaXQgd2lsbCBhbGxvdyB0
byBpbmRlcGVuZGVudGx5IGNvbnRyb2wgdGhlIHJlYWQgYW5kIHdyaXRlCmludGVyY2VwdGlvbnMu
CgpTaWduZWQtb2ZmLWJ5OiBOaWN1yJlvciBDw67Im3UgPG5pY3UuY2l0dUBpY2xvdWQuY29tPgpT
aWduZWQtb2ZmLWJ5OiBBZGFsYmVydCBMYXrEg3IgPGFsYXphckBiaXRkZWZlbmRlci5jb20+Ci0t
LQogYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtX2hvc3QuaCB8ICAgNCArKwogYXJjaC94ODYva3Zt
L3N2bS9zZXYuYyAgICAgICAgICB8ICAxOCArKysrLS0KIGFyY2gveDg2L2t2bS9zdm0vc3ZtLmMg
ICAgICAgICAgfCAxMDMgKysrKysrKysrKysrKysrKysrKystLS0tLS0tLS0tLS0KIGFyY2gveDg2
L2t2bS9zdm0vc3ZtLmggICAgICAgICAgfCAgIDIgKy0KIGFyY2gveDg2L2t2bS92bXgvdm14Lmgg
ICAgICAgICAgfCAgIDQgLS0KIDUgZmlsZXMgY2hhbmdlZCwgODMgaW5zZXJ0aW9ucygrKSwgNDgg
ZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtX2hvc3Qu
aCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bV9ob3N0LmgKaW5kZXggMWU3N2NiODI1ZWM0Li43
OWIyZDhhYmZmMzYgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bV9ob3N0LmgK
KysrIGIvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtX2hvc3QuaApAQCAtMTUwLDYgKzE1MCwxMCBA
QAogI2RlZmluZSBDUl9UWVBFX1cJMgogI2RlZmluZSBDUl9UWVBFX1JXCTMKIAorI2RlZmluZSBN
U1JfVFlQRV9SCTEKKyNkZWZpbmUgTVNSX1RZUEVfVwkyCisjZGVmaW5lIE1TUl9UWVBFX1JXCTMK
KwogI2RlZmluZSBBU1lOQ19QRl9QRVJfVkNQVSA2NAogCiBlbnVtIGt2bV9yZWcgewpkaWZmIC0t
Z2l0IGEvYXJjaC94ODYva3ZtL3N2bS9zZXYuYyBiL2FyY2gveDg2L2t2bS9zdm0vc2V2LmMKaW5k
ZXggMWU4YjI2YjkzYjRmLi4yOWJmOTNjOTdiNjUgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS9z
dm0vc2V2LmMKKysrIGIvYXJjaC94ODYva3ZtL3N2bS9zZXYuYwpAQCAtMjYyMywxMiArMjYyMywx
OCBAQCB2b2lkIHNldl9lc19pbml0X3ZtY2Ioc3RydWN0IHZjcHVfc3ZtICpzdm0pCiAJc3ZtX2Ns
cl9pbnRlcmNlcHQoc3ZtLCBJTlRFUkNFUFRfWFNFVEJWKTsKIAogCS8qIENsZWFyIGludGVyY2Vw
dHMgb24gc2VsZWN0ZWQgTVNScyAqLwotCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+
bXNycG0sIE1TUl9FRkVSLCAxLCAxKTsKLQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0t
Pm1zcnBtLCBNU1JfSUEzMl9DUl9QQVQsIDEsIDEpOwotCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZj
cHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hGUk9NSVAsIDEsIDEpOwotCXNldF9t
c3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hUT0lQ
LCAxLCAxKTsKLQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEz
Ml9MQVNUSU5URlJPTUlQLCAxLCAxKTsKLQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0t
Pm1zcnBtLCBNU1JfSUEzMl9MQVNUSU5UVE9JUCwgMSwgMSk7CisJc2V0X21zcl9pbnRlcmNlcHRp
b24odmNwdSwgc3ZtLT5tc3JwbSwgTVNSX0VGRVIsIE1TUl9UWVBFX1JXLAorCQkJICAgICAxKTsK
KwlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9DUl9QQVQs
IE1TUl9UWVBFX1JXLAorCQkJICAgICAxKTsKKwlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBz
dm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUQlJBTkNIRlJPTUlQLAorCQkJICAgICBNU1JfVFlQRV9S
VywgMSk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwgc3ZtLT5tc3JwbSwgTVNSX0lBMzJf
TEFTVEJSQU5DSFRPSVAsCisJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKKwlzZXRfbXNyX2ludGVy
Y2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUSU5URlJPTUlQLAorCQkJICAg
ICBNU1JfVFlQRV9SVywgMSk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwgc3ZtLT5tc3Jw
bSwgTVNSX0lBMzJfTEFTVElOVFRPSVAsCisJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKIH0KIAog
dm9pZCBzZXZfZXNfdmNwdV9yZXNldChzdHJ1Y3QgdmNwdV9zdm0gKnN2bSkKZGlmZiAtLWdpdCBh
L2FyY2gveDg2L2t2bS9zdm0vc3ZtLmMgYi9hcmNoL3g4Ni9rdm0vc3ZtL3N2bS5jCmluZGV4IDMx
MTA5OTYxMTgzZS4uOTdmNzQwNmNmN2Q2IDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vc3ZtL3N2
bS5jCisrKyBiL2FyY2gveDg2L2t2bS9zdm0vc3ZtLmMKQEAgLTYxNiw4ICs2MTYsOCBAQCBzdGF0
aWMgaW50IGRpcmVjdF9hY2Nlc3NfbXNyX3Nsb3QodTMyIG1zcikKIAlyZXR1cm4gLUVOT0VOVDsK
IH0KIAotc3RhdGljIHZvaWQgc2V0X3NoYWRvd19tc3JfaW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSwgdTMyIG1zciwgaW50IHJlYWQsCi0JCQkJICAgICBpbnQgd3JpdGUpCitzdGF0aWMg
dm9pZCBzZXRfc2hhZG93X21zcl9pbnRlcmNlcHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIg
bXNyLAorCQkJCSAgICAgaW50IHR5cGUsIGJvb2wgdmFsdWUpCiB7CiAJc3RydWN0IHZjcHVfc3Zt
ICpzdm0gPSB0b19zdm0odmNwdSk7CiAJaW50IHNsb3QgPSBkaXJlY3RfYWNjZXNzX21zcl9zbG90
KG1zcik7CkBAIC02MjYsMTUgKzYyNiwxOSBAQCBzdGF0aWMgdm9pZCBzZXRfc2hhZG93X21zcl9p
bnRlcmNlcHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLCBpbnQgcmVhZCwKIAkJcmV0
dXJuOwogCiAJLyogU2V0IHRoZSBzaGFkb3cgYml0bWFwcyB0byB0aGUgZGVzaXJlZCBpbnRlcmNl
cHQgc3RhdGVzICovCi0JaWYgKHJlYWQpCi0JCXNldF9iaXQoc2xvdCwgc3ZtLT5zaGFkb3dfbXNy
X2ludGVyY2VwdC5yZWFkKTsKLQllbHNlCi0JCWNsZWFyX2JpdChzbG90LCBzdm0tPnNoYWRvd19t
c3JfaW50ZXJjZXB0LnJlYWQpOworCWlmICh0eXBlICYgTVNSX1RZUEVfUikgeworCQlpZiAodmFs
dWUpCisJCQlzZXRfYml0KHNsb3QsIHN2bS0+c2hhZG93X21zcl9pbnRlcmNlcHQucmVhZCk7CisJ
CWVsc2UKKwkJCWNsZWFyX2JpdChzbG90LCBzdm0tPnNoYWRvd19tc3JfaW50ZXJjZXB0LnJlYWQp
OworCX0KIAotCWlmICh3cml0ZSkKLQkJc2V0X2JpdChzbG90LCBzdm0tPnNoYWRvd19tc3JfaW50
ZXJjZXB0LndyaXRlKTsKLQllbHNlCi0JCWNsZWFyX2JpdChzbG90LCBzdm0tPnNoYWRvd19tc3Jf
aW50ZXJjZXB0LndyaXRlKTsKKwlpZiAodHlwZSAmIE1TUl9UWVBFX1cpIHsKKwkJaWYgKHZhbHVl
KQorCQkJc2V0X2JpdChzbG90LCBzdm0tPnNoYWRvd19tc3JfaW50ZXJjZXB0LndyaXRlKTsKKwkJ
ZWxzZQorCQkJY2xlYXJfYml0KHNsb3QsIHN2bS0+c2hhZG93X21zcl9pbnRlcmNlcHQud3JpdGUp
OworCX0KIH0KIAogc3RhdGljIGJvb2wgdmFsaWRfbXNyX2ludGVyY2VwdCh1MzIgaW5kZXgpCkBA
IC02NjIsNyArNjY2LDcgQEAgc3RhdGljIGJvb2wgbXNyX3dyaXRlX2ludGVyY2VwdGVkKHN0cnVj
dCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zcikKIH0KIAogc3RhdGljIHZvaWQgc2V0X21zcl9pbnRl
cmNlcHRpb25fYml0bWFwKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyICptc3JwbSwKLQkJCQkJ
dTMyIG1zciwgaW50IHJlYWQsIGludCB3cml0ZSkKKwkJCQkJdTMyIG1zciwgaW50IHR5cGUsIGJv
b2wgdmFsdWUpCiB7CiAJdTggYml0X3JlYWQsIGJpdF93cml0ZTsKIAl1bnNpZ25lZCBsb25nIHRt
cDsKQEAgLTY3NSwxMSArNjc5LDEzIEBAIHN0YXRpYyB2b2lkIHNldF9tc3JfaW50ZXJjZXB0aW9u
X2JpdG1hcChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiAqbXNycG0sCiAJV0FSTl9PTighdmFs
aWRfbXNyX2ludGVyY2VwdChtc3IpKTsKIAogCS8qIEVuZm9yY2Ugbm9uIGFsbG93ZWQgTVNScyB0
byB0cmFwICovCi0JaWYgKHJlYWQgJiYgIWt2bV9tc3JfYWxsb3dlZCh2Y3B1LCBtc3IsIEtWTV9N
U1JfRklMVEVSX1JFQUQpKQotCQlyZWFkID0gMDsKKwlpZiAodmFsdWUgJiYgKHR5cGUgJiBNU1Jf
VFlQRV9SKSAmJgorCSAgICAha3ZtX21zcl9hbGxvd2VkKHZjcHUsIG1zciwgS1ZNX01TUl9GSUxU
RVJfUkVBRCkpCisJCXR5cGUgJj0gfk1TUl9UWVBFX1I7CiAKLQlpZiAod3JpdGUgJiYgIWt2bV9t
c3JfYWxsb3dlZCh2Y3B1LCBtc3IsIEtWTV9NU1JfRklMVEVSX1dSSVRFKSkKLQkJd3JpdGUgPSAw
OworCWlmICh2YWx1ZSAmJiAodHlwZSAmIE1TUl9UWVBFX1cpICYmCisJICAgICFrdm1fbXNyX2Fs
bG93ZWQodmNwdSwgbXNyLCBLVk1fTVNSX0ZJTFRFUl9XUklURSkpCisJCXR5cGUgJj0gfk1TUl9U
WVBFX1c7CiAKIAlvZmZzZXQgICAgPSBzdm1fbXNycG1fb2Zmc2V0KG1zcik7CiAJYml0X3JlYWQg
ID0gMiAqIChtc3IgJiAweDBmKTsKQEAgLTY4OCw4ICs2OTQsMTAgQEAgc3RhdGljIHZvaWQgc2V0
X21zcl9pbnRlcmNlcHRpb25fYml0bWFwKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyICptc3Jw
bSwKIAogCUJVR19PTihvZmZzZXQgPT0gTVNSX0lOVkFMSUQpOwogCi0JcmVhZCAgPyBjbGVhcl9i
aXQoYml0X3JlYWQsICAmdG1wKSA6IHNldF9iaXQoYml0X3JlYWQsICAmdG1wKTsKLQl3cml0ZSA/
IGNsZWFyX2JpdChiaXRfd3JpdGUsICZ0bXApIDogc2V0X2JpdChiaXRfd3JpdGUsICZ0bXApOwor
CWlmICh0eXBlICYgTVNSX1RZUEVfUikKKwkJdmFsdWUgID8gY2xlYXJfYml0KGJpdF9yZWFkLCAg
JnRtcCkgOiBzZXRfYml0KGJpdF9yZWFkLCAgJnRtcCk7CisJaWYgKHR5cGUgJiBNU1JfVFlQRV9X
KQorCQl2YWx1ZSAgPyBjbGVhcl9iaXQoYml0X3dyaXRlLCAmdG1wKSA6IHNldF9iaXQoYml0X3dy
aXRlLCAmdG1wKTsKIAogCW1zcnBtW29mZnNldF0gPSB0bXA7CiAKQEAgLTY5OCwxMCArNzA2LDEw
IEBAIHN0YXRpYyB2b2lkIHNldF9tc3JfaW50ZXJjZXB0aW9uX2JpdG1hcChzdHJ1Y3Qga3ZtX3Zj
cHUgKnZjcHUsIHUzMiAqbXNycG0sCiB9CiAKIHZvaWQgc2V0X21zcl9pbnRlcmNlcHRpb24oc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgKm1zcnBtLCB1MzIgbXNyLAotCQkJICBpbnQgcmVhZCwg
aW50IHdyaXRlKQorCQkJICBpbnQgdHlwZSwgYm9vbCB2YWx1ZSkKIHsKLQlzZXRfc2hhZG93X21z
cl9pbnRlcmNlcHQodmNwdSwgbXNyLCByZWFkLCB3cml0ZSk7Ci0Jc2V0X21zcl9pbnRlcmNlcHRp
b25fYml0bWFwKHZjcHUsIG1zcnBtLCBtc3IsIHJlYWQsIHdyaXRlKTsKKwlzZXRfc2hhZG93X21z
cl9pbnRlcmNlcHQodmNwdSwgbXNyLCB0eXBlLCB2YWx1ZSk7CisJc2V0X21zcl9pbnRlcmNlcHRp
b25fYml0bWFwKHZjcHUsIG1zcnBtLCBtc3IsIHR5cGUsIHZhbHVlKTsKIH0KIAogdTMyICpzdm1f
dmNwdV9hbGxvY19tc3JwbSh2b2lkKQpAQCAtNzI2LDcgKzczNCw4IEBAIHZvaWQgc3ZtX3ZjcHVf
aW5pdF9tc3JwbShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiAqbXNycG0pCiAJZm9yIChpID0g
MDsgZGlyZWN0X2FjY2Vzc19tc3JzW2ldLmluZGV4ICE9IE1TUl9JTlZBTElEOyBpKyspIHsKIAkJ
aWYgKCFkaXJlY3RfYWNjZXNzX21zcnNbaV0uYWx3YXlzKQogCQkJY29udGludWU7Ci0JCXNldF9t
c3JfaW50ZXJjZXB0aW9uKHZjcHUsIG1zcnBtLCBkaXJlY3RfYWNjZXNzX21zcnNbaV0uaW5kZXgs
IDEsIDEpOworCQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBtc3JwbSwgZGlyZWN0X2FjY2Vz
c19tc3JzW2ldLmluZGV4LAorCQkJCSAgICAgTVNSX1RZUEVfUlcsIDEpOwogCX0KIH0KIApAQCAt
NzUxLDcgKzc2MCwxMCBAQCBzdGF0aWMgdm9pZCBzdm1fbXNyX2ZpbHRlcl9jaGFuZ2VkKHN0cnVj
dCBrdm1fdmNwdSAqdmNwdSkKIAkJdTMyIHJlYWQgPSB0ZXN0X2JpdChpLCBzdm0tPnNoYWRvd19t
c3JfaW50ZXJjZXB0LnJlYWQpOwogCQl1MzIgd3JpdGUgPSB0ZXN0X2JpdChpLCBzdm0tPnNoYWRv
d19tc3JfaW50ZXJjZXB0LndyaXRlKTsKIAotCQlzZXRfbXNyX2ludGVyY2VwdGlvbl9iaXRtYXAo
dmNwdSwgc3ZtLT5tc3JwbSwgbXNyLCByZWFkLCB3cml0ZSk7CisJCXNldF9tc3JfaW50ZXJjZXB0
aW9uX2JpdG1hcCh2Y3B1LCBzdm0tPm1zcnBtLCBtc3IsCisJCQkJCSAgICBNU1JfVFlQRV9SLCBy
ZWFkKTsKKwkJc2V0X21zcl9pbnRlcmNlcHRpb25fYml0bWFwKHZjcHUsIHN2bS0+bXNycG0sIG1z
ciwKKwkJCQkJICAgIE1TUl9UWVBFX1csIHdyaXRlKTsKIAl9CiB9CiAKQEAgLTgwMywxMCArODE1
LDE0IEBAIHN0YXRpYyB2b2lkIHN2bV9lbmFibGVfbGJydihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUp
CiAJc3RydWN0IHZjcHVfc3ZtICpzdm0gPSB0b19zdm0odmNwdSk7CiAKIAlzdm0tPnZtY2ItPmNv
bnRyb2wudmlydF9leHQgfD0gTEJSX0NUTF9FTkFCTEVfTUFTSzsKLQlzZXRfbXNyX2ludGVyY2Vw
dGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUQlJBTkNIRlJPTUlQLCAxLCAxKTsK
LQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUQlJB
TkNIVE9JUCwgMSwgMSk7Ci0Jc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwgc3ZtLT5tc3JwbSwg
TVNSX0lBMzJfTEFTVElOVEZST01JUCwgMSwgMSk7Ci0Jc2V0X21zcl9pbnRlcmNlcHRpb24odmNw
dSwgc3ZtLT5tc3JwbSwgTVNSX0lBMzJfTEFTVElOVFRPSVAsIDEsIDEpOworCXNldF9tc3JfaW50
ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hGUk9NSVAsCisJ
CQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKKwlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0t
Pm1zcnBtLCBNU1JfSUEzMl9MQVNUQlJBTkNIVE9JUCwKKwkJCSAgICAgTVNSX1RZUEVfUlcsIDEp
OworCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RJ
TlRGUk9NSVAsCisJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKKwlzZXRfbXNyX2ludGVyY2VwdGlv
bih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUSU5UVE9JUCwKKwkJCSAgICAgTVNSX1RZ
UEVfUlcsIDEpOwogfQogCiBzdGF0aWMgdm9pZCBzdm1fZGlzYWJsZV9sYnJ2KHN0cnVjdCBrdm1f
dmNwdSAqdmNwdSkKQEAgLTgxNCwxMCArODMwLDE0IEBAIHN0YXRpYyB2b2lkIHN2bV9kaXNhYmxl
X2xicnYoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogCXN0cnVjdCB2Y3B1X3N2bSAqc3ZtID0gdG9f
c3ZtKHZjcHUpOwogCiAJc3ZtLT52bWNiLT5jb250cm9sLnZpcnRfZXh0ICY9IH5MQlJfQ1RMX0VO
QUJMRV9NQVNLOwotCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9J
QTMyX0xBU1RCUkFOQ0hGUk9NSVAsIDAsIDApOwotCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUs
IHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hUT0lQLCAwLCAwKTsKLQlzZXRfbXNyX2lu
dGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNUSU5URlJPTUlQLCAwLCAw
KTsKLQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9MQVNU
SU5UVE9JUCwgMCwgMCk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwgc3ZtLT5tc3JwbSwg
TVNSX0lBMzJfTEFTVEJSQU5DSEZST01JUCwKKwkJCSAgICAgTVNSX1RZUEVfUlcsIDApOworCXNl
dF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX0xBU1RCUkFOQ0hU
T0lQLAorCQkJICAgICBNU1JfVFlQRV9SVywgMCk7CisJc2V0X21zcl9pbnRlcmNlcHRpb24odmNw
dSwgc3ZtLT5tc3JwbSwgTVNSX0lBMzJfTEFTVElOVEZST01JUCwKKwkJCSAgICAgTVNSX1RZUEVf
UlcsIDApOworCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMy
X0xBU1RJTlRUT0lQLAorCQkJICAgICBNU1JfVFlQRV9SVywgMCk7CiB9CiAKIHZvaWQgZGlzYWJs
ZV9ubWlfc2luZ2xlc3RlcChzdHJ1Y3QgdmNwdV9zdm0gKnN2bSkKQEAgLTExOTIsOCArMTIxMiwx
MCBAQCBzdGF0aWMgaW5saW5lIHZvaWQgaW5pdF92bWNiX2FmdGVyX3NldF9jcHVpZChzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUpCiAJCXN2bV9zZXRfaW50ZXJjZXB0KHN2bSwgSU5URVJDRVBUX1ZNU0FW
RSk7CiAJCXN2bS0+dm1jYi0+Y29udHJvbC52aXJ0X2V4dCAmPSB+VklSVFVBTF9WTUxPQURfVk1T
QVZFX0VOQUJMRV9NQVNLOwogCi0JCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNy
cG0sIE1TUl9JQTMyX1NZU0VOVEVSX0VJUCwgMCwgMCk7Ci0JCXNldF9tc3JfaW50ZXJjZXB0aW9u
KHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX1NZU0VOVEVSX0VTUCwgMCwgMCk7CisJCXNldF9t
c3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0sIE1TUl9JQTMyX1NZU0VOVEVSX0VJUCwK
KwkJCQkgICAgIE1TUl9UWVBFX1JXLCAwKTsKKwkJc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwg
c3ZtLT5tc3JwbSwgTVNSX0lBMzJfU1lTRU5URVJfRVNQLAorCQkJCSAgICAgTVNSX1RZUEVfUlcs
IDApOwogCX0gZWxzZSB7CiAJCS8qCiAJCSAqIElmIGhhcmR3YXJlIHN1cHBvcnRzIFZpcnR1YWwg
Vk1MT0FEIFZNU0FWRSB0aGVuIGVuYWJsZSBpdApAQCAtMTIwNSw4ICsxMjI3LDEwIEBAIHN0YXRp
YyBpbmxpbmUgdm9pZCBpbml0X3ZtY2JfYWZ0ZXJfc2V0X2NwdWlkKHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSkKIAkJCXN2bS0+dm1jYi0+Y29udHJvbC52aXJ0X2V4dCB8PSBWSVJUVUFMX1ZNTE9BRF9W
TVNBVkVfRU5BQkxFX01BU0s7CiAJCX0KIAkJLyogTm8gbmVlZCB0byBpbnRlcmNlcHQgdGhlc2Ug
TVNScyAqLwotCQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEz
Ml9TWVNFTlRFUl9FSVAsIDEsIDEpOwotCQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0t
Pm1zcnBtLCBNU1JfSUEzMl9TWVNFTlRFUl9FU1AsIDEsIDEpOworCQlzZXRfbXNyX2ludGVyY2Vw
dGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9TWVNFTlRFUl9FSVAsCisJCQkJICAgICBN
U1JfVFlQRV9SVywgMSk7CisJCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+bXNycG0s
IE1TUl9JQTMyX1NZU0VOVEVSX0VTUCwKKwkJCQkgICAgIE1TUl9UWVBFX1JXLCAxKTsKIAl9CiB9
CiAKQEAgLTEzMzQsNyArMTM1OCw4IEBAIHN0YXRpYyB2b2lkIGluaXRfdm1jYihzdHJ1Y3Qga3Zt
X3ZjcHUgKnZjcHUpCiAJICogb2YgTVNSX0lBMzJfU1BFQ19DVFJMLgogCSAqLwogCWlmIChib290
X2NwdV9oYXMoWDg2X0ZFQVRVUkVfVl9TUEVDX0NUUkwpKQotCQlzZXRfbXNyX2ludGVyY2VwdGlv
bih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9TUEVDX0NUUkwsIDEsIDEpOworCQlzZXRfbXNy
X2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9TUEVDX0NUUkwsCisJCQkJ
ICAgICBNU1JfVFlQRV9SVywgMSk7CiAKIAlpZiAoa3ZtX3ZjcHVfYXBpY3ZfYWN0aXZlKHZjcHUp
KQogCQlhdmljX2luaXRfdm1jYihzdm0pOwpAQCAtMzAwMSw3ICszMDI2LDggQEAgc3RhdGljIGlu
dCBzdm1fc2V0X21zcihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHN0cnVjdCBtc3JfZGF0YSAqbXNy
KQogCQkgKiBXZSB1cGRhdGUgdGhlIEwxIE1TUiBiaXQgYXMgd2VsbCBzaW5jZSBpdCB3aWxsIGVu
ZCB1cAogCQkgKiB0b3VjaGluZyB0aGUgTVNSIGFueXdheSBub3cuCiAJCSAqLwotCQlzZXRfbXNy
X2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9TUEVDX0NUUkwsIDEsIDEp
OworCQlzZXRfbXNyX2ludGVyY2VwdGlvbih2Y3B1LCBzdm0tPm1zcnBtLCBNU1JfSUEzMl9TUEVD
X0NUUkwsCisJCQkJICAgICBNU1JfVFlQRV9SVywgMSk7CiAJCWJyZWFrOwogCWNhc2UgTVNSX0lB
MzJfUFJFRF9DTUQ6CiAJCWlmICghbXNyLT5ob3N0X2luaXRpYXRlZCAmJgpAQCAtMzAxNiw3ICsz
MDQyLDEwIEBAIHN0YXRpYyBpbnQgc3ZtX3NldF9tc3Ioc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBz
dHJ1Y3QgbXNyX2RhdGEgKm1zcikKIAkJCWJyZWFrOwogCiAJCXdybXNybChNU1JfSUEzMl9QUkVE
X0NNRCwgUFJFRF9DTURfSUJQQik7Ci0JCXNldF9tc3JfaW50ZXJjZXB0aW9uKHZjcHUsIHN2bS0+
bXNycG0sIE1TUl9JQTMyX1BSRURfQ01ELCAwLCAxKTsKKwkJc2V0X21zcl9pbnRlcmNlcHRpb24o
dmNwdSwgc3ZtLT5tc3JwbSwgTVNSX0lBMzJfUFJFRF9DTUQsCisJCQkJICAgICBNU1JfVFlQRV9S
LCAwKTsKKwkJc2V0X21zcl9pbnRlcmNlcHRpb24odmNwdSwgc3ZtLT5tc3JwbSwgTVNSX0lBMzJf
UFJFRF9DTUQsCisJCQkJICAgICBNU1JfVFlQRV9XLCAxKTsKIAkJYnJlYWs7CiAJY2FzZSBNU1Jf
QU1ENjRfVklSVF9TUEVDX0NUUkw6CiAJCWlmICghbXNyLT5ob3N0X2luaXRpYXRlZCAmJgpkaWZm
IC0tZ2l0IGEvYXJjaC94ODYva3ZtL3N2bS9zdm0uaCBiL2FyY2gveDg2L2t2bS9zdm0vc3ZtLmgK
aW5kZXggMzJjMmQ2ZDM0MjRiLi5lMWU2M2E3YjBhNTcgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2
bS9zdm0vc3ZtLmgKKysrIGIvYXJjaC94ODYva3ZtL3N2bS9zdm0uaApAQCAtNDQwLDcgKzQ0MCw3
IEBAIGJvb2wgc3ZtX2ludGVycnVwdF9ibG9ja2VkKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSk7CiB2
b2lkIHN2bV9zZXRfZ2lmKHN0cnVjdCB2Y3B1X3N2bSAqc3ZtLCBib29sIHZhbHVlKTsKIGludCBz
dm1faW52b2tlX2V4aXRfaGFuZGxlcihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHU2NCBleGl0X2Nv
ZGUpOwogdm9pZCBzZXRfbXNyX2ludGVyY2VwdGlvbihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUz
MiAqbXNycG0sIHUzMiBtc3IsCi0JCQkgIGludCByZWFkLCBpbnQgd3JpdGUpOworCQkJICBpbnQg
dHlwZSwgYm9vbCB2YWx1ZSk7CiAKIC8qIG5lc3RlZC5jICovCiAKZGlmZiAtLWdpdCBhL2FyY2gv
eDg2L2t2bS92bXgvdm14LmggYi9hcmNoL3g4Ni9rdm0vdm14L3ZteC5oCmluZGV4IDU5MjIxN2Zk
N2Q5Mi4uZmZkZmU2MmExN2JjIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vdm14L3ZteC5oCisr
KyBiL2FyY2gveDg2L2t2bS92bXgvdm14LmgKQEAgLTE0LDEwICsxNCw2IEBACiAjaW5jbHVkZSAi
dm14X29wcy5oIgogI2luY2x1ZGUgImNwdWlkLmgiCiAKLSNkZWZpbmUgTVNSX1RZUEVfUgkxCi0j
ZGVmaW5lIE1TUl9UWVBFX1cJMgotI2RlZmluZSBNU1JfVFlQRV9SVwkzCi0KICNkZWZpbmUgWDJB
UElDX01TUihyKSAoQVBJQ19CQVNFX01TUiArICgocikgPj4gNCkpCiAKICNpZmRlZiBDT05GSUdf
WDg2XzY0Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClZp
cnR1YWxpemF0aW9uIG1haWxpbmcgbGlzdApWaXJ0dWFsaXphdGlvbkBsaXN0cy5saW51eC1mb3Vu
ZGF0aW9uLm9yZwpodHRwczovL2xpc3RzLmxpbnV4Zm91bmRhdGlvbi5vcmcvbWFpbG1hbi9saXN0
aW5mby92aXJ0dWFsaXphdGlvbg==
