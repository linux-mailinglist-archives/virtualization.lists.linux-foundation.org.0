Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
	by mail.lfdr.de (Postfix) with ESMTPS id 7701C303A32
	for <lists.virtualization@lfdr.de>; Tue, 26 Jan 2021 11:28:00 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by whitealder.osuosl.org (Postfix) with ESMTP id 33B398669F;
	Tue, 26 Jan 2021 10:27:59 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id lshyft2j0uk4; Tue, 26 Jan 2021 10:27:55 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by whitealder.osuosl.org (Postfix) with ESMTP id E8F9A8676C;
	Tue, 26 Jan 2021 10:27:54 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id CD5CDC1825;
	Tue, 26 Jan 2021 10:27:54 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from whitealder.osuosl.org (smtp1.osuosl.org [140.211.166.138])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 90281C1DA7
 for <virtualization@lists.linux-foundation.org>;
 Tue, 26 Jan 2021 10:27:53 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by whitealder.osuosl.org (Postfix) with ESMTP id 782E68676A
 for <virtualization@lists.linux-foundation.org>;
 Tue, 26 Jan 2021 10:27:53 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from whitealder.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id J7d8+ONnQ686
 for <virtualization@lists.linux-foundation.org>;
 Tue, 26 Jan 2021 10:27:49 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mga02.intel.com (mga02.intel.com [134.134.136.20])
 by whitealder.osuosl.org (Postfix) with ESMTPS id 278988668A
 for <virtualization@lists.linux-foundation.org>;
 Tue, 26 Jan 2021 10:27:49 +0000 (UTC)
IronPort-SDR: xMLy8G3XhCxxXpMsVXmjYLlKfOb9PO3IzbkZJFOtrWAAv6m07dNaFOOyL/vIB0G2OGF7g4zOg2
 tBaNTXASaS7Q==
X-IronPort-AV: E=McAfee;i="6000,8403,9875"; a="166979425"
X-IronPort-AV: E=Sophos;i="5.79,375,1602572400"; d="scan'208";a="166979425"
Received: from orsmga004.jf.intel.com ([10.7.209.38])
 by orsmga101.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 26 Jan 2021 02:27:48 -0800
IronPort-SDR: WicR44itkDdhyJrA/yfNjZSVT23QWkxB0VeRNI++AwgYRCzoJvd06qL2vHVpBsjDs5gXN5Oc1d
 pWxb39MBpTHQ==
X-IronPort-AV: E=Sophos;i="5.79,375,1602572400"; d="scan'208";a="504487464"
Received: from vkasired-desk2.fm.intel.com ([10.105.128.127])
 by orsmga004-auth.jf.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384;
 26 Jan 2021 02:27:48 -0800
From: Vivek Kasireddy <vivek.kasireddy@intel.com>
To: virtualization@lists.linux-foundation.org
Subject: [RFC v2 3/3] vhost: Add Vdmabuf backend
Date: Tue, 26 Jan 2021 02:17:35 -0800
Message-Id: <20210126101735.1304158-4-vivek.kasireddy@intel.com>
X-Mailer: git-send-email 2.26.2
In-Reply-To: <20210126101735.1304158-1-vivek.kasireddy@intel.com>
References: <20210126101735.1304158-1-vivek.kasireddy@intel.com>
MIME-Version: 1.0
Cc: daniel.vetter@intel.com, dongwon.kim@intel.com, daniel.vetter@ffwll.ch
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

VGhpcyBiYWNrZW5kIGFjdHMgYXMgdGhlIGNvdW50ZXJwYXJ0IHRvIHRoZSBWZG1hYnVmIFZpcnRp
byBmcm9udGVuZC4KV2hlbiBpdCByZWNlaXZlcyBhIG5ldyBleHBvcnQgZXZlbnQgZnJvbSB0aGUg
ZnJvbnRlbmQsIGl0IHJhaXNlcyBhbgpldmVudCB0byBhbGVydCB0aGUgUWVtdSBVSS91c2Vyc3Bh
Y2UuIFFlbXUgdGhlbiAiaW1wb3J0cyIgdGhpcyBidWZmZXIKdXNpbmcgdGhlIFVuaXF1ZSBJRC4K
CkFzIHBhcnQgb2YgdGhlIGltcG9ydCBzdGVwLCBhIG5ldyBkbWFidWYgaXMgY3JlYXRlZCBvbiB0
aGUgSG9zdCB1c2luZwp0aGUgcGFnZSBpbmZvcm1hdGlvbiBvYnRhaW5lZCBmcm9tIHRoZSBHdWVz
dC4gVGhlIGZkIGFzc29jaWF0ZWQgd2l0aAp0aGlzIGRtYWJ1ZiBpcyBtYWRlIGF2YWlsYWJsZSB0
byBRZW11IFVJL3VzZXJzcGFjZSB3aGljaCB0aGVuIGNyZWF0ZXMKYSB0ZXh0dXJlIGZyb20gaXQg
Zm9yIHRoZSBwdXJwb3NlIG9mIGRpc3BsYXlpbmcgaXQuCgpTaWduZWQtb2ZmLWJ5OiBEb25nd29u
IEtpbSA8ZG9uZ3dvbi5raW1AaW50ZWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBWaXZlayBLYXNpcmVk
ZHkgPHZpdmVrLmthc2lyZWRkeUBpbnRlbC5jb20+Ci0tLQogZHJpdmVycy92aG9zdC9LY29uZmln
ICAgICAgfCAgICA5ICsKIGRyaXZlcnMvdmhvc3QvTWFrZWZpbGUgICAgIHwgICAgMyArCiBkcml2
ZXJzL3Zob3N0L3ZkbWFidWYuYyAgICB8IDE0MDcgKysrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrKysrCiBpbmNsdWRlL3VhcGkvbGludXgvdmhvc3QuaCB8ICAgIDMgKwogNCBmaWxlcyBj
aGFuZ2VkLCAxNDIyIGluc2VydGlvbnMoKykKIGNyZWF0ZSBtb2RlIDEwMDY0NCBkcml2ZXJzL3Zo
b3N0L3ZkbWFidWYuYwoKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhvc3QvS2NvbmZpZyBiL2RyaXZl
cnMvdmhvc3QvS2NvbmZpZwppbmRleCA1ODdmYmFlMDYxODIuLjlhOTljYzI2MTFjYSAxMDA2NDQK
LS0tIGEvZHJpdmVycy92aG9zdC9LY29uZmlnCisrKyBiL2RyaXZlcnMvdmhvc3QvS2NvbmZpZwpA
QCAtODksNCArODksMTMgQEAgY29uZmlnIFZIT1NUX0NST1NTX0VORElBTl9MRUdBQ1kKIAogCSAg
SWYgdW5zdXJlLCBzYXkgIk4iLgogCitjb25maWcgVkhPU1RfVkRNQUJVRgorCWJvb2wgIlZob3N0
IGJhY2tlbmQgZm9yIHRoZSBWZG1hYnVmIGRyaXZlciIKKwlkZXBlbmRzIG9uIEtWTSAmJiBFVkVO
VEZECisJc2VsZWN0IFZIT1NUCisJZGVmYXVsdCBuCisJaGVscAorCSAgVGhpcyBkcml2ZXIgd29y
a3MgaW4gcGFpciB3aXRoIHRoZSBWaXJ0aW8gVmRtYWJ1ZiBmcm9udGVuZC4gSXQgY2FuCisJICBi
ZSB1c2VkIHRvIGNyZWF0ZSBhIGRtYWJ1ZiB1c2luZyB0aGUgcGFnZXMgc2hhcmVkIGJ5IHRoZSBH
dWVzdC4KKwogZW5kaWYKZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhvc3QvTWFrZWZpbGUgYi9kcml2
ZXJzL3Zob3N0L01ha2VmaWxlCmluZGV4IGYzZTE4OTdjY2U4NS4uNWMyY2VhNGE3ZWFmIDEwMDY0
NAotLS0gYS9kcml2ZXJzL3Zob3N0L01ha2VmaWxlCisrKyBiL2RyaXZlcnMvdmhvc3QvTWFrZWZp
bGUKQEAgLTE3LDMgKzE3LDYgQEAgb2JqLSQoQ09ORklHX1ZIT1NUKQkrPSB2aG9zdC5vCiAKIG9i
ai0kKENPTkZJR19WSE9TVF9JT1RMQikgKz0gdmhvc3RfaW90bGIubwogdmhvc3RfaW90bGIteSA6
PSBpb3RsYi5vCisKK29iai0kKENPTkZJR19WSE9TVF9WRE1BQlVGKSArPSB2aG9zdF92ZG1hYnVm
Lm8KK3Zob3N0X3ZkbWFidWYteSA6PSB2ZG1hYnVmLm8KZGlmZiAtLWdpdCBhL2RyaXZlcnMvdmhv
c3QvdmRtYWJ1Zi5jIGIvZHJpdmVycy92aG9zdC92ZG1hYnVmLmMKbmV3IGZpbGUgbW9kZSAxMDA2
NDQKaW5kZXggMDAwMDAwMDAwMDAwLi4yYThhMWQ4NTJlOTMKLS0tIC9kZXYvbnVsbAorKysgYi9k
cml2ZXJzL3Zob3N0L3ZkbWFidWYuYwpAQCAtMCwwICsxLDE0MDcgQEAKKy8vIFNQRFgtTGljZW5z
ZS1JZGVudGlmaWVyOiAoTUlUIE9SIEdQTC0yLjApCisKKy8qCisgKiBDb3B5cmlnaHQgwqkgMjAy
MSBJbnRlbCBDb3Jwb3JhdGlvbgorICoKKyAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQs
IGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCisgKiBjb3B5IG9mIHRo
aXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0
d2FyZSIpLAorICogdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwg
aW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbgorICogdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHks
IG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsCisgKiBhbmQv
b3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8g
d2hvbSB0aGUKKyAqIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0
aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CisgKgorICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3Rp
Y2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2UgKGluY2x1ZGluZyB0aGUgbmV4dAorICogcGFy
YWdyYXBoKSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBv
cnRpb25zIG9mIHRoZQorICogU29mdHdhcmUuCisgKgorICogVEhFIFNPRlRXQVJFIElTIFBST1ZJ
REVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKKyAq
IElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0Yg
TUVSQ0hBTlRBQklMSVRZLAorICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5E
IE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMCisgKiBUSEUgQVVUSE9SUyBPUiBD
T1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhF
UgorICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBP
UiBPVEhFUldJU0UsIEFSSVNJTkcKKyAqIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJ
VEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MKKyAqIElOIFRIRSBT
T0ZUV0FSRS4KKyAqCisgKiBBdXRob3JzOgorICogICAgRG9uZ3dvbiBLaW0gPGRvbmd3b24ua2lt
QGludGVsLmNvbT4KKyAqICAgIE1hdGV1c3ogUG9scm9sYSA8bWF0ZXVzei5wb2xyb2xhQGdtYWls
LmNvbT4KKyAqICAgIFZpdmVrIEthc2lyZWRkeSA8dml2ZWsua2FzaXJlZGR5QGludGVsLmNvbT4K
KyAqCisgKi8KKworI2luY2x1ZGUgPGxpbnV4L2tlcm5lbC5oPgorI2luY2x1ZGUgPGxpbnV4L2Vy
cm5vLmg+CisjaW5jbHVkZSA8bGludXgvaW5pdC5oPgorI2luY2x1ZGUgPGxpbnV4L21vZHVsZS5o
PgorI2luY2x1ZGUgPGxpbnV4L211dGV4Lmg+CisjaW5jbHVkZSA8bGludXgvbWlzY2RldmljZS5o
PgorI2luY2x1ZGUgPGxpbnV4L3dvcmtxdWV1ZS5oPgorI2luY2x1ZGUgPGxpbnV4L3NsYWIuaD4K
KyNpbmNsdWRlIDxsaW51eC9kZXZpY2UuaD4KKyNpbmNsdWRlIDxsaW51eC9oYXNodGFibGUuaD4K
KyNpbmNsdWRlIDxsaW51eC91YWNjZXNzLmg+CisjaW5jbHVkZSA8bGludXgvcG9sbC5oPgorI2lu
Y2x1ZGUgPGxpbnV4L2RtYS1idWYuaD4KKyNpbmNsdWRlIDxsaW51eC92aG9zdC5oPgorI2luY2x1
ZGUgPGxpbnV4L3ZmaW8uaD4KKyNpbmNsdWRlIDxsaW51eC9rdm1faG9zdC5oPgorI2luY2x1ZGUg
PGxpbnV4L3ZpcnRpb192ZG1hYnVmLmg+CisKKyNpbmNsdWRlICJ2aG9zdC5oIgorCisjZGVmaW5l
IFJFRlNfUEVSX1BBR0UgKFBBR0VfU0laRS9zaXplb2YobG9uZykpCisKK3N0YXRpYyBzdHJ1Y3Qg
dmlydGlvX3ZkbWFidWZfaW5mbyAqZHJ2X2luZm87CisKK3N0cnVjdCBrdm1faW5zdGFuY2Ugewor
CXN0cnVjdCBrdm0gKmt2bTsKKwlzdHJ1Y3QgbGlzdF9oZWFkIGxpbms7Cit9OworCitzdHJ1Y3Qg
dmhvc3RfdmRtYWJ1ZiB7CisJc3RydWN0IHZob3N0X2RldiBkZXY7CisJc3RydWN0IHZob3N0X3Zp
cnRxdWV1ZSB2cTsKKwlzdHJ1Y3Qgdmhvc3Rfd29yayB0eF93b3JrOworCXN0cnVjdCB2aXJ0aW9f
dmRtYWJ1Zl9ldmVudF9xdWV1ZSAqZXZxOworCXU2NCB2bWlkOworCisJLyogc3luY2hyb25pemF0
aW9uIGJldHdlZW4gdHJhbnNtaXNzaW9ucyAqLworCXN0cnVjdCBtdXRleCB0eF9tdXRleDsKKwkv
KiBzeW5jaHJvbml6YXRpb24gb24gdHggYW5kIHJ4ICovCisJc3RydWN0IG11dGV4IHZxX211dGV4
OworCisJc3RydWN0IHZpcnRpb192ZG1hYnVmX3R4bXNnIG5leHQ7CisJc3RydWN0IGxpc3RfaGVh
ZCBsaXN0OworCXN0cnVjdCBrdm0gKmt2bTsKK307CisKK3N0YXRpYyBpbmxpbmUgdm9pZCB2aG9z
dF92ZG1hYnVmX2FkZChzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqbmV3KQoreworCWxpc3RfYWRkX3Rh
aWwoJm5ldy0+bGlzdCwgJmRydl9pbmZvLT5oZWFkX3ZkbWFidWZfbGlzdCk7Cit9CisKK3N0YXRp
YyBpbmxpbmUgc3RydWN0IHZob3N0X3ZkbWFidWYgKnZob3N0X3ZkbWFidWZfZmluZCh1NjQgdm1p
ZCkKK3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqZm91bmQ7CisKKwlsaXN0X2Zvcl9lYWNoX2Vu
dHJ5KGZvdW5kLCAmZHJ2X2luZm8tPmhlYWRfdmRtYWJ1Zl9saXN0LCBsaXN0KQorCQlpZiAoZm91
bmQtPnZtaWQgPT0gdm1pZCkKKwkJCXJldHVybiBmb3VuZDsKKworCXJldHVybiBOVUxMOworfQor
CitzdGF0aWMgaW5saW5lIGJvb2wgdmhvc3RfdmRtYWJ1Zl9kZWwoc3RydWN0IHZob3N0X3ZkbWFi
dWYgKnZkbWFidWYpCit7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKml0ZXIsICp0ZW1wOworCisJ
bGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZlKGl0ZXIsIHRlbXAsCisJCQkJICZkcnZfaW5mby0+aGVh
ZF92ZG1hYnVmX2xpc3QsCisJCQkJIGxpc3QpCisJCWlmIChpdGVyID09IHZkbWFidWYpIHsKKwkJ
CWxpc3RfZGVsKCZpdGVyLT5saXN0KTsKKwkJCXJldHVybiB0cnVlOworCQl9CisKKwlyZXR1cm4g
ZmFsc2U7Cit9CisKK3N0YXRpYyBpbmxpbmUgdm9pZCB2aG9zdF92ZG1hYnVmX2RlbF9hbGwodm9p
ZCkKK3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqaXRlciwgKnRlbXA7CisKKwlsaXN0X2Zvcl9l
YWNoX2VudHJ5X3NhZmUoaXRlciwgdGVtcCwKKwkJCQkgJmRydl9pbmZvLT5oZWFkX3ZkbWFidWZf
bGlzdCwKKwkJCQkgbGlzdCkgeworCQlsaXN0X2RlbCgmaXRlci0+bGlzdCk7CisJCWtmcmVlKGl0
ZXIpOworCX0KK30KKworc3RhdGljIHZvaWQgKm1hcF9ncGEoc3RydWN0IGt2bV92Y3B1ICp2Y3B1
LCBncGFfdCBncGEpCit7CisJc3RydWN0IGt2bV9ob3N0X21hcCBtYXA7CisJaW50IHJldDsKKwor
CXJldCA9IGt2bV92Y3B1X21hcCh2Y3B1LCBncGFfdG9fZ2ZuKGdwYSksICZtYXApOworCWlmIChy
ZXQgPCAwKQorCQlyZXR1cm4gRVJSX1BUUihyZXQpOworCWVsc2UKKwkJcmV0dXJuIG1hcC5odmE7
Cit9CisKK3N0YXRpYyB2b2lkIHVubWFwX2h2YShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90
IGh2YSkKK3sKKwlzdHJ1Y3QgcGFnZSAqcGFnZSA9IHZpcnRfdG9fcGFnZShodmEpOworCXN0cnVj
dCBrdm1faG9zdF9tYXAgbWFwOworCisJbWFwLmh2YSA9ICh2b2lkICopaHZhOworCW1hcC5wYWdl
ID0gcGFnZTsKKworCWt2bV92Y3B1X3VubWFwKHZjcHUsICZtYXAsIHRydWUpOworfQorCisvKiBt
YXBwaW5nIGd1ZXN0J3MgcGFnZXMgZm9yIHRoZSB2ZG1hYnVmICovCitzdGF0aWMgaW50Cit2aG9z
dF92ZG1hYnVmX21hcF9wYWdlcyh1NjQgdm1pZCwKKwkJICAgICAgICBzdHJ1Y3QgdmlydGlvX3Zk
bWFidWZfc2hhcmVkX3BhZ2VzICpwYWdlc19pbmZvKQoreworCXN0cnVjdCB2aG9zdF92ZG1hYnVm
ICp2ZG1hYnVmID0gdmhvc3RfdmRtYWJ1Zl9maW5kKHZtaWQpOworCXN0cnVjdCBrdm1fdmNwdSAq
dmNwdTsKKwl2b2lkICpwYWRkcjsKKwlpbnQgbnBncyA9IFJFRlNfUEVSX1BBR0U7CisJaW50IGxh
c3RfbmVudHMsIG5fbDJyZWZzOworCWludCBpLCBqID0gMCwgayA9IDA7CisKKwlpZiAoIXZkbWFi
dWYgfHwgIXZkbWFidWYtPmt2bSB8fCAhcGFnZXNfaW5mbyB8fCBwYWdlc19pbmZvLT5wYWdlcykK
KwkJcmV0dXJuIC1FSU5WQUw7CisKKwl2Y3B1ID0ga3ZtX2dldF92Y3B1X2J5X2lkKHZkbWFidWYt
Pmt2bSwgMCk7CisJaWYgKCF2Y3B1KQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWxhc3RfbmVudHMg
PSAocGFnZXNfaW5mby0+bmVudHMgLSAxKSAlIG5wZ3MgKyAxOworCW5fbDJyZWZzID0gKHBhZ2Vz
X2luZm8tPm5lbnRzIC8gbnBncykgKyAoKGxhc3RfbmVudHMgPiAwKSA/IDEgOiAwKSAtCisJCSAg
IChsYXN0X25lbnRzID09IG5wZ3MpOworCisJcGFnZXNfaW5mby0+cGFnZXMgPSBrY2FsbG9jKHBh
Z2VzX2luZm8tPm5lbnRzLCBzaXplb2Yoc3RydWN0IHBhZ2UgKiksCisJCQkJICAgIEdGUF9LRVJO
RUwpOworCWlmICghcGFnZXNfaW5mby0+cGFnZXMpCisJCWdvdG8gZmFpbF9wYWdlX2FsbG9jOwor
CisJcGFnZXNfaW5mby0+bDJyZWZzID0ga2NhbGxvYyhuX2wycmVmcywgc2l6ZW9mKGdwYV90ICop
LCBHRlBfS0VSTkVMKTsKKwlpZiAoIXBhZ2VzX2luZm8tPmwycmVmcykKKwkJZ290byBmYWlsX2wy
cmVmczsKKworCXBhZ2VzX2luZm8tPmwzcmVmcyA9IChncGFfdCAqKW1hcF9ncGEodmNwdSwgcGFn
ZXNfaW5mby0+cmVmKTsKKwlpZiAoSVNfRVJSKHBhZ2VzX2luZm8tPmwzcmVmcykpCisJCWdvdG8g
ZmFpbF9sM3JlZnM7CisKKwlmb3IgKGkgPSAwOyBpIDwgbl9sMnJlZnM7IGkrKykgeworCQlwYWdl
c19pbmZvLT5sMnJlZnNbaV0gPSAoZ3BhX3QgKiltYXBfZ3BhKHZjcHUsCisJCQkJCQkJIHBhZ2Vz
X2luZm8tPmwzcmVmc1tpXSk7CisKKwkJaWYgKElTX0VSUihwYWdlc19pbmZvLT5sMnJlZnNbaV0p
KQorCQkJZ290byBmYWlsX21hcHBpbmdfbDI7CisKKwkJLyogbGFzdCBsZXZlbC0yIHJlZiAqLwor
CQlpZiAoaSA9PSBuX2wycmVmcyAtIDEpCisJCQlucGdzID0gbGFzdF9uZW50czsKKworCQlmb3Ig
KGogPSAwOyBqIDwgbnBnczsgaisrKSB7CisJCQlwYWRkciA9IG1hcF9ncGEodmNwdSwgcGFnZXNf
aW5mby0+bDJyZWZzW2ldW2pdKTsKKwkJCWlmIChJU19FUlIocGFkZHIpKQorCQkJCWdvdG8gZmFp
bF9tYXBwaW5nX2wxOworCisJCQlwYWdlc19pbmZvLT5wYWdlc1trXSA9IHZpcnRfdG9fcGFnZShw
YWRkcik7CisJCQlrKys7CisJCX0KKwkJdW5tYXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPmwzcmVm
c1tpXSk7CisJfQorCisJdW5tYXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPnJlZik7CisKKwlyZXR1
cm4gMDsKKworZmFpbF9tYXBwaW5nX2wxOgorCWZvciAoayA9IDA7IGsgPCBqOyBrKyspCisJCXVu
bWFwX2h2YSh2Y3B1LCBwYWdlc19pbmZvLT5sMnJlZnNbaV1ba10pOworCitmYWlsX21hcHBpbmdf
bDI6CisJZm9yIChqID0gMDsgaiA8IGk7IGorKykgeworCQlmb3IgKGsgPSAwOyBrIDwgUkVGU19Q
RVJfUEFHRTsgaysrKQorCQkJdW5tYXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPmwycmVmc1tpXVtr
XSk7CisJfQorCisJdW5tYXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPmwzcmVmc1tpXSk7CisJdW5t
YXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPnJlZik7CisKK2ZhaWxfbDNyZWZzOgorCWtmcmVlKHBh
Z2VzX2luZm8tPmwycmVmcyk7CisKK2ZhaWxfbDJyZWZzOgorCWtmcmVlKHBhZ2VzX2luZm8tPnBh
Z2VzKTsKKworZmFpbF9wYWdlX2FsbG9jOgorCXJldHVybiAtRU5PTUVNOworfQorCisvKiB1bm1h
cHBpbmcgbWFwcGVkIHBhZ2VzICovCitzdGF0aWMgaW50Cit2aG9zdF92ZG1hYnVmX3VubWFwX3Bh
Z2VzKHU2NCB2bWlkLAorCQkJICBzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfc2hhcmVkX3BhZ2VzICpw
YWdlc19pbmZvKQoreworCXN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmID0gdmhvc3RfdmRt
YWJ1Zl9maW5kKHZtaWQpOworCXN0cnVjdCBrdm1fdmNwdSAqdmNwdTsKKwlpbnQgbGFzdF9uZW50
cyA9IChwYWdlc19pbmZvLT5uZW50cyAtIDEpICUgUkVGU19QRVJfUEFHRSArIDE7CisJaW50IG5f
bDJyZWZzID0gKHBhZ2VzX2luZm8tPm5lbnRzIC8gUkVGU19QRVJfUEFHRSkgKworCQkgICAgICAg
KChsYXN0X25lbnRzID4gMCkgPyAxIDogMCkgLQorCQkgICAgICAgKGxhc3RfbmVudHMgPT0gUkVG
U19QRVJfUEFHRSk7CisJaW50IGksIGo7CisKKwlpZiAoIXZkbWFidWYgfHwgIXZkbWFidWYtPmt2
bSB8fCAhcGFnZXNfaW5mbyB8fCBwYWdlc19pbmZvLT5wYWdlcykKKwkJcmV0dXJuIC1FSU5WQUw7
CisKKwl2Y3B1ID0ga3ZtX2dldF92Y3B1X2J5X2lkKHZkbWFidWYtPmt2bSwgMCk7CisJaWYgKCF2
Y3B1KQorCQlyZXR1cm4gLUVJTlZBTDsKKworCWZvciAoaSA9IDA7IGkgPCBuX2wycmVmcyAtIDE7
IGkrKykgeworCQlmb3IgKGogPSAwOyBqIDwgUkVGU19QRVJfUEFHRTsgaisrKQorCQkJdW5tYXBf
aHZhKHZjcHUsIHBhZ2VzX2luZm8tPmwycmVmc1tpXVtqXSk7CisJfQorCisJZm9yIChqID0gMDsg
aiA8IGxhc3RfbmVudHM7IGorKykKKwkJdW5tYXBfaHZhKHZjcHUsIHBhZ2VzX2luZm8tPmwycmVm
c1tpXVtqXSk7CisKKwlrZnJlZShwYWdlc19pbmZvLT5sMnJlZnMpOworCWtmcmVlKHBhZ2VzX2lu
Zm8tPnBhZ2VzKTsKKwlwYWdlc19pbmZvLT5wYWdlcyA9IE5VTEw7CisKKwlyZXR1cm4gMDsKK30K
KworLyogY3JlYXRlIHNnX3RhYmxlIHdpdGggZ2l2ZW4gcGFnZXMgYW5kIG90aGVyIHBhcmFtZXRl
cnMgKi8KK3N0YXRpYyBzdHJ1Y3Qgc2dfdGFibGUgKm5ld19zZ3Qoc3RydWN0IHBhZ2UgKipwZ3Ms
CisJCQkJaW50IGZpcnN0X29mc3QsIGludCBsYXN0X2xlbiwKKwkJCQlpbnQgbmVudHMpCit7CisJ
c3RydWN0IHNnX3RhYmxlICpzZ3Q7CisJc3RydWN0IHNjYXR0ZXJsaXN0ICpzZ2w7CisJaW50IGks
IHJldDsKKworCXNndCA9IGttYWxsb2Moc2l6ZW9mKHN0cnVjdCBzZ190YWJsZSksIEdGUF9LRVJO
RUwpOworCWlmICghc2d0KQorCQlyZXR1cm4gTlVMTDsKKworCXJldCA9IHNnX2FsbG9jX3RhYmxl
KHNndCwgbmVudHMsIEdGUF9LRVJORUwpOworCWlmIChyZXQpIHsKKwkJa2ZyZWUoc2d0KTsKKwkJ
cmV0dXJuIE5VTEw7CisJfQorCisJc2dsID0gc2d0LT5zZ2w7CisJc2dfc2V0X3BhZ2Uoc2dsLCBw
Z3NbMF0sIFBBR0VfU0laRS1maXJzdF9vZnN0LCBmaXJzdF9vZnN0KTsKKworCWZvciAoaSA9IDE7
IGkgPCBuZW50cy0xOyBpKyspIHsKKwkJc2dsID0gc2dfbmV4dChzZ2wpOworCQlzZ19zZXRfcGFn
ZShzZ2wsIHBnc1tpXSwgUEFHRV9TSVpFLCAwKTsKKwl9CisKKwkvKiBtb3JlIHRoYW4gMSBwYWdl
ICovCisJaWYgKG5lbnRzID4gMSkgeworCQlzZ2wgPSBzZ19uZXh0KHNnbCk7CisJCXNnX3NldF9w
YWdlKHNnbCwgcGdzW2ldLCBsYXN0X2xlbiwgMCk7CisJfQorCisJcmV0dXJuIHNndDsKK30KKwor
c3RhdGljIHN0cnVjdCBzZ190YWJsZQorKnZob3N0X3ZkbWFidWZfZG1hYnVmX21hcChzdHJ1Y3Qg
ZG1hX2J1Zl9hdHRhY2htZW50ICphdHRhY2htZW50LAorCQkJICBlbnVtIGRtYV9kYXRhX2RpcmVj
dGlvbiBkaXIpCit7CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1ZiAqaW1wOworCisJaWYgKCFh
dHRhY2htZW50LT5kbWFidWYgfHwgIWF0dGFjaG1lbnQtPmRtYWJ1Zi0+cHJpdikKKwkJcmV0dXJu
IE5VTEw7CisKKwlpbXAgPSAoc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1ZiAqKWF0dGFjaG1lbnQt
PmRtYWJ1Zi0+cHJpdjsKKworCS8qIGlmIGJ1ZmZlciBoYXMgbmV2ZXIgYmVlbiBtYXBwZWQgKi8K
KwlpZiAoIWltcC0+c2d0KSB7CisJCWltcC0+c2d0ID0gbmV3X3NndChpbXAtPnBhZ2VzX2luZm8t
PnBhZ2VzLAorCQkJCSAgIGltcC0+cGFnZXNfaW5mby0+Zmlyc3Rfb2ZzdCwKKwkJCQkgICBpbXAt
PnBhZ2VzX2luZm8tPmxhc3RfbGVuLAorCQkJCSAgIGltcC0+cGFnZXNfaW5mby0+bmVudHMpOwor
CisJCWlmICghaW1wLT5zZ3QpCisJCQlyZXR1cm4gTlVMTDsKKwl9CisKKwlpZiAoIWRtYV9tYXBf
c2coYXR0YWNobWVudC0+ZGV2LCBpbXAtPnNndC0+c2dsLAorCQkJaW1wLT5zZ3QtPm5lbnRzLCBk
aXIpKSB7CisJCXNnX2ZyZWVfdGFibGUoaW1wLT5zZ3QpOworCQlrZnJlZShpbXAtPnNndCk7CisJ
CXJldHVybiBOVUxMOworCX0KKworCXJldHVybiBpbXAtPnNndDsKK30KKworc3RhdGljIHZvaWQK
K3Zob3N0X3ZkbWFidWZfZG1hYnVmX3VubWFwKHN0cnVjdCBkbWFfYnVmX2F0dGFjaG1lbnQgKmF0
dGFjaG1lbnQsCisJICAgCSAgICAgICAgICAgc3RydWN0IHNnX3RhYmxlICpzZywKKwkJCSAgIGVu
dW0gZG1hX2RhdGFfZGlyZWN0aW9uIGRpcikKK3sKKwlkbWFfdW5tYXBfc2coYXR0YWNobWVudC0+
ZGV2LCBzZy0+c2dsLCBzZy0+bmVudHMsIGRpcik7Cit9CisKK3N0YXRpYyBpbnQgdmhvc3RfdmRt
YWJ1Zl9kbWFidWZfbW1hcChzdHJ1Y3QgZG1hX2J1ZiAqZG1hYnVmLAorCQkJCSAgICAgc3RydWN0
IHZtX2FyZWFfc3RydWN0ICp2bWEpCit7CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1ZiAqaW1w
OworCXU2NCB1YWRkcjsKKwlpbnQgaSwgZXJyOworCisJaWYgKCFkbWFidWYtPnByaXYpCisJCXJl
dHVybiAtRUlOVkFMOworCisJaW1wID0gKHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9idWYgKilkbWFi
dWYtPnByaXY7CisKKwlpZiAoIWltcC0+cGFnZXNfaW5mbykKKwkJcmV0dXJuIC1FSU5WQUw7CisK
Kwl2bWEtPnZtX2ZsYWdzIHw9IFZNX0RPTlRFWFBBTkQgfCBWTV9ET05URFVNUDsKKworCXVhZGRy
ID0gdm1hLT52bV9zdGFydDsKKwlmb3IgKGkgPSAwOyBpIDwgaW1wLT5wYWdlc19pbmZvLT5uZW50
czsgaSsrKSB7CisJCWVyciA9IHZtX2luc2VydF9wYWdlKHZtYSwgdWFkZHIsCisJCQkJICAgICBp
bXAtPnBhZ2VzX2luZm8tPnBhZ2VzW2ldKTsKKwkJaWYgKGVycikKKwkJCXJldHVybiBlcnI7CisK
KwkJdWFkZHIgKz0gUEFHRV9TSVpFOworCX0KKworCXJldHVybiAwOworfQorCitzdGF0aWMgaW50
IHZob3N0X3ZkbWFidWZfZG1hYnVmX3ZtYXAoc3RydWN0IGRtYV9idWYgKmRtYWJ1ZiwKKwkJCQkg
ICAgIHN0cnVjdCBkbWFfYnVmX21hcCAqbWFwKQoreworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9i
dWYgKmltcDsKKwl2b2lkICphZGRyOworCisJaWYgKCFkbWFidWYtPnByaXYpCisJCXJldHVybiAt
RUlOVkFMOworCisJaW1wID0gKHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9idWYgKilkbWFidWYtPnBy
aXY7CisKKwlpZiAoIWltcC0+cGFnZXNfaW5mbykKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlhZGRy
ID0gdm1hcChpbXAtPnBhZ2VzX2luZm8tPnBhZ2VzLCBpbXAtPnBhZ2VzX2luZm8tPm5lbnRzLAor
ICAgICAgICAgICAgICAgICAgICAwLCBQQUdFX0tFUk5FTCk7CisJaWYgKElTX0VSUihhZGRyKSkK
KwkJcmV0dXJuIFBUUl9FUlIoYWRkcik7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIHZvaWQg
dmhvc3RfdmRtYWJ1Zl9kbWFidWZfcmVsZWFzZShzdHJ1Y3QgZG1hX2J1ZiAqZG1hX2J1ZikKK3sK
KwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICppbXA7CisKKwlpZiAoIWRtYV9idWYtPnByaXYp
CisJCXJldHVybjsKKworCWltcCA9IChzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICopZG1hX2J1
Zi0+cHJpdjsKKwlpbXAtPmRtYV9idWYgPSBOVUxMOworCWltcC0+dmFsaWQgPSBmYWxzZTsKKwor
CXZob3N0X3ZkbWFidWZfdW5tYXBfcGFnZXMoaW1wLT52bWlkLCBpbXAtPnBhZ2VzX2luZm8pOwor
CXZpcnRpb192ZG1hYnVmX2RlbF9idWYoZHJ2X2luZm8sICZpbXAtPmJ1Zl9pZCk7CisKKwlpZiAo
aW1wLT5zZ3QpIHsKKwkJc2dfZnJlZV90YWJsZShpbXAtPnNndCk7CisJCWtmcmVlKGltcC0+c2d0
KTsKKwkJaW1wLT5zZ3QgPSBOVUxMOworCX0KKworCWtmcmVlKGltcC0+cHJpdik7CisJa2ZyZWUo
aW1wLT5wYWdlc19pbmZvKTsKKwlrZnJlZShpbXApOworfQorCitzdGF0aWMgY29uc3Qgc3RydWN0
IGRtYV9idWZfb3BzIHZob3N0X3ZkbWFidWZfZG1hYnVmX29wcyA9IHsKKwkubWFwX2RtYV9idWYg
PSB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl9tYXAsCisJLnVubWFwX2RtYV9idWYgPSB2aG9zdF92ZG1h
YnVmX2RtYWJ1Zl91bm1hcCwKKwkucmVsZWFzZSA9IHZob3N0X3ZkbWFidWZfZG1hYnVmX3JlbGVh
c2UsCisJLm1tYXAgPSB2aG9zdF92ZG1hYnVmX2RtYWJ1Zl9tbWFwLAorCS52bWFwID0gdmhvc3Rf
dmRtYWJ1Zl9kbWFidWZfdm1hcCwKK307CisKKy8qIGV4cG9ydGluZyBkbWFidWYgYXMgZmQgKi8K
K3N0YXRpYyBpbnQgdmhvc3RfdmRtYWJ1Zl9leHBfZmQoc3RydWN0IHZpcnRpb192ZG1hYnVmX2J1
ZiAqaW1wLCBpbnQgZmxhZ3MpCit7CisJREVGSU5FX0RNQV9CVUZfRVhQT1JUX0lORk8oZXhwX2lu
Zm8pOworCisJZXhwX2luZm8ub3BzID0gJnZob3N0X3ZkbWFidWZfZG1hYnVmX29wczsKKworCS8q
IG11bHRpcGxlIG9mIFBBR0VfU0laRSwgbm90IGNvbnNpZGVyaW5nIG9mZnNldCAqLworCWV4cF9p
bmZvLnNpemUgPSBpbXAtPnBhZ2VzX2luZm8tPm5lbnRzICogUEFHRV9TSVpFOworCWV4cF9pbmZv
LmZsYWdzID0gMDsKKwlleHBfaW5mby5wcml2ID0gaW1wOworCisJaWYgKCFpbXAtPmRtYV9idWYp
IHsKKwkJaW1wLT5kbWFfYnVmID0gZG1hX2J1Zl9leHBvcnQoJmV4cF9pbmZvKTsKKwkJaWYgKElT
X0VSUl9PUl9OVUxMKGltcC0+ZG1hX2J1ZikpIHsKKwkJCWltcC0+ZG1hX2J1ZiA9IE5VTEw7CisJ
CQlyZXR1cm4gLUVJTlZBTDsKKwkJfQorCX0KKworCXJldHVybiBkbWFfYnVmX2ZkKGltcC0+ZG1h
X2J1ZiwgZmxhZ3MpOworfQorCitzdGF0aWMgaW50IHZob3N0X3ZkbWFidWZfYWRkX2V2ZW50KHN0
cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmLAorCQkJCSAgIHN0cnVjdCB2aXJ0aW9fdmRtYWJ1
Zl9idWYgKmJ1Zl9pbmZvKQoreworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9ldmVudCAqZV9vbGRl
c3QsICplX25ldzsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfZXZlbnRfcXVldWUgKmV2cSA9IHZk
bWFidWYtPmV2cTsKKwl1bnNpZ25lZCBsb25nIGlycWZsYWdzOworCisJZV9uZXcgPSBremFsbG9j
KHNpemVvZigqZV9uZXcpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIWVfbmV3KQorCQlyZXR1cm4gLUVO
T01FTTsKKworCWVfbmV3LT5lX2RhdGEuaGRyLmJ1Zl9pZCA9IGJ1Zl9pbmZvLT5idWZfaWQ7CisJ
ZV9uZXctPmVfZGF0YS5kYXRhID0gKHZvaWQgKilidWZfaW5mby0+cHJpdjsKKwllX25ldy0+ZV9k
YXRhLmhkci5zaXplID0gYnVmX2luZm8tPnN6X3ByaXY7CisKKwlzcGluX2xvY2tfaXJxc2F2ZSgm
ZXZxLT5lX2xvY2ssIGlycWZsYWdzKTsKKworCS8qIGNoZWNrIGN1cnJlbnQgbnVtYmVyIG9mIGV2
ZW50IHRoZW4gaWYgaXQgaGl0cyB0aGUgbWF4IG51bSAoMzIpCisJICogdGhlbiByZW1vdmUgdGhl
IG9sZGVzdCBldmVudCBpbiB0aGUgbGlzdAorCSAqLworCWlmIChldnEtPnBlbmRpbmcgPiAzMSkg
eworCQllX29sZGVzdCA9IGxpc3RfZmlyc3RfZW50cnkoJmV2cS0+ZV9saXN0LAorCQkJCQkgICAg
c3RydWN0IHZpcnRpb192ZG1hYnVmX2V2ZW50LCBsaW5rKTsKKwkJbGlzdF9kZWwoJmVfb2xkZXN0
LT5saW5rKTsKKwkJZXZxLT5wZW5kaW5nLS07CisJCWtmcmVlKGVfb2xkZXN0KTsKKwl9CisKKwls
aXN0X2FkZF90YWlsKCZlX25ldy0+bGluaywgJmV2cS0+ZV9saXN0KTsKKworCWV2cS0+cGVuZGlu
ZysrOworCisJd2FrZV91cF9pbnRlcnJ1cHRpYmxlKCZldnEtPmVfd2FpdCk7CisJc3Bpbl91bmxv
Y2tfaXJxcmVzdG9yZSgmZXZxLT5lX2xvY2ssIGlycWZsYWdzKTsKKworCXJldHVybiAwOworfQor
CisvKiB0cmFuc21pdHRpbmcgbWVzc2FnZSAqLworc3RhdGljIGludCBzZW5kX21zZ190b19ndWVz
dCh1NjQgdm1pZCwgZW51bSB2aXJ0aW9fdmRtYWJ1Zl9jbWQgY21kLCBpbnQgKm9wKQoreworCXN0
cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9tc2cgbXNnOworCXN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1h
YnVmOworCisJdmRtYWJ1ZiA9IHZob3N0X3ZkbWFidWZfZmluZCh2bWlkKTsKKwlpZiAoIXZkbWFi
dWYpIHsKKwkJZGV2X2VycihkcnZfaW5mby0+ZGV2LAorCQkJImNhbid0IGZpbmQgdmRtYWJ1ZiBm
b3IgOiB2bWlkID0gJWxsdVxuIiwgdm1pZCk7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCXN3
aXRjaCAoY21kKSB7CisJY2FzZSBWSVJUSU9fVkRNQUJVRl9DTURfRE1BQlVGX1JFTDoKKwkJbWVt
Y3B5KCZtc2cub3BbMF0sICZvcFswXSwgOCAqIHNpemVvZihpbnQpKTsKKwkJYnJlYWs7CisJZGVm
YXVsdDoKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJbXNnLmNtZCA9IGNtZDsKKworCW11dGV4
X2xvY2soJnZkbWFidWYtPnR4X211dGV4KTsKKwltdXRleF9sb2NrKCZ2ZG1hYnVmLT52cV9tdXRl
eCk7CisKKwlpZiAoKHZkbWFidWYtPm5leHQubXNnX3B0ciA9PSBOVUxMKSB8fAorCSAgICAodmRt
YWJ1Zi0+bmV4dC5oZWFkID09IC0xKSkgeworCQltdXRleF91bmxvY2soJnZkbWFidWYtPnZxX211
dGV4KTsKKwkJbXV0ZXhfdW5sb2NrKCZ2ZG1hYnVmLT50eF9tdXRleCk7CisJCXJldHVybiAtRUJV
U1k7CisJfQorCisJbWVtY3B5KCZ2ZG1hYnVmLT5uZXh0Lm1zZywgJm1zZywgc2l6ZW9mKG1zZykp
OworCXZob3N0X3dvcmtfcXVldWUoJnZkbWFidWYtPmRldiwgJnZkbWFidWYtPnR4X3dvcmspOwor
CisJbXV0ZXhfdW5sb2NrKCZ2ZG1hYnVmLT52cV9tdXRleCk7CisJbXV0ZXhfdW5sb2NrKCZ2ZG1h
YnVmLT50eF9tdXRleCk7CisKKwlyZXR1cm4gMDsKK30KKworc3RhdGljIGludCByZWdpc3Rlcl9l
eHBvcnRlZChzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiwKKwkJCSAgICAgdmlydGlvX3Zk
bWFidWZfYnVmX2lkX3QgKmJ1Zl9pZCwgaW50ICpvcHMpCit7CisJc3RydWN0IHZpcnRpb192ZG1h
YnVmX2J1ZiAqaW1wOworCWludCByZXQ7CisKKwlpbXAgPSBrY2FsbG9jKDEsIHNpemVvZigqaW1w
KSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFpbXApCisJCXJldHVybiAtRU5PTUVNOworCisJaW1wLT5w
YWdlc19pbmZvID0ga2NhbGxvYygxLCBzaXplb2Yoc3RydWN0IHZpcnRpb192ZG1hYnVmX3NoYXJl
ZF9wYWdlcyksCisJCQkJICBHRlBfS0VSTkVMKTsKKwlpZiAoIWltcC0+cGFnZXNfaW5mbykgewor
CQlrZnJlZShpbXApOworCQlyZXR1cm4gLUVOT01FTTsKKwl9CisKKwlpbXAtPnN6X3ByaXYgPSBv
cHNbVklSVElPX1ZETUFCVUZfUFJJVkFURV9EQVRBX1NJWkVdOworCWlmIChpbXAtPnN6X3ByaXYp
IHsKKwkJaW1wLT5wcml2ID0ga2NhbGxvYygxLCBvcHNbVklSVElPX1ZETUFCVUZfUFJJVkFURV9E
QVRBX1NJWkVdLAorCQkJCSAgICBHRlBfS0VSTkVMKTsKKwkJaWYgKCFpbXAtPnByaXYpIHsKKwkJ
CWtmcmVlKGltcC0+cGFnZXNfaW5mbyk7CisJCQlrZnJlZShpbXApOworCQkJcmV0dXJuIC1FTk9N
RU07CisJCX0KKwl9CisKKwltZW1jcHkoJmltcC0+YnVmX2lkLCBidWZfaWQsIHNpemVvZigqYnVm
X2lkKSk7CisKKwlpbXAtPnBhZ2VzX2luZm8tPm5lbnRzID0gb3BzW1ZJUlRJT19WRE1BQlVGX05V
TV9QQUdFU19TSEFSRURdOworCWltcC0+cGFnZXNfaW5mby0+Zmlyc3Rfb2ZzdCA9IG9wc1tWSVJU
SU9fVkRNQUJVRl9GSVJTVF9QQUdFX0RBVEFfT0ZGU0VUXTsKKwlpbXAtPnBhZ2VzX2luZm8tPmxh
c3RfbGVuID0gb3BzW1ZJUlRJT19WRE1BQlVGX0xBU1RfUEFHRV9EQVRBX0xFTkdUSF07CisJaW1w
LT5wYWdlc19pbmZvLT5yZWYgPSAqKGdwYV90ICopJm9wc1tWSVJUSU9fVkRNQUJVRl9SRUZfQURE
Ul9VUFBFUl8zMkJJVF07CisJaW1wLT52bWlkID0gdmRtYWJ1Zi0+dm1pZDsKKwlpbXAtPnZhbGlk
ID0gdHJ1ZTsKKworCXZpcnRpb192ZG1hYnVmX2FkZF9idWYoZHJ2X2luZm8sIGltcCk7CisKKwkv
KiB0cmFuc2ZlcnJpbmcgcHJpdmF0ZSBkYXRhICovCisJbWVtY3B5KGltcC0+cHJpdiwgJm9wc1tW
SVJUSU9fVkRNQUJVRl9QUklWQVRFX0RBVEFfU1RBUlRdLAorCSAgICAgICBvcHNbVklSVElPX1ZE
TUFCVUZfUFJJVkFURV9EQVRBX1NJWkVdKTsKKworCS8qIGdlbmVyYXRlIGltcG9ydCBldmVudCAq
LworCXJldCA9IHZob3N0X3ZkbWFidWZfYWRkX2V2ZW50KHZkbWFidWYsIGltcCk7CisJaWYgKHJl
dCkKKwkJcmV0dXJuIHJldDsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgdm9pZCBzZW5kX3Rv
X3R4cShzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiwKKwkJCXN0cnVjdCB2aXJ0aW9fdmRt
YWJ1Zl90eG1zZyAqbXNnX2luZm8pCit7CisJaW50IHJldDsKKworCXJldCA9IF9fY29weV90b191
c2VyKG1zZ19pbmZvLT5tc2dfcHRyLCAmbXNnX2luZm8tPm1zZywKKwkJCSAgICAgc2l6ZW9mKHN0
cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9tc2cpKTsKKworCWlmICghcmV0KSB7CisJCXZob3N0X2FkZF91
c2VkX2FuZF9zaWduYWwoJnZkbWFidWYtPmRldiwgJnZkbWFidWYtPnZxLAorCQkJCQkgIG1zZ19p
bmZvLT5oZWFkLAorCQkJCQkgIHNpemVvZihzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfbXNnKSk7CisJ
CW1zZ19pbmZvLT5tc2dfcHRyID0gTlVMTDsKKwkJbXNnX2luZm8tPmhlYWQgPSAtMTsKKwl9IGVs
c2UgeworCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsCisJCQkiZmFpbCB0byBjb3B5IHR4IG1zZ1xu
Iik7CisJfQorfQorCitzdGF0aWMgdm9pZCB0eF93b3JrKHN0cnVjdCB2aG9zdF93b3JrICp3b3Jr
KQoreworCXN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmID0gY29udGFpbmVyX29mKHdvcmss
CisJCQkJCSAgICAgICAgICAgICBzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiwKKwkJCQkJICAgICAgICAg
ICAgIHR4X3dvcmspOworCisJbXV0ZXhfbG9jaygmdmRtYWJ1Zi0+dnFfbXV0ZXgpOworCXNlbmRf
dG9fdHhxKHZkbWFidWYsICZ2ZG1hYnVmLT5uZXh0KTsKKwltdXRleF91bmxvY2soJnZkbWFidWYt
PnZxX211dGV4KTsKK30KKworLyogcGFyc2UgaW5jb21pbmcgbWVzc2FnZSBmcm9tIGEgZ3Vlc3Qg
Ki8KK3N0YXRpYyBpbnQgcGFyc2VfbXNnKHN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmLAor
CQkgICAgIHN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9tc2cgKm1zZywKKyAgICAgICAgICAgICAgICAg
ICAgIHZvaWQgX191c2VyICpvdXQsIGludCBoZWFkKQoreworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1
Zl90eG1zZyAqbXNnX2luZm87CisJdmlydGlvX3ZkbWFidWZfYnVmX2lkX3QgKmJ1Zl9pZCA9ICh2
aXJ0aW9fdmRtYWJ1Zl9idWZfaWRfdCAqKW1zZy0+b3A7CisJaW50IHJldCA9IDA7CisKKwltc2df
aW5mbyA9IGtjYWxsb2MoMSwgc2l6ZW9mKCptc2dfaW5mbyksIEdGUF9LRVJORUwpOworCWlmICgh
bXNnX2luZm8pCisJCXJldHVybiAtRU5PTUVNOworCisJc3dpdGNoIChtc2ctPmNtZCkgeworCWNh
c2UgVklSVElPX1ZETUFCVUZfQ01EX0VYUE9SVDoKKwkJcmV0ID0gcmVnaXN0ZXJfZXhwb3J0ZWQo
dmRtYWJ1ZiwgYnVmX2lkLCBtc2ctPm9wKTsKKwkJaWYgKHJldCkKKwkJCWJyZWFrOworCisJCW1l
bWNweSgmbXNnX2luZm8tPm1zZywgbXNnLCBzaXplb2Yoc3RydWN0IHZpcnRpb192ZG1hYnVmX21z
ZykpOworCQlicmVhazsKKworCWRlZmF1bHQ6CisJCXJldCA9IC1FSU5WQUw7CisJCWJyZWFrOwor
CX0KKworCW1zZ19pbmZvLT5tc2dfcHRyID0gb3V0OworCW1zZ19pbmZvLT5oZWFkID0gaGVhZDsK
KworCWtmcmVlKG1zZ19pbmZvKTsKKworCXJldHVybiByZXQ7Cit9CisKK3N0YXRpYyB2b2lkIHJ4
X3dvcmsoc3RydWN0IHZob3N0X3dvcmsgKndvcmspCit7CisJc3RydWN0IHZob3N0X3ZpcnRxdWV1
ZSAqdnEgPSBjb250YWluZXJfb2Yod29yaywKKwkJCQkJCSAgc3RydWN0IHZob3N0X3ZpcnRxdWV1
ZSwKKwkJCQkJCSAgcG9sbC53b3JrKTsKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1ZiA9
IGNvbnRhaW5lcl9vZih2cS0+ZGV2LAorCQkJCQkgICAgICAJICAgICBzdHJ1Y3Qgdmhvc3RfdmRt
YWJ1ZiwKKwkJCQkJICAgICAgCSAgICAgZGV2KTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfbXNn
IG1zZzsKKwlpbnQgaGVhZCwgaW4sIG91dCwgaW5fc2l6ZTsKKwlpbnQgcmV0OworCisJbXV0ZXhf
bG9jaygmdmRtYWJ1Zi0+dnFfbXV0ZXgpOworCXZob3N0X2Rpc2FibGVfbm90aWZ5KCZ2ZG1hYnVm
LT5kZXYsIHZxKTsKKworCS8qIE1ha2Ugc3VyZSB3ZSB3aWxsIHByb2Nlc3MgYWxsIHBlbmRpbmcg
cmVxdWVzdHMgKi8KKwlmb3IgKDs7KSB7CisJCWhlYWQgPSB2aG9zdF9nZXRfdnFfZGVzYyh2cSwg
dnEtPmlvdiwgQVJSQVlfU0laRSh2cS0+aW92KSwKKwkJCQkJICZvdXQsICZpbiwgTlVMTCwgTlVM
TCk7CisKKwkJaWYgKHVubGlrZWx5KGhlYWQgPCAwKSkKKwkJCWJyZWFrOworCisJCS8qIE5vdGhp
bmcgbmV3PyBXYWl0IGZvciBldmVudGZkIHRvIHRlbGwgdXMgdGhleSByZWZpbGxlZCAqLworCQlp
ZiAoaGVhZCA9PSB2cS0+bnVtKSB7CisJCQlpZiAodW5saWtlbHkodmhvc3RfZW5hYmxlX25vdGlm
eSgmdmRtYWJ1Zi0+ZGV2LCB2cSkpKSB7CisJCQkJdmhvc3RfZGlzYWJsZV9ub3RpZnkoJnZkbWFi
dWYtPmRldiwgdnEpOworCQkJCWNvbnRpbnVlOworCQkJfQorCQkJYnJlYWs7CisJCX0KKworCQlp
ZiAob3V0KQorCQkJYnJlYWs7CisKKwkJaW5fc2l6ZSA9IGlvdl9sZW5ndGgoJnZxLT5pb3Zbb3V0
XSwgaW4pOworCisJCWlmIChpbl9zaXplID09IHNpemVvZihzdHJ1Y3QgdmlydGlvX3ZkbWFidWZf
bXNnKSkgeworCQkJaWYgKF9fY29weV9mcm9tX3VzZXIoJm1zZywgdnEtPmlvdltvdXRdLmlvdl9i
YXNlLAorCQkJCQkgICAgaW5fc2l6ZSkpIHsKKwkJCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsCisJ
CQkJCSJlcnI6IGNhbid0IGdldCB0aGUgbXNnIGZyb20gdnFcbiIpOworCQkJCWNvbnRpbnVlOwor
CQkJfQorCisJCQl2ZG1hYnVmLT5uZXh0Lm1zZ19wdHIgPSB2cS0+aW92W291dF0uaW92X2Jhc2U7
CisJCQl2ZG1hYnVmLT5uZXh0LmhlYWQgPSBoZWFkOworCisJCQlpZiAobXNnLmNtZCA9PSBWSVJU
SU9fVkRNQUJVRl9DTURfTkVFRF9WTUlEKSB7CisJCQkJc3RydWN0IHZpcnRpb192ZG1hYnVmX3R4
bXNnIGFjazsKKworCQkJCWFjay5tc2cucmVxX2lkID0gbXNnLnJlcV9pZDsKKwkJCQlhY2subXNn
LmNtZCA9IG1zZy5jbWQ7CisJCQkJYWNrLm1zZy5vcFswXSA9IHZkbWFidWYtPnZtaWQ7CisJCQkJ
YWNrLm1zZ19wdHIgPSB2cS0+aW92W291dF0uaW92X2Jhc2U7CisJCQkJYWNrLmhlYWQgPSBoZWFk
OworCisJCQkJc2VuZF90b190eHEodmRtYWJ1ZiwgJmFjayk7CisJCQl9IGVsc2UgeworCQkJCXJl
dCA9IHBhcnNlX21zZyh2ZG1hYnVmLCAmbXNnLAorCQkJCQkJdnEtPmlvdltvdXRdLmlvdl9iYXNl
LAorCQkJCQkJaGVhZCk7CisJCQkJaWYgKHJldCkgeworCQkJCQlkZXZfZXJyKGRydl9pbmZvLT5k
ZXYsCisJCQkJCQkibXNnIHBhcnNlIGVycm9yOiAlZCIsCisJCQkJCQlyZXQpOworCQkJCQlkZXZf
ZXJyKGRydl9pbmZvLT5kZXYsCisJCQkJCQkiIGNtZDogJWRcbiIsIG1zZy5jbWQpOworCQkJCX0K
KwkJCX0KKwkJfSBlbHNlIHsKKwkJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwgInJ4IG1zZyB3aXRo
IHdyb25nIHNpemVcbiIpOworCisJCQkvKiBqdXN0IHRocm93IGJhY2sgdGhlIG1lc3NhZ2UgdG8g
dGhlIGNsaWVudCB0bworCQkJICogZW1wdHkgdXNlZCBidWZmZXIKKwkJCSAqLworCQkJdmhvc3Rf
YWRkX3VzZWRfYW5kX3NpZ25hbCgmdmRtYWJ1Zi0+ZGV2LCB2cSwgaGVhZCwKKwkJCQkJCSAgaW5f
c2l6ZSk7CisJCX0KKwl9CisKKwl2aG9zdF9lbmFibGVfbm90aWZ5KCZ2ZG1hYnVmLT5kZXYsIHZx
KTsKKwltdXRleF91bmxvY2soJnZkbWFidWYtPnZxX211dGV4KTsKK30KKworc3RhdGljIGludCB2
aG9zdF92ZG1hYnVmX2dldF9rdm0oc3RydWN0IG5vdGlmaWVyX2Jsb2NrICpuYiwKKwkJCQkgdW5z
aWduZWQgbG9uZyBldmVudCwgdm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3Qga3ZtX2luc3RhbmNlICpp
bnN0YW5jZTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfaW5mbyAqZHJ2ID0gY29udGFpbmVyX29m
KG5iLAorCQkJCQkJc3RydWN0IHZpcnRpb192ZG1hYnVmX2luZm8sCisJCQkJCQlrdm1fbm90aWZp
ZXIpOworCisJaW5zdGFuY2UgPSBremFsbG9jKHNpemVvZigqaW5zdGFuY2UpLCBHRlBfS0VSTkVM
KTsKKwlpZiAoaW5zdGFuY2UgJiYgZXZlbnQgPT0gS1ZNX0VWRU5UX0NSRUFURV9WTSkgeworCQlp
ZiAoZGF0YSkgeworCQkJaW5zdGFuY2UtPmt2bSA9IGRhdGE7CisJCQlsaXN0X2FkZF90YWlsKCZp
bnN0YW5jZS0+bGluaywKKwkJCQkgICAgICAmZHJ2LT5rdm1faW5zdGFuY2VzKTsKKwkJfQorCX0K
KworCXJldHVybiBOT1RJRllfT0s7Cit9CisKK3N0YXRpYyBzdHJ1Y3Qga3ZtICpmaW5kX2t2bV9p
bnN0YW5jZSh1NjQgdm1pZCkKK3sKKwlzdHJ1Y3Qga3ZtX2luc3RhbmNlICppbnN0YW5jZSwgKnRt
cDsKKwlzdHJ1Y3Qga3ZtICprdm0gPSBOVUxMOworCisJbGlzdF9mb3JfZWFjaF9lbnRyeV9zYWZl
KGluc3RhbmNlLCB0bXAsICZkcnZfaW5mby0+a3ZtX2luc3RhbmNlcywKKyAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgIGxpbmspIHsKKwkJaWYgKGluc3RhbmNlLT5rdm0tPnVzZXJzcGFj
ZV9waWQgPT0gdm1pZCkgeworCQkJa3ZtID0gaW5zdGFuY2UtPmt2bTsKKworCQkJbGlzdF9kZWwo
Jmluc3RhbmNlLT5saW5rKTsKKwkJCWtmcmVlKGluc3RhbmNlKTsKKwkJCWJyZWFrOworCQl9CisJ
fQorCisJcmV0dXJuIGt2bTsKK30KKworc3RhdGljIGludCB2aG9zdF92ZG1hYnVmX29wZW4oc3Ry
dWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZpbGUgKmZpbHApCit7CisJc3RydWN0IHZob3N0X3Zk
bWFidWYgKnZkbWFidWY7CisJc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqKnZxczsKKwlpbnQgcmV0
ID0gMDsKKworCWlmICghZHJ2X2luZm8pIHsKKwkJcHJfZXJyKCJ2aG9zdC12ZG1hYnVmOiBjYW4n
dCBvcGVuIG1pc2MgZGV2aWNlXG4iKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJdnFzID0g
a2NhbGxvYygxLCBzaXplb2YoKnZxcyksIEdGUF9LRVJORUwpOworCWlmICghdnFzKQorCQlyZXR1
cm4gLUVOT01FTTsKKworCXZkbWFidWYgPSBrdnphbGxvYyhzaXplb2YoKnZkbWFidWYpLCBHRlBf
S0VSTkVMIHwKKwkJCV9fR0ZQX1JFVFJZX01BWUZBSUwpOworCWlmICghdmRtYWJ1ZikgeworCQlr
ZnJlZSh2cXMpOworCQlyZXR1cm4gLUVOT01FTTsKKwl9CisKKwl2ZG1hYnVmLT5ldnEgPSBrY2Fs
bG9jKDEsIHNpemVvZigqKHZkbWFidWYtPmV2cSkpLCBHRlBfS0VSTkVMKTsKKwlpZiAoIXZkbWFi
dWYtPmV2cSkgeworCQlrZnJlZSh2ZG1hYnVmKTsKKwkJa2ZyZWUodnFzKTsKKwkJcmV0dXJuIC1F
Tk9NRU07CisJfQorCisJbXV0ZXhfbG9jaygmZHJ2X2luZm8tPmdfbXV0ZXgpOworCisJdnFzWzBd
ID0gJnZkbWFidWYtPnZxOworCXZkbWFidWYtPnZxLmhhbmRsZV9raWNrID0gcnhfd29yazsKKwor
CW11dGV4X2luaXQoJnZkbWFidWYtPnZxX211dGV4KTsKKwltdXRleF9pbml0KCZ2ZG1hYnVmLT50
eF9tdXRleCk7CisJdmhvc3RfZGV2X2luaXQoJnZkbWFidWYtPmRldiwgdnFzLCAxLCBVSU9fTUFY
SU9WLCAwLCAwLCB0cnVlLCBOVUxMKTsKKworCXZob3N0X3dvcmtfaW5pdCgmdmRtYWJ1Zi0+dHhf
d29yaywgdHhfd29yayk7CisJdmRtYWJ1Zi0+dm1pZCA9IHRhc2tfcGlkX25yKGN1cnJlbnQpOwor
CXZkbWFidWYtPmt2bSA9IGZpbmRfa3ZtX2luc3RhbmNlKHZkbWFidWYtPnZtaWQpOworCXZob3N0
X3ZkbWFidWZfYWRkKHZkbWFidWYpOworCisJbXV0ZXhfaW5pdCgmdmRtYWJ1Zi0+ZXZxLT5lX3Jl
YWRsb2NrKTsKKwlzcGluX2xvY2tfaW5pdCgmdmRtYWJ1Zi0+ZXZxLT5lX2xvY2spOworCisJLyog
SW5pdGlhbGl6ZSBldmVudCBxdWV1ZSAqLworCUlOSVRfTElTVF9IRUFEKCZ2ZG1hYnVmLT5ldnEt
PmVfbGlzdCk7CisJaW5pdF93YWl0cXVldWVfaGVhZCgmdmRtYWJ1Zi0+ZXZxLT5lX3dhaXQpOwor
CisJLyogcmVzZXR0aW5nIG51bWJlciBvZiBwZW5kaW5nIGV2ZW50cyAqLworCXZkbWFidWYtPmV2
cS0+cGVuZGluZyA9IDA7CisJZmlscC0+cHJpdmF0ZV9kYXRhID0gdmRtYWJ1ZjsKKworCW11dGV4
X3VubG9jaygmZHJ2X2luZm8tPmdfbXV0ZXgpOworCisJcmV0dXJuIHJldDsKK30KKworc3RhdGlj
IGludCB2aG9zdF92ZG1hYnVmX3JlbGVhc2Uoc3RydWN0IGlub2RlICppbm9kZSwgc3RydWN0IGZp
bGUgKmZpbHApCit7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSBmaWxwLT5wcml2
YXRlX2RhdGE7CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX2V2ZW50ICplLCAqZXQ7CisKKwlpZiAo
IXZob3N0X3ZkbWFidWZfZGVsKHZkbWFidWYpKQorCQlyZXR1cm4gLUVJTlZBTDsKKworCW11dGV4
X2xvY2soJmRydl9pbmZvLT5nX211dGV4KTsKKworCWxpc3RfZm9yX2VhY2hfZW50cnlfc2FmZShl
LCBldCwgJnZkbWFidWYtPmV2cS0+ZV9saXN0LAorCQkJCSBsaW5rKSB7CisJCWxpc3RfZGVsKCZl
LT5saW5rKTsKKwkJa2ZyZWUoZSk7CisJCXZkbWFidWYtPmV2cS0+cGVuZGluZy0tOworCX0KKwor
CXZob3N0X3BvbGxfc3RvcCgmdmRtYWJ1Zi0+dnEucG9sbCk7CisJdmhvc3RfcG9sbF9mbHVzaCgm
dmRtYWJ1Zi0+dnEucG9sbCk7CisJdmhvc3RfZGV2X2NsZWFudXAoJnZkbWFidWYtPmRldik7CisK
KwlrZnJlZSh2ZG1hYnVmLT5kZXYudnFzKTsKKwlrdmZyZWUodmRtYWJ1Zik7CisKKwlmaWxwLT5w
cml2YXRlX2RhdGEgPSBOVUxMOworCW11dGV4X3VubG9jaygmZHJ2X2luZm8tPmdfbXV0ZXgpOwor
CisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyB1bnNpZ25lZCBpbnQgdmhvc3RfdmRtYWJ1Zl9ldmVu
dF9wb2xsKHN0cnVjdCBmaWxlICpmaWxwLAorCQkJCSAgICAJICAgICBzdHJ1Y3QgcG9sbF90YWJs
ZV9zdHJ1Y3QgKndhaXQpCit7CisJc3RydWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSBmaWxw
LT5wcml2YXRlX2RhdGE7CisKKwlwb2xsX3dhaXQoZmlscCwgJnZkbWFidWYtPmV2cS0+ZV93YWl0
LCB3YWl0KTsKKworCWlmICghbGlzdF9lbXB0eSgmdmRtYWJ1Zi0+ZXZxLT5lX2xpc3QpKQorCQly
ZXR1cm4gUE9MTElOIHwgUE9MTFJETk9STTsKKworCXJldHVybiAwOworfQorCitzdGF0aWMgc3Np
emVfdCB2aG9zdF92ZG1hYnVmX2V2ZW50X3JlYWQoc3RydWN0IGZpbGUgKmZpbHAsIGNoYXIgX191
c2VyICpidWYsCisJCQkgICAgICAgCQlzaXplX3QgY250LCBsb2ZmX3QgKm9mc3QpCit7CisJc3Ry
dWN0IHZob3N0X3ZkbWFidWYgKnZkbWFidWYgPSBmaWxwLT5wcml2YXRlX2RhdGE7CisJaW50IHJl
dDsKKworCWlmICh0YXNrX3BpZF9ucihjdXJyZW50KSAhPSB2ZG1hYnVmLT52bWlkKSB7CisJCWRl
dl9lcnIoZHJ2X2luZm8tPmRldiwgImN1cnJlbnQgcHJvY2VzcyBjYW5ub3QgcmVhZCBldmVudHNc
biIpOworCQlyZXR1cm4gLUVQRVJNOworCX0KKworCS8qIG1ha2Ugc3VyZSB1c2VyIGJ1ZmZlciBj
YW4gYmUgd3JpdHRlbiAqLworCWlmICghYWNjZXNzX29rKGJ1Ziwgc2l6ZW9mKCpidWYpKSkgewor
CQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsICJ1c2VyIGJ1ZmZlciBjYW4ndCBiZSB3cml0dGVuLlxu
Iik7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCXJldCA9IG11dGV4X2xvY2tfaW50ZXJydXB0
aWJsZSgmdmRtYWJ1Zi0+ZXZxLT5lX3JlYWRsb2NrKTsKKwlpZiAocmV0KQorCQlyZXR1cm4gcmV0
OworCisJZm9yICg7OykgeworCQlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfZXZlbnQgKmUgPSBOVUxM
OworCisJCXNwaW5fbG9ja19pcnEoJnZkbWFidWYtPmV2cS0+ZV9sb2NrKTsKKwkJaWYgKCFsaXN0
X2VtcHR5KCZ2ZG1hYnVmLT5ldnEtPmVfbGlzdCkpIHsKKwkJCWUgPSBsaXN0X2ZpcnN0X2VudHJ5
KCZ2ZG1hYnVmLT5ldnEtPmVfbGlzdCwKKwkJCQkJICAgICBzdHJ1Y3QgdmlydGlvX3ZkbWFidWZf
ZXZlbnQsIGxpbmspOworCQkJbGlzdF9kZWwoJmUtPmxpbmspOworCQl9CisJCXNwaW5fdW5sb2Nr
X2lycSgmdmRtYWJ1Zi0+ZXZxLT5lX2xvY2spOworCisJCWlmICghZSkgeworCQkJaWYgKHJldCkK
KwkJCQlicmVhazsKKworCQkJaWYgKGZpbHAtPmZfZmxhZ3MgJiBPX05PTkJMT0NLKSB7CisJCQkJ
cmV0ID0gLUVBR0FJTjsKKwkJCQlicmVhazsKKwkJCX0KKworCQkJbXV0ZXhfdW5sb2NrKCZ2ZG1h
YnVmLT5ldnEtPmVfcmVhZGxvY2spOworCQkJcmV0ID0gd2FpdF9ldmVudF9pbnRlcnJ1cHRpYmxl
KHZkbWFidWYtPmV2cS0+ZV93YWl0LAorCQkJCQkhbGlzdF9lbXB0eSgmdmRtYWJ1Zi0+ZXZxLT5l
X2xpc3QpKTsKKworCQkJaWYgKHJldCA9PSAwKQorCQkJCXJldCA9IG11dGV4X2xvY2tfaW50ZXJy
dXB0aWJsZSgKKwkJCQkJCSZ2ZG1hYnVmLT5ldnEtPmVfcmVhZGxvY2spOworCisJCQlpZiAocmV0
KQorCQkJCXJldHVybiByZXQ7CisJCX0gZWxzZSB7CisJCQl1bnNpZ25lZCBpbnQgbGVuID0gKHNp
emVvZihlLT5lX2RhdGEuaGRyKSArCisJCQkJCSAgICBlLT5lX2RhdGEuaGRyLnNpemUpOworCisJ
CQlpZiAobGVuID4gY250IC0gcmV0KSB7CitwdXRfYmFja19ldmVudDoKKwkJCQlzcGluX2xvY2tf
aXJxKCZ2ZG1hYnVmLT5ldnEtPmVfbG9jayk7CisJCQkJbGlzdF9hZGQoJmUtPmxpbmssICZ2ZG1h
YnVmLT5ldnEtPmVfbGlzdCk7CisJCQkJc3Bpbl91bmxvY2tfaXJxKCZ2ZG1hYnVmLT5ldnEtPmVf
bG9jayk7CisJCQkJYnJlYWs7CisJCQl9CisKKwkJCWlmIChjb3B5X3RvX3VzZXIoYnVmICsgcmV0
LCAmZS0+ZV9kYXRhLmhkciwKKwkJCQkJIHNpemVvZihlLT5lX2RhdGEuaGRyKSkpIHsKKwkJCQlp
ZiAocmV0ID09IDApCisJCQkJCXJldCA9IC1FRkFVTFQ7CisKKwkJCQlnb3RvIHB1dF9iYWNrX2V2
ZW50OworCQkJfQorCisJCQlyZXQgKz0gc2l6ZW9mKGUtPmVfZGF0YS5oZHIpOworCisJCQlpZiAo
Y29weV90b191c2VyKGJ1ZiArIHJldCwgZS0+ZV9kYXRhLmRhdGEsCisJCQkJCSBlLT5lX2RhdGEu
aGRyLnNpemUpKSB7CisKKwkJCQlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfZV9oZHIgZHVtbXlfaGRy
ID0gezB9OworCisJCQkJcmV0IC09IHNpemVvZihlLT5lX2RhdGEuaGRyKTsKKworCQkJCS8qIG51
bGxpZnlpbmcgaGRyIG9mIHRoZSBldmVudCBpbiB1c2VyIGJ1ZmZlciAqLworCQkJCWlmIChjb3B5
X3RvX3VzZXIoYnVmICsgcmV0LCAmZHVtbXlfaGRyLAorCQkJCQkJIHNpemVvZihkdW1teV9oZHIp
KSkKKwkJCQkJZGV2X2VycihkcnZfaW5mby0+ZGV2LAorCQkJCQkgICAiZmFpbCB0byBudWxsaWZ5
IGludmFsaWQgaGRyXG4iKTsKKworCQkJCXJldCA9IC1FRkFVTFQ7CisKKwkJCQlnb3RvIHB1dF9i
YWNrX2V2ZW50OworCQkJfQorCisJCQlyZXQgKz0gZS0+ZV9kYXRhLmhkci5zaXplOworCisJCQlz
cGluX2xvY2tfaXJxKCZ2ZG1hYnVmLT5ldnEtPmVfbG9jayk7CisJCQl2ZG1hYnVmLT5ldnEtPnBl
bmRpbmctLTsKKwkJCXNwaW5fdW5sb2NrX2lycSgmdmRtYWJ1Zi0+ZXZxLT5lX2xvY2spOworCQkJ
a2ZyZWUoZSk7CisJCX0KKwl9CisKKwltdXRleF91bmxvY2soJnZkbWFidWYtPmV2cS0+ZV9yZWFk
bG9jayk7CisKKwlyZXR1cm4gcmV0OworfQorCisvKiB2aG9zdCBpbnRlcmZhY2Ugb3duZXIgcmVz
ZXQgKi8KK3N0YXRpYyBsb25nIHZob3N0X3ZkbWFidWZfcmVzZXRfb3duZXIoc3RydWN0IHZob3N0
X3ZkbWFidWYgKnZkbWFidWYpCit7CisJbG9uZyByZXQ7CisJc3RydWN0IHZob3N0X2lvdGxiICpp
b3RsYjsKKworCW11dGV4X2xvY2soJnZkbWFidWYtPmRldi5tdXRleCk7CisJcmV0ID0gdmhvc3Rf
ZGV2X2NoZWNrX293bmVyKCZ2ZG1hYnVmLT5kZXYpOworCWlmIChyZXQpCisJCWdvdG8gZXJyOwor
CisJaW90bGIgPSB2aG9zdF9kZXZfcmVzZXRfb3duZXJfcHJlcGFyZSgpOworCWlmICghaW90bGIp
IHsKKwkJcmV0ID0gLUVOT01FTTsKKwkJZ290byBlcnI7CisJfQorCisJdmhvc3RfcG9sbF9zdG9w
KCZ2ZG1hYnVmLT52cS5wb2xsKTsKKwl2aG9zdF9wb2xsX2ZsdXNoKCZ2ZG1hYnVmLT52cS5wb2xs
KTsKKworCXZob3N0X2Rldl9yZXNldF9vd25lcigmdmRtYWJ1Zi0+ZGV2LCBpb3RsYik7CitlcnI6
CisJbXV0ZXhfdW5sb2NrKCZ2ZG1hYnVmLT5kZXYubXV0ZXgpOworCXJldHVybiByZXQ7Cit9CisK
K3N0YXRpYyBpbnQgdmhvc3RfdmRtYWJ1Zl9zdGFydChzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRt
YWJ1ZikKK3sKKyAgICAgICAgc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnE7CisgICAgICAgIGlu
dCByZXQ7CisKKyAgICAgICAgbXV0ZXhfbG9jaygmZHJ2X2luZm8tPmdfbXV0ZXgpOworCisgICAg
ICAgIHJldCA9IHZob3N0X2Rldl9jaGVja19vd25lcigmdmRtYWJ1Zi0+ZGV2KTsKKyAgICAgICAg
aWYgKHJldCkKKyAgICAgICAgICAgICAgICBnb3RvIGVycjsKKworICAgICAgICB2cSA9ICZ2ZG1h
YnVmLT52cTsKKworICAgICAgICBtdXRleF9sb2NrKCZ2cS0+bXV0ZXgpOworCisgICAgICAgIGlm
ICghdmhvc3RfdnFfYWNjZXNzX29rKHZxKSkgeworICAgICAgICAgICAgICAgIHJldCA9IC1FRkFV
TFQ7CisgICAgICAgICAgICAgICAgZ290byBlcnJfdnE7CisgICAgICAgIH0KKworICAgICAgICBp
ZiAoIXZob3N0X3ZxX2dldF9iYWNrZW5kKHZxKSkgeworICAgICAgICAgICAgICAgIHZob3N0X3Zx
X3NldF9iYWNrZW5kKHZxLCB2ZG1hYnVmKTsKKyAgICAgICAgICAgICAgICByZXQgPSB2aG9zdF92
cV9pbml0X2FjY2Vzcyh2cSk7CisgICAgICAgICAgICAgICAgaWYgKHJldCkKKyAgICAgICAgICAg
ICAgICAgICAgICAgIGdvdG8gZXJyX3ZxOworICAgICAgICB9CisKKyAgICAgICAgbXV0ZXhfdW5s
b2NrKCZ2cS0+bXV0ZXgpOworICAgICAgICBtdXRleF91bmxvY2soJmRydl9pbmZvLT5nX211dGV4
KTsKKyAgICAgICAgcmV0dXJuIDA7CisKK2Vycl92cToKKyAgICAgICAgdmhvc3RfdnFfc2V0X2Jh
Y2tlbmQodnEsIE5VTEwpOworICAgICAgICBtdXRleF91bmxvY2soJnZxLT5tdXRleCk7CitlcnI6
CisgICAgICAgIG11dGV4X3VubG9jaygmZHJ2X2luZm8tPmdfbXV0ZXgpOworICAgICAgICByZXR1
cm4gcmV0OworfQorCitzdGF0aWMgaW50IHZob3N0X3ZkbWFidWZfc3RvcChzdHJ1Y3Qgdmhvc3Rf
dmRtYWJ1ZiAqdmRtYWJ1ZikKK3sKKyAgICAgICAgc3RydWN0IHZob3N0X3ZpcnRxdWV1ZSAqdnE7
CisgICAgICAgIGludCByZXQ7CisKKyAgICAgICAgbXV0ZXhfbG9jaygmZHJ2X2luZm8tPmdfbXV0
ZXgpOworCisgICAgICAgIHJldCA9IHZob3N0X2Rldl9jaGVja19vd25lcigmdmRtYWJ1Zi0+ZGV2
KTsKKyAgICAgICAgaWYgKHJldCkKKyAgICAgICAgICAgICAgICBnb3RvIGVycjsKKworICAgICAg
ICB2cSA9ICZ2ZG1hYnVmLT52cTsKKworICAgICAgICBtdXRleF9sb2NrKCZ2cS0+bXV0ZXgpOwor
ICAgICAgICB2aG9zdF92cV9zZXRfYmFja2VuZCh2cSwgTlVMTCk7CisgICAgICAgIG11dGV4X3Vu
bG9jaygmdnEtPm11dGV4KTsKKworZXJyOgorICAgICAgICBtdXRleF91bmxvY2soJmRydl9pbmZv
LT5nX211dGV4KTsKKyAgICAgICAgcmV0dXJuIHJldDsKK30KKworLyogd3JhcHBlciBpb2N0bCBm
b3Igdmhvc3QgaW50ZXJmYWNlIGNvbnRyb2wgKi8KK3N0YXRpYyBpbnQgdmhvc3RfY29yZV9pb2N0
bChzdHJ1Y3QgZmlsZSAqZmlscCwgdW5zaWduZWQgaW50IGNtZCwKKwkJCSAgICB1bnNpZ25lZCBs
b25nIHBhcmFtKQoreworCXN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmID0gZmlscC0+cHJp
dmF0ZV9kYXRhOworCWludCByZXQsIHN0YXJ0OworCisJc3dpdGNoIChjbWQpIHsKKwljYXNlIFZI
T1NUX0dFVF9GRUFUVVJFUzoKKwkJLyogVE9ETzogZnV0dXJlIGltcGxlbWVudGF0aW9uICovCisJ
CXJldHVybiAwOworCWNhc2UgVkhPU1RfU0VUX0ZFQVRVUkVTOgorCQkvKiBUT0RPOiBmdXR1cmUg
aW1wbGVtZW50YXRpb24gKi8KKwkJcmV0dXJuIDA7CisJY2FzZSBWSE9TVF9WRE1BQlVGX1NFVF9S
VU5OSU5HOgorCQlpZiAoY29weV9mcm9tX3VzZXIoJnN0YXJ0LCAodm9pZCBfX3VzZXIgKilwYXJh
bSwgc2l6ZW9mKHN0YXJ0KSkpCisJCQlyZXR1cm4gLUVGQVVMVDsKKwkJaWYgKHN0YXJ0KQorCQkJ
cmV0dXJuIHZob3N0X3ZkbWFidWZfc3RhcnQodmRtYWJ1Zik7CisJCWVsc2UKKwkJCXJldHVybiB2
aG9zdF92ZG1hYnVmX3N0b3AodmRtYWJ1Zik7CisJY2FzZSBWSE9TVF9SRVNFVF9PV05FUjoKKwkJ
cmV0dXJuIHZob3N0X3ZkbWFidWZfcmVzZXRfb3duZXIodmRtYWJ1Zik7CisKKwlkZWZhdWx0Ogor
CQlyZXQgPSB2aG9zdF9kZXZfaW9jdGwoJnZkbWFidWYtPmRldiwgY21kLCAodm9pZCBfX3VzZXIg
KilwYXJhbSk7CisJCWlmIChyZXQgPT0gLUVOT0lPQ1RMQ01EKSB7CisJCQlyZXQgPSB2aG9zdF92
cmluZ19pb2N0bCgmdmRtYWJ1Zi0+ZGV2LCBjbWQsCisJCQkJCQkodm9pZCBfX3VzZXIgKilwYXJh
bSk7CisJCX0gZWxzZSB7CisJCQl2aG9zdF9wb2xsX2ZsdXNoKCZ2ZG1hYnVmLT52cS5wb2xsKTsK
KwkJfQorCX0KKworCXJldHVybiByZXQ7Cit9CisKKy8qCisgKiBpb2N0bCAtIGltcG9ydGluZyB2
ZG1hYnVmIGZyb20gZ3Vlc3QgT1MKKyAqCisgKiB1c2VyIHBhcmFtZXRlcnM6CisgKgorICoJdmly
dGlvX3ZkbWFidWZfYnVmX2lkX3QgYnVmX2lkIC0gdmRtYWJ1ZiBJRCBvZiBpbXBvcnRlZCBidWZm
ZXIKKyAqCWludCBmbGFncyAtIGZsYWdzCisgKglpbnQgZmQgLSBmaWxlIGhhbmRsZSBvZgl0aGUg
aW1wb3J0ZWQgYnVmZmVyCisgKgorICovCitzdGF0aWMgaW50IGltcG9ydF9pb2N0bChzdHJ1Y3Qg
ZmlsZSAqZmlscCwgdm9pZCAqZGF0YSkKK3sKKwlzdHJ1Y3Qgdmhvc3RfdmRtYWJ1ZiAqdmRtYWJ1
ZiA9IGZpbHAtPnByaXZhdGVfZGF0YTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfaW1wb3J0ICph
dHRyID0gZGF0YTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICppbXA7CisJaW50IHJldCA9
IDA7CisKKwltdXRleF9sb2NrKCZ2ZG1hYnVmLT5kZXYubXV0ZXgpOworCisJLyogbG9vayBmb3Ig
ZG1hYnVmIGZvciB0aGUgaWQgKi8KKwlpbXAgPSB2aXJ0aW9fdmRtYWJ1Zl9maW5kX2J1ZihkcnZf
aW5mbywgJmF0dHItPmJ1Zl9pZCk7CisJaWYgKCFpbXAgfHwgIWltcC0+dmFsaWQpIHsKKwkJbXV0
ZXhfdW5sb2NrKCZ2ZG1hYnVmLT5kZXYubXV0ZXgpOworCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYs
CisJCQkibm8gdmFsaWQgYnVmIGZvdW5kIHdpdGggaWQgPSAlbGx1XG4iLCBhdHRyLT5idWZfaWQu
aWQpOworCQlyZXR1cm4gLUVOT0VOVDsKKwl9CisKKwkvKiBvbmx5IGlmIG1hcHBlZCBwYWdlcyBh
cmUgbm90IHByZXNlbnQgKi8KKwlpZiAoIWltcC0+cGFnZXNfaW5mby0+cGFnZXMpIHsKKwkJcmV0
ID0gdmhvc3RfdmRtYWJ1Zl9tYXBfcGFnZXModmRtYWJ1Zi0+dm1pZCwgaW1wLT5wYWdlc19pbmZv
KTsKKwkJaWYgKHJldCA8IDApIHsKKwkJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwKKwkJCQkiZmFp
bGVkIHRvIG1hcCBndWVzdCBwYWdlc1xuIik7CisJCQlnb3RvIGZhaWxfbWFwOworCQl9CisJfQor
CisJYXR0ci0+ZmQgPSB2aG9zdF92ZG1hYnVmX2V4cF9mZChpbXAsIGF0dHItPmZsYWdzKTsKKwlp
ZiAoYXR0ci0+ZmQgPCAwKSB7CisJCWRldl9lcnIoZHJ2X2luZm8tPmRldiwgImZhaWxlZCB0byBn
ZXQgZmlsZSBkZXNjcmlwdG9yXG4iKTsKKwkJZ290byBmYWlsX2ltcG9ydDsKKwl9CisKKwlpbXAt
PmltcG9ydGVkID0gdHJ1ZTsKKworCW11dGV4X3VubG9jaygmdmRtYWJ1Zi0+ZGV2Lm11dGV4KTsK
Kwlnb3RvIHN1Y2Nlc3M7CisKK2ZhaWxfaW1wb3J0OgorCS8qIG5vdCBpbXBvcnRlZCB5ZXQ/ICov
CisJaWYgKCFpbXAtPmltcG9ydGVkKSB7CisJCXZob3N0X3ZkbWFidWZfdW5tYXBfcGFnZXModmRt
YWJ1Zi0+dm1pZCwgaW1wLT5wYWdlc19pbmZvKTsKKwkJaWYgKGltcC0+ZG1hX2J1ZikKKwkJCWtm
cmVlKGltcC0+ZG1hX2J1Zik7CisKKwkJaWYgKGltcC0+c2d0KSB7CisJCQlzZ19mcmVlX3RhYmxl
KGltcC0+c2d0KTsKKwkJCWtmcmVlKGltcC0+c2d0KTsKKwkJCWltcC0+c2d0ID0gTlVMTDsKKwkJ
fQorCX0KKworZmFpbF9tYXA6CisJLyogQ2hlY2sgaWYgYnVmZmVyIGlzIHN0aWxsIHZhbGlkIGFu
ZCBpZiBub3QgcmVtb3ZlIGl0CisJICogZnJvbSBpbXBvcnRlZCBsaXN0LgorCSAqLworCWlmICgh
aW1wLT52YWxpZCAmJiAhaW1wLT5pbXBvcnRlZCkgeworCQl2aXJ0aW9fdmRtYWJ1Zl9kZWxfYnVm
KGRydl9pbmZvLCAmaW1wLT5idWZfaWQpOworCQlrZnJlZShpbXAtPnByaXYpOworCQlrZnJlZShp
bXAtPnBhZ2VzX2luZm8pOworCQlrZnJlZShpbXApOworCX0KKworCXJldCA9ICBhdHRyLT5mZDsK
KwltdXRleF91bmxvY2soJnZkbWFidWYtPmRldi5tdXRleCk7CisKK3N1Y2Nlc3M6CisJcmV0dXJu
IHJldDsKK30KKworc3RhdGljIGludCByZWxlYXNlX2lvY3RsKHN0cnVjdCBmaWxlICpmaWxwLCB2
b2lkICpkYXRhKQoreworCXN0cnVjdCB2aG9zdF92ZG1hYnVmICp2ZG1hYnVmID0gZmlscC0+cHJp
dmF0ZV9kYXRhOworCXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9pbXBvcnQgKmF0dHIgPSBkYXRhOwor
CXN0cnVjdCB2aXJ0aW9fdmRtYWJ1Zl9idWYgKmltcDsKKwl2aXJ0aW9fdmRtYWJ1Zl9idWZfaWRf
dCBidWZfaWQgPSBhdHRyLT5idWZfaWQ7CisJaW50ICpvcDsKKwlpbnQgcmV0ID0gMDsKKworCW9w
ID0ga2NhbGxvYygxLCBzaXplb2YoaW50KSAqIDY1LCBHRlBfS0VSTkVMKTsKKwlpZiAoIW9wKQor
CQlyZXR1cm4gLUVOT01FTTsKKworCWltcCA9IHZpcnRpb192ZG1hYnVmX2ZpbmRfYnVmKGRydl9p
bmZvLCAmYnVmX2lkKTsKKwlpZiAoIWltcCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlpbXAtPmlt
cG9ydGVkID0gZmFsc2U7CisKKwltZW1jcHkob3AsICZpbXAtPmJ1Zl9pZCwgc2l6ZW9mKGltcC0+
YnVmX2lkKSk7CisKKwlyZXQgPSBzZW5kX21zZ190b19ndWVzdCh2ZG1hYnVmLT52bWlkLCBWSVJU
SU9fVkRNQUJVRl9DTURfRE1BQlVGX1JFTCwKKwkJCQlvcCk7CisJaWYgKHJldCA8IDApIHsKKwkJ
ZGV2X2VycihkcnZfaW5mby0+ZGV2LCAiZmFpbCB0byBzZW5kIHJlbGVhc2UgY21kXG4iKTsKKwkJ
cmV0dXJuIHJldDsKKwl9CisKKwlyZXR1cm4gMDsKK30KKworLyoKKyAqIGlvY3RsIC0gcXVlcnlp
bmcgdmFyaW91cyBpbmZvcm1hdGlvbiBvZiB2ZG1hYnVmCisgKgorICogdXNlciBwYXJhbWV0ZXJz
OgorICoKKyAqCXZpcnRpb192ZG1hYnVmX2J1Zl9pZF90IGJ1Zl9pZCAtIHZkbWFidWYgSUQgb2Yg
aW1wb3J0ZWQgYnVmZmVyCisgKgl1bnNpZ25lZCBsb25nIGluZm8gLSByZXR1cm5lZCBxdWVyeWlu
ZyByZXN1bHQKKyAqCisgKi8KK3N0YXRpYyBpbnQgcXVlcnlfaW9jdGwoc3RydWN0IGZpbGUgKmZp
bHAsIHZvaWQgKmRhdGEpCit7CisJc3RydWN0IHZpcnRpb192ZG1hYnVmX3F1ZXJ5ICphdHRyID0g
ZGF0YTsKKwlzdHJ1Y3QgdmlydGlvX3ZkbWFidWZfYnVmICppbXA7CisJdmlydGlvX3ZkbWFidWZf
YnVmX2lkX3QgYnVmX2lkID0gYXR0ci0+YnVmX2lkOworCisJLyogcXVlcnkgZm9yIGltcG9ydGVk
IGRtYWJ1ZiAqLworCWltcCA9IHZpcnRpb192ZG1hYnVmX2ZpbmRfYnVmKGRydl9pbmZvLCAmYnVm
X2lkKTsKKwlpZiAoIWltcCkKKwkJcmV0dXJuIC1FSU5WQUw7CisKKwlzd2l0Y2ggKGF0dHItPml0
ZW0pIHsKKwkvKiBzaXplIG9mIGRtYWJ1ZiBpbiBieXRlICovCisJY2FzZSBWSVJUSU9fVkRNQUJV
Rl9RVUVSWV9TSVpFOgorCQlpZiAoaW1wLT5kbWFfYnVmKSB7CisJCQkvKiBpZiBsb2NhbCBkbWFf
YnVmIGlzIGNyZWF0ZWQgKGlmIGl0J3MKKwkJCSAqIGV2ZXIgbWFwcGVkKSwgcmV0cmlldmUgaXQg
ZGlyZWN0bHkKKwkJCSAqIGZyb20gc3RydWN0IGRtYV9idWYgKgorCQkJICovCisJCQlhdHRyLT5p
bmZvID0gaW1wLT5kbWFfYnVmLT5zaXplOworCQl9IGVsc2UgeworCQkJLyogY2FsY3VhdGUgaXQg
ZnJvbSBnaXZlbiBuZW50cywgZmlyc3Rfb2ZzdAorCQkJICogYW5kIGxhc3RfbGVuCisJCQkgKi8K
KwkJCWF0dHItPmluZm8gPSAoKGltcC0+cGFnZXNfaW5mby0+bmVudHMpKlBBR0VfU0laRSAtCisJ
CQkJICAgICAoaW1wLT5wYWdlc19pbmZvLT5maXJzdF9vZnN0KSAtIFBBR0VfU0laRSArCisJCQkJ
ICAgICAoaW1wLT5wYWdlc19pbmZvLT5sYXN0X2xlbikpOworCQl9CisJCWJyZWFrOworCisJLyog
d2hldGhlciB0aGUgYnVmZmVyIGlzIHVzZWQgb3Igbm90ICovCisJY2FzZSBWSVJUSU9fVkRNQUJV
Rl9RVUVSWV9CVVNZOgorCQkvKiBjaGVja3MgaWYgaXQncyB1c2VkIGJ5IGltcG9ydGVyICovCisJ
CWF0dHItPmluZm8gPSBpbXAtPmltcG9ydGVkOworCQlicmVhazsKKworCS8qIHNpemUgb2YgcHJp
dmF0ZSBpbmZvIGF0dGFjaGVkIHRvIGJ1ZmZlciAqLworCWNhc2UgVklSVElPX1ZETUFCVUZfUVVF
UllfUFJJVl9JTkZPX1NJWkU6CisJCWF0dHItPmluZm8gPSBpbXAtPnN6X3ByaXY7CisJCWJyZWFr
OworCisJLyogY29weSBwcml2YXRlIGluZm8gYXR0YWNoZWQgdG8gYnVmZmVyICovCisJY2FzZSBW
SVJUSU9fVkRNQUJVRl9RVUVSWV9QUklWX0lORk86CisJCWlmIChpbXAtPnN6X3ByaXYgPiAwKSB7
CisJCQlpbnQgbjsKKworCQkJbiA9IGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilhdHRyLT5p
bmZvLAorCQkJCQlpbXAtPnByaXYsCisJCQkJCWltcC0+c3pfcHJpdik7CisJCQlpZiAobiAhPSAw
KQorCQkJCXJldHVybiAtRUlOVkFMOworCQl9CisJCWJyZWFrOworCisJZGVmYXVsdDoKKwkJcmV0
dXJuIC1FSU5WQUw7CisJfQorCisJcmV0dXJuIDA7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3Qg
dmlydGlvX3ZkbWFidWZfaW9jdGxfZGVzYyB2aG9zdF92ZG1hYnVmX2lvY3Rsc1tdID0geworCVZJ
UlRJT19WRE1BQlVGX0lPQ1RMX0RFRihWSVJUSU9fVkRNQUJVRl9JT0NUTF9JTVBPUlQsIGltcG9y
dF9pb2N0bCwgMCksCisJVklSVElPX1ZETUFCVUZfSU9DVExfREVGKFZJUlRJT19WRE1BQlVGX0lP
Q1RMX1JFTEVBU0UsIHJlbGVhc2VfaW9jdGwsIDApLAorCVZJUlRJT19WRE1BQlVGX0lPQ1RMX0RF
RihWSVJUSU9fVkRNQUJVRl9JT0NUTF9RVUVSWSwgcXVlcnlfaW9jdGwsIDApLAorfTsKKworc3Rh
dGljIGxvbmcgdmhvc3RfdmRtYWJ1Zl9pb2N0bChzdHJ1Y3QgZmlsZSAqZmlscCwgdW5zaWduZWQg
aW50IGNtZCwKKwkJCQl1bnNpZ25lZCBsb25nIHBhcmFtKQoreworCWNvbnN0IHN0cnVjdCB2aXJ0
aW9fdmRtYWJ1Zl9pb2N0bF9kZXNjICppb2N0bDsKKwl2aXJ0aW9fdmRtYWJ1Zl9pb2N0bF90IGZ1
bmM7CisJdW5zaWduZWQgaW50IG5yOworCWludCByZXQ7CisJY2hhciAqa2RhdGE7CisKKwkvKiBj
aGVjayBpZiBjbWQgaXMgdmhvc3QncyAqLworCWlmIChfSU9DX1RZUEUoY21kKSA9PSBWSE9TVF9W
SVJUSU8pIHsKKwkJcmV0ID0gdmhvc3RfY29yZV9pb2N0bChmaWxwLCBjbWQsIHBhcmFtKTsKKwkJ
cmV0dXJuIHJldDsKKwl9CisKKwluciA9IF9JT0NfTlIoY21kKTsKKworCWlmIChuciA+PSBBUlJB
WV9TSVpFKHZob3N0X3ZkbWFidWZfaW9jdGxzKSkgeworCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYs
ICJpbnZhbGlkIGlvY3RsXG4iKTsKKwkJcmV0dXJuIC1FSU5WQUw7CisJfQorCisJaW9jdGwgPSAm
dmhvc3RfdmRtYWJ1Zl9pb2N0bHNbbnJdOworCisJZnVuYyA9IGlvY3RsLT5mdW5jOworCisJaWYg
KHVubGlrZWx5KCFmdW5jKSkgeworCQlkZXZfZXJyKGRydl9pbmZvLT5kZXYsICJubyBmdW5jdGlv
blxuIik7CisJCXJldHVybiAtRUlOVkFMOworCX0KKworCWtkYXRhID0ga21hbGxvYyhfSU9DX1NJ
WkUoY21kKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFrZGF0YSkKKwkJcmV0dXJuIC1FTk9NRU07CisK
KwlpZiAoY29weV9mcm9tX3VzZXIoa2RhdGEsICh2b2lkIF9fdXNlciAqKXBhcmFtLAorCQkJICAg
X0lPQ19TSVpFKGNtZCkpICE9IDApIHsKKwkJZGV2X2VycihkcnZfaW5mby0+ZGV2LAorCQkJImZh
aWxlZCB0byBjb3B5IGFyZ3MgZnJvbSB1c2Vyc3BhY2VcbiIpOworCQlyZXQgPSAtRUZBVUxUOwor
CQlnb3RvIGlvY3RsX2Vycm9yOworCX0KKworCXJldCA9IGZ1bmMoZmlscCwga2RhdGEpOworCisJ
aWYgKGNvcHlfdG9fdXNlcigodm9pZCBfX3VzZXIgKilwYXJhbSwga2RhdGEsCisJCQkgX0lPQ19T
SVpFKGNtZCkpICE9IDApIHsKKwkJZGV2X2VycihkcnZfaW5mby0+ZGV2LAorCQkJImZhaWxlZCB0
byBjb3B5IGFyZ3MgYmFjayB0byB1c2Vyc3BhY2VcbiIpOworCQlyZXQgPSAtRUZBVUxUOworCQln
b3RvIGlvY3RsX2Vycm9yOworCX0KKworaW9jdGxfZXJyb3I6CisJa2ZyZWUoa2RhdGEpOworCXJl
dHVybiByZXQ7Cit9CisKK3N0YXRpYyBjb25zdCBzdHJ1Y3QgZmlsZV9vcGVyYXRpb25zIHZob3N0
X3ZkbWFidWZfZm9wcyA9IHsKKwkub3duZXIgPSBUSElTX01PRFVMRSwKKwkub3BlbiA9IHZob3N0
X3ZkbWFidWZfb3BlbiwKKwkucmVsZWFzZSA9IHZob3N0X3ZkbWFidWZfcmVsZWFzZSwKKwkucmVh
ZCA9IHZob3N0X3ZkbWFidWZfZXZlbnRfcmVhZCwKKwkucG9sbCA9IHZob3N0X3ZkbWFidWZfZXZl
bnRfcG9sbCwKKwkudW5sb2NrZWRfaW9jdGwgPSB2aG9zdF92ZG1hYnVmX2lvY3RsLAorfTsKKwor
c3RhdGljIHN0cnVjdCBtaXNjZGV2aWNlIHZob3N0X3ZkbWFidWZfbWlzY2RldiA9IHsKKwkubWlu
b3IgPSBNSVNDX0RZTkFNSUNfTUlOT1IsCisJLm5hbWUgPSAidmhvc3QtdmRtYWJ1ZiIsCisJLmZv
cHMgPSAmdmhvc3RfdmRtYWJ1Zl9mb3BzLAorfTsKKworc3RhdGljIGludCBfX2luaXQgdmhvc3Rf
dmRtYWJ1Zl9pbml0KHZvaWQpCit7CisJaW50IHJldCA9IDA7CisKKwlyZXQgPSBtaXNjX3JlZ2lz
dGVyKCZ2aG9zdF92ZG1hYnVmX21pc2NkZXYpOworCWlmIChyZXQpIHsKKwkJcHJfZXJyKCJ2aG9z
dC12ZG1hYnVmOiBkcml2ZXIgY2FuJ3QgYmUgcmVnaXN0ZXJlZFxuIik7CisJCXJldHVybiByZXQ7
CisJfQorCisJZG1hX2NvZXJjZV9tYXNrX2FuZF9jb2hlcmVudCh2aG9zdF92ZG1hYnVmX21pc2Nk
ZXYudGhpc19kZXZpY2UsCisJCQkJICAgICBETUFfQklUX01BU0soNjQpKTsKKworCWRydl9pbmZv
ID0ga2NhbGxvYygxLCBzaXplb2YoKmRydl9pbmZvKSwgR0ZQX0tFUk5FTCk7CisJaWYgKCFkcnZf
aW5mbykgeworCQltaXNjX2RlcmVnaXN0ZXIoJnZob3N0X3ZkbWFidWZfbWlzY2Rldik7CisJCXJl
dHVybiAtRU5PTUVNOworCX0KKworCWRydl9pbmZvLT5kZXYgPSB2aG9zdF92ZG1hYnVmX21pc2Nk
ZXYudGhpc19kZXZpY2U7CisKKwloYXNoX2luaXQoZHJ2X2luZm8tPmJ1Zl9saXN0KTsKKwltdXRl
eF9pbml0KCZkcnZfaW5mby0+Z19tdXRleCk7CisJSU5JVF9MSVNUX0hFQUQoJmRydl9pbmZvLT5o
ZWFkX3ZkbWFidWZfbGlzdCk7CisJSU5JVF9MSVNUX0hFQUQoJmRydl9pbmZvLT5rdm1faW5zdGFu
Y2VzKTsKKworCWRydl9pbmZvLT5rdm1fbm90aWZpZXIubm90aWZpZXJfY2FsbCA9IHZob3N0X3Zk
bWFidWZfZ2V0X2t2bTsKKwlyZXQgPSBrdm1fdm1fcmVnaXN0ZXJfbm90aWZpZXIoJmRydl9pbmZv
LT5rdm1fbm90aWZpZXIpOworCisJcmV0dXJuIHJldDsKK30KKworc3RhdGljIHZvaWQgX19leGl0
IHZob3N0X3ZkbWFidWZfZGVpbml0KHZvaWQpCit7CisJbWlzY19kZXJlZ2lzdGVyKCZ2aG9zdF92
ZG1hYnVmX21pc2NkZXYpOworCXZob3N0X3ZkbWFidWZfZGVsX2FsbCgpOworCisJa3ZtX3ZtX3Vu
cmVnaXN0ZXJfbm90aWZpZXIoJmRydl9pbmZvLT5rdm1fbm90aWZpZXIpOworCWtmcmVlKGRydl9p
bmZvKTsKKwlkcnZfaW5mbyA9IE5VTEw7Cit9CisKK21vZHVsZV9pbml0KHZob3N0X3ZkbWFidWZf
aW5pdCk7Cittb2R1bGVfZXhpdCh2aG9zdF92ZG1hYnVmX2RlaW5pdCk7CisKK01PRFVMRV9ERVND
UklQVElPTigiVmhvc3QgVmRtYWJ1ZiBEcml2ZXIiKTsKK01PRFVMRV9MSUNFTlNFKCJHUEwgYW5k
IGFkZGl0aW9uYWwgcmlnaHRzIik7CmRpZmYgLS1naXQgYS9pbmNsdWRlL3VhcGkvbGludXgvdmhv
c3QuaCBiL2luY2x1ZGUvdWFwaS9saW51eC92aG9zdC5oCmluZGV4IGM5OTg4NjBkN2JiYy4uODdl
MGQxYjhjYzc2IDEwMDY0NAotLS0gYS9pbmNsdWRlL3VhcGkvbGludXgvdmhvc3QuaAorKysgYi9p
bmNsdWRlL3VhcGkvbGludXgvdmhvc3QuaApAQCAtMTUwLDQgKzE1MCw3IEBACiAvKiBHZXQgdGhl
IHZhbGlkIGlvdmEgcmFuZ2UgKi8KICNkZWZpbmUgVkhPU1RfVkRQQV9HRVRfSU9WQV9SQU5HRQlf
SU9SKFZIT1NUX1ZJUlRJTywgMHg3OCwgXAogCQkJCQkgICAgIHN0cnVjdCB2aG9zdF92ZHBhX2lv
dmFfcmFuZ2UpCisKKy8qIFZIT1NUX1ZETUFCVUYgc3BlY2lmaWMgZGVmaW5lcyAqLworI2RlZmlu
ZSBWSE9TVF9WRE1BQlVGX1NFVF9SVU5OSU5HICAgICAgIF9JT1coVkhPU1RfVklSVElPLCAweDgw
LCBpbnQpCiAjZW5kaWYKLS0gCjIuMjYuMgoKX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX18KVmlydHVhbGl6YXRpb24gbWFpbGluZyBsaXN0ClZpcnR1YWxpemF0
aW9uQGxpc3RzLmxpbnV4LWZvdW5kYXRpb24ub3JnCmh0dHBzOi8vbGlzdHMubGludXhmb3VuZGF0
aW9uLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3ZpcnR1YWxpemF0aW9u
