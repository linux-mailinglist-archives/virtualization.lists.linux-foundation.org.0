Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 435C2228AAB
	for <lists.virtualization@lfdr.de>; Tue, 21 Jul 2020 23:16:27 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by hemlock.osuosl.org (Postfix) with ESMTP id BD83B84371;
	Tue, 21 Jul 2020 21:16:25 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id 5BOrz4TPiUzG; Tue, 21 Jul 2020 21:16:24 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by hemlock.osuosl.org (Postfix) with ESMTP id 64C46882BD;
	Tue, 21 Jul 2020 21:16:19 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 44D1AC016F;
	Tue, 21 Jul 2020 21:16:19 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 739A0C08A9
 for <virtualization@lists.linux-foundation.org>;
 Tue, 21 Jul 2020 21:16:05 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id 309E322735
 for <virtualization@lists.linux-foundation.org>;
 Tue, 21 Jul 2020 21:16:05 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id tFsseo2P7xFc
 for <virtualization@lists.linux-foundation.org>;
 Tue, 21 Jul 2020 21:16:00 +0000 (UTC)
X-Greylist: from auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by silver.osuosl.org (Postfix) with ESMTPS id 3D0332276C
 for <virtualization@lists.linux-foundation.org>;
 Tue, 21 Jul 2020 21:15:57 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp02.buh.bitdefender.net [10.17.80.76])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 507F2305D50B; Wed, 22 Jul 2020 00:09:32 +0300 (EEST)
Received: from localhost.localdomain (unknown [91.199.104.27])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 2D61F303EF1F;
 Wed, 22 Jul 2020 00:09:32 +0300 (EEST)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v9 83/84] KVM: introspection: emulate a guest page table walk
 on SPT violations due to A/D bit updates
Date: Wed, 22 Jul 2020 00:09:21 +0300
Message-Id: <20200721210922.7646-84-alazar@bitdefender.com>
In-Reply-To: <20200721210922.7646-1-alazar@bitdefender.com>
References: <20200721210922.7646-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKT24gU1BUIHBhZ2Ug
ZmF1bHRzIGNhdXNlZCBieSBndWVzdCBwYWdlIHRhYmxlIHdhbGtzLCB1c2UgdGhlIGV4aXN0aW5n
Cmd1ZXN0IHBhZ2UgdGFibGUgd2FsayBjb2RlIHRvIG1ha2UgdGhlIG5lY2Vzc2FyeSBhZGp1c3Rt
ZW50cyB0byB0aGUgQS9ECmJpdHMgYW5kIHJldHVybiB0byBndWVzdC4gVGhpcyBlZmZlY3RpdmVs
eSBieXBhc3NlcyB0aGUgeDg2IGVtdWxhdG9yCndobyB3YXMgbWFraW5nIHRoZSB3cm9uZyBtb2Rp
ZmljYXRpb25zIGxlYWRpbmcgb25lIE9TIChXaW5kb3dzIDguMSB4NjQpCnRvIHRyaXBsZS1mYXVs
dCB2ZXJ5IGVhcmx5IGluIHRoZSBib290IHByb2Nlc3Mgd2l0aCB0aGUgaW50cm9zcGVjdGlvbgpl
bmFibGVkLgoKV2l0aCBpbnRyb3NwZWN0aW9uIGRpc2FibGVkLCB0aGVzZSBmYXVsdHMgYXJlIGhh
bmRsZWQgYnkgc2ltcGx5IHJlbW92aW5nCnRoZSBwcm90ZWN0aW9uIGZyb20gdGhlIGFmZmVjdGVk
IGd1ZXN0IHBhZ2UgYW5kIHJldHVybmluZyB0byBndWVzdC4KClNpZ25lZC1vZmYtYnk6IE1paGFp
IERvbsibdSA8bWRvbnR1QGJpdGRlZmVuZGVyLmNvbT4KU2lnbmVkLW9mZi1ieTogQWRhbGJlcnQg
TGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29tPgotLS0KIGFyY2gveDg2L2luY2x1ZGUvYXNt
L2t2bWlfaG9zdC5oIHwgIDIgKysKIGFyY2gveDg2L2t2bS9rdm1pLmMgICAgICAgICAgICAgIHwg
MzMgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIGFyY2gveDg2L2t2bS9tbXUvbW11
LmMgICAgICAgICAgIHwgMTIgKysrKysrKysrKy0tCiBpbmNsdWRlL2xpbnV4L2t2bWlfaG9zdC5o
ICAgICAgICB8ICAzICsrKwogdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMgICAgfCAyNiAr
KysrKysrKysrKysrKysrKysrKysrKysrCiA1IGZpbGVzIGNoYW5nZWQsIDc0IGluc2VydGlvbnMo
KyksIDIgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYvaW5jbHVkZS9hc20va3Zt
aV9ob3N0LmggYi9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaAppbmRleCAyNWM3YmI4
YTkwODIuLjUwOWZhM2ZmZjVlNyAxMDA2NDQKLS0tIGEvYXJjaC94ODYvaW5jbHVkZS9hc20va3Zt
aV9ob3N0LmgKKysrIGIvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtaV9ob3N0LmgKQEAgLTY0LDYg
KzY0LDcgQEAgYm9vbCBrdm1pX2Rlc2NyaXB0b3JfZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1
LCB1OCBkZXNjcmlwdG9yLCBib29sIHdyaXRlKTsKIGJvb2wga3ZtaV9tc3JfZXZlbnQoc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCBzdHJ1Y3QgbXNyX2RhdGEgKm1zcik7CiBib29sIGt2bWlfbW9uaXRv
cl9tc3J3X2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiBtc3IsIGJvb2wgZW5h
YmxlKTsKIGJvb2wga3ZtaV9tc3J3X2ludGVyY2VwdF9vcmlnaW5hdG9yKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSk7Citib29sIGt2bWlfdXBkYXRlX2FkX2ZsYWdzKHN0cnVjdCBrdm1fdmNwdSAqdmNw
dSk7CiAKICNlbHNlIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwogCkBAIC04OCw2ICs4
OSw3IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX21vbml0b3JfbXNyd19pbnRlcmNlcHQoc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLAogCQkJCQkgICAgICAgYm9vbCBlbmFibGUpIHsg
cmV0dXJuIGZhbHNlOyB9CiBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9tc3J3X2ludGVyY2VwdF9v
cmlnaW5hdG9yKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkKIAkJCQl7IHJldHVybiBmYWxzZTsgfQor
c3RhdGljIGlubGluZSBib29sIGt2bWlfdXBkYXRlX2FkX2ZsYWdzKHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSkgeyByZXR1cm4gZmFsc2U7IH0KIAogI2VuZGlmIC8qIENPTkZJR19LVk1fSU5UUk9TUEVD
VElPTiAqLwogCmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9rdm0va3ZtaS5jIGIvYXJjaC94ODYva3Zt
L2t2bWkuYwppbmRleCA4MDUxZDA2MDY0YWIuLjRlNzU4NThjMDNiNCAxMDA2NDQKLS0tIGEvYXJj
aC94ODYva3ZtL2t2bWkuYworKysgYi9hcmNoL3g4Ni9rdm0va3ZtaS5jCkBAIC0xMzc4LDMgKzEz
NzgsMzYgQEAgZ3BhX3Qga3ZtaV9hcmNoX2NtZF90cmFuc2xhdGVfZ3ZhKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSwgZ3ZhX3QgZ3ZhKQogewogCXJldHVybiBrdm1fbW11X2d2YV90b19ncGFfc3lzdGVt
KHZjcHUsIGd2YSwgMCwgTlVMTCk7CiB9CisKK2Jvb2wga3ZtaV91cGRhdGVfYWRfZmxhZ3Moc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1KQoreworCXN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaTsK
Kwlib29sIHJldCA9IGZhbHNlOworCWd2YV90IGd2YTsKKwlncGFfdCBncGE7CisKKwlrdm1pID0g
a3ZtaV9nZXQodmNwdS0+a3ZtKTsKKwlpZiAoIWt2bWkpCisJCXJldHVybiBmYWxzZTsKKworCWd2
YSA9IGt2bV94ODZfb3BzLmZhdWx0X2dsYSh2Y3B1KTsKKwlpZiAoZ3ZhID09IH4wdWxsKSB7CisJ
CWt2bWlfd2Fybl9vbmNlKGt2bWksICIlczogY2Fubm90IHBlcmZvcm0gdHJhbnNsYXRpb25cbiIs
CisJCQkgICAgICAgX19mdW5jX18pOworCQlnb3RvIG91dDsKKwl9CisKKwlncGEgPSBrdm1fbW11
X2d2YV90b19ncGFfc3lzdGVtKHZjcHUsIGd2YSwgUEZFUlJfV1JJVEVfTUFTSywgTlVMTCk7CisJ
aWYgKGdwYSA9PSBVTk1BUFBFRF9HVkEpIHsKKwkJc3RydWN0IHg4Nl9leGNlcHRpb24gZXhjZXB0
aW9uID0geyB9OworCisJCWdwYSA9IGt2bV9tbXVfZ3ZhX3RvX2dwYV9zeXN0ZW0odmNwdSwgZ3Zh
LCAwLCAmZXhjZXB0aW9uKTsKKwl9CisKKwlyZXQgPSAoZ3BhICE9IFVOTUFQUEVEX0dWQSk7CisK
K291dDoKKwlrdm1pX3B1dCh2Y3B1LT5rdm0pOworCisJcmV0dXJuIHJldDsKK30KZGlmZiAtLWdp
dCBhL2FyY2gveDg2L2t2bS9tbXUvbW11LmMgYi9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCmluZGV4
IDRkZjViNzI5ZTJjNS4uOTc3NjZmMzQ5MTBkIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vbW11
L21tdS5jCisrKyBiL2FyY2gveDg2L2t2bS9tbXUvbW11LmMKQEAgLTQwLDYgKzQwLDcgQEAKICNp
bmNsdWRlIDxsaW51eC9oYXNoLmg+CiAjaW5jbHVkZSA8bGludXgva2Vybl9sZXZlbHMuaD4KICNp
bmNsdWRlIDxsaW51eC9rdGhyZWFkLmg+CisjaW5jbHVkZSA8bGludXgva3ZtaV9ob3N0Lmg+CiAK
ICNpbmNsdWRlIDxhc20vcGFnZS5oPgogI2luY2x1ZGUgPGFzbS9tZW10eXBlLmg+CkBAIC01NTQ5
LDggKzU1NTAsMTUgQEAgaW50IGt2bV9tbXVfcGFnZV9mYXVsdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZj
cHUsIGdwYV90IGNyMl9vcl9ncGEsIHU2NCBlcnJvcl9jb2RlLAogCSAqLwogCWlmICh2Y3B1LT5h
cmNoLm1tdS0+ZGlyZWN0X21hcCAmJgogCSAgICAoZXJyb3JfY29kZSAmIFBGRVJSX05FU1RFRF9H
VUVTVF9QQUdFKSA9PSBQRkVSUl9ORVNURURfR1VFU1RfUEFHRSkgewotCQlrdm1fbW11X3VucHJv
dGVjdF9wYWdlKHZjcHUtPmt2bSwgZ3BhX3RvX2dmbihjcjJfb3JfZ3BhKSk7Ci0JCXJldHVybiAx
OworCQlnZm5fdCBnZm4gPSBncGFfdG9fZ2ZuKGNyMl9vcl9ncGEpOworCisJCWlmIChrdm1pX3Ry
YWNrZWRfZ2ZuKHZjcHUsIGdmbikpIHsKKwkJCWlmIChrdm1pX3VwZGF0ZV9hZF9mbGFncyh2Y3B1
KSkKKwkJCQlyZXR1cm4gMTsKKwkJfSBlbHNlIHsKKwkJCWt2bV9tbXVfdW5wcm90ZWN0X3BhZ2Uo
dmNwdS0+a3ZtLCBnZm4pOworCQkJcmV0dXJuIDE7CisJCX0KIAl9CiAKIAkvKgpkaWZmIC0tZ2l0
IGEvaW5jbHVkZS9saW51eC9rdm1pX2hvc3QuaCBiL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgK
aW5kZXggYjAxZTg1MDVmNDkzLi41YmFlZjY4ZDhjYmUgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGlu
dXgva3ZtaV9ob3N0LmgKKysrIGIvaW5jbHVkZS9saW51eC9rdm1pX2hvc3QuaApAQCAtOTYsNiAr
OTYsNyBAQCBib29sIGt2bWlfZW50ZXJfZ3Vlc3Qoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsKIGJv
b2wga3ZtaV92Y3B1X3J1bm5pbmdfc2luZ2xlc3RlcChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpOwog
dm9pZCBrdm1pX3NpbmdsZXN0ZXBfZG9uZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpOwogdm9pZCBr
dm1pX3NpbmdsZXN0ZXBfZmFpbGVkKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSk7Citib29sIGt2bWlf
dHJhY2tlZF9nZm4oc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBnZm5fdCBnZm4pOwogCiAjZWxzZQog
CkBAIC0xMTYsNiArMTE3LDggQEAgc3RhdGljIGlubGluZSBib29sIGt2bWlfdmNwdV9ydW5uaW5n
X3NpbmdsZXN0ZXAoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogCQkJeyByZXR1cm4gZmFsc2U7IH0K
IHN0YXRpYyBpbmxpbmUgdm9pZCBrdm1pX3NpbmdsZXN0ZXBfZG9uZShzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUpIHsgfQogc3RhdGljIGlubGluZSB2b2lkIGt2bWlfc2luZ2xlc3RlcF9mYWlsZWQoc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1KSB7IH0KK3N0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX3RyYWNrZWRf
Z2ZuKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ2ZuX3QgZ2ZuKQorCQkJeyByZXR1cm4gZmFsc2U7
IH0KIAogI2VuZGlmIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwogCmRpZmYgLS1naXQg
YS92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYyBiL3ZpcnQva3ZtL2ludHJvc3BlY3Rpb24v
a3ZtaS5jCmluZGV4IDUzODI1NjliMTkwYi4uMmE5NmI4MGJkZGIyIDEwMDY0NAotLS0gYS92aXJ0
L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYworKysgYi92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2
bWkuYwpAQCAtMTM4MSwzICsxMzgxLDI5IEBAIHZvaWQga3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChz
dHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCiAJa3ZtaV9oYW5kbGVfc2luZ2xlc3RlcF9leGl0KHZjcHUs
IGZhbHNlKTsKIH0KIEVYUE9SVF9TWU1CT0woa3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZCk7CisKK3N0
YXRpYyBib29sIF9fa3ZtaV90cmFja2VkX2dmbihzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2
bWksIGdmbl90IGdmbikKK3sKKwl1OCBpZ25vcmVkX2FjY2VzczsKKworCWlmIChrdm1pX2dldF9n
Zm5fYWNjZXNzKGt2bWksIGdmbiwgJmlnbm9yZWRfYWNjZXNzKSkKKwkJcmV0dXJuIGZhbHNlOwor
CisJcmV0dXJuIHRydWU7Cit9CisKK2Jvb2wga3ZtaV90cmFja2VkX2dmbihzdHJ1Y3Qga3ZtX3Zj
cHUgKnZjcHUsIGdmbl90IGdmbikKK3sKKwlzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWk7
CisJYm9vbCByZXQ7CisKKwlrdm1pID0ga3ZtaV9nZXQodmNwdS0+a3ZtKTsKKwlpZiAoIWt2bWkp
CisJCXJldHVybiBmYWxzZTsKKworCXJldCA9IF9fa3ZtaV90cmFja2VkX2dmbihrdm1pLCBnZm4p
OworCisJa3ZtaV9wdXQodmNwdS0+a3ZtKTsKKworCXJldHVybiByZXQ7Cit9Cl9fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClZpcnR1YWxpemF0aW9uIG1haWxp
bmcgbGlzdApWaXJ0dWFsaXphdGlvbkBsaXN0cy5saW51eC1mb3VuZGF0aW9uLm9yZwpodHRwczov
L2xpc3RzLmxpbnV4Zm91bmRhdGlvbi5vcmcvbWFpbG1hbi9saXN0aW5mby92aXJ0dWFsaXphdGlv
bg==
