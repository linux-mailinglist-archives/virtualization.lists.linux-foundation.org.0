Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
	by mail.lfdr.de (Postfix) with ESMTPS id D83B7155E49
	for <lists.virtualization@lfdr.de>; Fri,  7 Feb 2020 19:36:23 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by fraxinus.osuosl.org (Postfix) with ESMTP id 88D27869C0;
	Fri,  7 Feb 2020 18:36:22 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id o-n8DLL4JA-W; Fri,  7 Feb 2020 18:36:19 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by fraxinus.osuosl.org (Postfix) with ESMTP id 6237C869BC;
	Fri,  7 Feb 2020 18:36:10 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 349F1C013E;
	Fri,  7 Feb 2020 18:36:10 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id DE138C013E
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:36:03 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id D6ED92263C
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:36:03 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id t3Tzor624iod
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:58 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by silver.osuosl.org (Postfix) with ESMTPS id F3DE52264C
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:55 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 1CA7E305D3F5; Fri,  7 Feb 2020 20:16:40 +0200 (EET)
Received: from host.bbu.bitdefender.biz (unknown [195.210.4.22])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 0A591305206E;
 Fri,  7 Feb 2020 20:16:40 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [RFC PATCH v7 33/78] KVM: x86: wire in the preread/prewrite/preexec
 page trackers
Date: Fri,  7 Feb 2020 20:15:51 +0200
Message-Id: <20200207181636.1065-34-alazar@bitdefender.com>
In-Reply-To: <20200207181636.1065-1-alazar@bitdefender.com>
References: <20200207181636.1065-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 Sean Christopherson <sean.j.christopherson@intel.com>,
 virtualization@lists.linux-foundation.org,
 =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Marian Rotariu <marian.c.rotariu@gmail.com>,
 Paolo Bonzini <pbonzini@redhat.com>
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKVGhlc2UgYXJlIG5l
ZWRlZCBieSB0aGUgaW50cm9zcGVjdGlvbiBzdWJzeXN0ZW0uCgpTaWduZWQtb2ZmLWJ5OiBNaWhh
aSBEb27Im3UgPG1kb250dUBiaXRkZWZlbmRlci5jb20+CkNvLWRldmVsb3BlZC1ieTogTWFyaWFu
IFJvdGFyaXUgPG1hcmlhbi5jLnJvdGFyaXVAZ21haWwuY29tPgpTaWduZWQtb2ZmLWJ5OiBNYXJp
YW4gUm90YXJpdSA8bWFyaWFuLmMucm90YXJpdUBnbWFpbC5jb20+ClNpZ25lZC1vZmYtYnk6IEFk
YWxiZXJ0IExhesSDciA8YWxhemFyQGJpdGRlZmVuZGVyLmNvbT4KLS0tCiBhcmNoL3g4Ni9pbmNs
dWRlL2FzbS9rdm1fZW11bGF0ZS5oIHwgIDEgKwogYXJjaC94ODYva3ZtL2VtdWxhdGUuYyAgICAg
ICAgICAgICB8ICA0ICsrKwogYXJjaC94ODYva3ZtL21tdS9tbXUuYyAgICAgICAgICAgICB8IDU3
ICsrKysrKysrKysrKysrKysrKysrKysrLS0tLS0tLQogYXJjaC94ODYva3ZtL3g4Ni5jICAgICAg
ICAgICAgICAgICB8IDQyICsrKysrKysrKysrKysrKysrLS0tLS0KIDQgZmlsZXMgY2hhbmdlZCwg
ODMgaW5zZXJ0aW9ucygrKSwgMjEgZGVsZXRpb25zKC0pCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYv
aW5jbHVkZS9hc20va3ZtX2VtdWxhdGUuaCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bV9lbXVs
YXRlLmgKaW5kZXggNzdjZjZjMTFmNjZiLi4wNjdiOTViZDgzYzYgMTAwNjQ0Ci0tLSBhL2FyY2gv
eDg2L2luY2x1ZGUvYXNtL2t2bV9lbXVsYXRlLmgKKysrIGIvYXJjaC94ODYvaW5jbHVkZS9hc20v
a3ZtX2VtdWxhdGUuaApAQCAtNDQ3LDYgKzQ0Nyw3IEBAIGJvb2wgeDg2X3BhZ2VfdGFibGVfd3Jp
dGluZ19pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0KTsKICNkZWZpbmUgRU1VTEFU
SU9OX09LIDAKICNkZWZpbmUgRU1VTEFUSU9OX1JFU1RBUlQgMQogI2RlZmluZSBFTVVMQVRJT05f
SU5URVJDRVBURUQgMgorI2RlZmluZSBFTVVMQVRJT05fUkVUUllfSU5TVFIgMwogdm9pZCBpbml0
X2RlY29kZV9jYWNoZShzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCk7CiBpbnQgeDg2X2Vt
dWxhdGVfaW5zbihzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCk7CiBpbnQgZW11bGF0b3Jf
dGFza19zd2l0Y2goc3RydWN0IHg4Nl9lbXVsYXRlX2N0eHQgKmN0eHQsCmRpZmYgLS1naXQgYS9h
cmNoL3g4Ni9rdm0vZW11bGF0ZS5jIGIvYXJjaC94ODYva3ZtL2VtdWxhdGUuYwppbmRleCA5NTJk
MWE0ZjRkN2UuLjJhZjliZjdlMjI2YiAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL2VtdWxhdGUu
YworKysgYi9hcmNoL3g4Ni9rdm0vZW11bGF0ZS5jCkBAIC01NDE0LDYgKzU0MTQsOCBAQCBpbnQg
eDg2X2RlY29kZV9pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0LCB2b2lkICppbnNu
LCBpbnQgaW5zbl9sZW4pCiAJCQkJCWN0eHQtPm1lbW9wcC0+YWRkci5tZW0uZWEgKyBjdHh0LT5f
ZWlwKTsKIAogZG9uZToKKwlpZiAocmMgPT0gWDg2RU1VTF9SRVRSWV9JTlNUUikKKwkJcmV0dXJu
IEVNVUxBVElPTl9SRVRSWV9JTlNUUjsKIAlpZiAocmMgPT0gWDg2RU1VTF9QUk9QQUdBVEVfRkFV
TFQpCiAJCWN0eHQtPmhhdmVfZXhjZXB0aW9uID0gdHJ1ZTsKIAlyZXR1cm4gKHJjICE9IFg4NkVN
VUxfQ09OVElOVUUpID8gRU1VTEFUSU9OX0ZBSUxFRCA6IEVNVUxBVElPTl9PSzsKQEAgLTU3ODYs
NiArNTc4OCw4IEBAIGludCB4ODZfZW11bGF0ZV9pbnNuKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0
ICpjdHh0KQogCWlmIChyYyA9PSBYODZFTVVMX0lOVEVSQ0VQVEVEKQogCQlyZXR1cm4gRU1VTEFU
SU9OX0lOVEVSQ0VQVEVEOwogCisJaWYgKHJjID09IFg4NkVNVUxfUkVUUllfSU5TVFIpCisJCXJl
dHVybiBFTVVMQVRJT05fUkVUUllfSU5TVFI7CiAJaWYgKHJjID09IFg4NkVNVUxfQ09OVElOVUUp
CiAJCXdyaXRlYmFja19yZWdpc3RlcnMoY3R4dCk7CiAKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2
bS9tbXUvbW11LmMgYi9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCmluZGV4IDEyNGU3Y2E3M2I0OC4u
NWYwZGRjNmI2N2RlIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9rdm0vbW11L21tdS5jCisrKyBiL2Fy
Y2gveDg2L2t2bS9tbXUvbW11LmMKQEAgLTEyMTgsOSArMTIxOCwxMyBAQCBzdGF0aWMgdm9pZCBh
Y2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0gKmt2bSwgc3RydWN0IGt2bV9tbXVfcGFnZSAqc3Ap
CiAJc2xvdCA9IF9fZ2ZuX3RvX21lbXNsb3Qoc2xvdHMsIGdmbik7CiAKIAkvKiB0aGUgbm9uLWxl
YWYgc2hhZG93IHBhZ2VzIGFyZSBrZWVwaW5nIHJlYWRvbmx5LiAqLwotCWlmIChzcC0+cm9sZS5s
ZXZlbCA+IFBUX1BBR0VfVEFCTEVfTEVWRUwpCi0JCXJldHVybiBrdm1fc2xvdF9wYWdlX3RyYWNr
X2FkZF9wYWdlKGt2bSwgc2xvdCwgZ2ZuLAotCQkJCQkJICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRF
KTsKKwlpZiAoc3AtPnJvbGUubGV2ZWwgPiBQVF9QQUdFX1RBQkxFX0xFVkVMKSB7CisJCWt2bV9z
bG90X3BhZ2VfdHJhY2tfYWRkX3BhZ2Uoa3ZtLCBzbG90LCBnZm4sCisJCQkJCSAgICAgS1ZNX1BB
R0VfVFJBQ0tfUFJFV1JJVEUpOworCQlrdm1fc2xvdF9wYWdlX3RyYWNrX2FkZF9wYWdlKGt2bSwg
c2xvdCwgZ2ZuLAorCQkJCQkgICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRFKTsKKwkJcmV0dXJuOwor
CX0KIAogCWt2bV9tbXVfZ2ZuX2Rpc2FsbG93X2xwYWdlKHNsb3QsIGdmbik7CiB9CkBAIC0xMjQ2
LDkgKzEyNTAsMTMgQEAgc3RhdGljIHZvaWQgdW5hY2NvdW50X3NoYWRvd2VkKHN0cnVjdCBrdm0g
Kmt2bSwgc3RydWN0IGt2bV9tbXVfcGFnZSAqc3ApCiAJZ2ZuID0gc3AtPmdmbjsKIAlzbG90cyA9
IGt2bV9tZW1zbG90c19mb3Jfc3B0ZV9yb2xlKGt2bSwgc3AtPnJvbGUpOwogCXNsb3QgPSBfX2dm
bl90b19tZW1zbG90KHNsb3RzLCBnZm4pOwotCWlmIChzcC0+cm9sZS5sZXZlbCA+IFBUX1BBR0Vf
VEFCTEVfTEVWRUwpCi0JCXJldHVybiBrdm1fc2xvdF9wYWdlX3RyYWNrX3JlbW92ZV9wYWdlKGt2
bSwgc2xvdCwgZ2ZuLAotCQkJCQkJICAgICAgIEtWTV9QQUdFX1RSQUNLX1dSSVRFKTsKKwlpZiAo
c3AtPnJvbGUubGV2ZWwgPiBQVF9QQUdFX1RBQkxFX0xFVkVMKSB7CisJCWt2bV9zbG90X3BhZ2Vf
dHJhY2tfcmVtb3ZlX3BhZ2Uoa3ZtLCBzbG90LCBnZm4sCisJCQkJCQlLVk1fUEFHRV9UUkFDS19Q
UkVXUklURSk7CisJCWt2bV9zbG90X3BhZ2VfdHJhY2tfcmVtb3ZlX3BhZ2Uoa3ZtLCBzbG90LCBn
Zm4sCisJCQkJCQlLVk1fUEFHRV9UUkFDS19XUklURSk7CisJCXJldHVybjsKKwl9CiAKIAlrdm1f
bW11X2dmbl9hbGxvd19scGFnZShzbG90LCBnZm4pOwogfQpAQCAtMzA0MSw3ICszMDQ5LDggQEAg
c3RhdGljIGJvb2wgbW11X25lZWRfd3JpdGVfcHJvdGVjdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IGdmbl90IGdmbiwKIHsKIAlzdHJ1Y3Qga3ZtX21tdV9wYWdlICpzcDsKIAotCWlmIChrdm1fcGFn
ZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19XUklURSkpCisJaWYg
KGt2bV9wYWdlX3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9QQUdFX1RSQUNLX1BSRVdS
SVRFKSB8fAorCSAgICBrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFH
RV9UUkFDS19XUklURSkpCiAJCXJldHVybiB0cnVlOwogCiAJZm9yX2VhY2hfZ2ZuX2luZGlyZWN0
X3ZhbGlkX3NwKHZjcHUtPmt2bSwgc3AsIGdmbikgewpAQCAtMzM5OCw2ICszNDA3LDIxIEBAIHN0
YXRpYyB2b2lkIGRpc2FsbG93ZWRfaHVnZXBhZ2VfYWRqdXN0KHN0cnVjdCBrdm1fc2hhZG93X3dh
bGtfaXRlcmF0b3IgaXQsCiAJfQogfQogCitzdGF0aWMgdW5zaWduZWQgaW50IGt2bV9tbXVfYXBw
bHlfaW50cm9zcGVjdGlvbl9hY2Nlc3Moc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAorCQkJCQkJCWdm
bl90IGdmbiwKKwkJCQkJCQl1bnNpZ25lZCBpbnQgYWNjKQoreworCWlmIChrdm1fcGFnZV90cmFj
a19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19QUkVSRUFEKSkKKwkJYWNjICY9
IH5BQ0NfVVNFUl9NQVNLOworCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2Zu
LCBLVk1fUEFHRV9UUkFDS19QUkVXUklURSkgfHwKKwkgICAga3ZtX3BhZ2VfdHJhY2tfaXNfYWN0
aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0VfVFJBQ0tfV1JJVEUpKQorCQlhY2MgJj0gfkFDQ19XUklU
RV9NQVNLOworCWlmIChrdm1fcGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFH
RV9UUkFDS19QUkVFWEVDKSkKKwkJYWNjICY9IH5BQ0NfRVhFQ19NQVNLOworCisJcmV0dXJuIGFj
YzsKK30KKwogc3RhdGljIGludCBfX2RpcmVjdF9tYXAoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBn
cGFfdCBncGEsIGludCB3cml0ZSwKIAkJCWludCBtYXBfd3JpdGFibGUsIGludCBsZXZlbCwga3Zt
X3Bmbl90IHBmbiwKIAkJCWJvb2wgcHJlZmF1bHQsIGJvb2wgbHBhZ2VfZGlzYWxsb3dlZCkKQEAg
LTM0MDcsNiArMzQzMSw3IEBAIHN0YXRpYyBpbnQgX19kaXJlY3RfbWFwKHN0cnVjdCBrdm1fdmNw
dSAqdmNwdSwgZ3BhX3QgZ3BhLCBpbnQgd3JpdGUsCiAJaW50IHJldDsKIAlnZm5fdCBnZm4gPSBn
cGEgPj4gUEFHRV9TSElGVDsKIAlnZm5fdCBiYXNlX2dmbiA9IGdmbjsKKwl1bnNpZ25lZCBpbnQg
YWNjOwogCiAJaWYgKCFWQUxJRF9QQUdFKHZjcHUtPmFyY2gubW11LT5yb290X2hwYSkpCiAJCXJl
dHVybiBSRVRfUEZfUkVUUlk7CkBAIC0zNDM0LDcgKzM0NTksOSBAQCBzdGF0aWMgaW50IF9fZGly
ZWN0X21hcChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGdwYSwgaW50IHdyaXRlLAogCQl9
CiAJfQogCi0JcmV0ID0gbW11X3NldF9zcHRlKHZjcHUsIGl0LnNwdGVwLCBBQ0NfQUxMLAorCWFj
YyA9IGt2bV9tbXVfYXBwbHlfaW50cm9zcGVjdGlvbl9hY2Nlc3ModmNwdSwgYmFzZV9nZm4sIEFD
Q19BTEwpOworCisJcmV0ID0gbW11X3NldF9zcHRlKHZjcHUsIGl0LnNwdGVwLCBhY2MsCiAJCQkg
ICB3cml0ZSwgbGV2ZWwsIGJhc2VfZ2ZuLCBwZm4sIHByZWZhdWx0LAogCQkJICAgbWFwX3dyaXRh
YmxlKTsKIAlkaXJlY3RfcHRlX3ByZWZldGNoKHZjcHUsIGl0LnNwdGVwKTsKQEAgLTQxOTksMTUg
KzQyMjYsMjEgQEAgc3RhdGljIGJvb2wgcGFnZV9mYXVsdF9oYW5kbGVfcGFnZV90cmFjayhzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUsCiAJaWYgKHVubGlrZWx5KGVycm9yX2NvZGUgJiBQRkVSUl9SU1ZE
X01BU0spKQogCQlyZXR1cm4gZmFsc2U7CiAKLQlpZiAoIShlcnJvcl9jb2RlICYgUEZFUlJfUFJF
U0VOVF9NQVNLKSB8fAotCSAgICAgICEoZXJyb3JfY29kZSAmIFBGRVJSX1dSSVRFX01BU0spKQor
CWlmICghKGVycm9yX2NvZGUgJiBQRkVSUl9QUkVTRU5UX01BU0spKQogCQlyZXR1cm4gZmFsc2U7
CiAKIAkvKgotCSAqIGd1ZXN0IGlzIHdyaXRpbmcgdGhlIHBhZ2Ugd2hpY2ggaXMgd3JpdGUgdHJh
Y2tlZCB3aGljaCBjYW4KKwkgKiBndWVzdCBpcyByZWFkaW5nL3dyaXRpbmcvZmV0Y2hpbmcgdGhl
IHBhZ2Ugd2hpY2ggaXMKKwkgKiByZWFkL3dyaXRlL2V4ZWN1dGUgdHJhY2tlZCB3aGljaCBjYW4K
IAkgKiBub3QgYmUgZml4ZWQgYnkgcGFnZSBmYXVsdCBoYW5kbGVyLgogCSAqLwotCWlmIChrdm1f
cGFnZV90cmFja19pc19hY3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19XUklURSkpCisJ
aWYgKCgoZXJyb3JfY29kZSAmIFBGRVJSX1VTRVJfTUFTSykKKwkJJiYga3ZtX3BhZ2VfdHJhY2tf
aXNfYWN0aXZlKHZjcHUsIGdmbiwgS1ZNX1BBR0VfVFJBQ0tfUFJFUkVBRCkpCisJICAgIHx8ICgo
ZXJyb3JfY29kZSAmIFBGRVJSX1dSSVRFX01BU0spCisJCSYmIChrdm1fcGFnZV90cmFja19pc19h
Y3RpdmUodmNwdSwgZ2ZuLCBLVk1fUEFHRV9UUkFDS19QUkVXUklURSkKKwkJIHx8IGt2bV9wYWdl
X3RyYWNrX2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9QQUdFX1RSQUNLX1dSSVRFKSkpCisJICAg
IHx8ICgoZXJyb3JfY29kZSAmIFBGRVJSX0ZFVENIX01BU0spCisJCSYmIGt2bV9wYWdlX3RyYWNr
X2lzX2FjdGl2ZSh2Y3B1LCBnZm4sIEtWTV9QQUdFX1RSQUNLX1BSRUVYRUMpKSkKIAkJcmV0dXJu
IHRydWU7CiAKIAlyZXR1cm4gZmFsc2U7CmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9rdm0veDg2LmMg
Yi9hcmNoL3g4Ni9rdm0veDg2LmMKaW5kZXggYzczZGE0MDc5MWE3Li44YzZhOGQwM2U0MWEgMTAw
NjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS94ODYuYworKysgYi9hcmNoL3g4Ni9rdm0veDg2LmMKQEAg
LTUzNDYsNiArNTM0Niw4IEBAIHN0YXRpYyBpbnQga3ZtX3JlYWRfZ3Vlc3RfdmlydF9oZWxwZXIo
Z3ZhX3QgYWRkciwgdm9pZCAqdmFsLCB1bnNpZ25lZCBpbnQgYnl0ZXMsCiAKIAkJaWYgKGdwYSA9
PSBVTk1BUFBFRF9HVkEpCiAJCQlyZXR1cm4gWDg2RU1VTF9QUk9QQUdBVEVfRkFVTFQ7CisJCWlm
ICgha3ZtX3BhZ2VfdHJhY2tfcHJlcmVhZCh2Y3B1LCBncGEsIGFkZHIsIHRvcmVhZCkpCisJCQly
ZXR1cm4gWDg2RU1VTF9SRVRSWV9JTlNUUjsKIAkJcmV0ID0ga3ZtX3ZjcHVfcmVhZF9ndWVzdF9w
YWdlKHZjcHUsIGdwYSA+PiBQQUdFX1NISUZULCBkYXRhLAogCQkJCQkgICAgICAgb2Zmc2V0LCB0
b3JlYWQpOwogCQlpZiAocmV0IDwgMCkgewpAQCAtNTM3Nyw2ICs1Mzc5LDkgQEAgc3RhdGljIGlu
dCBrdm1fZmV0Y2hfZ3Vlc3RfdmlydChzdHJ1Y3QgeDg2X2VtdWxhdGVfY3R4dCAqY3R4dCwKIAlp
ZiAodW5saWtlbHkoZ3BhID09IFVOTUFQUEVEX0dWQSkpCiAJCXJldHVybiBYODZFTVVMX1BST1BB
R0FURV9GQVVMVDsKIAorCWlmICgha3ZtX3BhZ2VfdHJhY2tfcHJlZXhlYyh2Y3B1LCBncGEsIGFk
ZHIpKQorCQlyZXR1cm4gWDg2RU1VTF9SRVRSWV9JTlNUUjsKKwogCW9mZnNldCA9IGFkZHIgJiAo
UEFHRV9TSVpFLTEpOwogCWlmIChXQVJOX09OKG9mZnNldCArIGJ5dGVzID4gUEFHRV9TSVpFKSkK
IAkJYnl0ZXMgPSAodW5zaWduZWQpUEFHRV9TSVpFIC0gb2Zmc2V0OwpAQCAtNTU1NywxMyArNTU2
MiwyMiBAQCBzdGF0aWMgaW50IHZjcHVfbW1pb19ndmFfdG9fZ3BhKHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSwgdW5zaWduZWQgbG9uZyBndmEsCiBpbnQgZW11bGF0b3Jfd3JpdGVfcGh5cyhzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGdwYSwgZ3ZhX3QgZ3ZhLAogCQkJY29uc3Qgdm9pZCAqdmFs
LCBpbnQgYnl0ZXMpCiB7Ci0JaW50IHJldDsKLQotCXJldCA9IGt2bV92Y3B1X3dyaXRlX2d1ZXN0
KHZjcHUsIGdwYSwgdmFsLCBieXRlcyk7Ci0JaWYgKHJldCA8IDApCi0JCXJldHVybiAwOworCWlm
ICgha3ZtX3BhZ2VfdHJhY2tfcHJld3JpdGUodmNwdSwgZ3BhLCBndmEsIHZhbCwgYnl0ZXMpKQor
CQlyZXR1cm4gWDg2RU1VTF9SRVRSWV9JTlNUUjsKKwlpZiAoa3ZtX3ZjcHVfd3JpdGVfZ3Vlc3Qo
dmNwdSwgZ3BhLCB2YWwsIGJ5dGVzKSA8IDApCisJCXJldHVybiBYODZFTVVMX1VOSEFORExFQUJM
RTsKIAlrdm1fcGFnZV90cmFja193cml0ZSh2Y3B1LCBncGEsIGd2YSwgdmFsLCBieXRlcyk7Ci0J
cmV0dXJuIDE7CisJcmV0dXJuIFg4NkVNVUxfQ09OVElOVUU7Cit9CisKK3N0YXRpYyBpbnQgZW11
bGF0b3JfcmVhZF9waHlzKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3BhX3QgZ3BhLCBndmFfdCBn
dmEsCisJCQkgICAgICB2b2lkICp2YWwsIGludCBieXRlcykKK3sKKwlpZiAoIWt2bV9wYWdlX3Ry
YWNrX3ByZXJlYWQodmNwdSwgZ3BhLCBndmEsIGJ5dGVzKSkKKwkJcmV0dXJuIFg4NkVNVUxfUkVU
UllfSU5TVFI7CisJaWYgKGt2bV92Y3B1X3JlYWRfZ3Vlc3QodmNwdSwgZ3BhLCB2YWwsIGJ5dGVz
KSA8IDApCisJCXJldHVybiBYODZFTVVMX1VOSEFORExFQUJMRTsKKwlyZXR1cm4gWDg2RU1VTF9D
T05USU5VRTsKIH0KIAogc3RydWN0IHJlYWRfd3JpdGVfZW11bGF0b3Jfb3BzIHsKQEAgLTU1OTMs
NyArNTYwNyw3IEBAIHN0YXRpYyBpbnQgcmVhZF9wcmVwYXJlKHN0cnVjdCBrdm1fdmNwdSAqdmNw
dSwgdm9pZCAqdmFsLCBpbnQgYnl0ZXMpCiBzdGF0aWMgaW50IHJlYWRfZW11bGF0ZShzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGdwYSwgZ3ZhX3QgZ3ZhLAogCQkJdm9pZCAqdmFsLCBpbnQg
Ynl0ZXMpCiB7Ci0JcmV0dXJuICFrdm1fdmNwdV9yZWFkX2d1ZXN0KHZjcHUsIGdwYSwgdmFsLCBi
eXRlcyk7CisJcmV0dXJuIGVtdWxhdG9yX3JlYWRfcGh5cyh2Y3B1LCBncGEsIGd2YSwgdmFsLCBi
eXRlcyk7CiB9CiAKIHN0YXRpYyBpbnQgd3JpdGVfZW11bGF0ZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZj
cHUsIGdwYV90IGdwYSwgZ3ZhX3QgZ3ZhLApAQCAtNTY2OCw4ICs1NjgyLDExIEBAIHN0YXRpYyBp
bnQgZW11bGF0b3JfcmVhZF93cml0ZV9vbmVwYWdlKHVuc2lnbmVkIGxvbmcgYWRkciwgdm9pZCAq
dmFsLAogCQkJcmV0dXJuIFg4NkVNVUxfUFJPUEFHQVRFX0ZBVUxUOwogCX0KIAotCWlmICghcmV0
ICYmIG9wcy0+cmVhZF93cml0ZV9lbXVsYXRlKHZjcHUsIGdwYSwgYWRkciwgdmFsLCBieXRlcykp
Ci0JCXJldHVybiBYODZFTVVMX0NPTlRJTlVFOworCWlmICghcmV0KSB7CisJCXJldCA9IG9wcy0+
cmVhZF93cml0ZV9lbXVsYXRlKHZjcHUsIGdwYSwgYWRkciwgdmFsLCBieXRlcyk7CisJCWlmIChy
ZXQgPT0gWDg2RU1VTF9DT05USU5VRSB8fCByZXQgPT0gWDg2RU1VTF9SRVRSWV9JTlNUUikKKwkJ
CXJldHVybiByZXQ7CisJfQogCiAJLyoKIAkgKiBJcyB0aGlzIE1NSU8gaGFuZGxlZCBsb2NhbGx5
PwpAQCAtNTgwMyw2ICs1ODIwLDkgQEAgc3RhdGljIGludCBlbXVsYXRvcl9jbXB4Y2hnX2VtdWxh
dGVkKHN0cnVjdCB4ODZfZW11bGF0ZV9jdHh0ICpjdHh0LAogCWlmIChrdm1fdmNwdV9tYXAodmNw
dSwgZ3BhX3RvX2dmbihncGEpLCAmbWFwKSkKIAkJZ290byBlbXVsX3dyaXRlOwogCisJaWYgKCFr
dm1fcGFnZV90cmFja19wcmV3cml0ZSh2Y3B1LCBncGEsIGFkZHIsIG5ldywgYnl0ZXMpKQorCQly
ZXR1cm4gWDg2RU1VTF9SRVRSWV9JTlNUUjsKKwogCWthZGRyID0gbWFwLmh2YSArIG9mZnNldF9p
bl9wYWdlKGdwYSk7CiAKIAlzd2l0Y2ggKGJ5dGVzKSB7CkBAIC02NjgzLDYgKzY3MDMsOCBAQCBp
bnQgeDg2X2VtdWxhdGVfaW5zdHJ1Y3Rpb24oc3RydWN0IGt2bV92Y3B1ICp2Y3B1LAogCiAJCXRy
YWNlX2t2bV9lbXVsYXRlX2luc25fc3RhcnQodmNwdSk7CiAJCSsrdmNwdS0+c3RhdC5pbnNuX2Vt
dWxhdGlvbjsKKwkJaWYgKHIgPT0gRU1VTEFUSU9OX1JFVFJZX0lOU1RSKQorCQkJcmV0dXJuIDE7
CiAJCWlmIChyICE9IEVNVUxBVElPTl9PSykgIHsKIAkJCWlmICgoZW11bGF0aW9uX3R5cGUgJiBF
TVVMVFlQRV9UUkFQX1VEKSB8fAogCQkJICAgIChlbXVsYXRpb25fdHlwZSAmIEVNVUxUWVBFX1RS
QVBfVURfRk9SQ0VEKSkgewpAQCAtNjc0MCw2ICs2NzYyLDggQEAgaW50IHg4Nl9lbXVsYXRlX2lu
c3RydWN0aW9uKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwKIAogCXIgPSB4ODZfZW11bGF0ZV9pbnNu
KGN0eHQpOwogCisJaWYgKHIgPT0gRU1VTEFUSU9OX1JFVFJZX0lOU1RSKQorCQlyZXR1cm4gMTsK
IAlpZiAociA9PSBFTVVMQVRJT05fSU5URVJDRVBURUQpCiAJCXJldHVybiAxOwogCl9fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fClZpcnR1YWxpemF0aW9uIG1h
aWxpbmcgbGlzdApWaXJ0dWFsaXphdGlvbkBsaXN0cy5saW51eC1mb3VuZGF0aW9uLm9yZwpodHRw
czovL2xpc3RzLmxpbnV4Zm91bmRhdGlvbi5vcmcvbWFpbG1hbi9saXN0aW5mby92aXJ0dWFsaXph
dGlvbg==
