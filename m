Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from smtp2.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 28F2567EFF2
	for <lists.virtualization@lfdr.de>; Fri, 27 Jan 2023 21:50:57 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by smtp2.osuosl.org (Postfix) with ESMTP id B2E1B4100C;
	Fri, 27 Jan 2023 20:50:55 +0000 (UTC)
DKIM-Filter: OpenDKIM Filter v2.11.0 smtp2.osuosl.org B2E1B4100C
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from smtp2.osuosl.org ([127.0.0.1])
	by localhost (smtp2.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id bVgbliGpWLiL; Fri, 27 Jan 2023 20:50:55 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [IPv6:2605:bc80:3010:104::8cd3:938])
	by smtp2.osuosl.org (Postfix) with ESMTPS id 7CD034048C;
	Fri, 27 Jan 2023 20:50:54 +0000 (UTC)
DKIM-Filter: OpenDKIM Filter v2.11.0 smtp2.osuosl.org 7CD034048C
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id B201DC0078;
	Fri, 27 Jan 2023 20:50:53 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from smtp2.osuosl.org (smtp2.osuosl.org [IPv6:2605:bc80:3010::133])
 by lists.linuxfoundation.org (Postfix) with ESMTP id F2AAAC002D
 for <virtualization@lists.linux-foundation.org>;
 Fri, 27 Jan 2023 20:50:51 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by smtp2.osuosl.org (Postfix) with ESMTP id BF86540339
 for <virtualization@lists.linux-foundation.org>;
 Fri, 27 Jan 2023 20:50:51 +0000 (UTC)
DKIM-Filter: OpenDKIM Filter v2.11.0 smtp2.osuosl.org BF86540339
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from smtp2.osuosl.org ([127.0.0.1])
 by localhost (smtp2.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id 1imTihoYmb6m
 for <virtualization@lists.linux-foundation.org>;
 Fri, 27 Jan 2023 20:50:51 +0000 (UTC)
X-Greylist: delayed 00:05:16 by SQLgrey-1.8.0
DKIM-Filter: OpenDKIM Filter v2.11.0 smtp2.osuosl.org 8F30B40187
Received: from mout.kundenserver.de (mout.kundenserver.de [217.72.192.74])
 by smtp2.osuosl.org (Postfix) with ESMTPS id 8F30B40187
 for <virtualization@lists.linux-foundation.org>;
 Fri, 27 Jan 2023 20:50:50 +0000 (UTC)
Received: from lenovo-t14s.redhat.com ([82.142.8.70]) by
 mrelayeu.kundenserver.de (mreue106 [212.227.15.183]) with ESMTPSA (Nemesis)
 id 1Mg6qO-1ojgP34AIw-00heND; Fri, 27 Jan 2023 21:45:04 +0100
From: Laurent Vivier <lvivier@redhat.com>
To: linux-kernel@vger.kernel.org
Subject: [PATCH v3 0/2] virtio_net: vdpa: update MAC address when it is
 generated by virtio-net
Date: Fri, 27 Jan 2023 21:44:58 +0100
Message-Id: <20230127204500.51930-1-lvivier@redhat.com>
X-Mailer: git-send-email 2.39.1
MIME-Version: 1.0
X-Provags-ID: V03:K1:TfZQpimzNNMv8hqbL9D41vCDh9lvaXnjCJ//uRr4zVq2ql49+Uq
 mIZBp/ghKq5cLNQR/0TfdSTWsccWk0W0aQXSsk2fkNQzFtjg0JSXagemyDEAD8zKalRSIkW
 Tb/biSu28xjL8Q5lkFtL/bCcDf6//ri/JJC6R5s3Fui3kZK2J0rx+W6laqlley4C43BVzWc
 8Nl5AHMscT9CjCXjC2Xjg==
UI-OutboundReport: notjunk:1;M01:P0:37D4RHoTs8k=;qvpIu9esh+64Ekg2dFOK0mB9x0k
 QZODgaVYBf8Gr1ONqYfztavLfA5YLYLARYpknwmDZjwlO513zfZe9m6ddkS6iHDk8DTXKe9G6
 GIJTBtrKexpkhk4e/ZcPYLTCqUL6BBKtNNS5o3TnI4KSIMYGHj3t4DvH+hL0euiq5KsA+XVne
 8rUVwPGemWl7vPjUqWmgnf4Ppu13/pq76+7Jki3jrC+TiyXlFyqql+3JTlb964tu2JO8jImj5
 3dSxq/L3YjB/ozEVgUhdLQ0TsEcOykYc/5pAwixNoKXLLHU55Ghi1HQGcKN43TYkJdQb5nfaE
 aJwn2ayNGz4Q8h2OdqhlvvSAL8Ip3m4Cz0UAFdn1nlqDXb519oZ3Rdxi84/lrBTnuEzhF2CRZ
 nLj85m5oPHj2nTF50GragZq1MrCesZVKapnctHrfcGuqFKludcByaoU206n37ar6r8ALhBBb8
 qpNutx5DOVApPLfUuoqTshx10BOdoaS5jKy8pKf0j6VFY/+ye9IyIr1MOANErHaHFD4EQFYzl
 Wnk4kgX0xhT2E21LniWAtJwSdiSv8+pmA5e94F/dS1DS3SQbcmMCV71XAiP52SdIBxlIDndlv
 JHoB8xHqdcH4Yh8bMCL+4e74c8FoeMZ4El/HtnvHXR1wDJjAOItOiX2hoRCNeXXX4Tfl2mrZY
 3euHrYHZenahVxCA2CEtpBpkD2tfTKlN6qmBZUZ6mCPr7EWFbcQi85VoOg6tcRVgtp5UUC9IC
 aMrk9km/OfO8PcY/aHBo+fvhJE5y9VqaQ==
Cc: Cindy Lu <lulu@redhat.com>, "Michael S. Tsirkin" <mst@redhat.com>,
 netdev@vger.kernel.org, "David S. Miller" <davem@davemloft.net>,
 =?UTF-8?q?Eugenio=20P=C3=A9rez?= <eperezma@redhat.com>,
 Eli Cohen <elic@nvidia.com>, virtualization@lists.linux-foundation.org,
 Gautam Dawar <gautam.dawar@xilinx.com>
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

When the MAC address is not provided by the vdpa device virtio_net
driver assigns a random one without notifying the device.
The consequence, in the case of mlx5_vdpa, is the internal routing
tables of the device are not updated and this can block the
communication between two namespaces.

To fix this problem, use virtnet_send_command(VIRTIO_NET_CTRL_MAC)
to set the address from virtnet_probe() when the MAC address is
not provided by the device.

v3:
  - update comments
  - fail probe if VIRTIO_NET_CTRL_MAC_ADDR_SET fails
  - move the virtnet_send_command() upper, inside the RTNL lock,
    this simplifies the cleanup in case of error, and a future patch
    from Jason adds an ASSERT_RTNL() in virtnet_send_command()
    ("virtio-net: convert rx mode setting to use workqueue")
  - add a patch to disable F_STANDBY if F_MAC is not set

v2:
  - remove vdpa_sim related fixes
  - check virtio_has_feature(vdev, VIRTIO_NET_F_MAC) rather than
    addr_assign_type

Laurent Vivier (2):
  virtio_net: disable VIRTIO_NET_F_STANDBY if VIRTIO_NET_F_MAC is not
    set
  virtio_net: notify MAC address change on device initialization

 drivers/net/virtio_net.c | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

-- 
2.39.1

_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
