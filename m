Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
	by mail.lfdr.de (Postfix) with ESMTPS id 9FA11155E3C
	for <lists.virtualization@lfdr.de>; Fri,  7 Feb 2020 19:36:17 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by fraxinus.osuosl.org (Postfix) with ESMTP id 5FDB6869D0;
	Fri,  7 Feb 2020 18:36:16 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id d-NlL3nOxS0f; Fri,  7 Feb 2020 18:36:14 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by fraxinus.osuosl.org (Postfix) with ESMTP id F2DA4869FE;
	Fri,  7 Feb 2020 18:36:07 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id DFE27C013E;
	Fri,  7 Feb 2020 18:36:07 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
 by lists.linuxfoundation.org (Postfix) with ESMTP id BFEFAC1D88
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:36:00 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by hemlock.osuosl.org (Postfix) with ESMTP id A4A0D87F92
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:36:00 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id wGDX4a4au8qy
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:57 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by hemlock.osuosl.org (Postfix) with ESMTPS id 12A9C87F5C
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:57 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 B89ED305D362; Fri,  7 Feb 2020 20:16:41 +0200 (EET)
Received: from host.bbu.bitdefender.biz (unknown [195.210.4.22])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id AA951305207A;
 Fri,  7 Feb 2020 20:16:41 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [RFC PATCH v7 68/78] KVM: introspection: restore the state of
 descriptor interception on unhook
Date: Fri,  7 Feb 2020 20:16:26 +0200
Message-Id: <20200207181636.1065-69-alazar@bitdefender.com>
In-Reply-To: <20200207181636.1065-1-alazar@bitdefender.com>
References: <20200207181636.1065-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Nicu=C8=99or=20C=C3=AE=C8=9Bu?= <ncitu@bitdefender.com>,
 Sean Christopherson <sean.j.christopherson@intel.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTmljdciZb3IgQ8OuyJt1IDxuY2l0dUBiaXRkZWZlbmRlci5jb20+CgpUaGlzIGNvbW1p
dCBhbHNvIGVuc3VyZXMgdGhhdCB0aGUgaW50cm9zcGVjdGlvbiB0b29sIGFuZCB0aGUgdXNlcnNw
YWNlCmRvIG5vdCBkaXNhYmxlIGVhY2ggb3RoZXIgdGhlIGRlc2NyaXB0b3IgYWNjZXNzIFZNLWV4
aXQuCgpTaWduZWQtb2ZmLWJ5OiBOaWN1yJlvciBDw67Im3UgPG5jaXR1QGJpdGRlZmVuZGVyLmNv
bT4KU2lnbmVkLW9mZi1ieTogQWRhbGJlcnQgTGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29t
PgotLS0KIGFyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5oIHwgIDQgKysrCiBhcmNoL3g4
Ni9rdm0va3ZtaS5jICAgICAgICAgICAgICB8IDQ1ICsrKysrKysrKysrKysrKysrKysrKysrKysr
KysrKysrCiBhcmNoL3g4Ni9rdm0vc3ZtLmMgICAgICAgICAgICAgICB8ICAzICsrKwogYXJjaC94
ODYva3ZtL3ZteC92bXguYyAgICAgICAgICAgfCAgMyArKysKIDQgZmlsZXMgY2hhbmdlZCwgNTUg
aW5zZXJ0aW9ucygrKQoKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9z
dC5oIGIvYXJjaC94ODYvaW5jbHVkZS9hc20va3ZtaV9ob3N0LmgKaW5kZXggOGY5ZTZiZDI5NTNh
Li4xMGIyNTE4NTZjMGUgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9z
dC5oCisrKyBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5oCkBAIC0xNCw2ICsxNCw3
IEBAIHN0cnVjdCBrdm1pX2ludGVyY2VwdGlvbiB7CiAJYm9vbCByZXN0b3JlX2ludGVyY2VwdGlv
bjsKIAlzdHJ1Y3Qga3ZtaV9tb25pdG9yX2ludGVyY2VwdGlvbiBicmVha3BvaW50OwogCXN0cnVj
dCBrdm1pX21vbml0b3JfaW50ZXJjZXB0aW9uIGNyM3c7CisJc3RydWN0IGt2bWlfbW9uaXRvcl9p
bnRlcmNlcHRpb24gZGVzY3JpcHRvcjsKIH07CiAKIHN0cnVjdCBrdm1fdmNwdV9hcmNoX2ludHJv
c3BlY3Rpb24gewpAQCAtMzEsNiArMzIsNyBAQCBib29sIGt2bWlfY3JfZXZlbnQoc3RydWN0IGt2
bV92Y3B1ICp2Y3B1LCB1bnNpZ25lZCBpbnQgY3IsCiBib29sIGt2bWlfY3IzX2ludGVyY2VwdGVk
KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSk7CiBib29sIGt2bWlfbW9uaXRvcl9jcjN3X2ludGVyY2Vw
dChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGJvb2wgZW5hYmxlKTsKIHZvaWQga3ZtaV94c2V0YnZf
ZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsKK2Jvb2wga3ZtaV9tb25pdG9yX2Rlc2NfaW50
ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgYm9vbCBlbmFibGUpOwogYm9vbCBrdm1pX2Rl
c2NyaXB0b3JfZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1OCBkZXNjcmlwdG9yLCB1OCB3
cml0ZSk7CiAKICNlbHNlIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwpAQCAtNDQsNiAr
NDYsOCBAQCBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9jcjNfaW50ZXJjZXB0ZWQoc3RydWN0IGt2
bV92Y3B1ICp2Y3B1KSB7IHJldHVybiBmYWxzZTsgfQogc3RhdGljIGlubGluZSBib29sIGt2bWlf
bW9uaXRvcl9jcjN3X2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsCiAJCQkJCQlib29s
IGVuYWJsZSkgeyByZXR1cm4gZmFsc2U7IH0KIHN0YXRpYyBpbmxpbmUgdm9pZCBrdm1pX3hzZXRi
dl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpIHsgfQorc3RhdGljIGlubGluZSBib29sIGt2
bWlfbW9uaXRvcl9kZXNjX2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsCisJCQkJCSAg
ICAgICBib29sIGVuYWJsZSkgeyByZXR1cm4gZmFsc2U7IH0KIHN0YXRpYyBpbmxpbmUgYm9vbCBr
dm1pX2Rlc2NyaXB0b3JfZXZlbnQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCB1OCBkZXNjcmlwdG9y
LAogCQkJCQkgdTggd3JpdGUpIHsgcmV0dXJuIHRydWU7IH0KIApkaWZmIC0tZ2l0IGEvYXJjaC94
ODYva3ZtL2t2bWkuYyBiL2FyY2gveDg2L2t2bS9rdm1pLmMKaW5kZXggZWQ5YjQ1MDYwZTJhLi4w
NDhmMGUxZjlmNzkgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS9rdm1pLmMKKysrIGIvYXJjaC94
ODYva3ZtL2t2bWkuYwpAQCAtMzExLDEyICszMTEsNTIgQEAgc3RhdGljIHZvaWQga3ZtaV9hcmNo
X2Rpc2FibGVfY3Izd19pbnRlcmNlcHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogCXZjcHUtPmFy
Y2gua3ZtaS0+Y3Izdy5rdm1faW50ZXJjZXB0ZWQgPSBmYWxzZTsKIH0KIAorLyoKKyAqIFJldHVy
bnMgdHJ1ZSBpZiBvbmUgc2lkZSAoa3ZtIG9yIGt2bWkpIHRyaWVzIHRvIGRpc2FibGUgdGhlIGRl
c2NyaXB0b3IKKyAqIGludGVyY2VwdGlvbiB3aGlsZSB0aGUgb3RoZXIgc2lkZSBpcyBzdGlsbCB0
cmFja2luZyBpdC4KKyAqLworYm9vbCBrdm1pX21vbml0b3JfZGVzY19pbnRlcmNlcHQoc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCBib29sIGVuYWJsZSkKK3sKKwlzdHJ1Y3Qga3ZtaV9pbnRlcmNlcHRp
b24gKmFyY2hfdmNwdWkgPSBSRUFEX09OQ0UodmNwdS0+YXJjaC5rdm1pKTsKKworCXJldHVybiAo
YXJjaF92Y3B1aSAmJiBhcmNoX3ZjcHVpLT5kZXNjcmlwdG9yLm1vbml0b3JfZmN0KHZjcHUsIGVu
YWJsZSkpOworfQorRVhQT1JUX1NZTUJPTChrdm1pX21vbml0b3JfZGVzY19pbnRlcmNlcHQpOwor
CitzdGF0aWMgYm9vbCBtb25pdG9yX2Rlc2NfZmN0X2t2bWkoc3RydWN0IGt2bV92Y3B1ICp2Y3B1
LCBib29sIGVuYWJsZSkKK3sKKwl2Y3B1LT5hcmNoLmt2bWktPmRlc2NyaXB0b3Iua3ZtaV9pbnRl
cmNlcHRlZCA9IGVuYWJsZTsKKworCWlmIChlbmFibGUpCisJCXZjcHUtPmFyY2gua3ZtaS0+ZGVz
Y3JpcHRvci5rdm1faW50ZXJjZXB0ZWQgPQorCQkJa3ZtX3g4Nl9vcHMtPmRlc2NfaW50ZXJjZXB0
ZWQodmNwdSk7CisJZWxzZSBpZiAodmNwdS0+YXJjaC5rdm1pLT5kZXNjcmlwdG9yLmt2bV9pbnRl
cmNlcHRlZCkKKwkJcmV0dXJuIHRydWU7CisKKwlyZXR1cm4gZmFsc2U7Cit9CisKK3N0YXRpYyBi
b29sIG1vbml0b3JfZGVzY19mY3Rfa3ZtKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgYm9vbCBlbmFi
bGUpCit7CisJaWYgKCF2Y3B1LT5hcmNoLmt2bWktPmRlc2NyaXB0b3Iua3ZtaV9pbnRlcmNlcHRl
ZCkKKwkJcmV0dXJuIGZhbHNlOworCisJdmNwdS0+YXJjaC5rdm1pLT5kZXNjcmlwdG9yLmt2bV9p
bnRlcmNlcHRlZCA9IGVuYWJsZTsKKworCWlmICghZW5hYmxlKQorCQlyZXR1cm4gdHJ1ZTsKKwor
CXJldHVybiBmYWxzZTsKK30KKwogc3RhdGljIGludCBrdm1pX2NvbnRyb2xfZGVzY19pbnRlcmNl
cHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBib29sIGVuYWJsZSkKIHsKIAlpZiAoIWt2bV94ODZf
b3BzLT51bWlwX2VtdWxhdGVkKCkpCiAJCXJldHVybiAtS1ZNX0VPUE5PVFNVUFA7CiAKKwl2Y3B1
LT5hcmNoLmt2bWktPmRlc2NyaXB0b3IubW9uaXRvcl9mY3QgPSBtb25pdG9yX2Rlc2NfZmN0X2t2
bWk7CiAJa3ZtX3g4Nl9vcHMtPmNvbnRyb2xfZGVzY19pbnRlcmNlcHQodmNwdSwgZW5hYmxlKTsK
Kwl2Y3B1LT5hcmNoLmt2bWktPmRlc2NyaXB0b3IubW9uaXRvcl9mY3QgPSBtb25pdG9yX2Rlc2Nf
ZmN0X2t2bTsKIAogCXJldHVybiAwOwogfQpAQCAtMzI0LDYgKzM2NCw5IEBAIHN0YXRpYyBpbnQg
a3ZtaV9jb250cm9sX2Rlc2NfaW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgYm9vbCBl
bmFibGUpCiBzdGF0aWMgdm9pZCBrdm1pX2FyY2hfZGlzYWJsZV9kZXNjX2ludGVyY2VwdChzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUpCiB7CiAJa3ZtaV9jb250cm9sX2Rlc2NfaW50ZXJjZXB0KHZjcHUs
IGZhbHNlKTsKKworCXZjcHUtPmFyY2gua3ZtaS0+ZGVzY3JpcHRvci5rdm1pX2ludGVyY2VwdGVk
ID0gZmFsc2U7CisJdmNwdS0+YXJjaC5rdm1pLT5kZXNjcmlwdG9yLmt2bV9pbnRlcmNlcHRlZCA9
IGZhbHNlOwogfQogCiBpbnQga3ZtaV9hcmNoX2NtZF9jb250cm9sX2ludGVyY2VwdChzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsCkBAIC0zODksMTEgKzQzMiwxMyBAQCBib29sIGt2bWlfYXJjaF92Y3B1
X2FsbG9jKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkKIAogCWFyY2hfdmNwdWktPmJyZWFrcG9pbnQu
bW9uaXRvcl9mY3QgPSBtb25pdG9yX2JwX2ZjdF9rdm07CiAJYXJjaF92Y3B1aS0+Y3Izdy5tb25p
dG9yX2ZjdCA9IG1vbml0b3JfY3Izd19mY3Rfa3ZtOworCWFyY2hfdmNwdWktPmRlc2NyaXB0b3Iu
bW9uaXRvcl9mY3QgPSBtb25pdG9yX2Rlc2NfZmN0X2t2bTsKIAogCS8qCiAJICogcGFpcmVkIHdp
dGg6CiAJICogIC0ga3ZtaV9tb25pdG9yX2JwX2ludGVyY2VwdCgpCiAJICogIC0ga3ZtaV9tb25p
dG9yX2NyM3dfaW50ZXJjZXB0KCkKKwkgKiAgLSBrdm1pX21vbml0b3JfZGVzY19pbnRlcmNlcHQo
KQogCSAqLwogCXNtcF93bWIoKTsKIAlXUklURV9PTkNFKHZjcHUtPmFyY2gua3ZtaSwgYXJjaF92
Y3B1aSk7CmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9rdm0vc3ZtLmMgYi9hcmNoL3g4Ni9rdm0vc3Zt
LmMKaW5kZXggOTg4ZWI2OTM3NTE1Li43Y2Q0OGVmMjVmNTkgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2
L2t2bS9zdm0uYworKysgYi9hcmNoL3g4Ni9rdm0vc3ZtLmMKQEAgLTczODgsNiArNzM4OCw5IEBA
IHN0YXRpYyB2b2lkIHN2bV9jb250cm9sX2Rlc2NfaW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSwgYm9vbCBlbmFibGUpCiB7CiAJc3RydWN0IHZjcHVfc3ZtICpzdm0gPSB0b19zdm0odmNw
dSk7CiAKKwlpZiAoa3ZtaV9tb25pdG9yX2Rlc2NfaW50ZXJjZXB0KHZjcHUsIGVuYWJsZSkpCisJ
CXJldHVybjsKKwogCWlmIChlbmFibGUpIHsKIAkJc2V0X2ludGVyY2VwdChzdm0sIElOVEVSQ0VQ
VF9TVE9SRV9JRFRSKTsKIAkJc2V0X2ludGVyY2VwdChzdm0sIElOVEVSQ0VQVF9TVE9SRV9HRFRS
KTsKZGlmZiAtLWdpdCBhL2FyY2gveDg2L2t2bS92bXgvdm14LmMgYi9hcmNoL3g4Ni9rdm0vdm14
L3ZteC5jCmluZGV4IDY4OTg2ZjYwMGY5OC4uZTQyM2RiYmYzY2Y1IDEwMDY0NAotLS0gYS9hcmNo
L3g4Ni9rdm0vdm14L3ZteC5jCisrKyBiL2FyY2gveDg2L2t2bS92bXgvdm14LmMKQEAgLTMwMDgs
NiArMzAwOCw5IEBAIHN0YXRpYyB2b2lkIHZteF9jb250cm9sX2Rlc2NfaW50ZXJjZXB0KHN0cnVj
dCBrdm1fdmNwdSAqdmNwdSwgYm9vbCBlbmFibGUpCiB7CiAJc3RydWN0IHZjcHVfdm14ICp2bXgg
PSB0b192bXgodmNwdSk7CiAKKwlpZiAoa3ZtaV9tb25pdG9yX2Rlc2NfaW50ZXJjZXB0KHZjcHUs
IGVuYWJsZSkpCisJCXJldHVybjsKKwogCWlmIChlbmFibGUpCiAJCXNlY29uZGFyeV9leGVjX2Nv
bnRyb2xzX3NldGJpdCh2bXgsIFNFQ09OREFSWV9FWEVDX0RFU0MpOwogCWVsc2UKX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX18KVmlydHVhbGl6YXRpb24gbWFp
bGluZyBsaXN0ClZpcnR1YWxpemF0aW9uQGxpc3RzLmxpbnV4LWZvdW5kYXRpb24ub3JnCmh0dHBz
Oi8vbGlzdHMubGludXhmb3VuZGF0aW9uLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3ZpcnR1YWxpemF0
aW9u
