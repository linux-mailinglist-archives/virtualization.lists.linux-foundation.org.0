Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
	by mail.lfdr.de (Postfix) with ESMTPS id B690D155E42
	for <lists.virtualization@lfdr.de>; Fri,  7 Feb 2020 19:36:19 +0100 (CET)
Received: from localhost (localhost [127.0.0.1])
	by silver.osuosl.org (Postfix) with ESMTP id 634B3226EA;
	Fri,  7 Feb 2020 18:36:18 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id fKJOlfXun46f; Fri,  7 Feb 2020 18:36:13 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by silver.osuosl.org (Postfix) with ESMTP id 2A84822703;
	Fri,  7 Feb 2020 18:36:01 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id 005DBC1D81;
	Fri,  7 Feb 2020 18:36:00 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from fraxinus.osuosl.org (smtp4.osuosl.org [140.211.166.137])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 41431C013E
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:57 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by fraxinus.osuosl.org (Postfix) with ESMTP id 2E1AF86972
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:57 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from fraxinus.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id L6BZjeRwt6hB
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:56 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by fraxinus.osuosl.org (Postfix) with ESMTPS id 0DAB8858FC
 for <virtualization@lists.linux-foundation.org>;
 Fri,  7 Feb 2020 18:35:56 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp01.buh.bitdefender.com [10.17.80.75])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 15E91305D36B; Fri,  7 Feb 2020 20:16:42 +0200 (EET)
Received: from host.bbu.bitdefender.biz (unknown [195.210.4.22])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 054EE305207C;
 Fri,  7 Feb 2020 20:16:42 +0200 (EET)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [RFC PATCH v7 77/78] KVM: introspection: emulate a guest page table
 walk on SPT violations due to A/D bit updates
Date: Fri,  7 Feb 2020 20:16:35 +0200
Message-Id: <20200207181636.1065-78-alazar@bitdefender.com>
In-Reply-To: <20200207181636.1065-1-alazar@bitdefender.com>
References: <20200207181636.1065-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 Sean Christopherson <sean.j.christopherson@intel.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKT24gU1BUIHBhZ2Ug
ZmF1bHRzIGNhdXNlZCBieSBndWVzdCBwYWdlIHRhYmxlIHdhbGtzLCB1c2UgdGhlIGV4aXN0aW5n
Cmd1ZXN0IHBhZ2UgdGFibGUgd2FsayBjb2RlIHRvIG1ha2UgdGhlIG5lY2Vzc2FyeSBhZGp1c3Rt
ZW50cyB0byB0aGUgQS9ECmJpdHMgYW5kIHJldHVybiB0byBndWVzdC4gVGhpcyBlZmZlY3RpdmVs
eSBieXBhc3NlcyB0aGUgeDg2IGVtdWxhdG9yCndobyB3YXMgbWFraW5nIHRoZSB3cm9uZyBtb2Rp
ZmljYXRpb25zIGxlYWRpbmcgb25lIE9TIChXaW5kb3dzIDguMSB4NjQpCnRvIHRyaXBsZS1mYXVs
dCB2ZXJ5IGVhcmx5IGluIHRoZSBib290IHByb2Nlc3Mgd2l0aCB0aGUgaW50cm9zcGVjdGlvbgpl
bmFibGVkLgoKV2l0aCBpbnRyb3NwZWN0aW9uIGRpc2FibGVkLCB0aGVzZSBmYXVsdHMgYXJlIGhh
bmRsZWQgYnkgc2ltcGx5IHJlbW92aW5nCnRoZSBwcm90ZWN0aW9uIGZyb20gdGhlIGFmZmVjdGVk
IGd1ZXN0IHBhZ2UgYW5kIHJldHVybmluZyB0byBndWVzdC4KClNpZ25lZC1vZmYtYnk6IE1paGFp
IERvbsibdSA8bWRvbnR1QGJpdGRlZmVuZGVyLmNvbT4KU2lnbmVkLW9mZi1ieTogQWRhbGJlcnQg
TGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29tPgotLS0KIGFyY2gveDg2L2luY2x1ZGUvYXNt
L2t2bWlfaG9zdC5oIHwgIDIgKysKIGFyY2gveDg2L2t2bS9rdm1pLmMgICAgICAgICAgICAgIHwg
MzMgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIGFyY2gveDg2L2t2bS9tbXUvbW11
LmMgICAgICAgICAgIHwgMTEgKysrKysrKysrLS0KIGluY2x1ZGUvbGludXgva3ZtaV9ob3N0Lmgg
ICAgICAgIHwgIDMgKysrCiB2aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYyAgICB8IDI2ICsr
KysrKysrKysrKysrKysrKysrKysrKysKIDUgZmlsZXMgY2hhbmdlZCwgNzMgaW5zZXJ0aW9ucygr
KSwgMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5oCmluZGV4IDJlNGVmZjUw
MWMwYS4uNGMyMTg4ZGM0YTJiIDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaAorKysgYi9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaApAQCAtNjEsNiAr
NjEsNyBAQCBib29sIGt2bWlfZGVzY3JpcHRvcl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IHU4IGRlc2NyaXB0b3IsIHU4IHdyaXRlKTsKIGJvb2wga3ZtaV9tc3JfZXZlbnQoc3RydWN0IGt2
bV92Y3B1ICp2Y3B1LCBzdHJ1Y3QgbXNyX2RhdGEgKm1zcik7CiBib29sIGt2bWlfbW9uaXRvcl9t
c3J3X2ludGVyY2VwdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiBtc3IsIGJvb2wgZW5hYmxl
KTsKIGJvb2wga3ZtaV9tc3J3X2ludGVyY2VwdF9vcmlnaW5hdG9yKHN0cnVjdCBrdm1fdmNwdSAq
dmNwdSk7Citib29sIGt2bWlfdXBkYXRlX2FkX2ZsYWdzKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSk7
CiAKICNlbHNlIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwogCkBAIC04Myw2ICs4NCw3
IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX21vbml0b3JfbXNyd19pbnRlcmNlcHQoc3RydWN0
IGt2bV92Y3B1ICp2Y3B1LCB1MzIgbXNyLAogCQkJCQkgICAgICAgYm9vbCBlbmFibGUpIHsgcmV0
dXJuIGZhbHNlOyB9CiBzdGF0aWMgaW5saW5lIGJvb2wga3ZtaV9tc3J3X2ludGVyY2VwdF9vcmln
aW5hdG9yKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkKIAkJCQl7IHJldHVybiBmYWxzZTsgfQorYm9v
bCBrdm1pX3VwZGF0ZV9hZF9mbGFncyhzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpIHsgcmV0dXJuIGZh
bHNlOyB9CiAKICNlbmRpZiAvKiBDT05GSUdfS1ZNX0lOVFJPU1BFQ1RJT04gKi8KIApkaWZmIC0t
Z2l0IGEvYXJjaC94ODYva3ZtL2t2bWkuYyBiL2FyY2gveDg2L2t2bS9rdm1pLmMKaW5kZXggN2Iw
MmJjODJkYmQ3Li4yMjk1NDNlZTkwZTYgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS9rdm1pLmMK
KysrIGIvYXJjaC94ODYva3ZtL2t2bWkuYwpAQCAtMTEzMywzICsxMTMzLDM2IEBAIGdwYV90IGt2
bWlfYXJjaF9jbWRfdHJhbnNsYXRlX2d2YShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGd2YV90IGd2
YSkKIHsKIAlyZXR1cm4ga3ZtX21tdV9ndmFfdG9fZ3BhX3N5c3RlbSh2Y3B1LCBndmEsIDAsIE5V
TEwpOwogfQorCitib29sIGt2bWlfdXBkYXRlX2FkX2ZsYWdzKHN0cnVjdCBrdm1fdmNwdSAqdmNw
dSkKK3sKKwlzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWk7CisJYm9vbCByZXQgPSBmYWxz
ZTsKKwlndmFfdCBndmE7CisJZ3BhX3QgZ3BhOworCisJa3ZtaSA9IGt2bWlfZ2V0KHZjcHUtPmt2
bSk7CisJaWYgKCFrdm1pKQorCQlyZXR1cm4gZmFsc2U7CisKKwlndmEgPSBrdm1feDg2X29wcy0+
ZmF1bHRfZ2xhKHZjcHUpOworCWlmIChndmEgPT0gfjB1bGwpIHsKKwkJa3ZtaV93YXJuX29uY2Uo
a3ZtaSwgIiVzOiBjYW5ub3QgcGVyZm9ybSB0cmFuc2xhdGlvblxuIiwKKwkJCSAgICAgICBfX2Z1
bmNfXyk7CisJCWdvdG8gb3V0OworCX0KKworCWdwYSA9IGt2bV9tbXVfZ3ZhX3RvX2dwYV9zeXN0
ZW0odmNwdSwgZ3ZhLCBQRkVSUl9XUklURV9NQVNLLCBOVUxMKTsKKwlpZiAoZ3BhID09IFVOTUFQ
UEVEX0dWQSkgeworCQlzdHJ1Y3QgeDg2X2V4Y2VwdGlvbiBleGNlcHRpb24gPSB7IH07CisKKwkJ
Z3BhID0ga3ZtX21tdV9ndmFfdG9fZ3BhX3N5c3RlbSh2Y3B1LCBndmEsIDAsICZleGNlcHRpb24p
OworCX0KKworCXJldCA9IChncGEgIT0gVU5NQVBQRURfR1ZBKTsKKworb3V0OgorCWt2bWlfcHV0
KHZjcHUtPmt2bSk7CisKKwlyZXR1cm4gcmV0OworfQpkaWZmIC0tZ2l0IGEvYXJjaC94ODYva3Zt
L21tdS9tbXUuYyBiL2FyY2gveDg2L2t2bS9tbXUvbW11LmMKaW5kZXggZDI4Yjc0MjVjNGYxLi42
MDM3NzZmOWJkODQgMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2t2bS9tbXUvbW11LmMKKysrIGIvYXJj
aC94ODYva3ZtL21tdS9tbXUuYwpAQCAtNTY3NSw4ICs1Njc1LDE1IEBAIGludCBrdm1fbW11X3Bh
Z2VfZmF1bHQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1LCBndmFfdCBjcjIsIHU2NCBlcnJvcl9jb2Rl
LAogCSAqLwogCWlmICh2Y3B1LT5hcmNoLm1tdS0+ZGlyZWN0X21hcCAmJgogCSAgICAoZXJyb3Jf
Y29kZSAmIFBGRVJSX05FU1RFRF9HVUVTVF9QQUdFKSA9PSBQRkVSUl9ORVNURURfR1VFU1RfUEFH
RSkgewotCQlrdm1fbW11X3VucHJvdGVjdF9wYWdlKHZjcHUtPmt2bSwgZ3BhX3RvX2dmbihjcjIp
KTsKLQkJcmV0dXJuIDE7CisJCWdmbl90IGdmbiA9IGdwYV90b19nZm4oY3IyKTsKKworCQlpZiAo
a3ZtaV90cmFja2VkX2dmbih2Y3B1LCBnZm4pKSB7CisJCQlpZiAoa3ZtaV91cGRhdGVfYWRfZmxh
Z3ModmNwdSkpCisJCQkJcmV0dXJuIDE7CisJCX0gZWxzZSB7CisJCQlrdm1fbW11X3VucHJvdGVj
dF9wYWdlKHZjcHUtPmt2bSwgZ2ZuKTsKKwkJCXJldHVybiAxOworCQl9CiAJfQogCiAJLyoKZGlm
ZiAtLWdpdCBhL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmggYi9pbmNsdWRlL2xpbnV4L2t2bWlf
aG9zdC5oCmluZGV4IDcyM2E5MDJmNGI4OS4uOWE5Y2Q3ZTFmNzVlIDEwMDY0NAotLS0gYS9pbmNs
dWRlL2xpbnV4L2t2bWlfaG9zdC5oCisrKyBiL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgKQEAg
LTk3LDYgKzk3LDcgQEAgYm9vbCBrdm1pX2VudGVyX2d1ZXN0KHN0cnVjdCBrdm1fdmNwdSAqdmNw
dSk7CiBib29sIGt2bWlfdmNwdV9ydW5uaW5nX3NpbmdsZXN0ZXAoc3RydWN0IGt2bV92Y3B1ICp2
Y3B1KTsKIHZvaWQga3ZtaV9zaW5nbGVzdGVwX2RvbmUoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsK
IHZvaWQga3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpOworYm9v
bCBrdm1pX3RyYWNrZWRfZ2ZuKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ2ZuX3QgZ2ZuKTsKIAog
I2Vsc2UKIApAQCAtMTE3LDYgKzExOCw4IEBAIHN0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX3ZjcHVf
cnVubmluZ19zaW5nbGVzdGVwKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkKIAkJCXsgcmV0dXJuIGZh
bHNlOyB9CiBzdGF0aWMgdm9pZCBrdm1pX3NpbmdsZXN0ZXBfZG9uZShzdHJ1Y3Qga3ZtX3ZjcHUg
KnZjcHUpIHsgfQogc3RhdGljIHZvaWQga3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChzdHJ1Y3Qga3Zt
X3ZjcHUgKnZjcHUpIHsgfQorc3RhdGljIGlubGluZSBib29sIGt2bWlfdHJhY2tlZF9nZm4oc3Ry
dWN0IGt2bV92Y3B1ICp2Y3B1LCBnZm5fdCBnZm4pCisJCQl7IHJldHVybiBmYWxzZTsgfQogCiAj
ZW5kaWYgLyogQ09ORklHX0tWTV9JTlRST1NQRUNUSU9OICovCiAKZGlmZiAtLWdpdCBhL3ZpcnQv
a3ZtL2ludHJvc3BlY3Rpb24va3ZtaS5jIGIvdmlydC9rdm0vaW50cm9zcGVjdGlvbi9rdm1pLmMK
aW5kZXggNWJiM2UxMjUyMjQyLi44ZjNkZTZiZTY0MTMgMTAwNjQ0Ci0tLSBhL3ZpcnQva3ZtL2lu
dHJvc3BlY3Rpb24va3ZtaS5jCisrKyBiL3ZpcnQva3ZtL2ludHJvc3BlY3Rpb24va3ZtaS5jCkBA
IC0xMzgwLDMgKzEzODAsMjkgQEAgdm9pZCBrdm1pX3NpbmdsZXN0ZXBfZmFpbGVkKHN0cnVjdCBr
dm1fdmNwdSAqdmNwdSkKIAlrdm1pX3NpbmdsZXN0ZXBfZXZlbnQodmNwdSwgZmFsc2UpOwogfQog
RVhQT1JUX1NZTUJPTChrdm1pX3NpbmdsZXN0ZXBfZmFpbGVkKTsKKworc3RhdGljIGJvb2wgX19r
dm1pX3RyYWNrZWRfZ2ZuKHN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaSwgZ2ZuX3QgZ2Zu
KQoreworCXU4IGlnbm9yZWRfYWNjZXNzOworCisJaWYgKGt2bWlfZ2V0X2dmbl9hY2Nlc3Moa3Zt
aSwgZ2ZuLCAmaWdub3JlZF9hY2Nlc3MpKQorCQlyZXR1cm4gZmFsc2U7CisKKwlyZXR1cm4gdHJ1
ZTsKK30KKworYm9vbCBrdm1pX3RyYWNrZWRfZ2ZuKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ2Zu
X3QgZ2ZuKQoreworCXN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaTsKKwlib29sIHJldDsK
KworCWt2bWkgPSBrdm1pX2dldCh2Y3B1LT5rdm0pOworCWlmICgha3ZtaSkKKwkJcmV0dXJuIGZh
bHNlOworCisJcmV0ID0gX19rdm1pX3RyYWNrZWRfZ2ZuKGt2bWksIGdmbik7CisKKwlrdm1pX3B1
dCh2Y3B1LT5rdm0pOworCisJcmV0dXJuIHJldDsKK30KX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fX19fX19fX19fX19fX18KVmlydHVhbGl6YXRpb24gbWFpbGluZyBsaXN0ClZpcnR1
YWxpemF0aW9uQGxpc3RzLmxpbnV4LWZvdW5kYXRpb24ub3JnCmh0dHBzOi8vbGlzdHMubGludXhm
b3VuZGF0aW9uLm9yZy9tYWlsbWFuL2xpc3RpbmZvL3ZpcnR1YWxpemF0aW9u
