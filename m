Return-Path: <virtualization-bounces@lists.linux-foundation.org>
X-Original-To: lists.virtualization@lfdr.de
Delivered-To: lists.virtualization@lfdr.de
Received: from hemlock.osuosl.org (smtp2.osuosl.org [140.211.166.133])
	by mail.lfdr.de (Postfix) with ESMTPS id 450731978E8
	for <lists.virtualization@lfdr.de>; Mon, 30 Mar 2020 12:20:24 +0200 (CEST)
Received: from localhost (localhost [127.0.0.1])
	by hemlock.osuosl.org (Postfix) with ESMTP id 88E55883DC;
	Mon, 30 Mar 2020 10:20:22 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from hemlock.osuosl.org ([127.0.0.1])
	by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
	with ESMTP id G4t7p5uiBVnv; Mon, 30 Mar 2020 10:20:20 +0000 (UTC)
Received: from lists.linuxfoundation.org (lf-lists.osuosl.org [140.211.9.56])
	by hemlock.osuosl.org (Postfix) with ESMTP id C2AA68851D;
	Mon, 30 Mar 2020 10:20:14 +0000 (UTC)
Received: from lf-lists.osuosl.org (localhost [127.0.0.1])
	by lists.linuxfoundation.org (Postfix) with ESMTP id B00FAC1D7E;
	Mon, 30 Mar 2020 10:20:14 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@lists.linuxfoundation.org
Received: from silver.osuosl.org (smtp3.osuosl.org [140.211.166.136])
 by lists.linuxfoundation.org (Postfix) with ESMTP id 4BF00C1D87
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:20:03 +0000 (UTC)
Received: from localhost (localhost [127.0.0.1])
 by silver.osuosl.org (Postfix) with ESMTP id 2BA6A23115
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:20:03 +0000 (UTC)
X-Virus-Scanned: amavisd-new at osuosl.org
Received: from silver.osuosl.org ([127.0.0.1])
 by localhost (.osuosl.org [127.0.0.1]) (amavisd-new, port 10024)
 with ESMTP id uqLXFr3GKDSa
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:19:59 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx01.bbu.dsd.mx.bitdefender.com
 (mx01.bbu.dsd.mx.bitdefender.com [91.199.104.161])
 by silver.osuosl.org (Postfix) with ESMTPS id E0B952012F
 for <virtualization@lists.linux-foundation.org>;
 Mon, 30 Mar 2020 10:19:54 +0000 (UTC)
Received: from smtp.bitdefender.com (smtp02.buh.bitdefender.net [10.17.80.76])
 by mx01.bbu.dsd.mx.bitdefender.com (Postfix) with ESMTPS id
 B0CEA305D3D6; Mon, 30 Mar 2020 13:13:02 +0300 (EEST)
Received: from localhost.localdomain (unknown [91.199.104.28])
 by smtp.bitdefender.com (Postfix) with ESMTPSA id 6DEA7305B7AA;
 Mon, 30 Mar 2020 13:13:02 +0300 (EEST)
From: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>
To: kvm@vger.kernel.org
Subject: [PATCH v8 80/81] KVM: introspection: emulate a guest page table walk
 on SPT violations due to A/D bit updates
Date: Mon, 30 Mar 2020 13:13:07 +0300
Message-Id: <20200330101308.21702-81-alazar@bitdefender.com>
In-Reply-To: <20200330101308.21702-1-alazar@bitdefender.com>
References: <20200330101308.21702-1-alazar@bitdefender.com>
MIME-Version: 1.0
Cc: =?UTF-8?q?Adalbert=20Laz=C4=83r?= <alazar@bitdefender.com>,
 Paolo Bonzini <pbonzini@redhat.com>,
 =?UTF-8?q?Mihai=20Don=C8=9Bu?= <mdontu@bitdefender.com>,
 virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.15
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>, 
 <mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
Errors-To: virtualization-bounces@lists.linux-foundation.org
Sender: "Virtualization" <virtualization-bounces@lists.linux-foundation.org>

RnJvbTogTWloYWkgRG9uyJt1IDxtZG9udHVAYml0ZGVmZW5kZXIuY29tPgoKT24gU1BUIHBhZ2Ug
ZmF1bHRzIGNhdXNlZCBieSBndWVzdCBwYWdlIHRhYmxlIHdhbGtzLCB1c2UgdGhlIGV4aXN0aW5n
Cmd1ZXN0IHBhZ2UgdGFibGUgd2FsayBjb2RlIHRvIG1ha2UgdGhlIG5lY2Vzc2FyeSBhZGp1c3Rt
ZW50cyB0byB0aGUgQS9ECmJpdHMgYW5kIHJldHVybiB0byBndWVzdC4gVGhpcyBlZmZlY3RpdmVs
eSBieXBhc3NlcyB0aGUgeDg2IGVtdWxhdG9yCndobyB3YXMgbWFraW5nIHRoZSB3cm9uZyBtb2Rp
ZmljYXRpb25zIGxlYWRpbmcgb25lIE9TIChXaW5kb3dzIDguMSB4NjQpCnRvIHRyaXBsZS1mYXVs
dCB2ZXJ5IGVhcmx5IGluIHRoZSBib290IHByb2Nlc3Mgd2l0aCB0aGUgaW50cm9zcGVjdGlvbgpl
bmFibGVkLgoKV2l0aCBpbnRyb3NwZWN0aW9uIGRpc2FibGVkLCB0aGVzZSBmYXVsdHMgYXJlIGhh
bmRsZWQgYnkgc2ltcGx5IHJlbW92aW5nCnRoZSBwcm90ZWN0aW9uIGZyb20gdGhlIGFmZmVjdGVk
IGd1ZXN0IHBhZ2UgYW5kIHJldHVybmluZyB0byBndWVzdC4KClNpZ25lZC1vZmYtYnk6IE1paGFp
IERvbsibdSA8bWRvbnR1QGJpdGRlZmVuZGVyLmNvbT4KU2lnbmVkLW9mZi1ieTogQWRhbGJlcnQg
TGF6xINyIDxhbGF6YXJAYml0ZGVmZW5kZXIuY29tPgotLS0KIGFyY2gveDg2L2luY2x1ZGUvYXNt
L2t2bWlfaG9zdC5oIHwgIDIgKysKIGFyY2gveDg2L2t2bS9rdm1pLmMgICAgICAgICAgICAgIHwg
MzMgKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysKIGFyY2gveDg2L2t2bS9tbXUvbW11
LmMgICAgICAgICAgIHwgMTEgKysrKysrKysrLS0KIGluY2x1ZGUvbGludXgva3ZtaV9ob3N0Lmgg
ICAgICAgIHwgIDMgKysrCiB2aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYyAgICB8IDI2ICsr
KysrKysrKysrKysrKysrKysrKysrKysKIDUgZmlsZXMgY2hhbmdlZCwgNzMgaW5zZXJ0aW9ucygr
KSwgMiBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaCBiL2FyY2gveDg2L2luY2x1ZGUvYXNtL2t2bWlfaG9zdC5oCmluZGV4IDhkMGMzZWQz
MDIxYi4uOWM5ZDZhMDE4MjA2IDEwMDY0NAotLS0gYS9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1p
X2hvc3QuaAorKysgYi9hcmNoL3g4Ni9pbmNsdWRlL2FzbS9rdm1pX2hvc3QuaApAQCAtNjEsNiAr
NjEsNyBAQCBib29sIGt2bWlfZGVzY3JpcHRvcl9ldmVudChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUs
IHU4IGRlc2NyaXB0b3IsIGJvb2wgd3JpdGUpOwogYm9vbCBrdm1pX21zcl9ldmVudChzdHJ1Y3Qg
a3ZtX3ZjcHUgKnZjcHUsIHN0cnVjdCBtc3JfZGF0YSAqbXNyKTsKIGJvb2wga3ZtaV9tb25pdG9y
X21zcndfaW50ZXJjZXB0KHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgdTMyIG1zciwgYm9vbCBlbmFi
bGUpOwogYm9vbCBrdm1pX21zcndfaW50ZXJjZXB0X29yaWdpbmF0b3Ioc3RydWN0IGt2bV92Y3B1
ICp2Y3B1KTsKK2Jvb2wga3ZtaV91cGRhdGVfYWRfZmxhZ3Moc3RydWN0IGt2bV92Y3B1ICp2Y3B1
KTsKIAogI2Vsc2UgLyogQ09ORklHX0tWTV9JTlRST1NQRUNUSU9OICovCiAKQEAgLTgzLDYgKzg0
LDcgQEAgc3RhdGljIGlubGluZSBib29sIGt2bWlfbW9uaXRvcl9tc3J3X2ludGVyY2VwdChzdHJ1
Y3Qga3ZtX3ZjcHUgKnZjcHUsIHUzMiBtc3IsCiAJCQkJCSAgICAgICBib29sIGVuYWJsZSkgeyBy
ZXR1cm4gZmFsc2U7IH0KIHN0YXRpYyBpbmxpbmUgYm9vbCBrdm1pX21zcndfaW50ZXJjZXB0X29y
aWdpbmF0b3Ioc3RydWN0IGt2bV92Y3B1ICp2Y3B1KQogCQkJCXsgcmV0dXJuIGZhbHNlOyB9Citi
b29sIGt2bWlfdXBkYXRlX2FkX2ZsYWdzKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSkgeyByZXR1cm4g
ZmFsc2U7IH0KIAogI2VuZGlmIC8qIENPTkZJR19LVk1fSU5UUk9TUEVDVElPTiAqLwogCmRpZmYg
LS1naXQgYS9hcmNoL3g4Ni9rdm0va3ZtaS5jIGIvYXJjaC94ODYva3ZtL2t2bWkuYwppbmRleCBk
MzM5YTg3OWJhMGIuLmY2NDk2MzBiMDg5ZSAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL2t2bWku
YworKysgYi9hcmNoL3g4Ni9rdm0va3ZtaS5jCkBAIC0xMjMyLDMgKzEyMzIsMzYgQEAgZ3BhX3Qg
a3ZtaV9hcmNoX2NtZF90cmFuc2xhdGVfZ3ZhKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwgZ3ZhX3Qg
Z3ZhKQogewogCXJldHVybiBrdm1fbW11X2d2YV90b19ncGFfc3lzdGVtKHZjcHUsIGd2YSwgMCwg
TlVMTCk7CiB9CisKK2Jvb2wga3ZtaV91cGRhdGVfYWRfZmxhZ3Moc3RydWN0IGt2bV92Y3B1ICp2
Y3B1KQoreworCXN0cnVjdCBrdm1faW50cm9zcGVjdGlvbiAqa3ZtaTsKKwlib29sIHJldCA9IGZh
bHNlOworCWd2YV90IGd2YTsKKwlncGFfdCBncGE7CisKKwlrdm1pID0ga3ZtaV9nZXQodmNwdS0+
a3ZtKTsKKwlpZiAoIWt2bWkpCisJCXJldHVybiBmYWxzZTsKKworCWd2YSA9IGt2bV94ODZfb3Bz
LT5mYXVsdF9nbGEodmNwdSk7CisJaWYgKGd2YSA9PSB+MHVsbCkgeworCQlrdm1pX3dhcm5fb25j
ZShrdm1pLCAiJXM6IGNhbm5vdCBwZXJmb3JtIHRyYW5zbGF0aW9uXG4iLAorCQkJICAgICAgIF9f
ZnVuY19fKTsKKwkJZ290byBvdXQ7CisJfQorCisJZ3BhID0ga3ZtX21tdV9ndmFfdG9fZ3BhX3N5
c3RlbSh2Y3B1LCBndmEsIFBGRVJSX1dSSVRFX01BU0ssIE5VTEwpOworCWlmIChncGEgPT0gVU5N
QVBQRURfR1ZBKSB7CisJCXN0cnVjdCB4ODZfZXhjZXB0aW9uIGV4Y2VwdGlvbiA9IHsgfTsKKwor
CQlncGEgPSBrdm1fbW11X2d2YV90b19ncGFfc3lzdGVtKHZjcHUsIGd2YSwgMCwgJmV4Y2VwdGlv
bik7CisJfQorCisJcmV0ID0gKGdwYSAhPSBVTk1BUFBFRF9HVkEpOworCitvdXQ6CisJa3ZtaV9w
dXQodmNwdS0+a3ZtKTsKKworCXJldHVybiByZXQ7Cit9CmRpZmYgLS1naXQgYS9hcmNoL3g4Ni9r
dm0vbW11L21tdS5jIGIvYXJjaC94ODYva3ZtL21tdS9tbXUuYwppbmRleCAzNWJlOWYyYTJmYzcu
LjE5YTYxMTM2ZTFmMSAxMDA2NDQKLS0tIGEvYXJjaC94ODYva3ZtL21tdS9tbXUuYworKysgYi9h
cmNoL3g4Ni9rdm0vbW11L21tdS5jCkBAIC01NTc0LDggKzU1NzQsMTUgQEAgaW50IGt2bV9tbXVf
cGFnZV9mYXVsdChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdwYV90IGNyMl9vcl9ncGEsIHU2NCBl
cnJvcl9jb2RlLAogCSAqLwogCWlmICh2Y3B1LT5hcmNoLm1tdS0+ZGlyZWN0X21hcCAmJgogCSAg
ICAoZXJyb3JfY29kZSAmIFBGRVJSX05FU1RFRF9HVUVTVF9QQUdFKSA9PSBQRkVSUl9ORVNURURf
R1VFU1RfUEFHRSkgewotCQlrdm1fbW11X3VucHJvdGVjdF9wYWdlKHZjcHUtPmt2bSwgZ3BhX3Rv
X2dmbihjcjJfb3JfZ3BhKSk7Ci0JCXJldHVybiAxOworCQlnZm5fdCBnZm4gPSBncGFfdG9fZ2Zu
KGNyMl9vcl9ncGEpOworCisJCWlmIChrdm1pX3RyYWNrZWRfZ2ZuKHZjcHUsIGdmbikpIHsKKwkJ
CWlmIChrdm1pX3VwZGF0ZV9hZF9mbGFncyh2Y3B1KSkKKwkJCQlyZXR1cm4gMTsKKwkJfSBlbHNl
IHsKKwkJCWt2bV9tbXVfdW5wcm90ZWN0X3BhZ2UodmNwdS0+a3ZtLCBnZm4pOworCQkJcmV0dXJu
IDE7CisJCX0KIAl9CiAKIAkvKgpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9rdm1pX2hvc3Qu
aCBiL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgKaW5kZXggNThhMzBjMDg3ZDYzLi5hMzAxMTQ4
Yzg4NTcgMTAwNjQ0Ci0tLSBhL2luY2x1ZGUvbGludXgva3ZtaV9ob3N0LmgKKysrIGIvaW5jbHVk
ZS9saW51eC9rdm1pX2hvc3QuaApAQCAtOTcsNiArOTcsNyBAQCBib29sIGt2bWlfZW50ZXJfZ3Vl
c3Qoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KTsKIGJvb2wga3ZtaV92Y3B1X3J1bm5pbmdfc2luZ2xl
c3RlcChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpOwogdm9pZCBrdm1pX3NpbmdsZXN0ZXBfZG9uZShz
dHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpOwogdm9pZCBrdm1pX3NpbmdsZXN0ZXBfZmFpbGVkKHN0cnVj
dCBrdm1fdmNwdSAqdmNwdSk7Citib29sIGt2bWlfdHJhY2tlZF9nZm4oc3RydWN0IGt2bV92Y3B1
ICp2Y3B1LCBnZm5fdCBnZm4pOwogCiAjZWxzZQogCkBAIC0xMTcsNiArMTE4LDggQEAgc3RhdGlj
IGlubGluZSBib29sIGt2bWlfdmNwdV9ydW5uaW5nX3NpbmdsZXN0ZXAoc3RydWN0IGt2bV92Y3B1
ICp2Y3B1KQogCQkJeyByZXR1cm4gZmFsc2U7IH0KIHN0YXRpYyBpbmxpbmUgdm9pZCBrdm1pX3Np
bmdsZXN0ZXBfZG9uZShzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpIHsgfQogc3RhdGljIGlubGluZSB2
b2lkIGt2bWlfc2luZ2xlc3RlcF9mYWlsZWQoc3RydWN0IGt2bV92Y3B1ICp2Y3B1KSB7IH0KK3N0
YXRpYyBpbmxpbmUgYm9vbCBrdm1pX3RyYWNrZWRfZ2ZuKHN0cnVjdCBrdm1fdmNwdSAqdmNwdSwg
Z2ZuX3QgZ2ZuKQorCQkJeyByZXR1cm4gZmFsc2U7IH0KIAogI2VuZGlmIC8qIENPTkZJR19LVk1f
SU5UUk9TUEVDVElPTiAqLwogCmRpZmYgLS1naXQgYS92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2
bWkuYyBiL3ZpcnQva3ZtL2ludHJvc3BlY3Rpb24va3ZtaS5jCmluZGV4IDhhNzNmYWMyODdiNC4u
OTE3NmFlMTQ3ZDJhIDEwMDY0NAotLS0gYS92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYwor
KysgYi92aXJ0L2t2bS9pbnRyb3NwZWN0aW9uL2t2bWkuYwpAQCAtMTM4MSwzICsxMzgxLDI5IEBA
IHZvaWQga3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZChzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUpCiAJa3Zt
aV9oYW5kbGVfc2luZ2xlc3RlcF9leGl0KHZjcHUsIGZhbHNlKTsKIH0KIEVYUE9SVF9TWU1CT0wo
a3ZtaV9zaW5nbGVzdGVwX2ZhaWxlZCk7CisKK3N0YXRpYyBib29sIF9fa3ZtaV90cmFja2VkX2dm
bihzdHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWksIGdmbl90IGdmbikKK3sKKwl1OCBpZ25v
cmVkX2FjY2VzczsKKworCWlmIChrdm1pX2dldF9nZm5fYWNjZXNzKGt2bWksIGdmbiwgJmlnbm9y
ZWRfYWNjZXNzKSkKKwkJcmV0dXJuIGZhbHNlOworCisJcmV0dXJuIHRydWU7Cit9CisKK2Jvb2wg
a3ZtaV90cmFja2VkX2dmbihzdHJ1Y3Qga3ZtX3ZjcHUgKnZjcHUsIGdmbl90IGdmbikKK3sKKwlz
dHJ1Y3Qga3ZtX2ludHJvc3BlY3Rpb24gKmt2bWk7CisJYm9vbCByZXQ7CisKKwlrdm1pID0ga3Zt
aV9nZXQodmNwdS0+a3ZtKTsKKwlpZiAoIWt2bWkpCisJCXJldHVybiBmYWxzZTsKKworCXJldCA9
IF9fa3ZtaV90cmFja2VkX2dmbihrdm1pLCBnZm4pOworCisJa3ZtaV9wdXQodmNwdS0+a3ZtKTsK
KworCXJldHVybiByZXQ7Cit9Cl9fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19fX19f
X19fX19fX19fClZpcnR1YWxpemF0aW9uIG1haWxpbmcgbGlzdApWaXJ0dWFsaXphdGlvbkBsaXN0
cy5saW51eC1mb3VuZGF0aW9uLm9yZwpodHRwczovL2xpc3RzLmxpbnV4Zm91bmRhdGlvbi5vcmcv
bWFpbG1hbi9saXN0aW5mby92aXJ0dWFsaXphdGlvbg==
